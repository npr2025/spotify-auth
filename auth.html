<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Editions Builder â€” Files Only (All Sheets, Column Mapping, 3-way Match)</title>
<style>
  :root{--bg:#0b1220;--fg:#cfe3ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1180px;margin:32px auto;padding:0 12px}
  h1{margin:0 0 8px}
  fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
  legend{padding:0 6px}
  label{display:block;margin:6px 0}
  input[type="text"],input[type="number"],select{width:100%;max-width:720px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
  input[type="file"]{margin:4px 0}
  button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:220px}
  small.hint{color:#666}
  .muted{color:#666}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>Editions Builder â€” Files Only</h1>
<p id="status">æœªæ¥ç¶š</p>
<div class="row">
  <button id="btnConnect">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button id="btnReset">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
  <button id="btnCheck">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
</div>

<fieldset>
  <legend>å›ºå®šï¼ˆDashboardã¨å®Œå…¨ä¸€è‡´ï¼‰</legend>
  <div class="grid2">
    <label>CLIENT_ID
      <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled>
    </label>
    <label>REDIRECT_URI
      <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled>
    </label>
  </div>
  <small class="hint">â€» å€¤ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§å›ºå®šã€‚ã‚¼ãƒ­å¹…ãƒ»ç©ºç™½ã¯è‡ªå‹•é™¤å»ã€‚</small>
</fieldset>

<fieldset>
  <legend>è¨­å®š</legend>
  <label>APIé–“éš”(ms) <input id="gap" type="number" value="900"></label>
  <div class="grid2">
    <label>UKãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ URL/ID <input id="plUK" type="text" value="https://open.spotify.com/playlist/1zqDXSgnbc87v4BxbHxtKK"></label>
    <label>USãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ URL/ID <input id="plUS" type="text" value="https://open.spotify.com/playlist/2oeS8QglwS4hLtLuqvPZgH"></label>
    <label>EUãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ URL/ID <input id="plEU" type="text" value="https://open.spotify.com/playlist/2JWHMN3yxLI5S4XFdDZbwt"></label>
    <label>WORLDãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆ URL/ID <input id="plWORLD" type="text" value="https://open.spotify.com/playlist/4SCclM9zLNuSPOmqORdVN8"></label>
  </div>
  <div class="grid2">
    <label>Balancedå€™è£œæ•° <input id="balancedN" type="number" value="150"></label>
    <label>å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å‡ºåŠ›æ•° <input id="finalN" type="number" value="130"></label>
  </div>
  <div class="grid2">
    <label>äººæ°—ã®é‡ã¿ï¼ˆSaveRateå´ï¼‰<input id="wPopularity" type="number" step="0.01" value="0.55"></label>
    <label class="muted">æ–°ã—ã•é…åˆ†ï¼ˆå›ºå®š 24/7/28=0.5/0.3/0.2ï¼‰<input type="number" step="0.01" value="0.45" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆã‚½ãƒ¼ã‚¹CSVï¼æ¯é›†å›£ï¼åˆ†æXLSX/CSVï¼æŒ‡æ¨™ï¼‰</legend>
  <label>ã‚½ãƒ¼ã‚¹CSVï¼ˆä¾‹ï¼šPropgapandaã‚½ãƒ¼ã‚¹.csvï¼‰<input id="fileSource" type="file" accept=".csv"></label>
  <label>åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆExcel .xlsx / CSVï¼‰<input id="fileAnalytics" type="file" accept=".xlsx,.csv"></label>
  <div class="row">
    <button id="btnPreview" disabled>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè¨ºæ–­ï¼‹ä¸Šä½20ï¼‰</button>
    <button id="btnRun" disabled>4ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¸ä¸Šæ›¸ã</button>
  </div>
  <small class="hint">â€» ã¾ãšãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãƒãƒƒãƒç‡ã‚’ç¢ºèª â†’ 0ä»¶ãªã‚‰ä¸‹ã®ã€Œåˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã€ã‚’èª¿æ•´ã€‚</small>
</fieldset>

<fieldset>
  <legend>åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆè‡ªå‹•æ¨æ¸¬ï¼æ‰‹å‹•å¤‰æ›´å¯ï¼‰</legend>
  <div class="grid2">
    <div>
      <h3>ã‚½ãƒ¼ã‚¹CSV</h3>
      <label>æ›²ID/URLåˆ— <select id="mapSourceId"></select></label>
      <label>ISRCåˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapSourceISRC"></select></label>
      <label>æ›²ååˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapSourceName"></select></label>
      <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapSourceArtist"></select></label>
    </div>
    <div>
      <h3>åˆ†æãƒ‡ãƒ¼ã‚¿</h3>
      <label>æ›²ID/URLåˆ— <select id="mapAnalyticId"></select></label>
      <label>ISRCåˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapAnalyticISRC"></select></label>
      <label>æ›²ååˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapAnalyticName"></select></label>
      <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapAnalyticArtist"></select></label>
    </div>
  </div>
  <hr>
  <div class="grid4">
    <label>plays 24h <select id="mapP24"></select></label>
    <label>plays 7d  <select id="mapP7"></select></label>
    <label>plays 28d <select id="mapP28"></select></label>
    <label>remixerï¼ˆä»»æ„ï¼‰ <select id="mapRemix"></select></label>
  </div>
  <div class="grid4">
    <label>save rate 24h <select id="mapSR24"></select></label>
    <label>save rate 7d  <select id="mapSR7"></select></label>
    <label>save rate 28d <select id="mapSR28"></select></label>
    <label>åœ°åŸŸï¼ˆUK/US/EU/WORLD ä»»æ„ï¼‰ï¼š<br>
      UK <select id="mapUK"></select><br>
      US <select id="mapUS"></select><br>
      EU <select id="mapEU"></select><br>
      WORLD <select id="mapWO"></select>
    </label>
  </div>
  <small class="hint">ç©ºæ¬„ï¼æœªä½¿ç”¨ã€‚æœªçŸ¥ã®åˆ—åã§ã‚‚ã€ã“ã“ã§é¸ã¹ã°ä½¿ãˆã¾ã™ï¼ˆæ—¥æœ¬èªåˆ—OKï¼‰ã€‚</small>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<script>
/*** å›ºå®šï¼šã‚ãªãŸã®ã‚¢ãƒ—ãƒªè¨­å®š ***/
const CLIENT_ID_RAW    = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI_RAW = "https://npr2025.github.io/spotify-auth/callback.html";
const zws=/[\u200B-\u200D\uFEFF]/g;
const CLIENT_ID   = CLIENT_ID_RAW.replace(zws,"").trim();
const REDIRECT_URI= REDIRECT_URI_RAW.replace(zws,"").trim();
const SCOPES      = "playlist-modify-public playlist-modify-private ugc-image-upload";

/* ---------- util ---------- */
const LS = { acc:"sp_access_token", ref:"sp_refresh_token", exp:"sp_token_exp", ver:"sp_code_verifier" };
const $ = (id)=>document.getElementById(id);
const log = (s)=>{ const el=$("log"); el.textContent += (el.textContent? "\n":"")+ s; el.scrollTop = el.scrollHeight; };
const clearLog = ()=>{ $("log").textContent=""; };
const isAuthed = ()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0) - 5000;
function setStatus(){ $("status").textContent = isAuthed()? "æ¥ç¶šä¸­ï¼ˆOKï¼‰":"æœªæ¥ç¶š"; $("btnPreview").disabled = !filesReady()||!isAuthed(); $("btnRun").disabled = !filesReady()||!isAuthed(); }
function filesReady(){ return $("fileSource").files.length && $("fileAnalytics").files.length; }
function normalizeKey(s){ return String(s||"").toLowerCase().replace(/[ï¼ˆï¼‰\(\)\[\]ã€ã€‘]/g," ").replace(/\s+/g," ").trim(); }
function truthy(v){ const s=String(v).trim().toLowerCase(); return ["1","true","yes","y","ok","âœ“","â—","â—¯","o","ã¯ã„","æœ‰"].includes(s); }
const num = (x)=>{ const s=String(x??0).replace(/[ %,ï¼Œ]/g,""); const v=parseFloat(s); return isFinite(v)? v:0; };

/* ---------- Spotify auth ---------- */
function dumpAuthDiag(stage){
  log(`ğŸ” ${stage}\n  CLIENT_ID(len=${CLIENT_ID.length}): ${CLIENT_ID.slice(0,6)}â€¦${CLIENT_ID.slice(-6)}\n  REDIRECT_URI: ${REDIRECT_URI}`);
}
async function startAuth(){
  dumpAuthDiag("Authorizeå‰");
  // PKCE
  const verifier = crypto.getRandomValues(new Uint8Array(64)).reduce((s,b)=>s+String.fromCharCode(97+(b%26)),"");
  localStorage.setItem(LS.ver, verifier);
  const challenge = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier)).then(b=>btoa(String.fromCharCode(...new Uint8Array(b))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""));
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id", CLIENT_ID);
  url.searchParams.set("redirect_uri", REDIRECT_URI);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", challenge);
  url.searchParams.set("scope", SCOPES);
  location.href = url.toString();
}
async function refreshTokenIfNeeded(){
  const exp=+localStorage.getItem(LS.exp||0);
  if(Date.now()<exp-5000) return;
  const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:rt,client_id:CLIENT_ID});
  const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!res.ok){ log("âš ï¸ refreshå¤±æ•—: "+res.status+" "+(await res.text())); return; }
  const j=await res.json();
  localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
  log("ğŸ”„ access_token refreshed");
}
async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const gap=+$("gap").value||900; await new Promise(r=>setTimeout(r,gap));
  for(let a=0;a<5;a++){
    const res=await fetch("https://api.spotify.com"+path,{ method, headers:{ "Authorization":"Bearer "+localStorage.getItem(LS.acc), "Content-Type":"application/json" }, body: body?JSON.stringify(body):null });
    if(res.status===401){ await refreshTokenIfNeeded(); continue; }
    if(res.status===429){ const ra=+res.headers.get("Retry-After")||2; log(`â³ 429 â†’ ${ra}så¾…æ©Ÿ`); await new Promise(r=>setTimeout(r,ra*1000)); continue; }
    if(!res.ok){ const t=await res.text(); throw new Error(`Spotify API ${res.status}: ${t}`); }
    if(res.status===204) return null;
    return await res.json();
  }
  throw new Error("Spotify API max retries");
}

/* ---------- ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ï¼ˆXLSXã¯å…¨ã‚·ãƒ¼ãƒˆï¼‰ ---------- */
let sourceRows=[], analyticsRows=[];
function readCSV(file){ return new Promise((resolve,reject)=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject})); }
async function readXLSX_allSheets(file){
  const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:"array"});
  let rows=[]; const details=[];
  for(const name of wb.SheetNames){
    const sheet=wb.Sheets[name];
    const json=XLSX.utils.sheet_to_json(sheet,{defval:""});
    for(const r of json){ r.__sheet=name; }
    rows=rows.concat(json); details.push(`${name}:${json.length}`);
  }
  return { rows, details, sheetNames: wb.SheetNames };
}

/* ---------- åˆ—ãƒãƒƒãƒ”ãƒ³ã‚° ---------- */
const selects=["mapSourceId","mapSourceISRC","mapSourceName","mapSourceArtist","mapAnalyticId","mapAnalyticISRC","mapAnalyticName","mapAnalyticArtist","mapP24","mapP7","mapP28","mapSR24","mapSR7","mapSR28","mapRemix","mapUK","mapUS","mapEU","mapWO"];
function fillSelect(id, columns){
  const el=$(id); const cur=el.value; el.innerHTML="";
  const optNone=document.createElement("option"); optNone.value=""; optNone.textContent="ï¼ˆæœªä½¿ç”¨ï¼‰"; el.appendChild(optNone);
  columns.forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=c; el.appendChild(o); });
  if(columns.includes(cur)) el.value=cur;
}
function collectColumns(rows){
  const set=new Set(); rows.slice(0,200).forEach(r=> Object.keys(r).forEach(k=> set.add(k)));
  return [...set];
}
function autoPick(columns, aliases){
  const L=columns.map(c=>[c,normalizeKey(c)]);
  for(const a of aliases){
    const needle=normalizeKey(a);
    const hit=L.find(([orig,norm])=> norm===needle || norm.includes(needle));
    if(hit) return hit[0];
  }
  return "";
}

/* â˜… è¿½åŠ ï¼šå†…å®¹ãƒ™ãƒ¼ã‚¹ã®åˆ—æ¨æ¸¬ï¼ˆã‚¼ãƒ­ä»¶å¯¾ç­–ï¼‰ */
function guessCols(rows){
  const cols = [...new Set(rows.slice(0,300).flatMap(r=>Object.keys(r)))];
  const norm = s => String(s||"").toLowerCase();
  const score = (c, likeWords) => {
    let s=0, n=0;
    for(const r of rows.slice(0,500)){
      const v = String(r[c] ?? "");
      if(!v) continue;
      n++;
      const ln = norm(v);
      s += likeWords.some(w=> ln.includes(w)) ? 2 : 1;
      if(/\b[A-Z]{2}-?[A-Z0-9]{3}-?[0-9]{2}-?[0-9]{5}\b/.test(v)) s -= 2; // ISRCã£ã½ã„
      if(/https?:|open\.spotify\.com|spotify:/.test(ln)) s -= 2; // URLç³»
    }
    return n? s/n : -1;
  };
  const bestBy = like => cols.sort((a,b)=> score(b,like)-score(a,like))[0] || "";
  return {
    name:   bestBy(["title","track","æ›²","ã‚¿ã‚¤ãƒˆãƒ«","name"]),
    artist: bestBy(["artist","artists","ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ"]),
    isrc:   cols.find(c=>/isrc/i.test(c)) || ""
  };
}

function autoMap(){
  const srcCols=collectColumns(sourceRows);
  const anCols=collectColumns(analyticsRows);
  selects.forEach(id=> fillSelect(id, id.startsWith("mapSource")? srcCols : anCols));

  const idAlias = ["spotify_uri","track_uri","uri","spotify_url","url","link","ãƒªãƒ³ã‚¯","ãƒˆãƒ©ãƒƒã‚¯url","ãƒˆãƒ©ãƒƒã‚¯uri","æ›²url","æ›²uri","spotify link"];
  const isrcAlias=["isrc","isrc_code","isrcã‚³ãƒ¼ãƒ‰","ï¼©ï¼³ï¼²ï¼£"];
  const nameAlias=["track_name","title","æ›²å","ã‚¿ã‚¤ãƒˆãƒ«","name","track title","æ›²"];
  const artistAlias=["artist","artists","artist_name","ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ","ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå","primary artist","main artist"];

  const p24A=["plays_24h","p24","streams24","play_24h","24h plays","24æ™‚é–“å†ç”Ÿæ•°"];
  const p7A =["plays_7d","p7","streams7","play_7d","7d plays","7æ—¥å†ç”Ÿæ•°"];
  const p28A=["plays_28d","p28","streams28","play_28d","28d plays","28æ—¥å†ç”Ÿæ•°"];

  const sr24A=["save_rate_24h","sr24","save24","save_rate24","24h saverate","ä¿å­˜ç‡24h","ä¿å­˜ç‡24æ™‚é–“"];
  const sr7A =["save_rate_7d","sr7","save7","save_rate7","ä¿å­˜ç‡7d","ä¿å­˜ç‡7æ—¥"];
  const sr28A=["save_rate_28d","sr28","save28","save_rate28","ä¿å­˜ç‡28d","ä¿å­˜ç‡28æ—¥"];

  const remixA=["remixer","remixers","remixer_name","ãƒªãƒŸã‚­ã‚µãƒ¼","ãƒªãƒŸãƒƒã‚¯ã‚¹"];
  const ukA=["uk","available_uk","avail_uk","è‹±å›½","ã‚¤ã‚®ãƒªã‚¹"];
  const usA=["us","available_us","avail_us","ç±³å›½","ã‚¢ãƒ¡ãƒªã‚«"];
  const euA=["eu","available_eu","avail_eu","æ¬§å·","ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘"];
  const woA=["world","available_world","avail_world","global","worldwide","å…¨ä¸–ç•Œ"];

  // åˆ¥åã‹ã‚‰è‡ªå‹•
  $("mapSourceId").value     = autoPick(srcCols, idAlias);
  $("mapSourceISRC").value   = autoPick(srcCols, isrcAlias);
  $("mapSourceName").value   = autoPick(srcCols, nameAlias);
  $("mapSourceArtist").value = autoPick(srcCols, artistAlias);

  $("mapAnalyticId").value     = autoPick(anCols, idAlias);
  $("mapAnalyticISRC").value   = autoPick(anCols, isrcAlias);
  $("mapAnalyticName").value   = autoPick(anCols, nameAlias);
  $("mapAnalyticArtist").value = autoPick(anCols, artistAlias);

  $("mapP24").value = autoPick(anCols, p24A);
  $("mapP7").value  = autoPick(anCols, p7A);
  $("mapP28").value = autoPick(anCols, p28A);

  $("mapSR24").value = autoPick(anCols, sr24A);
  $("mapSR7").value  = autoPick(anCols, sr7A);
  $("mapSR28").value = autoPick(anCols, sr28A);

  $("mapRemix").value = autoPick(anCols, remixA);
  $("mapUK").value = autoPick(anCols, ukA);
  $("mapUS").value = autoPick(anCols, usA);
  $("mapEU").value = autoPick(anCols, euA);
  $("mapWO").value = autoPick(anCols, woA);

  // â˜… ç©ºæ¬„ã¯å†…å®¹ã‹ã‚‰æ¨æ¸¬ã—ã¦è£œå®Œ
  const sGuess=guessCols(sourceRows); const aGuess=guessCols(analyticsRows);
  if(!$("mapSourceName").value)   $("mapSourceName").value   = sGuess.name;
  if(!$("mapSourceArtist").value) $("mapSourceArtist").value = sGuess.artist;
  if(!$("mapSourceISRC").value)   $("mapSourceISRC").value   = sGuess.isrc;
  if(!$("mapAnalyticName").value)   $("mapAnalyticName").value   = aGuess.name;
  if(!$("mapAnalyticArtist").value) $("mapAnalyticArtist").value = aGuess.artist;
  if(!$("mapAnalyticISRC").value)   $("mapAnalyticISRC").value   = aGuess.isrc;

  log(`ğŸ§­ è‡ªå‹•æ¨æ¸¬ â†’ ã‚½ãƒ¼ã‚¹(name:${$("mapSourceName").value||"-"}, artist:${$("mapSourceArtist").value||"-"}, isrc:${$("mapSourceISRC").value||"-"}) / åˆ†æ(name:${$("mapAnalyticName").value||"-"}, artist:${$("mapAnalyticArtist").value||"-"}, isrc:${$("mapAnalyticISRC").value||"-"})`);
}

/* ---------- èª­è¾¼ ---------- */
async function loadFiles(){
  clearLog(); log("ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿â€¦");
  sourceRows = await readCSV($("fileSource").files[0]);
  log(`âœ… ã‚½ãƒ¼ã‚¹CSV: ${sourceRows.length} è¡Œ`);
  const f2=$("fileAnalytics").files[0];
  if(f2.name.toLowerCase().endsWith(".xlsx")){
    const res = await readXLSX_allSheets(f2);
    analyticsRows = res.rows;
    log(`âœ… åˆ†æ: XLSX å…¨${res.sheetNames.length}ã‚·ãƒ¼ãƒˆåˆè¨ˆ ${analyticsRows.length} è¡Œ [${res.details.join(", ")}]`);
  }else{
    analyticsRows = await readCSV(f2);
    log(`âœ… åˆ†æ: CSV ${analyticsRows.length} è¡Œ`);
  }
  autoMap();
  $("btnPreview").disabled = !isAuthed();
  $("btnRun").disabled     = !isAuthed();
}

/* ---------- ã‚­ãƒ¼ç”Ÿæˆ ---------- */
function extractTrackId(raw){
  const s=String(raw||"").trim();
  if(!s) return "";
  let m=s.match(/spotify:track:([A-Za-z0-9]{22})/); if(m) return m[1];
  m=s.match(/open\.spotify\.com\/track\/([A-Za-z0-9]{22})/); if(m) return m[1];
  m=s.match(/\/track\/([A-Za-z0-9]{22})(?:\?|$)/); if(m) return m[1];
  m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1];
  return "";
}
function nameKey(name, artist){
  const clean = (t)=>String(t||"").toLowerCase()
    .replace(/[\u3000]/g," ")
    .replace(/[^\p{L}\p{N}\s]/gu,"")
    .replace(/\s+/g," ").trim();
  const n=clean(name), a=clean(artist);
  if(!n || !a) return "";
  return `${n}ï½œ${a}`;
}

/* ---------- è¨ºæ–­ï¼‹ã‚¹ã‚³ã‚¢ ---------- */
function buildIndex(rows, idCol, isrcCol, nameCol, artistCol){
  const idx=new Map();
  let idCount=0,isrcCount=0,nameCount=0;
  for(const r of rows){
    const id = idCol? extractTrackId(r[idCol]) : "";
    const isrc = isrcCol? String(r[isrcCol]||"").trim() : "";
    const nk = (nameCol||artistCol)? nameKey(r[nameCol], r[artistCol]) : "";
    if(id){ idx.set("ID:"+id, r); idCount++; continue; }
    if(isrc){ idx.set("ISRC:"+isrc.toUpperCase(), r); isrcCount++; continue; }
    if(nk){ idx.set("NM:"+nk, r); nameCount++; continue; }
  }
  return {idx, idCount, isrcCount, nameCount};
}

function getVal(obj, col){ return col? obj[col] : ""; }

function computeScoresAndDiagnostics(){
  // 1) ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚½ãƒ¼ã‚¹ï¼æ¯é›†å›£ï¼‰
  const src = buildIndex(
    sourceRows,
    $("mapSourceId").value, $("mapSourceISRC").value,
    $("mapSourceName").value, $("mapSourceArtist").value
  );

  // 2) åˆ†æ â†’ ã‚½ãƒ¼ã‚¹ã«ã‚ã‚‹ã‚‚ã®ã ã‘æ¡ç”¨
  const rows=[]; let anKeys=0, match=0;
  for(const a of analyticsRows){
    const id  = $("mapAnalyticId").value ? extractTrackId(a[$("mapAnalyticId").value]) : "";
    const isc = $("mapAnalyticISRC").value ? String(a[$("mapAnalyticISRC").value]||"").trim() : "";
    const n   = getVal(a,$("mapAnalyticName").value);
    const art = getVal(a,$("mapAnalyticArtist").value);
    const nk  = nameKey(n, art);
    let srcRow=null;

    if(id){ anKeys++; if(src.idx.has("ID:"+id))  srcRow=src.idx.get("ID:"+id); }
    if(!srcRow && isc){ anKeys++; if(src.idx.has("ISRC:"+isc.toUpperCase())) srcRow=src.idx.get("ISRC:"+isc.toUpperCase()); }
    if(!srcRow && nk){  anKeys++; if(src.idx.has("NM:"+nk))  srcRow=src.idx.get("NM:"+nk); }

    if(srcRow){
      match++;
      const srcId  = extractTrackId(getVal(srcRow, $("mapSourceId").value));
      const srcIsc = String(getVal(srcRow, $("mapSourceISRC").value)||"").trim();
      const srcN   = getVal(srcRow, $("mapSourceName").value) || n || "";
      const srcA   = getVal(srcRow, $("mapSourceArtist").value) || art || "";

      rows.push({
        id: id || srcId || "",
        isrc: (isc || srcIsc || "").toUpperCase(),
        name: srcN,
        artist: srcA,
        a, s: srcRow
      });
    }
  }

  // è¨ºæ–­ãƒ­ã‚°
  log(`ğŸ” è¨ºæ–­:
  ã‚½ãƒ¼ã‚¹: ID=${src.idCount}, ISRC=${src.isrcCount}, åå‰=${src.nameCount}
  åˆ†æ:   ã‚­ãƒ¼æŠ½å‡ºè©¦è¡Œ=${anKeys}ï¼ˆè¡Œã‚ãŸã‚Šæœ€å¤§3ï¼‰ â†’ ãƒãƒƒãƒ=${match}`);

  // â˜… 0ä»¶ã§ã‚‚è½ã¨ã•ãªã„ï¼šå€™è£œã¨åˆ—ä¸€è¦§ã‚’æç¤ºã—ã¦çµ‚äº†
  if(rows.length===0){
    const sG = guessCols(sourceRows);
    const aG = guessCols(analyticsRows);
    const srcCols = collectColumns(sourceRows).join(", ");
    const anCols  = collectColumns(analyticsRows).join(", ");
    log("âŒ ä¸€è‡´0ä»¶ã€‚åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¦‹ç›´ã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
    log(`å€™è£œï¼ˆã‚½ãƒ¼ã‚¹ï¼‰ name:${sG.name||"-"}, artist:${sG.artist||"-"}, isrc:${sG.isrc||"-"}`);
    log(`å€™è£œï¼ˆåˆ†æï¼‰   name:${aG.name||"-"}, artist:${aG.artist||"-"}, isrc:${aG.isrc||"-"}`);
    log("ğŸ”¤ ã‚½ãƒ¼ã‚¹åˆ—: "+srcCols);
    log("ğŸ”¤ åˆ†æåˆ—:  "+anCols);
    return [];
  }

  // 3) ã‚¹ã‚³ã‚¢åŒ–
  const playsCols = {p24:$("mapP24").value, p7:$("mapP7").value, p28:$("mapP28").value};
  const srCols    = {s24:$("mapSR24").value, s7:$("mapSR7").value, s28:$("mapSR28").value};

  let max24=0,max7=0,max28=0;
  for(const r of rows){
    max24=Math.max(max24, num(r.a[playsCols.p24]));
    max7 =Math.max(max7,  num(r.a[playsCols.p7]));
    max28=Math.max(max28, num(r.a[playsCols.p28]));
  }

  for(const r of rows){
    const sr24 = num(r.a[srCols.s24])/100;
    const sr7  = num(r.a[srCols.s7])/100;
    const sr28 = num(r.a[srCols.s28])/100;
    const p24  = max24? num(r.a[playsCols.p24])/max24 : 0;
    const p7   = max7 ? num(r.a[playsCols.p7])/max7  : 0;
    const p28  = max28? num(r.a[playsCols.p28])/max28: 0;
    const wN   = [0.5,0.3,0.2];
    const saveComp = wN[0]*sr24 + wN[1]*sr7 + wN[2]*sr28;
    const playComp = wN[0]*p24  + wN[1]*p7  + wN[2]*p28;
    const wPop= +$("wPopularity").value || .55;
    r.score = wPop*saveComp + (1-wPop)*playComp;

    const uk = truthy(getVal(r.a,$("mapUK").value));
    const us = truthy(getVal(r.a,$("mapUS").value));
    const eu = truthy(getVal(r.a,$("mapEU").value));
    const wo = truthy(getVal(r.a,$("mapWO").value));
    const rem= String(getVal(r.a,$("mapRemix").value)||"").trim();
    r.flags={uk,us,eu,wo}; r.remixer=rem;
  }

  rows.sort((a,b)=> b.score-a.score);
  return rows;
}

/* ---------- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ---------- */
function layoutNoAdjacent(list, maxN){
  const out=[];
  for(const item of list){
    if(out.length>=maxN) break;
    const r=(item.remixer||"").toLowerCase();
    if(out.length>0 && r && (out[out.length-1].remixer||"").toLowerCase()===r) continue;
    out.push(item);
  }
  for(const item of list){
    if(out.length>=maxN) break;
    if(out.includes(item)) continue;
    out.push(item);
  }
  return out;
}
function filterByEdition(rows, ed){
  const hasAny = rows.some(r=> r.flags.uk||r.flags.us||r.flags.eu||r.flags.wo);
  if(!hasAny) return rows;
  const k=ed.toLowerCase();
  return rows.filter(r=> k==="world" ? (r.flags.wo||r.flags.uk||r.flags.us||r.flags.eu) : r.flags[k]);
}
function extractPlaylistId(s){ s=String(s||""); let m=s.match(/playlist\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }

/* ---------- URIè§£æ±ºï¼ˆID/ISRC/åå‰+ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼‰ ---------- */
const resolveCache = new Map(); // key â†’ "spotify:track:ID"
async function resolveUriOne(item){
  if(item.id && item.id.length===22) return "spotify:track:"+item.id;
  if(item.isrc){
    const key="ISRC:"+item.isrc;
    if(resolveCache.has(key)) return resolveCache.get(key);
    try{
      const q=encodeURIComponent("isrc:"+item.isrc);
      const r=await spFetch(`/v1/search?q=${q}&type=track&limit=1`,"GET");
      const t=r?.tracks?.items?.[0]; if(t?.id){
        const uri="spotify:track:"+t.id; resolveCache.set(key,uri); return uri;
      }
    }catch{}
  }
  if(item.name && item.artist){
    const key="NM:"+ (item.name+"|"+item.artist).toLowerCase();
    if(resolveCache.has(key)) return resolveCache.get(key);
    try{
      const q=encodeURIComponent(`track:${item.name} artist:${item.artist}`);
      const r=await spFetch(`/v1/search?q=${q}&type=track&limit=1`,"GET");
      const t=r?.tracks?.items?.[0]; if(t?.id){
        const uri="spotify:track:"+t.id; resolveCache.set(key,uri); return uri;
      }
    }catch{}
  }
  return "";
}
async function toUris(items){
  const uris=[]; let ok=0, ng=0;
  for(const it of items){
    const uri=await resolveUriOne(it);
    if(uri){ uris.push(uri); ok++; } else { ng++; }
  }
  log(`ğŸ”— URIè§£æ±º: æˆåŠŸ ${ok} / å¤±æ•— ${ng}`);
  return uris;
}

/* ---------- æ›¸ãè¾¼ã¿ ---------- */
async function replacePlaylist(pid, uris){
  const chunks=[]; for(let i=0;i<uris.length;i+=100) chunks.push(uris.slice(i,i+100));
  if(!chunks.length) chunks.push([]);
  await spFetch(`/v1/playlists/${pid}/tracks`,"PUT",{uris:chunks[0]}); log(`ğŸ§¹ ç½®æ›: ${chunks[0].length}ä»¶`);
  for(let i=1;i<chunks.length;i++){ await spFetch(`/v1/playlists/${pid}/tracks`,"POST",{uris:chunks[i]}); log(`â• è¿½åŠ : ${chunks[i].length}ä»¶`); }
}

/* ---------- å®Ÿè¡Œ ---------- */
async function run(doPreview=false){
  try{
    clearLog();
    log("ğŸ” ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆXLSXå…¨ã‚·ãƒ¼ãƒˆï¼‹3æ®µéšãƒãƒƒãƒï¼‰â€¦");
    const rows = computeScoresAndDiagnostics();

    if(!rows.length){
      log("â¹ï¸ ãƒãƒƒãƒ0ä»¶ã®ãŸã‚å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è¦‹ç›´ã—ã¦å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const balancedN=+$("balancedN").value||150;
    const finalN=+$("finalN").value||130;
    const top=rows.slice(0,balancedN);

    const mk=(name)=>{ const f=filterByEdition(top,name); const p=layoutNoAdjacent(f,finalN); log(`â€¢ ${name}: å€™è£œ${f.length} â†’ å‡ºåŠ›${p.length}`); return p; };
    const edUK=mk("UK"), edUS=mk("US"), edEU=mk("EU"), edWO=mk("WORLD");

    if(doPreview){
      const sample=[...edUK.slice(0,5),...edUS.slice(0,5),...edEU.slice(0,5),...edWO.slice(0,5)];
      const uris=await toUris(sample);
      log("ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URIï¼ˆåˆè¨ˆ"+uris.length+"ï¼‰\n"+uris.join("\n"));
      return;
    }

    if(!isAuthed()) throw new Error("Spotifyæœªæ¥ç¶šã§ã™ã€‚å…ˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ã€‚");
    const pidUK=extractPlaylistId($("plUK").value), pidUS=extractPlaylistId($("plUS").value),
          pidEU=extractPlaylistId($("plEU").value), pidWO=extractPlaylistId($("plWORLD").value);
    if(!(pidUK&&pidUS&&pidEU&&pidWO)) throw new Error("ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURL/IDãŒä¸æ­£ã§ã™ã€‚");

    log("ğŸ”— UKã®URIè§£æ±ºâ€¦"); const uriUK=await toUris(edUK);
    log("ğŸ”— USã®URIè§£æ±ºâ€¦"); const uriUS=await toUris(edUS);
    log("ğŸ”— EUã®URIè§£æ±ºâ€¦"); const uriEU=await toUris(edEU);
    log("ğŸ”— WORLDã®URIè§£æ±ºâ€¦"); const uriWO=await toUris(edWO);

    log("ğŸš€ ä¸Šæ›¸ãé–‹å§‹â€¦ï¼ˆ429ã¯è‡ªå‹•å¾…æ©Ÿï¼‰");
    await replacePlaylist(pidUK, uriUK);
    await replacePlaylist(pidUS, uriUS);
    await replacePlaylist(pidEU, uriEU);
    await replacePlaylist(pidWO, uriWO);
    log("âœ… å®Œäº†");
  }catch(e){ log("ğŸ’¥ ERROR: "+e.message); console.error(e); }
}

/* ---------- events ---------- */
$("btnConnect").onclick = startAuth;
$("btnReset").onclick = ()=>{ Object.values(LS).forEach(k=>localStorage.removeItem(k)); setStatus(); log("ğŸ§½ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤"); };
$("btnCheck").onclick = async ()=>{ try{ await refreshTokenIfNeeded(); const me=await spFetch("/v1/me","GET"); $("status").textContent=`æ¥ç¶šä¸­ï¼ˆ${me.display_name||me.id}ï¼‰`; log("âœ… APIç¢ºèª OK"); }catch(e){ log("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+e.message); } };
$("fileSource").addEventListener("change", loadFiles);
$("fileAnalytics").addEventListener("change", loadFiles);
$("btnPreview").onclick = ()=>run(true);
$("btnRun").onclick = ()=>run(false);
setStatus();
log("Ready. 1) ã‚µã‚¤ãƒ³ã‚¤ãƒ³ â†’ 2) 2ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ 3) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§è¨ºæ–­ â†’ 4) ä¸Šæ›¸ãã€‚");
</script>
</body>
</html>
