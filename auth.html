<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder — Auto-Fill 4×130 / Non-Overlap / Balanced</title>
<style>
:root{--bg:#0b1220;--fg:#cfe3ff}
body{font-family:system-ui;max-width:1180px;margin:32px auto;padding:0 12px}
fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
label{display:block;margin:6px 0}
input[type="text"],input[type="number"],select{width:100%;max-width:760px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
input[type="file"]{margin:4px 0}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
button:disabled{opacity:.5;cursor:not-allowed}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
#log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:280px}
small.hint{color:#666}
#progWrap{position:relative;height:12px;background:#e6eaf2;border-radius:6px;overflow:hidden;margin:6px 0}
#progBar{height:100%;width:0%;background:#4a90e2;transition:width .2s ease}
#progLine{font-variant-numeric:tabular-nums;margin:4px 0 0 0;color:#333}
.hidden{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>TDCS Editions Builder — 自動補充で 4×130（相互非重複／バランス分配）</h1>
<p id="status">未接続</p>
<div>
  <button id="btnConnect">Spotifyにサインイン</button>
  <button id="btnReset">初期化（保存トークン削除）</button>
  <button id="btnCheck">接続チェック</button>
</div>

<fieldset>
  <legend>固定</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled></label>
    <label>REDIRECT_URI <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>設定（4リスト）</legend>
  <div class="grid2">
    <label>UK <input id="plUK" type="text" value="https://open.spotify.com/playlist/6wrsoYUr3IagrMW7zlwaIS"></label>
    <label>US <input id="plUS" type="text" value="https://open.spotify.com/playlist/6pv3J4odtKELYRIwoiZHhe"></label>
    <label>EU <input id="plEU" type="text" value="https://open.spotify.com/playlist/4VadrmkpMeXK813mkhWGwV"></label>
    <label>WORLD <input id="plWORLD" type="text" value="https://open.spotify.com/playlist/5y1UWtrBjYjHpReuAsnFMR"></label>
  </div>
  <div class="grid3">
    <label>API間隔(ms) <input id="gap" type="number" value="900"></label>
    <label>各エディション出力数 <input id="finalN" type="number" value="130"></label>
    <label>人気の重み（SaveRate側）<input id="wPopularity" type="number" step="0.01" value="0.55"></label>
  </div>
  <div class="grid3">
    <label>UKプリセット
      <select id="presetUK"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
    <label>USプリセット
      <select id="presetUS"><option selected>rise</option><option>waves</option><option>drop</option><option>dj</option></select>
    </label>
    <label>EUプリセット
      <select id="presetEU"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
  </div>
  <div class="grid3">
    <label>同リミキサー最小間隔（曲）<input id="gapRemixer" type="number" value="3"></label>
    <label>同アーティスト最小間隔（曲）<input id="gapArtist" type="number" value="4"></label>
    <label><input id="appendDate" type="checkbox" checked> 新規名に日付（YYYY-MM-DD）</label>
  </div>
  <div>
    <label><input id="doUpdate" type="checkbox" checked> 既存4リストを上書き</label>
    <label><input id="doCreate" type="checkbox"> 同内容で新規4リストも作成（公開）</label>
    <label>新規リスト名の接頭辞 <input id="newPrefix" type="text" value="TDCS Editions"></label>
  </div>
  <small class="hint">※4エディション間で相互に重複なし。同じ録音（URI/ISRC/ベース曲名＋先頭アーティストID）は1回のみ。</small>
</fieldset>

<fieldset>
  <legend>ファイル</legend>
  <label>ソースCSV（任意）<input id="fileSource" type="file" accept=".csv"></label>
  <label>分析（Excel .xlsx / CSV）<input id="fileAnalytics" type="file" accept=".xlsx,.csv"></label>
  <small class="hint">列は自動検出。Exact→Fuzzy→Spotify検索→（TDCSの）Top/新譜で自動補充。</small>
</fieldset>

<fieldset>
  <legend>進捗</legend>
  <div id="progWrap" class="hidden"><div id="progBar"></div></div>
  <div id="progLine">0% — 待機中</div>
</fieldset>

<fieldset>
  <legend>ログ</legend>
  <pre id="log">Booting…</pre>
</fieldset>

<div>
  <button id="btnExportXlsx" disabled>エクスポート（XLSX）</button>
  <button id="btnExportCsv"  disabled>エクスポート（CSV）</button>
</div>

<script>
(function(){
  /* ====== 初期化 ====== */
  var _pending=null;

  /* 基本 */
  var FORCED_ARTIST_IDS=["55fvQ5I2IZUfcFT2DV02T3"]; // TDCS 固定
  var CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
  var REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
  var SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
  var LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};

  function $(id){return document.getElementById(id);}
  function log(s){var el=$("log"); el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight;}
  function progress(p,msg){$("progWrap").classList.remove("hidden");$("progBar").style.width=Math.max(0,Math.min(100,p))+"%"; if(msg) $("progLine").textContent=Math.round(p)+"% — "+msg;}
  function subProgress(i,t,s,e,l){var f=t?i/t:0; progress(s+(e-s)*f,l+" ("+i+"/"+t+")");}
  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
  function num(x){var s=String(x==null?0:x).replace(/[ %,，]/g,""); var v=parseFloat(s); return isFinite(v)?v:0;}
  function round4(x){return (typeof x==="number"&&isFinite(x))?Math.round(x*10000)/10000:"";}
  function truthy(v){var s=String(v==null?"":v).trim().toLowerCase(); return ["1","true","yes","y","ok","✓","◎","◯","o","はい","有","可","true"].includes(s);}
  function NFKC(s){return String(s||"").normalize("NFKC");}
  function rmMarks(s){return NFKC(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
  function norm(s){return rmMarks(s).toLowerCase().replace(/[‐-‒–—−]/g,"-").replace(/[‘’‚‛“”„‟"]/g," ").replace(/[()［］\[\]{}【】]/g," ").replace(/&/g," and ").replace(/\s+/g," ").trim();}

  /* 起動時のエラー可視化 */
  window.onerror=function(m,src,lin,col,err){log("💥 ScriptError: "+m+" @"+lin+":"+col); console.error(err||m);};
  window.addEventListener("unhandledrejection",function(e){log("💥 PromiseRejection: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason))); console.error(e.reason);});

  log("🔧 JS起動OK");

  /* ====== Auth / API ====== */
  function isAuthed(){return !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0)-5000;}
  function setStatus(){ $("status").textContent=isAuthed()?"接続中（OK）":"未接続"; if(isAuthed() && _pending) resolveAndWrite(_pending); }
  async function startAuth(){
    var ver=""; var u8=new Uint8Array(64); crypto.getRandomValues(u8); for(var i=0;i<u8.length;i++) ver+=String.fromCharCode(97+(u8[i]%26));
    localStorage.setItem(LS.ver,ver);
    var hash=new Uint8Array(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(ver)));
    var b=""; for(var i=0;i<hash.length;i++) b+=String.fromCharCode(hash[i]);
    var ch=btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    var u=new URL("https://accounts.spotify.com/authorize");
    u.searchParams.set("response_type","code"); u.searchParams.set("client_id",CLIENT_ID);
    u.searchParams.set("redirect_uri",REDIRECT_URI);
    u.searchParams.set("code_challenge_method","S256"); u.searchParams.set("code_challenge",ch);
    u.searchParams.set("scope",SCOPES); location.href=u.toString();
  }
  async function refreshTokenIfNeeded(){
    var exp=+(localStorage.getItem(LS.exp)||0);
    if(Date.now()<exp-5000) return;
    var rt=localStorage.getItem(LS.ref); if(!rt) return;
    var body=new URLSearchParams(); body.set("grant_type","refresh_token"); body.set("refresh_token",rt); body.set("client_id",CLIENT_ID);
    var r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body});
    if(!r.ok){log("⚠️ refresh失敗 "+r.status);return;}
    var j=await r.json();
    localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
    if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
  }
  async function spFetch(path,method,body){
    if(!method)method="GET";
    await refreshTokenIfNeeded();
    var gap=+($("gap").value||900); await sleep(gap);
    for(var a=0;a<5;a++){
      var init={method:method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
      if(body) init.body=JSON.stringify(body);
      var r=await fetch("https://api.spotify.com"+path,init);
      if(r.status===401){await refreshTokenIfNeeded();continue;}
      if(r.status===429){var ra=+(r.headers.get("Retry-After")||2);log("⏳429→"+ra+"s待機");await sleep(ra*1000);continue;}
      if(!r.ok){var t=await r.text();throw new Error("Spotify "+r.status+": "+t.slice(0,200));}
      if(r.status===204) return null;
      return await r.json();
    }
    throw new Error("Spotify API max retries");
  }
  var _me=null; async function getMe(){ if(_me) return _me; _me=await spFetch("/v1/me","GET"); return _me; }

  /* ====== ファイル読込 ====== */
  var sourceRows=[], analyticsRows=[];
  function readCSV(file){return new Promise((res,rej)=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej}));}
  async function readXLSX_allSheets(file){
    var buf=await file.arrayBuffer(); var wb=XLSX.read(buf,{type:"array"}); var rows=[],details=[];
    for(var i=0;i<wb.SheetNames.length;i++){var n=wb.SheetNames[i]; var js=XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:""}); for(var k=0;k<js.length;k++) js[k].__sheet=n; rows=rows.concat(js); details.push(n+":"+js.length);}
    return {rows:rows,details:details};
  }
  async function loadFiles(){
    $("log").textContent=""; progress(3,"ファイル読み込み…");
    if($("fileSource").files.length){ sourceRows=await readCSV($("fileSource").files[0]); log("✅ ソース: "+sourceRows.length+" 行"); }
    var f=$("fileAnalytics").files[0];
    if((f.name||"").toLowerCase().indexOf(".xlsx")>=0){ var r=await readXLSX_allSheets(f); analyticsRows=r.rows; log("✅ 分析: XLSX 合計 "+analyticsRows.length+" 行 ["+r.details.join(", ")+"]"); }
    else{ analyticsRows=await readCSV(f); log("✅ 分析: CSV "+analyticsRows.length+" 行"); }
    progress(8,"読み込み完了"); await runAnalysis();
  }

  /* ====== 列検出・突合 ====== */
  var ISRC_RE=/^[A-Z]{2}-?[A-Z0-9]{3}-?\d{2}-?\d{5}$/i;
  function columns(rows){var s={},out=[];for(var i=0;i<Math.min(400,rows.length);i++){var r=rows[i];for(var k in r){if(!s[k]){s[k]=1;out.push(k);}}}return out;}
  function pickByName(cols,prefers,forbids){forbids=forbids||[];var bad=forbids.length?new RegExp(forbids.join("|"),"i"):null;var L=[];for(var i=0;i<cols.length;i++){var c=cols[i]; if(!bad||!bad.test(c)) L.push([c, norm(c)]);} for(var j=0;j<prefers.length;j++){var n=norm(prefers[j]);for(var k=0;k<L.length;k++){var hit=L[k]; if(hit[1]===n || hit[1].indexOf(n)>=0) return hit[0];}} return L.length?L[0]:"";}
  function bestColOrEmpty(cols, scorer, min){if(min==null)min=0.15;var best=null,bestSc=-1;for(var i=0;i<cols.length;i++){var c=cols[i], sc=scorer(c); if(sc>bestSc){bestSc=sc; best=c;}} return (bestSc>=min)?best:"";}
  function pickSourceColumns(rows){
    var cols=columns(rows);
    function scId(c){var m=0,n=0;for(var i=0;i<rows.length&&i<1200;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(/spotify:track:[A-Za-z0-9]{22}/.test(v)||/open\.spotify\.com\/track\/[A-Za-z0-9]{22}/.test(v)||/^[A-Za-z0-9]{22}$/.test(v))m++;} return n?m/n:0;}
    function scIsrc(c){var m=0,n=0;for(var i=0;i<rows.length&&i<2000;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(ISRC_RE.test(v))m++;} return n?m/n:0;}
    function scAid(c){var m=0,n=0;for(var i=0;i<rows.length&&i<1500;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(/spotify:artist:[A-Za-z0-9]{22}/.test(v)||/open\.spotify\.com\/artist\/[A-Za-z0-9]{22}/.test(v)||/\b([A-Za-z0-9]{22})\b/.test(v))m++;} return n?m/n:0;}
    return {
      idCol:bestColOrEmpty(cols,scId,0.20),
      isrcCol:bestColOrEmpty(cols,scIsrc,0.20),
      artistIdCol:bestColOrEmpty(cols,scAid,0.20),
      nameCol:pickByName(cols,["track title","track_name","title","曲名","タイトル"]),
      verCol: pickByName(cols,["track version","version","バージョン"]),
      artistCol:pickByName(cols,["track primary artists","primary artists","artists","artist","アーティスト"]),
      remixCol: pickByName(cols,["remixer","remixers","リミキサー"])
    };
  }
  function pickAnalyticColumns(rows){
    var cols=columns(rows);
    function scId(c){var m=0,n=0;for(var i=0;i<rows.length&&i<1200;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(/spotify:track:[A-Za-z0-9]{22}/.test(v)||/open\.spotify\.com\/track\/[A-Za-z0-9]{22}/.test(v)||/^[A-Za-z0-9]{22}$/.test(v))m++;} return n?m/n:0;}
    function scIsrc(c){var m=0,n=0;for(var i=0;i<rows.length&&i<2000;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(ISRC_RE.test(v))m++;} return n?m/n:0;}
    var idCol=bestColOrEmpty(cols,scId,0.20)||pickByName(cols,["spotify_uri","track_uri","uri","url"]);
    var isrcCol=bestColOrEmpty(cols,scIsrc,0.20)||pickByName(cols,["isrc","isrc_code"]);
    function pickText(pref){var cand=[];for(var i=0;i<cols.length;i++){if(/title|name|曲名|artist|アーティスト/i.test(cols[i])) cand.push(cols[i]);}
      return cand[0]||pickByName(cols,pref)||cols[0]||"";}
    return { idCol:idCol,isrcCol:isrcCol,nameCol:pickText(["title","track_name","曲名"]),artistCol:pickText(["artist","artists","アーティスト"]),
      p24:pickByName(cols,["plays_24h","p24","streams24","24h"]), p7:pickByName(cols,["plays_7d","p7","streams7","7d"]), p28:pickByName(cols,["plays_28d","p28","streams28","28d"]),
      s24:pickByName(cols,["save_rate_24h","sr24","save24"]), s7:pickByName(cols,["save_rate_7d","sr7","save7"]), s28:pickByName(cols,["save_rate_28d","sr28","save28"]),
      uk:pickByName(cols,["uk","available_uk","英国"]), us:pickByName(cols,["us","available_us","米国","アメリカ"]), eu:pickByName(cols,["eu","available_eu","欧州","ヨーロッパ"]), wo:pickByName(cols,["world","available_world","global","全世界"]) };
  }

  /* ====== テキスト・バージョン正規化 & ファジー ====== */
  var STOP=(function(){var a=["feat","featuring","ft","vs","and","&","the","a","an","mix","remix","edit","version","vip","dub","club","radio","extended","original","instrumental","clean","dirty"];var s={};for(var i=0;i<a.length;i++)s[a[i]]=1;return s;})();
  function tokensTitle(s){s=norm(s).replace(/ - /g," ").replace(/\((.*?)\)/g," $1 ").replace(/\[(.*?)\]/g," $1 ");var arr=s.split(" ");var set={},out=[];for(var i=0;i<arr.length;i++){var w=arr[i];if(w && !STOP[w]){if(!set[w]){set[w]=1;out.push(w);}}}return out;}
  function setJaccard(A,B){var inter=0,sa={},sb={};for(var i=0;i<A.length;i++)sa[A[i]]=1;for(var j=0;j<B.length;j++){var x=B[j];sb[x]=1;if(sa[x])inter++;}var ua=Object.keys(sa).length+Object.keys(sb).length-inter;return ua?inter/ua:0;}
  function canonVersion(s){
    s=norm(s);
    var pairs=[["original mix","original"],["orig mix","original"],["radio edit","radio"],["extended mix","extended"],["club mix","club"]];
    for(var i=0;i<pairs.length;i++) s=s.replace(pairs[i][0],pairs[i][1]);
    var kinds=[],kSeen={}; function add(k){if(k&&!kSeen[k]){kinds.push(k);kSeen[k]=1;}}
    if(/original/.test(s))add("original"); if(/radio/.test(s))add("radio"); if(/extended/.test(s))add("extended");
    if(/instrumental/.test(s))add("instrumental"); if(/acoustic/.test(s))add("acoustic"); if(/vip/.test(s))add("vip");
    if(/dub/.test(s))add("dub"); if(/club/.test(s))add("club"); if(/remix|rmx/.test(s))add("remix");
    var rem=s.replace(/\b(original|radio|extended|instrumental|acoustic|vip|dub|club|remix|mix|edit)\b/g," ").trim();
    return {kinds:kinds, remTok:tokensTitle(rem)};
  }

  /* ====== 抽出ユーティリティ ====== */
  function extractTrackId(raw){var s=String(raw||"").trim();if(!s)return"";var m=s.match(/spotify:track:([A-Za-z0-9]{22})/);if(m)return m[1];m=s.match(/open\.spotify\.com\/track\/([A-Za-z0-9]{22})/);if(m)return m[1];m=s.match(/\/track\/([A-Za-z0-9]{22})(?:\?|$)/);if(m)return m[1];m=s.match(/^([A-Za-z0-9]{22})$/);if(m)return m[1];return"";}
  function extractArtistIds(raw){
    if(raw==null) return [];
    var s=String(raw); var parts=s.split(/[,;\/|]+|\s{2,}/g); var ids=[], has={};
    function push(id){ if(id && !has[id]){ids.push(id);has[id]=1;} }
    for(var i=0;i<parts.length;i++){
      var p=parts[i].trim(); if(!p)continue;
      var m=p.match(/spotify:artist:([A-Za-z0-9]{22})/); if(m){push(m[1]); continue;}
      m=p.match(/open\.spotify\.com\/artist\/([A-Za-z0-9]{22})/); if(m){push(m[1]); continue;}
      m=p.match(/\b([A-Za-z0-9]{22})\b/); if(m){push(m[1]); continue;}
    }
    return ids;
  }

  /* ====== ソース索引・突合 ====== */
  function buildSourceIndex(cfg){
    if(!sourceRows.length) return {idxExact:new Map(),blob:[]};
    var idxExact=new Map(), blob=[], hasAid=0;
    for(var i=0;i<sourceRows.length;i++){
      var r=sourceRows[i];
      var id=cfg.idCol?extractTrackId(r[cfg.idCol]):"";
      var isrc=cfg.isrcCol?String(r[cfg.isrcCol]||"").trim().toUpperCase():"";
      var t=String(cfg.nameCol? r[cfg.nameCol] : "").trim(), v=String(cfg.verCol? r[cfg.verCol] : "").trim();
      var disp=(!v||/original\s*mix/i.test(v))?t:(t+" - "+v);
      var ttok=tokensTitle(disp);
      var vinfo=canonVersion(v+" "+String(cfg.remixCol? r[cfg.remixCol] : "" ));
      var aids=cfg.artistIdCol?extractArtistIds(r[cfg.artistIdCol]):[];
      if(aids.length) hasAid++;
      if(id) idxExact.set("ID:"+id,r);
      if(isrc) idxExact.set("ISRC:"+isrc,r);
      if(disp) idxExact.set("NM:"+norm(disp),r);
      blob.push({r:r,disp:disp,ttok:ttok,vinfo:vinfo,artistIds:aids});
    }
    log("🎯 アーティストID付き行: "+hasAid+" / "+sourceRows.length);
    return {idxExact:idxExact, blob:blob};
  }
  function parseAnalysisTitle(a,anCfg){
    var name=String(a[anCfg.nameCol]||"");
    var art =String(anCfg.artistCol? (a[anCfg.artistCol]||"") : "");
    return {disp:name+" "+art, ttok:tokensTitle(name+" "+art), vinfo:canonVersion(name)};
  }
  function fuzzyBest(sourceBlob,an){
    var best=null, tw=an.vinfo.kinds.length?0.75:0.85, vw=1-tw;
    for(var i=0;i<sourceBlob.length;i++){
      var s=sourceBlob[i];
      var ts=setJaccard(an.ttok,s.ttok);
      var vk=setJaccard(an.vinfo.kinds,s.vinfo.kinds);
      var vr=setJaccard(an.vinfo.remTok,s.vinfo.remTok);
      var ver=0.6*vk+0.4*vr;
      var sc=tw*ts+vw*ver;
      if(!best || sc>best.sc) best={s:s,sc:sc};
    }
    return best;
  }
  function autoMatch(srcIdx,anCfg,onTick){
    var idA=anCfg.idCol, isrcA=anCfg.isrcCol;
    var thr=0.86, minFrac=0.5, rows=[], diag=null;
    for(;thr>=0.72;thr-=0.02){
      rows=[]; diag={exact:0,fuzzy:0,none:0};
      var total=analyticsRows.length;
      for(var j=0;j<analyticsRows.length;j++){
        var a=analyticsRows[j]; if(onTick&&((j+1)%20===0||j+1===total)) onTick(j+1,total);
        var id=idA?extractTrackId(a[idA]):"";
        var isc=isrcA?String(a[isrcA]||"").trim().toUpperCase():"";
        var an=parseAnalysisTitle(a,anCfg);
        var pick=null, mode="exact", score=1;
        if(id && srcIdx.idxExact.has("ID:"+id)) pick=srcIdx.idxExact.get("ID:"+id);
        else if(isc && srcIdx.idxExact.has("ISRC:"+isc)) pick=srcIdx.idxExact.get("ISRC:"+isc);
        else if(srcIdx.idxExact.has("NM:"+norm(an.disp))) pick=srcIdx.idxExact.get("NM:"+norm(an.disp));
        if(!pick){
          var b=fuzzyBest(srcIdx.blob,an);
          if(b && b.sc>=thr){ pick=b.s.r; mode="fuzzy"; score=b.sc; }
        }
        if(pick) rows.push({a:a,s:pick,_mode:mode,_score:score}); else diag.none++;
        if(pick && mode==="exact") diag.exact++; else if(pick) diag.fuzzy++;
      }
      if(rows.length/Math.max(1,total)>=minFrac) break;
    }
    return {rows:rows,thr:thr,diag:diag};
  }

  /* ====== スコアリング ====== */
  function buildItemFromMatch(m,srcCols,anCols){
    var t  = String(srcCols.nameCol? m.s[srcCols.nameCol] : "").trim() || String(m.a[anCols.nameCol]||"").trim();
    var v  = String(srcCols.verCol?  m.s[srcCols.verCol]  : "").trim();
    return {
      id: srcCols.idCol?extractTrackId(m.s[srcCols.idCol]):"",
      isrc: srcCols.isrcCol?String(m.s[srcCols.isrcCol]||"").toUpperCase():"",
      name: (!v||/original\s*mix/i.test(v))?t:(t+" - "+v),
      artist: String(srcCols.artistCol? m.s[srcCols.artistCol] : (m.a[anCols.artistCol]||"")),
      remixer: String(srcCols.remixCol? m.s[srcCols.remixCol] : ""),
      artistIds: FORCED_ARTIST_IDS.slice(0), // ★TDCS固定
      flags:{ uk:anCols.uk?truthy(m.a[anCols.uk]):false, us:anCols.us?truthy(m.a[anCols.us]):false, eu:anCols.eu?truthy(m.a[anCols.eu]):false, wo:anCols.wo?truthy(m.a[anCols.wo]):false },
      score:m.score, _mode:m._mode, _score:m._score, a:m.a, s:m.s
    };
  }
  function computeScores(rows,anCfg){
    var p24=anCfg.p24,p7=anCfg.p7,p28=anCfg.p28,s24=anCfg.s24,s7=anCfg.s7,s28=anCfg.s28;
    var max24=0,max7=0,max28=0; for(var i=0;i<rows.length;i++){max24=Math.max(max24,num(rows[i].a[p24]));max7=Math.max(max7,num(rows[i].a[p7]));max28=Math.max(max28,num(rows[i].a[p28]));}
    for(var j=0;j<rows.length;j++){
      var r=rows[j]; var sr24=num(r.a[s24])/100, sr7=num(r.a[s7])/100, sr28=num(r.a[s28])/100;
      var pl24=max24?num(r.a[p24])/max24:0, pl7=max7?num(r.a[p7])/max7:0, pl28=max28?num(r.a[p28])/max28:0;
      var w=[0.5,0.3,0.2], wp=+($("wPopularity").value||0.55);
      r.score = wp*(w[0]*sr24+w[1]*sr7+w[2]*sr28) + (1-wp)*(w[0]*pl24+w[1]*pl7+w[2]*pl28);
    }
    rows.sort((a,b)=>(b.score||0)-(a.score||0)); return rows;
  }
  function buildItemsFromAnalyticsOnly(anCols){
    var out=[];
    for(var i=0;i<analyticsRows.length;i++){
      var a=analyticsRows[i], name=String(a[anCols.nameCol]||"").trim(); if(!name) continue;
      out.push({id:extractTrackId(a[anCols.idCol]), isrc:String(a[anCols.isrcCol]||"").toUpperCase(),
        name:name, artist:String(a[anCols.artistCol]||"").trim(), remixer:"", artistIds:FORCED_ARTIST_IDS.slice(0),
        flags:{wo:true,uk:false,us:false,eu:false}, score:0.0001, _mode:"fallback", _score:1, a:a, s:null});
    }
    return out;
  }

  /* ====== 候補プール拡張（TDCSのみ） ====== */
  function keyOf(it){var title=String(it.name||"");var artist=String(it.artist||"");var v=canonVersion(title);var base=(title.split(/\s+-\s+/)[0]||title);return norm(base+"|"+v.kinds.sort().join("+")+"|"+artist);}
  function dedupeByMeta(list){
    var seen={}, seenId={}, seenIsrc={}, out=[], dropId=0,dropIsrc=0,dropKey=0;
    for(var i=0;i<list.length;i++){
      var it=list[i];
      if(it.id && seenId[it.id]){dropId++;continue;}
      if(it.isrc && seenIsrc[it.isrc]){dropIsrc++;continue;}
      var k=keyOf(it); if(seen[k]){dropKey++;continue;}
      out.push(it); if(it.id)seenId[it.id]=1; if(it.isrc)seenIsrc[it.isrc]=1; seen[k]=1;
    }
    log("🧹 重複除去（候補）: 入"+list.length+"→残"+out.length+" [ID:"+dropId+",ISRC:"+dropIsrc+",Key:"+dropKey+"]");
    return out;
  }
  async function gatherArtistIds(){ return FORCED_ARTIST_IDS.slice(0); } // ★固定
  async function fetchTopTracksByArtist(aid,market){
    var r=await spFetch("/v1/artists/"+aid+"/top-tracks?market="+market,"GET");
    return (r&&r.tracks)||[];
  }
  async function fetchArtistAlbums(aid,market){
    var out=[], groups=["single","appears_on","album"];
    for(var g=0;g<groups.length;g++){
      var r=await spFetch("/v1/artists/"+aid+"/albums?include_groups="+groups[g]+"&limit=20&market="+market,"GET");
      if(r&&r.items) out=out.concat(r.items);
    }
    return out;
  }
  async function fetchAlbumTracks(albumId,market){
    var r=await spFetch("/v1/albums/"+albumId+"?market="+market,"GET");
    return (r&&r.tracks&&r.tracks.items)||[];
  }
  function itemFromTrackObj(t,aid){
    return { id:t.id||"", isrc:"", name:t.name||"", artist:(t.artists&&t.artists[0]&&t.artists[0].name)||"", remixer:"", artistIds:aid?[aid]:[], flags:{wo:true}, score:0.0001, _mode:"seed" };
  }
  async function buildExtraFromArtists(artistIds,label){
    var mkts=["JP","US","GB","DE","SE"], out=[];
    for(var m=0;m<mkts.length;m++){
      for(var a=0;a<artistIds.length;a++){
        try{
          var ts=await fetchTopTracksByArtist(artistIds[a],mkts[m]);
          for(var i=0;i<ts.length;i++) out.push(itemFromTrackObj(ts[i],artistIds[a]));
          var al=await fetchArtistAlbums(artistIds[a],mkts[m]);
          for(var j=0;j<Math.min(6,al.length);j++){
            var tr=await fetchAlbumTracks(al[j].id,mkts[m]);
            for(var k=0;k<Math.min(6,tr.length);k++) out.push(itemFromTrackObj(tr[k],artistIds[a]));
          }
        }catch(e){}
      }
    }
    log("➕ 補充("+label+"): +"+out.length);
    return out;
  }
  async function buildCandidatePoolV2(primaryItems, srcCols, anCols, finalN){
    var pool=dedupeByMeta(primaryItems);
    var target=Math.max(finalN*4+200, finalN*5);
    log("📦 候補プール開始: "+pool.length+" / 目標 "+target);

    if(pool.length < target){
      var extraA=buildItemsFromAnalyticsOnly(anCols).sort((a,b)=>(b.score||0)-(a.score||0));
      pool=dedupeByMeta(pool.concat(extraA)); log("➕ 補充(analytics only): "+pool.length);
    }
    if(pool.length < target){
      var artistIds=await gatherArtistIds(); // ★["55fv..."]のみ
      log("🧲 収集ArtistID: "+artistIds.length);
      var extraB=await buildExtraFromArtists(artistIds,"top+new");
      pool=dedupeByMeta(pool.concat(extraB)); log("➕ 補充(top/new): "+pool.length);
    }
    return pool.slice(0,target);
  }

  /* ====== URI解決（必ずTDCSを含む候補のみ採用） ====== */
  function isrcVariants(s){s=String(s||"").trim();if(!s)return[];var up=s.toUpperCase();var no=up.replace(/-/g,"");var hy=up.indexOf("-")>=0?up:up.replace(/^(.{2})(.{3})(.{2})(.{5})$/,"$1-$2-$3-$4");var set={},arr=[];[up,no,hy].forEach(v=>{if(!set[v]){set[v]=1;arr.push(v);}});return arr;}
  function topArtistName(a){var s=String(a||"");var m=s.split(/,|;|&| with | feat\.? | featuring | ft\.? /i);return (m[0]||"").trim();}
  function makeQueries(it){
    var q=[], full=String(it.name||"").trim(), base=(full.split(/\s+-\s+/)[0]||full), art=topArtistName(it.artist||"");
    if(it.isrc){var vars=isrcVariants(it.isrc); for(var i=0;i<vars.length;i++) q.push({q:"isrc:"+vars[i],type:"isrc"});}
    if(art){ q.push({q:'track:"'+base+'" artist:"'+art+'"',type:"field"}); if(full!==base) q.push({q:'track:"'+full+'" artist:"'+art+'"',type:"field"}); }
    q.push({q:'"'+base+'" '+(art||"").trim(),type:"free"}); if(full!==base) q.push({q:'"'+full+'" '+(art||"").trim(),type:"free"});
    var seen={}, out=[]; for(var k=0;k<q.length;k++){var qq=q[k].q; if(!seen[qq]){seen[qq]=1; out.push(q[k]);}} return out;
  }
  async function searchOnce(q,m){
    var r=await spFetch("/v1/search?q="+encodeURIComponent(q)+"&type=track&limit=10&market="+m,"GET");
    return (r&&r.tracks&&r.tracks.items)?r.tracks.items:[];
  }
  function scoreCandidate(item,cand){
    var ct=cand.name+(cand.version?(" - "+cand.version):"");
    var t1=setJaccard(tokensTitle(item.name),tokensTitle(ct));
    var t2=setJaccard(tokensTitle((item.name.split(/\s+-\s+/)[0]||item.name)),tokensTitle(ct));
    var title=Math.max(t1,t2);
    var vi=canonVersion(item.name), vc=canonVersion(ct);
    var ver=0.6*setJaccard(vi.kinds,vc.kinds)+0.4*setJaccard(vi.remTok,vc.remTok);
    return 0.80*title+0.20*ver;
  }
  async function resolveUriOneStrict(it){
    if(it.id && it.id.length===22) return "spotify:track:"+it.id;

    // ★TDCSを必ず含むものに限定
    var aids=FORCED_ARTIST_IDS, must=true;
    var mkts=["from_token","JP","US","GB","DE","SE"];

    if(it.isrc){
      var vars=isrcVariants(it.isrc);
      for(var vi=0;vi<vars.length;vi++){
        try{
          var r=await spFetch("/v1/search?q="+encodeURIComponent("isrc:"+vars[vi])+"&type=track&limit=5&market="+mkts[0],"GET");
          var items=(r&&r.tracks&&r.tracks.items)?r.tracks.items:[]; var cand=null;
          for(var ci=0;ci<items.length;ci++){
            var t=items[ci], ok=!must;
            if(!ok && t && t.artists){ for(var aa=0;aa<t.artists.length;aa++){ if(aids.indexOf(t.artists[aa].id)>=0){ok=true;break;} } }
            if(ok){cand=t; break;}
          }
          if(cand&&cand.id) return "spotify:track:"+cand.id;
        }catch(e){}
      }
    }
    var qs=makeQueries(it), best=null;
    for(var qi=0;qi<qs.length;qi++){
      var q=qs[qi];
      for(var mi=0;mi<mkts.length;mi++){
        var items=[]; try{items=await searchOnce(q.q,mkts[mi]);}catch(e){}
        var filtered=[]; for(var fi=0;fi<items.length;fi++){
          var t2=items[fi], ok2=!must;
          if(!ok2 && t2&&t2.artists){for(var a2=0;a2<t2.artists.length;a2++){if(aids.indexOf(t2.artists[a2].id)>=0){ok2=true;break;}}}
          if(ok2) filtered.push(t2);
        }
        for(var c=0;c<filtered.length;c++){
          var sc=(q.type==="isrc")?1.0:scoreCandidate(it,filtered[c]);
          if(!best||sc>best.sc) best={sc:sc,cand:filtered[c]};
        }
        if(best && best.sc>=0.80) break;
      }
      if(best && best.sc>=0.80) break;
    }
    if(best && best.cand && best.cand.id && best.sc>=0.62) return "spotify:track:"+best.cand.id;
    return "";
  }
  async function toUrisResolved(items,onTick){
    var aligned=new Array(items.length), ok=0, total=items.length;
    for(var i=0;i<items.length;i++){
      var u=await resolveUriOneStrict(items[i]); if(u){aligned[i]=u; ok++;}
      if(onTick) onTick(i+1,total,ok);
    }
    log("🔗 URI解決: "+ok+"/"+total);
    return {aligned:aligned};
  }

  /* ====== 曲詳細・重複排除 ====== */
  async function fetchTrackDetailsByUris(uris){
    var ids=[], map=new Map();
    for(var i=0;i<uris.length;i++){var u=uris[i]; if(u) ids.push(u.replace("spotify:track:",""));}
    for(var k=0;k<ids.length;k+=50){
      var slice=ids.slice(k,k+50); if(!slice.length) continue;
      var r=await spFetch("/v1/tracks?ids="+slice.join(","),"GET");
      var arr=(r&&r.tracks)?r.tracks:[];
      for(var j=0;j<arr.length;j++){var t=arr[j]; if(t&&t.id) map.set("spotify:track:"+t.id,t);}
    }
    return map;
  }
  function baseTitle(s){s=String(s||""); var m=s.split(/\s+-\s+/); return (m[0]||"").trim();}
  function dedupeByRecording(items,alignedUris,tracksMap){
    var seenUri={}, seenIsrc={}, seenBase={}, outItems=[], outUris=[];
    var dropU=0,dropI=0,dropB=0;
    for(var i=0;i<alignedUris.length;i++){
      var u=alignedUris[i]; if(!u) continue;
      if(seenUri[u]){dropU++; continue;}
      var tr=tracksMap.get(u);
      var isrc=(tr&&tr.external_ids&&tr.external_ids.isrc)?String(tr.external_ids.isrc).toUpperCase():"";
      if(isrc && seenIsrc[isrc]){dropI++; continue;}
      var base = tr ? (norm(baseTitle(tr.name))+"｜"+((tr.artists&&tr.artists[0]&&tr.artists[0].id)||""))
                    : (norm(baseTitle(items[i]&&items[i].name))+"｜"+norm(String(items[i]&&items[i].artist||"").split(/[,;&]/)[0]||""));
      if(seenBase[base]){dropB++; continue;}
      seenUri[u]=1; if(isrc) seenIsrc[isrc]=1; seenBase[base]=1;
      outItems.push(items[i]); outUris.push(u);
    }
    log("🧽 レコーディング重複除去: -URI:"+dropU+" -ISRC:"+dropI+" -Base:"+dropB);
    return {items:outItems, uris:outUris};
  }

  /* ====== 特徴量・並べ替え ====== */
  async function fetchAudioFeaturesByUris(uris){
    var ids=[], feats=new Map();
    for(var i=0;i<uris.length;i++){var u=uris[i]; if(u) ids.push(u.replace("spotify:track:",""));}
    for(var k=0;k<ids.length;k+=100){
      var slice=ids.slice(k,k+100); if(!slice.length) continue;
      var r=await spFetch("/v1/audio-features?ids="+slice.join(","),"GET");
      var arr=(r&&r.audio_features)?r.audio_features:[];
      for(var j=0;j<arr.length;j++){var f=arr[j]; if(f&&f.id) feats.set("spotify:track:"+f.id,f);}
    }
    return feats;
  }
  function camelot(key,mode){var map=[8,3,10,5,0,7,2,9,4,11,6,1];return{num:map[(key||0)%12],isMinor:mode===0};}
  function keyDistance(a,b){ if(!a||!b||a.key==null||b.key==null) return 2;
    var A=camelot(a.key,a.mode), B=camelot(b.key,b.mode); var d=Math.abs(A.num-B.num); d=Math.min(d,12-d); var pen=d/6; if(A.isMinor!==B.isMinor) pen+=0.4; return pen;}
  function nextCost(a,b,preset){
    var dTempo=(a&&b&&a.tempo&&b.tempo)?Math.min(1,Math.abs(a.tempo-b.tempo)/16):0.5;
    var dKey=keyDistance(a,b); var dEner=(a&&b)?Math.abs((a.energy||0)-(b.energy||0)):0.5;
    var dVal=(a&&b)?Math.abs((a.valence||0)-(b.valence||0)):0.5;
    if(preset==="dj")   return 0.45*dTempo+0.35*dKey+0.15*dEner+0.05*dVal;
    if(preset==="rise") return 0.35*dTempo+0.20*dKey+0.35*dEner+0.10*dVal;
    if(preset==="drop") return 0.35*dTempo+0.20*dKey+0.35*dEner+0.10*dVal;
    return               0.40*dTempo+0.25*dKey+0.25*dEner+0.10*dVal;
  }
  function orderFlow(items,featMap,preset,gapA,gapR,seed){
    function lcg(s){var x=0;for(var i=0;i<s.length;i++)x=(x*131+s.charCodeAt(i))>>>0; return function(){x=(1103515245*x+12345)>>>0; return (x/0xFFFFFFFF);};}
    var rnd=lcg(seed||"ed");
    var pool=items.slice(0).sort((a,b)=>(b.score||0)-(a.score||0));
    var skip=Math.min(3,Math.floor(rnd()*5)); if(pool.length>skip) pool=pool.slice(skip).concat(pool.slice(0,skip));
    var seq=[pool.shift()];
    var lastSeen={remixer:{},artist:{}};
    function mark(it,i){lastSeen.remixer[String(it.remixer||"").toLowerCase()]=i; lastSeen.artist[String(it.artist||"").toLowerCase()]=i;}
    mark(seq[0],0);
    while(pool.length){
      var prev=seq[seq.length-1], bestIdx=0, best=1e9;
      for(var i=0;i<Math.min(50,pool.length);i++){
        var cand=pool[i], fa=featMap.get(cand.uri)||{}, fb=featMap.get(prev.uri)||{};
        var cost=nextCost(fb,fa,preset);
        var rm=String(cand.remixer||"").toLowerCase(), ar=String(cand.artist||"").toLowerCase();
        var iR=(lastSeen.remixer[rm]!=null?lastSeen.remixer[rm]:-999), iA=(lastSeen.artist[ar]!=null?lastSeen.artist[ar]:-999);
        var idx=seq.length;
        if(idx-iR < (gapR||3)) cost+=0.8;
        if(idx-iA < (gapA||4)) cost+=0.6;
        cost*=1+(i*0.002);
        if(cost<best){best=cost; bestIdx=i;}
      }
      var pick=pool.splice(bestIdx,1)[0]; seq.push(pick); mark(pick,seq.length-1);
    }
    return seq;
  }

  /* ====== 分配（4×130、相互非重複） ====== */
  function edCfg(){ return [
    {name:"UK",    pref:"uk", fallback:["wo","us","eu"], preset:($("presetUK").value||"waves"), gapA:+($("gapArtist").value||4), gapR:+($("gapRemixer").value||3), seed:"UK"},
    {name:"US",    pref:"us", fallback:["wo","uk","eu"], preset:($("presetUS").value||"rise"),  gapA:+($("gapArtist").value||4), gapR:+($("gapRemixer").value||3), seed:"US"},
    {name:"EU",    pref:"eu", fallback:["wo","uk","us"], preset:($("presetEU").value||"waves"), gapA:+($("gapArtist").value||4), gapR:+($("gapRemixer").value||3), seed:"EU"},
    {name:"WORLD", pref:"wo", fallback:["uk","us","eu"], preset:"dj",                             gapA:+($("gapArtist").value||4), gapR:+($("gapRemixer").value||3), seed:"WORLD"}
  ]; }
  function edScoreBias(item,feat,edName){
    var base=item.score||0, e=(feat&&feat.energy)||0, v=(feat&&feat.valence)||0;
    if(edName==="US")   return base + 0.10*e + 0.03*v;
    if(edName==="UK")   return base + 0.06*e + 0.05*v;
    if(edName==="EU")   return base + 0.02*e + 0.08*(1-Math.abs(v-0.5));
    if(edName==="WORLD")return base + 0.05*(1-Math.abs(e-0.6));
    return base;
  }
  function buildEditionSetsRoundRobin(candidates, feats, finalN){
    var used=new Set(), packs={UK:[],US:[],EU:[],WORLD:[]};
    var cfgs=edCfg();

    function poolFor(ed){
      var pref=candidates.filter(x=>!used.has(x.uri) && x.flags && x.flags[ed.pref]);
      var fb=candidates.filter(x=>{
        if(used.has(x.uri) || !(x.flags)) return false;
        for(var i=0;i<ed.fallback.length;i++) if(x.flags[ed.fallback[i]]) return true;
        return false;
      });
      var rest=candidates.filter(x=>!used.has(x.uri) && (!x.flags || (!x.flags.uk&&!x.flags.us&&!x.flags.eu&&!x.flags.wo)));
      var pool=pref.concat(fb).concat(rest);
      pool.sort((a,b)=> (edScoreBias(b,feats.get(b.uri)||{},ed.name))-(edScoreBias(a,feats.get(a.uri)||{},ed.name)));
      return pool;
    }

    var queues={}; cfgs.forEach(ed=>queues[ed.name]=poolFor(ed));
    var filled={UK:0,US:0,EU:0,WORLD:0}, done=0, guard=0;
    while(done<4 && guard<20000){
      guard++;
      for(var c=0;c<cfgs.length;c++){
        var ed=cfgs[c];
        if(filled[ed.name] >= finalN) continue;
        var q=queues[ed.name];
        var pick=null;
        for(var i=0;i<q.length;i++){ if(!used.has(q[i].uri)){ pick=q.splice(i,1)[0]; break; } }
        if(!pick){
          queues[ed.name]=poolFor(ed); q=queues[ed.name];
          for(var i2=0;i2<q.length;i2++){ if(!used.has(q[i2].uri)){ pick=q.splice(i2,1)[0]; break; } }
        }
        if(pick){ packs[ed.name].push(pick); used.add(pick.uri); filled[ed.name]++; }
      }
      done = (filled.UK>=finalN) + (filled.US>=finalN) + (filled.EU>=finalN) + (filled.WORLD>=finalN);
      if(Object.values(filled).reduce((a,b)=>a+b,0) >= finalN*4) break;
      if(queues.UK.length+queues.US.length+queues.EU.length+queues.WORLD.length===0) break;
    }
    log("⚖️ 分配: UK="+packs.UK.length+", US="+packs.US.length+", EU="+packs.EU.length+", WORLD="+packs.WORLD.length);
    return packs;
  }

  /* ====== 書き込み & エクスポート ====== */
  function extractPlaylistId(s){s=String(s||"");var m=s.match(/playlist\/([A-Za-z0-9]{22})/);if(m)return m[1];m=s.match(/^([A-Za-z0-9]{22})$/);if(m)return m[1];return"";}
  async function replacePlaylist(pid,uris){
    var chunks=[]; for(var i=0;i<uris.length;i+=100) chunks.push(uris.slice(i,i+100));
    if(!chunks.length) chunks.push([]);
    await spFetch("/v1/playlists/"+pid+"/tracks","PUT",{uris:chunks[0]}); log("🧹 置換: "+chunks[0].length+"件");
    for(var k=1;k<chunks.length;k++){ await spFetch("/v1/playlists/"+pid+"/tracks","POST",{uris:chunks[k]}); log("➕ 追加: "+chunks[k].length+"件"); }
  }
  async function createPlaylistAndFill(name,desc,isPublic,uris){
    var me=await getMe();
    var pl=await spFetch("/v1/users/"+encodeURIComponent(me.id)+"/playlists","POST",{name:name,description:desc,public:true});
    var pid=(pl&&pl.id)?pl.id:""; await replacePlaylist(pid,uris); return pid;
  }

  var _exportData=null; function enableExportButtons(on){$("btnExportXlsx").disabled=!on; $("btnExportCsv").disabled=!on;}
  function exportXlsx(){
    if(!_exportData){log("ℹ️ データなし");return;}
    var wb=XLSX.utils.book_new();
    function addSheet(name,key){
      var ws=XLSX.utils.json_to_sheet(_exportData[key],{header:["position","edition","title","artist","remixer","isrc","source_id","source_sheet","match_mode","match_score","spotify_uri","score","tempo","energy","valence","key","mode"]});
      XLSX.utils.book_append_sheet(wb,ws,name);
    }
    addSheet("UK","uk"); addSheet("US","us"); addSheet("EU","eu"); addSheet("WORLD","wo");
    XLSX.writeFile(wb,"editions_"+new Date().toISOString().slice(0,10)+".xlsx");
  }
  function exportCsv(){
    if(!_exportData){log("ℹ️ データなし");return;}
    var all=[].concat(_exportData.uk,_exportData.us,_exportData.eu,_exportData.wo);
    var H=["position","edition","title","artist","remixer","isrc","source_id","source_sheet","match_mode","match_score","spotify_uri","score","tempo","energy","valence","key","mode"];
    function esc(v){return '"'+String(v==null?"":v).replace(/"/g,'""')+'"';}
    var csv=[H.join(",")];
    for(var i=0;i<all.length;i++){var r=all[i]; var row=[]; for(var h=0;h<H.length;h++) row.push(esc(r[H[h]])); csv.push(row.join(","));}
    var blob=new Blob([csv.join("\r\n")],{type:"text/csv;charset=utf-8"});
    var a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="editions_"+new Date().toISOString().slice(0,10)+".csv"; document.body.appendChild(a); a.click(); a.remove();
  }

  /* ====== メイン実行 ====== */
  async function runAnalysis(){
    try{
      progress(10,"列検出…");
      var srcCols=sourceRows.length?pickSourceColumns(sourceRows):{idCol:"",isrcCol:"",artistIdCol:"",nameCol:"",verCol:"",artistCol:"",remixCol:""};
      var srcIdx=buildSourceIndex(srcCols);
      var anCols=pickAnalyticColumns(analyticsRows);

      progress(28,"突合（Exact→Fuzzy）…");
      var match=autoMatch(srcIdx,anCols,(i,t)=>subProgress(i,t,28,50,"突合中"));
      log("🔎 診断: exact="+match.diag.exact+", fuzzy="+match.diag.fuzzy+", 未一致="+match.diag.none+", 採用="+match.rows.length+"/"+analyticsRows.length+", しきい値="+match.thr.toFixed(2));

      progress(51,"候補整形→スコア…");
      var items=[];
      if(match.rows.length){
        var scored=computeScores(match.rows,anCols);
        for(var i=0;i<scored.length;i++) items.push(buildItemFromMatch(scored[i],srcCols,anCols));
      }else{
        var only=buildItemsFromAnalyticsOnly(anCols);
        items=only.sort((a,b)=>(b.score||0)-(a.score||0));
      }

      progress(56,"候補プール拡張（TDCSのみ）…");
      var finalN=+($("finalN").value||130);
      var pool=await buildCandidatePoolV2(items,srcCols,anCols,finalN);

      progress(64,"URI解決（目標 4×"+finalN+"）…");
      var res=await toUrisResolved(pool,(i,t,ok)=>progress(64+(8*(i/t)),"URI解決 ("+i+"/"+t+")"));

      progress(72,"曲詳細→録音ユニーク…");
      var trackMap=await fetchTrackDetailsByUris(res.aligned.filter(Boolean));
      var usable=pool.map((it,idx)=>Object.assign({},it,{uri:res.aligned[idx]})).filter(x=>x.uri);
      var dedRec=dedupeByRecording(usable, usable.map(x=>x.uri), trackMap);

      progress(78,"Audio Features 取得…");
      var feats=await fetchAudioFeaturesByUris(dedRec.uris);

      progress(84,"エディション分配（均衡）…");
      var packs=buildEditionSetsRoundRobin(dedRec.items.map((it,i)=>Object.assign({},it,{uri:dedRec.uris[i]})), feats, finalN);

      progress(88,"曲順最適化…");
      var seqUK=orderFlow(packs.UK,feats,($("presetUK").value||"waves"),+($("gapArtist").value||4),+($("gapRemixer").value||3),"UK|"+new Date().toISOString().slice(0,10));
      var seqUS=orderFlow(packs.US,feats,($("presetUS").value||"rise"), +($("gapArtist").value||4),+($("gapRemixer").value||3),"US|"+new Date().toISOString().slice(0,10));
      var seqEU=orderFlow(packs.EU,feats,($("presetEU").value||"waves"),+($("gapArtist").value||4),+($("gapRemixer").value||3),"EU|"+new Date().toISOString().slice(0,10));
      var seqWO=orderFlow(packs.WORLD,feats,"dj",+($("gapArtist").value||4),+($("gapRemixer").value||3),"WORLD|"+new Date().toISOString().slice(0,10));

      function pack(items,edName){
        var out=[]; for(var i=0;i<items.length;i++){var it=items[i], f=feats.get(it.uri)||{};
          out.push({position:i+1,edition:edName,title:it.name||"",artist:it.artist||"",remixer:it.remixer||"",isrc:it.isrc||"",source_id:it.id||"",source_sheet:(it.a&&it.a.__sheet)||"",match_mode:it._mode||"",match_score:round4(it._score||1),spotify_uri:it.uri,score:round4(it.score),tempo:round4(f.tempo),energy:round4(f.energy),valence:round4(f.valence),key:(f.key==null?"":f.key),mode:(f.mode==null?"":f.mode)});
        } return out;
      }
      _exportData={uk:pack(seqUK,"UK"),us:pack(seqUS,"US"),eu:pack(seqEU,"EU"),wo:pack(seqWO,"WORLD")};
      enableExportButtons(true);

      if(isAuthed()) await resolveAndWrite({UK:seqUK,US:seqUS,EU:seqEU,WORLD:seqWO});
      else { _pending={UK:seqUK,US:seqUS,EU:seqEU,WORLD:seqWO}; log("🔑 接続待ち：『Spotifyにサインイン』→『接続チェック』"); }
    }catch(e){progress(100,"エラー");log("💥 ERROR(runAnalysis): "+e.message); console.error(e);}
  }

  async function resolveAndWrite(packs){
    try{
      if(!packs) packs=_pending;
      if(!packs){log("ℹ️ 続行データなし");return;}
      function toUris(list){var a=[]; for(var i=0;i<list.length;i++) a.push(list[i].uri); return a;}

      var all=[].concat(packs.UK,packs.US,packs.EU,packs.WORLD);
      var set={}, dup=0; for(var i=0;i<all.length;i++){var u=all[i].uri; if(set[u]) dup++; else set[u]=1;}
      log("🔒 相互重複: "+dup+" 件（0が正常）");

      var pidUK=extractPlaylistId($("plUK").value), pidUS=extractPlaylistId($("plUS").value), pidEU=extractPlaylistId($("plEU").value), pidWO=extractPlaylistId($("plWORLD").value);

      if($("doUpdate").checked){
        progress(90,"上書き: UK…"); await replacePlaylist(pidUK,toUris(packs.UK));
        progress(93,"上書き: US…"); await replacePlaylist(pidUS,toUris(packs.US));
        progress(95,"上書き: EU…"); await replacePlaylist(pidEU,toUris(packs.EU));
        progress(97,"上書き: WORLD…"); await replacePlaylist(pidWO,toUris(packs.WORLD));
        log("✅ 既存4リスト 上書き完了");
      }
      if($("doCreate").checked){
        progress(98,"新規作成…");
        var pre=($("newPrefix").value||"TDCS Editions").trim();
        var ds=$("appendDate").checked?(" "+new Date().toISOString().slice(0,10)):"";
        var pU=await createPlaylistAndFill(pre+" — UK"+ds,"Auto-created by TDCS Editions Builder",true,toUris(packs.UK));
        var pS=await createPlaylistAndFill(pre+" — US"+ds,"Auto-created by TDCS Editions Builder",true,toUris(packs.US));
        var pE=await createPlaylistAndFill(pre+" — EU"+ds,"Auto-created by TDCS Editions Builder",true,toUris(packs.EU));
        var pW=await createPlaylistAndFill(pre+" — WORLD"+ds,"Auto-created by TDCS Editions Builder",true,toUris(packs.WORLD));
        log("🆕 新規:\n  UK   → https://open.spotify.com/playlist/"+pU+"\n  US   → https://open.spotify.com/playlist/"+pS+"\n  EU   → https://open.spotify.com/playlist/"+pE+"\n  WORLD→ https://open.spotify.com/playlist/"+pW);
      }

      progress(100,"完了"); log("✅ 完了（TDCS限定／不足自動補充→4×130達成／相互非重複／バランス分配）");
      _pending=null;
    }catch(e){progress(100,"エラー");log("💥 ERROR(resolveAndWrite): "+e.message); console.error(e);}
  }

  /* ====== イベント ====== */
  $("btnConnect").onclick=startAuth;
  $("btnReset").onclick=function(){ for(var k in LS) localStorage.removeItem(LS[k]); setStatus(); log("🧽 ローカルトークン削除"); };
  $("btnCheck").onclick=async function(){ try{ await refreshTokenIfNeeded(); var me=await spFetch("/v1/me","GET"); $("status").textContent="接続中（"+(me.display_name||me.id)+")"; log("✅ API確認 OK"); if(_pending) await resolveAndWrite(_pending); }catch(e){ log("⚠️ 接続エラー: "+e.message); console.error(e); } };
  $("fileSource").addEventListener("change",function(){ if($("fileAnalytics").files.length) loadFiles(); });
  $("fileAnalytics").addEventListener("change",function(){ if($("fileAnalytics").files.length) loadFiles(); });
  $("btnExportXlsx").onclick=exportXlsx;
  $("btnExportCsv").onclick=exportCsv;

  setStatus();
  log("Ready. 読込→突合→TDCS補充→URI解決→録音ユニーク→分配(均衡/非重複)→曲順→上書き/新規→CSV/XLSX。");
})();
</script>
</body></html>
