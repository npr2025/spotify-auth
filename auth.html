<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<meta name="robots" content="noindex,nofollow">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Spotify公式のOAuth認可画面（accounts.spotify.com）に遷移します。">
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               connect-src 'self' https://accounts.spotify.com;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline';
               frame-ancestors 'none';
               base-uri 'self';
               form-action https://accounts.spotify.com;">

<title>Spotify Connect (PKCE)</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:760px;margin:40px auto;padding:0 12px}
  button{padding:10px 14px;border:1px solid #bbb;border-radius:8px;background:#f6f6f6;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  #log{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:10px;border-radius:8px;margin-top:14px}
</style>
</head>
<body>
<h1>Spotify 接続</h1>
<p>公式ドメイン <code>accounts.spotify.com</code> の画面で認可します。</p>
<button id="go">Connect with Spotify</button>
<pre id="log"></pre>

<script>
"use strict";
const CLIENT_ID    = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI = "https://npr2025.github.io/spotify-auth/callback.html";
const SCOPES       = "playlist-modify-private playlist-modify-public";

const MIN_AUTH_GAP_MS = 15_000;
let starting = false;
const KEY_VERIFIER="pkce_verifier", KEY_STATE="pkce_state", KEY_LAST_TS="pkce_last_auth_ts";
const log = m => { const el=document.getElementById("log"); el.textContent += m + "\n"; console.log(m); };

const b64url = buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
async function sha256(str){ const data=new TextEncoder().encode(str); const hash=await crypto.subtle.digest("SHA-256", data); return b64url(hash); }
function randomVerifier(len=128){ const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~"; const a=new Uint8Array(len); crypto.getRandomValues(a); let out=""; for(const x of a){ out += alphabet[x % alphabet.length]; } return out; }
function randHex(n=16){ const a=new Uint8Array(n); crypto.getRandomValues(a); return Array.from(a).map(x=>("0"+x.toString(16)).slice(-2)).join(""); }
function now(){ return Date.now(); }
function remainingCooldown(){ const last=parseInt(sessionStorage.getItem(KEY_LAST_TS)||"0",10); return Math.max(0, MIN_AUTH_GAP_MS - (now()-last)); }

async function startAuth(){
  if (starting){ log("認可処理は進行中（多重起動を抑止）"); return; }
  const remain = remainingCooldown();
  if (remain>0){ log(`短時間の再実行はブロック中。${Math.ceil(remain/1000)}秒後に再試行してください。`); return; }

  try{
    starting = true;
    const btn = document.getElementById("go");
    btn.disabled = true;
    btn.textContent = "Redirecting…";

    const verifier  = randomVerifier(128);
    const challenge = await sha256(verifier);
    const state     = randHex(16);

    sessionStorage.setItem(KEY_VERIFIER, verifier);
    sessionStorage.setItem(KEY_STATE, state);
    sessionStorage.setItem(KEY_LAST_TS, String(Date.now()));

    const u = new URL("https://accounts.spotify.com/authorize");
    u.searchParams.set("client_id", CLIENT_ID);
    u.searchParams.set("response_type", "code");
    u.searchParams.set("redirect_uri", REDIRECT_URI);
    u.searchParams.set("scope", SCOPES);
    u.searchParams.set("state", state);
    u.searchParams.set("code_challenge_method", "S256");
    u.searchParams.set("code_challenge", challenge);
    u.searchParams.set("show_dialog", "false");

    log("Spotify 公式の認可画面へ移動します…");
    location.href = u.toString();
  }catch(e){
    starting=false;
    const btn = document.getElementById("go");
    btn.disabled=false; btn.textContent = "Connect with Spotify";
    log("Auth init error: "+(e && e.message ? e.message : e));
  }
}
document.getElementById("go").addEventListener("click", startAuth);
log("✅ auth.html wired");
</script>
</body>
</html>
