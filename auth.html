<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TDCS Auth</title>
<style>body{font-family:system-ui;margin:24px}</style>
</head>
<body>
<h1>Starting Spotify sign-in…</h1>
<pre id="log"></pre>
<script>
const LOG=(...a)=>{document.getElementById('log').textContent += a.join(' ') + "\n";}
const CLIENT_ID='5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI='https://npr2025.github.io/spotify-auth/callback.html';
const SCOPES=[
  'playlist-modify-public',
  'playlist-modify-private',
  'user-read-email'
].join(' ');

function b64url(bytes){
  return btoa(String.fromCharCode.apply(null,new Uint8Array(bytes)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function sha256(s){ const enc=new TextEncoder().encode(s); return crypto.subtle.digest('SHA-256', enc); }

(async()=>{
  try{
    const verifier = [...crypto.getRandomValues(new Uint8Array(64))].map(b=>('0'+b.toString(16)).slice(-2)).join('');
    const digest = await sha256(verifier);
    const challenge = b64url(digest);
    const state = Math.random().toString(36).slice(2);

    sessionStorage.setItem('code_verifier', verifier);
    sessionStorage.setItem('oauth_state', state);

    const params = new URLSearchParams({
      response_type:'code',
      client_id: CLIENT_ID,
      redirect_uri: REDIRECT_URI,
      code_challenge_method:'S256',
      code_challenge: challenge,
      state,
      scope: SCOPES,
      show_dialog: 'false'
    });
    const url = 'https://accounts.spotify.com/authorize?'+params.toString();
    LOG('Redirecting to Spotify…');
    location.href = url;
  }catch(e){
    LOG('ERROR:', e.message);
  }
})();
</script>
</body>
</html>
