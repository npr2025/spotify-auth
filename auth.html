<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TDCS Auth (PKCE)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
           background:#0b1220;color:#cfe3ff;max-width:760px;margin:40px auto;padding:0 16px; }
    h1{font-size:20px;margin:0 0 12px}
    button{padding:10px 14px;border-radius:8px;border:1px solid #3a4d75;background:#14213a;color:#e9f1ff;cursor:pointer;}
    pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;padding:12px;border-radius:10px}
    a{color:#9ec1ff}
  </style>
</head>
<body>
<h1>Finishing sign-in…</h1>
<pre id="log">Preparing…</pre>
<script>
const CLIENT_ID = '5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI = 'https://npr2025.github.io/spotify-auth/callback.html';
const SCOPE = [
  'playlist-modify-public',
  'playlist-modify-private',
  'user-read-email'
].join(' ');

const log = (...a)=>{ const el=document.getElementById('log'); el.textContent += '\n' + a.join(' '); };

async function sha256(buf){ return crypto.subtle.digest('SHA-256', buf); }
function base64url(b){
  return btoa(String.fromCharCode(...new Uint8Array(b)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function pkceChallenge(verifier){
  const enc=new TextEncoder().encode(verifier);
  const hash=await sha256(enc);
  return base64url(hash);
}
function randomString(len=64){
  const a=new Uint8Array(len); crypto.getRandomValues(a);
  return Array.from(a).map(x=>('0'+x.toString(16)).slice(-2)).join('');
}

(async () => {
  try{
    const state = randomString(24);
    const verifier = base64url(new TextEncoder().encode(randomString(40)));
    const challenge = await pkceChallenge(new TextEncoder().encode(verifier));

    sessionStorage.setItem('pkce_state', state);
    sessionStorage.setItem('code_verifier', verifier);
    // どこへ戻すか（builder.html 既定）
    const ret = (sessionStorage.getItem('return_to') || 'https://npr2025.github.io/spotify-auth/builder.html');
    sessionStorage.setItem('return_to', ret);

    const url = new URL('https://accounts.spotify.com/authorize');
    url.searchParams.set('response_type','code');
    url.searchParams.set('client_id', CLIENT_ID);
    url.searchParams.set('redirect_uri', REDIRECT_URI);
    url.searchParams.set('scope', SCOPE);
    url.searchParams.set('code_challenge_method','S256');
    url.searchParams.set('code_challenge', challenge);
    url.searchParams.set('state', state);

    log('Redirecting to Spotify…');
    location.href = url.toString();
  }catch(e){
    log('ERROR:', e.message);
    log('Return to app');
    const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app (fallback)'; document.body.appendChild(a);
  }
})();
</script>
</body>
</html>
