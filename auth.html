<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 connect-src https://accounts.spotify.com https://api.spotify.com https://cdn.jsdelivr.net;
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
                 base-uri 'none'; frame-ancestors 'none'; form-action 'none';
                 upgrade-insecure-requests">
  <meta name="referrer" content="no-referrer">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TDCS Auth (PKCE)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
           background:#0b1220;color:#cfe3ff;max-width:760px;margin:40px auto;padding:0 16px; }
    h1{font-size:20px;margin:0 0 12px}
    pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;padding:12px;border-radius:10px}
    a{color:#9ec1ff}
  </style>
</head>
<body>
<h1>Starting sign-in…</h1>
<pre id="log">Preparing…</pre>
<script>
const APP_VER   = 'auth-v11.4';
const CLIENT_ID = '5b4dc486f92a46878665468fa5de9361';
const REDIRECT  = 'https://npr2025.github.io/spotify-auth/callback.html';
const DEFAULT_RETURN = 'https://npr2025.github.io/spotify-auth/builder.html';
const SCOPE = ['playlist-modify-public','playlist-modify-private','user-read-email','user-read-private'].join(' ');

const log = (...a)=>{ const el=document.getElementById('log'); el.textContent += '\n' + a.join(' '); };
const qs  = new URL(location.href).searchParams;

function randomVerifier(len=64){
  const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
  const a=new Uint8Array(len); crypto.getRandomValues(a);
  let out=''; for(let i=0;i<len;i++) out+=chars[a[i]%chars.length];
  return out;
}
async function sha256(str){ return crypto.subtle.digest('SHA-256', new TextEncoder().encode(str)); }
function b64url(buf){
  const bin = String.fromCharCode(...new Uint8Array(buf));
  return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function challengeFromVerifier(v){ return b64url(await sha256(v)); }

(async () => {
  try{
    // セッション汚染排除
    ['pkce_state','code_verifier','code_challenge','pkce_method','access_token',
     'refresh_token','access_token_expires_at','last_pkce_error'].forEach(k=>sessionStorage.removeItem(k));

    // return_to（同一オリジン＆/spotify-auth/配下のみに限定）
    const existingRT = sessionStorage.getItem('return_to');
    const rtRaw = (qs.get('rt') || existingRT || DEFAULT_RETURN);
    let rt = DEFAULT_RETURN;
    try {
      const u = new URL(rtRaw, location.origin);
      if (u.origin === location.origin && u.pathname.startsWith('/spotify-auth/')) {
        rt = u.toString();
      }
    } catch(_) {}
    sessionStorage.setItem('return_to', rt);

    // メソッド決定
    const method = (qs.get('m')||'S256').toUpperCase()==='PLAIN' ? 'plain' : 'S256';
    const state    = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
    const verifier = randomVerifier(64);
    const challenge = method==='S256' ? await challengeFromVerifier(verifier) : verifier;

    sessionStorage.setItem('pkce_state', state);
    sessionStorage.setItem('code_verifier', verifier);
    sessionStorage.setItem('code_challenge', challenge);
    sessionStorage.setItem('pkce_method', method);
    sessionStorage.setItem('app_ver', APP_VER);

    log('APP', APP_VER, '| method:', method);
    log('Verifier length:', verifier.length);
    log('Challenge sample:', challenge.slice(0,16)+'…');
    log('Return to:', rt);

    const url = new URL('https://accounts.spotify.com/authorize');
    url.searchParams.set('response_type','code');
    url.searchParams.set('client_id', CLIENT_ID);
    url.searchParams.set('redirect_uri', REDIRECT);
    url.searchParams.set('scope', SCOPE);
    url.searchParams.set('state', state);
    url.searchParams.set('code_challenge_method', method);
    url.searchParams.set('code_challenge', challenge);

    log('Redirecting to Spotify…');
    location.replace(url.toString());
  }catch(e){
    log('ERROR:', e.message);
    const a=document.createElement('a'); a.href=DEFAULT_RETURN; a.textContent='Return to app (fallback)'; document.body.appendChild(a);
  }
})();
</script>
</body>
</html>
