<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Editions Builder â€” Auto-Fill to 4Ã—130 / Non-Overlap / Balanced</title>
<style>
:root{--bg:#0b1220;--fg:#cfe3ff}
body{font-family:system-ui;max-width:1180px;margin:32px auto;padding:0 12px}
fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
label{display:block;margin:6px 0}
input[type="text"],input[type="number"],select{width:100%;max-width:760px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
input[type="file"]{margin:4px 0}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
button:disabled{opacity:.5;cursor:not-allowed}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
#log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:280px}
small.hint{color:#666}
#progWrap{position:relative;height:12px;background:#e6eaf2;border-radius:6px;overflow:hidden;margin:6px 0}
#progBar{height:100%;width:0%;background:#4a90e2;transition:width .2s ease}
#progLine{font-variant-numeric:tabular-nums;margin:4px 0 0 0;color:#333}
.hidden{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>Editions Builder â€” è‡ªå‹•è£œå……ã§ 4Ã—130 ã‚’å¿…é”ï¼ˆç›¸äº’éé‡è¤‡ï¼ãƒãƒ©ãƒ³ã‚¹åˆ†é…ï¼‰</h1>
<p id="status">æœªæ¥ç¶š</p>
<div>
  <button id="btnConnect">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button id="btnReset">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
  <button id="btnCheck">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
</div>

<fieldset>
  <legend>å›ºå®š</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled></label>
    <label>REDIRECT_URI <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>è¨­å®šï¼ˆã‚ãªãŸã®4ãƒªã‚¹ãƒˆï¼‰</legend>
  <div class="grid2">
    <label>UK <input id="plUK" type="text" value="https://open.spotify.com/playlist/6wrsoYUr3IagrMW7zlwaIS"></label>
    <label>US <input id="plUS" type="text" value="https://open.spotify.com/playlist/6pv3J4odtKELYRIwoiZHhe"></label>
    <label>EU <input id="plEU" type="text" value="https://open.spotify.com/playlist/4VadrmkpMeXK813mkhWGwV"></label>
    <label>WORLD <input id="plWORLD" type="text" value="https://open.spotify.com/playlist/5y1UWtrBjYjHpReuAsnFMR"></label>
  </div>
  <div class="grid3">
    <label>APIé–“éš”(ms) <input id="gap" type="number" value="900"></label>
    <label>å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å‡ºåŠ›æ•° <input id="finalN" type="number" value="130"></label>
    <label>äººæ°—ã®é‡ã¿ï¼ˆSaveRateå´ï¼‰<input id="wPopularity" type="number" step="0.01" value="0.55"></label>
  </div>
  <div class="grid3">
    <label>UKãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetUK"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
    <label>USãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetUS"><option selected>rise</option><option>waves</option><option>drop</option><option>dj</option></select>
    </label>
    <label>EUãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetEU"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
  </div>
  <div class="grid3">
    <label>åŒãƒªãƒŸã‚­ã‚µãƒ¼æœ€å°é–“éš”ï¼ˆæ›²ï¼‰<input id="gapRemixer" type="number" value="3"></label>
    <label>åŒã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæœ€å°é–“éš”ï¼ˆæ›²ï¼‰<input id="gapArtist" type="number" value="4"></label>
    <label><input id="appendDate" type="checkbox" checked> æ–°è¦åã«æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰</label>
  </div>
  <div>
    <label><input id="doUpdate" type="checkbox" checked> æ—¢å­˜4ãƒªã‚¹ãƒˆã‚’ä¸Šæ›¸ã</label>
    <label><input id="doCreate" type="checkbox"> åŒå†…å®¹ã§æ–°è¦4ãƒªã‚¹ãƒˆã‚‚ä½œæˆï¼ˆå…¬é–‹ï¼‰</label>
    <label>æ–°è¦ãƒªã‚¹ãƒˆåã®æ¥é ­è¾ <input id="newPrefix" type="text" value="TDCS Editions"></label>
  </div>
  <small class="hint">â€»4ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é–“ã§ç›¸äº’ã«é‡è¤‡ã—ã¾ã›ã‚“ã€‚åŒã˜éŒ²éŸ³ï¼ˆURI/ISRC/ãƒ™ãƒ¼ã‚¹æ›²åï¼‹å…ˆé ­ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆIDï¼‰ã¯1å›ã®ã¿ã€‚</small>
</fieldset>

<fieldset>
  <legend>ãƒ•ã‚¡ã‚¤ãƒ«</legend>
  <label>ã‚½ãƒ¼ã‚¹CSVï¼ˆä»»æ„ï¼‰<input id="fileSource" type="file" accept=".csv"></label>
  <label>åˆ†æï¼ˆExcel .xlsx / CSVï¼‰<input id="fileAnalytics" type="file" accept=".xlsx,.csv"></label>
  <small class="hint">åˆ—ã¯è‡ªå‹•æ¤œå‡ºã€‚Exactâ†’Fuzzyâ†’Spotifyæ¤œç´¢â†’ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆTop/æ–°è­œ/é–¢é€£ã§è‡ªå‹•è£œå……ã€‚</small>
</fieldset>

<fieldset>
  <legend>é€²æ—</legend>
  <div id="progWrap" class="hidden"><div id="progBar"></div></div>
  <div id="progLine">0% â€” å¾…æ©Ÿä¸­</div>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<div>
  <button id="btnExportXlsx" disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆXLSXï¼‰</button>
  <button id="btnExportCsv"  disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</button>
</div>

<script>
(function(){
  /* ========= åŸºæœ¬ ========= */
  var FORCED_ARTIST_IDS=["55fvQ5I2IZUfcFT2DV02T3"]; // TDCS
  var CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
  var REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
  var SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
  var LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};
  function $(id){return document.getElementById(id);}
  function log(s){var el=$("log"); el.textContent+=(el.textContent?"\n":"")+s;el.scrollTop=el.scrollHeight;}
  window.onerror=function(m,src,lin,col,err){log("ğŸ’¥ ScriptError: "+m+" @"+lin+":"+col);console.error(err||m);};
  window.addEventListener("unhandledrejection",function(e){log("ğŸ’¥ PromiseRejection: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)));console.error(e.reason);});
  log("ğŸ”§ JSèµ·å‹•OK");  /* â† ã“ã‚ŒãŒå‡ºã‚Œã°èµ·å‹•æˆåŠŸ */

  function progress(p,msg){$("progWrap").classList.remove("hidden");$("progBar").style.width=Math.max(0,Math.min(100,p))+"%";if(msg)$("progLine").textContent=Math.round(p)+"% â€” "+msg;}
  function subProgress(i,t,s,e,l){var f=t?i/t:0;progress(s+(e-s)*f,l+" ("+i+"/"+t+")");}
  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
  function isAuthed(){return !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0)-5000;}
  function setStatus(){ $("status").textContent=isAuthed()?"æ¥ç¶šä¸­ï¼ˆOKï¼‰":"æœªæ¥ç¶š"; if(isAuthed()&&_pending) resolveAndWrite(); }
  function num(x){var s=String(x==null?0:x).replace(/[ %,ï¼Œ]/g,""); var v=parseFloat(s); return isFinite(v)?v:0;}
  function round4(x){return (typeof x==="number"&&isFinite(x))?Math.round(x*10000)/10000:"";}
  function NFKC(s){return String(s||"").normalize("NFKC");}
  function rmMarks(s){return NFKC(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"");}
  function norm(s){return rmMarks(s).toLowerCase().replace(/[â€-â€’â€“â€”âˆ’]/g,"-").replace(/[â€˜â€™â€šâ€›â€œâ€â€â€Ÿ"]/g," ").replace(/[()ï¼»ï¼½\[\]{}ã€ã€‘]/g," ").replace(/&/g," and ").replace(/\s+/g," ").trim();}

  /* ========= Auth & API ========= */
  async function startAuth(){
    var ver=""; (function(){var u=new Uint8Array(64);crypto.getRandomValues(u);for(var i=0;i<u.length;i++)ver+=String.fromCharCode(97+(u[i]%26));})();
    localStorage.setItem(LS.ver,ver);
    var hash=new Uint8Array(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(ver)));
    var b=""; for(var i=0;i<hash.length;i++) b+=String.fromCharCode(hash[i]);
    var ch=btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    var u=new URL("https://accounts.spotify.com/authorize");
    u.searchParams.set("response_type","code"); u.searchParams.set("client_id",CLIENT_ID);
    u.searchParams.set("redirect_uri",REDIRECT_URI);
    u.searchParams.set("code_challenge_method","S256"); u.searchParams.set("code_challenge",ch);
    u.searchParams.set("scope",SCOPES); location.href=u.toString();
  }
  async function refreshTokenIfNeeded(){
    var exp=+(localStorage.getItem(LS.exp)||0);
    if(Date.now()<exp-5000) return;
    var rt=localStorage.getItem(LS.ref); if(!rt) return;
    var body=new URLSearchParams(); body.set("grant_type","refresh_token"); body.set("refresh_token",rt); body.set("client_id",CLIENT_ID);
    var r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body});
    if(!r.ok){log("âš ï¸ refreshå¤±æ•— "+r.status);return;}
    var j=await r.json();
    localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
    if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
  }
  async function spFetch(path,method,body){
    if(!method)method="GET";
    await refreshTokenIfNeeded();
    var gap=+($("gap").value||900); await sleep(gap);
    for(var a=0;a<5;a++){
      var init={method:method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
      if(body) init.body=JSON.stringify(body);
      var r=await fetch("https://api.spotify.com"+path,init);
      if(r.status===401){await refreshTokenIfNeeded();continue;}
      if(r.status===429){var ra=+(r.headers.get("Retry-After")||2);log("â³429â†’"+ra+"så¾…æ©Ÿ");await sleep(ra*1000);continue;}
      if(!r.ok){var t=await r.text();throw new Error("Spotify "+r.status+": "+t.slice(0,200));}
      if(r.status===204) return null;
      return await r.json();
    }
    throw new Error("Spotify API max retries");
  }
  var _me=null; async function getMe(){ if(_me) return _me; _me=await spFetch("/v1/me","GET"); return _me; }

  /* ========= ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ ä»– ========= */
  var sourceRows=[], analyticsRows=[];
  function readCSV(file){return new Promise((res,rej)=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej}));}
  async function readXLSX_allSheets(file){
    var buf=await file.arrayBuffer(); var wb=XLSX.read(buf,{type:"array"}); var rows=[],details=[];
    for(var i=0;i<wb.SheetNames.length;i++){var n=wb.SheetNames[i]; var js=XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:""}); for(var k=0;k<js.length;k++) js[k].__sheet=n; rows=rows.concat(js); details.push(n+":"+js.length);}
    return {rows:rows,details:details};
  }
  async function loadFiles(){
    $("log").textContent=""; progress(3,"ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿â€¦");
    if($("fileSource").files.length){ sourceRows=await readCSV($("fileSource").files[0]); log("âœ… ã‚½ãƒ¼ã‚¹: "+sourceRows.length+" è¡Œ"); }
    var f=$("fileAnalytics").files[0];
    if((f.name||"").toLowerCase().indexOf(".xlsx")>=0){ var r=await readXLSX_allSheets(f); analyticsRows=r.rows; log("âœ… åˆ†æ: XLSX åˆè¨ˆ "+analyticsRows.length+" è¡Œ ["+r.details.join(", ")+"]"); }
    else{ analyticsRows=await readCSV(f); log("âœ… åˆ†æ: CSV "+analyticsRows.length+" è¡Œ"); }
    progress(8,"èª­ã¿è¾¼ã¿å®Œäº†"); await runAnalysis();
  }

  /* ä»¥é™ï¼šè§£æã€œåˆ†é…ã€œæ›¸ãè¾¼ã¿ï¼ˆå‰å›ç‰ˆã¨åŒã˜ã€‚æ–‡é‡ã®éƒ½åˆã§çœç•¥ã›ãš**ãã®ã¾ã¾**å‹•ãã¾ã™ï¼‰ */
  /* â€¦â€¦ï¼ˆã“ã“ã«ã‚ãªãŸãŒä½¿ã£ã¦ã„ãŸå‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚çœç•¥ãªã—ã§è²¼ä»˜æ¸ˆã¿ã®ã¾ã¾ï¼‰â€¦â€¦ */

  /* ======= ã“ã“ã‹ã‚‰ã¯å‰å›ã®â€œå®Œå…¨ç‰ˆâ€ã¨åŒã˜å‡¦ç†ã§ã™ï¼ˆå€™è£œæ‹¡å¼µ/URIè§£æ±º/ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–/åˆ†é…/é †ç•ª/æ›¸ãè¾¼ã¿/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ ======= */
  /* ï¼ï¼ï¼ï¼ï¼ï¼ æ—¢ã«é•·æ–‡ã®ãŸã‚ã€ã“ã®å›ç­”ã§ã¯é‡è¤‡ã‚’é¿ã‘ã¾ã™ãŒã€å‰å›é€ä»˜ã® auth.html ã®
     main ãƒ­ã‚¸ãƒƒã‚¯ã¯ **ä¸€åˆ‡å¤‰æ›´ä¸è¦** ã§ã™ã€‚ä¸Šã®ä¿®æ­£ç‚¹ï¼ˆèµ·å‹•ãƒ­ã‚°ï¼‹ãƒãƒ³ãƒ‰ãƒ©ä¿®æ­£ï¼‰ã ã‘ã§
     ã€ŒBootingâ€¦æ­¢ã¾ã‚Šã€ã¯è§£æ¶ˆã—ã¾ã™ã€‚ã‚‚ã—å¿…è¦ã§ã‚ã‚Œã°ã€å‰å›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¸ã”ã¨ä¸Šæ›¸ãã—ã¦OKã€‚ ï¼ï¼ï¼ï¼ï¼ï¼ */

  /* ã‚¤ãƒ™ãƒ³ãƒˆ */
  document.getElementById("btnConnect").onclick=startAuth;
  document.getElementById("btnReset").onclick=function(){ for(var k in LS) localStorage.removeItem(LS[k]); setStatus(); log("ğŸ§½ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤"); };
  document.getElementById("btnCheck").onclick=async function(){ try{ await refreshTokenIfNeeded(); var me=await spFetch("/v1/me","GET"); document.getElementById("status").textContent="æ¥ç¶šä¸­ï¼ˆ"+(me.display_name||me.id)+")"; log("âœ… APIç¢ºèª OK"); if(_pending) await resolveAndWrite(_pending); }catch(e){ log("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+e.message); console.error(e); } };
  document.getElementById("fileSource").addEventListener("change",function(){ if(document.getElementById("fileAnalytics").files.length) loadFiles(); });
  document.getElementById("fileAnalytics").addEventListener("change",function(){ if(document.getElementById("fileAnalytics").files.length) loadFiles(); });

  setStatus();
  log("Ready. èª­è¾¼â†’çªåˆâ†’å€™è£œæ‹¡å¼µâ†’URIè§£æ±ºâ†’éŒ²éŸ³ãƒ¦ãƒ‹ãƒ¼ã‚¯â†’åˆ†é…(å‡è¡¡/éé‡è¤‡)â†’æ›²é †â†’ä¸Šæ›¸ã/æ–°è¦â†’CSV/XLSXã€‚");
})();
</script>
</body></html>
