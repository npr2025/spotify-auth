<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth (PKCE) — TDCS Builder</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:24px}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin-right:8px}
pre{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px}
small{color:#666}
</style>
</head>
<body>
<h1>Spotify Auth (PKCE)</h1>
<p>自動でSpotifyの認可画面へ遷移します。うまく動かないときは下のボタンから実行してください。</p>
<div>
  <button id="btnStart">サインインへ</button>
  <button id="btnClear">トークン削除</button>
</div>
<small>クエリ: <code>?back=&lt;戻り先URL&gt;&amp;callback=&lt;callback.htmlのURL&gt;&amp;client_id=&lt;任意&gt;&amp;scope=&lt;任意&gt;&amp;manual=1</code></small>
<pre id="log">準備中…</pre>

<script>
/* ====== 同一キー（index.html / callback.htmlと一致） ====== */
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};
const DEFAULT_CLIENT_ID = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const DEFAULT_CALLBACK  = "https://npr2025.github.io/spotify-auth/callback.html";
const DEFAULT_SCOPES    = "playlist-modify-public playlist-modify-private ugc-image-upload";

const log=(s)=>{ const el=document.getElementById("log"); el.textContent+=(el.textContent?"\n":"")+s; }

/* ====== PKCE ====== */
async function makeVerifierAndChallenge(){
  // 64文字の小文字英字ベリファイア
  let v=""; const u8=new Uint8Array(64); crypto.getRandomValues(u8);
  for(let i=0;i<u8.length;i++) v+=String.fromCharCode(97+(u8[i]%26));
  const digest=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v));
  const b=new Uint8Array(digest); let bin=""; for(const x of b) bin+=String.fromCharCode(x);
  const ch=btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  return {verifier:v, challenge:ch};
}

function saveBack(back){
  if(back){ localStorage.setItem("tdcs_builder_back", back); return back; }
  if(document.referrer){ localStorage.setItem("tdcs_builder_back", document.referrer); return document.referrer; }
  const guess = location.origin + "/"; localStorage.setItem("tdcs_builder_back", guess); return guess;
}

async function startAuth(opts={}){
  const clientId   = opts.clientId   || DEFAULT_CLIENT_ID;
  const callback   = opts.callback   || DEFAULT_CALLBACK;
  const scopes     = opts.scopes     || DEFAULT_SCOPES;

  const {verifier, challenge}=await makeVerifierAndChallenge();
  localStorage.setItem(LS.ver, verifier);

  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id", clientId);
  u.searchParams.set("redirect_uri", callback);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge", challenge);
  u.searchParams.set("scope", scopes);

  log("➡️ redirect: "+u.toString());
  location.href = u.toString();
}

/* ====== 便利操作 ====== */
function clearTokens(){
  for(const k of [LS.acc,LS.ref,LS.exp,LS.ver]) localStorage.removeItem(k);
  log("🧽 ローカルトークン削除");
}

/* ====== 起動処理 ====== */
(function boot(){
  const p = new URL(location.href).searchParams;
  const back     = p.get("back");
  const clientId = p.get("client_id") || DEFAULT_CLIENT_ID;
  const callback = p.get("callback")  || DEFAULT_CALLBACK;
  const scopes   = p.get("scope")     || DEFAULT_SCOPES;
  const manual   = p.get("manual")==="1";

  const savedBack = saveBack(back);
  log("back → "+savedBack);
  log("callback → "+callback);

  document.getElementById("btnStart").onclick=()=>startAuth({clientId, callback, scopes});
  document.getElementById("btnClear").onclick=clearTokens;

  if(!manual){
    // 自動開始（失敗してもボタンで再実行可能）
    startAuth({clientId, callback, scopes}).catch(e=>log("⚠️ startAuth失敗: "+(e.message||e)));
  }else{
    log("⏸ 自動リダイレクト無効（manual=1）。「サインインへ」を押してください。");
  }
})();
</script>
</body>
</html>
