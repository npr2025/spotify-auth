<!doctype html><meta charset="utf-8">
<title>Spotify PKCE Auth</title>
<h1>Login with Spotify (PKCE)</h1>
<button id="login">Spotify にログイン</button>
<p>Authorize URL:</p>
<pre id="u" style="white-space:break-spaces"></pre>
<p><a id="open" href="#" target="_blank" rel="noopener">新しいタブで開く</a></p>
<script>
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const SCOPE=""; // 読取だけなら空
function b64url(b){return btoa(String.fromCharCode(...new Uint8Array(b))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
async function sha256(t){return await crypto.subtle.digest("SHA-256", new TextEncoder().encode(t));}
function rand(n=64){const a=new Uint8Array(n);crypto.getRandomValues(a);return b64url(a);}
async function buildUrl(){
  const v=rand(64), c=b64url(await sha256(v)), s=rand(32);
  sessionStorage.setItem("pkce_verifier", v);
  sessionStorage.setItem("pkce_state", s);
  const q=new URLSearchParams({
    response_type:"code", client_id:CLIENT_ID, redirect_uri:REDIRECT_URI,
    code_challenge_method:"S256", code_challenge:c, state:s, scope:SCOPE
  }).toString();
  const url="https://accounts.spotify.com/authorize?"+q;
  document.getElementById("u").textContent=url;
  const a=document.getElementById("open"); a.href=url;
  return url;
}
document.getElementById("login").onclick = async ()=>{ location.href = await buildUrl(); };
buildUrl(); // 事前にURLを出しておく
</script>
