åˆã†ãƒ†ã‚£ãƒ 

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Editions Builder â€” Files Only (CSV/XLSX, All Sheets)</title>
<style>
  :root{--bg:#0b1220;--fg:#cfe3ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1100px;margin:32px auto;padding:0 12px}
  h1{margin:0 0 8px}
  fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:12px 0}
  legend{padding:0 6px}
  label{display:block;margin:6px 0}
  input[type="text"],input[type="number"]{width:100%;max-width:720px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
  input[type="file"]{margin:4px 0}
  button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:180px}
  small.hint{color:#666}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>Editions Builder â€” Files Only</h1>
<p id="status">æœªæ¥ç¶š</p>
<div class="row">
  <button id="btnConnect">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button id="btnReset">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
  <button id="btnCheck">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
</div>

<fieldset>
  <legend>å›ºå®šå€¤ï¼ˆDashboardã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ï¼‰</legend>
  <div class="grid2">
    <label>CLIENT_ID<input id="showCID" type="text" value="YOUR_SPOTIFY_CLIENT_ID"></label>
    <label>REDIRECT_URI<input id="showRURI" type="text" value="https://your-domain.example/callback.html"></label>
  </div>
  <small class="hint">â€» è¡¨ç¤ºç”¨ã€‚å®Ÿå‹•ã¯ä¸‹ã®å®šæ•°ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºé©ç”¨æ¸ˆã¿ï¼‰ã€‚</small>
</fieldset>

<fieldset>
  <legend>è¨­å®š</legend>
  <label>APIé–“éš”(ms) <input id="gap" type="number" value="900"></label>
  <div class="grid2">
    <label>UK PL URL/ID <input id="plUK" type="text" value="https://open.spotify.com/playlist/1zqDXSgnbc87v4BxbHxtKK"></label>
    <label>US PL URL/ID <input id="plUS" type="text" value="https://open.spotify.com/playlist/2oeS8QglwS4hLtLuqvPZgH"></label>
    <label>EU PL URL/ID <input id="plEU" type="text" value="https://open.spotify.com/playlist/2JWHMN3yxLI5S4XFdDZbwt"></label>
    <label>WORLD PL URL/ID <input id="plWORLD" type="text" value="https://open.spotify.com/playlist/4SCclM9zLNuSPOmqORdVN8"></label>
  </div>
  <div class="grid2">
    <label>Balancedå€™è£œ<input id="balancedN" type="number" value="150"></label>
    <label>å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å‡ºåŠ›æ•°<input id="finalN" type="number" value="130"></label>
  </div>
  <div class="grid2">
    <label>äººæ°—ã®é‡ã¿ï¼ˆSaveRateå´ï¼‰<input id="wPopularity" type="number" step="0.01" value="0.55"></label>
    <label>æ–°ã—ã•ã®é‡ã¿ï¼ˆ24/7/28=0.5/0.3/0.2ï¼‰<input type="number" value="0.45" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚½ãƒ¼ã‚¹CSVï¼æ¯é›†å›£ï¼åˆ†æXLSX/CSVï¼æŒ‡æ¨™ï¼‰</legend>
  <label>ã‚½ãƒ¼ã‚¹CSV<input id="fileSource" type="file" accept=".csv"></label>
  <label>åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆ.xlsxã¯<strong>å…¨ã‚·ãƒ¼ãƒˆçµåˆ</strong>ï¼‰<input id="fileAnalytics" type="file" accept=".xlsx,.csv"></label>
  <div class="row">
    <button id="btnPreview" disabled>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä¸Šä½20ï¼‰</button>
    <button id="btnRun" disabled>4ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¸ä¸Šæ›¸ã</button>
  </div>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<script>
/*** â†â†â† å¿…ãšç½®æ›ï¼ˆDashboardã¨å®Œå…¨ä¸€è‡´ï¼‰ ***/
const CLIENT_ID_RAW    = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI_RAW = "https://npr2025.github.io/spotify-auth/callback.html";
/*** ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆå‰å¾Œç©ºç™½ãƒ»æ”¹è¡Œãƒ»ã‚¼ãƒ­å¹…ï¼‰ ***/
const zws = /[\u200B-\u200D\uFEFF]/g;
const CLIENT_ID    = CLIENT_ID_RAW.replace(zws,"").trim();
const REDIRECT_URI = REDIRECT_URI_RAW.replace(zws,"").trim();
const SCOPES      = "playlist-modify-public playlist-modify-private ugc-image-upload";

/* ========== UTIL ========== */
const LS = { acc:"sp_access_token", ref:"sp_refresh_token", exp:"sp_token_exp", ver:"sp_code_verifier" };
const $ = (id)=>document.getElementById(id);
const log = (s)=>{ const el=$("log"); el.textContent += (el.textContent? "\n":"")+ s; el.scrollTop = el.scrollHeight; };
const clearLog = ()=>{ $("log").textContent=""; };
const isAuthed = ()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0) - 5000;
function setStatus(){ $("status").textContent = isAuthed()? "æ¥ç¶šä¸­ï¼ˆOKï¼‰":"æœªæ¥ç¶š"; $("btnPreview").disabled = !filesReady()||!isAuthed(); $("btnRun").disabled = !filesReady()||!isAuthed(); }
function filesReady(){ return $("fileSource").files.length && $("fileAnalytics").files.length; }
function normName(s){ return String(s||"").trim().toLowerCase(); }
function truthy(v){ const s=String(v).trim().toLowerCase(); return ["1","true","yes","y","ok","âœ“","â—","â—¯","o"].includes(s); }
function b64url(buf){ return btoa(String.fromCharCode.apply(null,new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
async function sha256(str){ const enc=new TextEncoder(); const data=enc.encode(str); const digest=await crypto.subtle.digest("SHA-256",data); return b64url(digest); }
function randomString(len=64){ const p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~"; let out=""; for(let i=0;i<len;i++) out+=p[Math.floor(Math.random()*p.length)]; return out; }
function extractTrackId(any){ const s=String(any||"").trim(); if(!s) return ""; let m=s.match(/spotify:track:([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/open\.spotify\.com\/track\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
function extractPlaylistId(any){ const s=String(any||"").trim(); let m=s.match(/playlist\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
function findCol(obj,cands){ const keys=Object.keys(obj); for(const k of keys){ const n=normName(k); for(const c of cands){ if(n===c) return k; if(n.includes(c)) return k; } } return null; }

/* ========== AUTH ========== */
function dumpAuthDiag(stage){
  log(`ğŸ” ${stage}
  CLIENT_ID(len=${CLIENT_ID.length}): ${CLIENT_ID ? CLIENT_ID.slice(0,6)+"â€¦"+CLIENT_ID.slice(-6) : "(empty)"}
  REDIRECT_URI(len=${REDIRECT_URI.length}): ${REDIRECT_URI}`);
}
async function startAuth(){
  if(!CLIENT_ID || CLIENT_ID.includes("1fd6350fcf4945a0b3ddffa2d5730d4e")){ alert("CLIENT_ID æœªè¨­å®š"); return; }
  if(!REDIRECT_URI || REDIRECT_URI.includes("https://npr2025.github.io/spotify-auth/callback.htme")){ alert("REDIRECT_URI æœªè¨­å®š"); return; }
  dumpAuthDiag("Authorizeå‰ãƒ€ã‚¤ã‚¢ã‚°");

  const verifier = randomString(64);
  localStorage.setItem(LS.ver, verifier);
  const challenge = await sha256(verifier);
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id", CLIENT_ID);
  url.searchParams.set("redirect_uri", REDIRECT_URI);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", challenge);
  url.searchParams.set("scope", SCOPES);
  location.href = url.toString();
}
async function refreshTokenIfNeeded(){
  const exp = +localStorage.getItem(LS.exp||0);
  if(Date.now() < exp-5000) return;
  const refresh_token = localStorage.getItem(LS.ref);
  if(!refresh_token) return;
  const body = new URLSearchParams({ grant_type:"refresh_token", refresh_token, client_id:CLIENT_ID });
  const res = await fetch("https://accounts.spotify.com/api/token",{ method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body });
  if(!res.ok){ log("âš ï¸ refreshå¤±æ•—: "+res.status+" "+(await res.text())); return; }
  const j = await res.json();
  localStorage.setItem(LS.acc, j.access_token);
  localStorage.setItem(LS.exp, String(Date.now()+ j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref, j.refresh_token);
  log("ğŸ”„ access_token refreshed");
}
async function spFetch(path, method="GET", body=null){
  await refreshTokenIfNeeded();
  const gap = +$("gap").value || 900;
  await new Promise(r=>setTimeout(r,gap));
  for(let attempt=0; attempt<5; attempt++){
    const res = await fetch("https://api.spotify.com"+path,{ method, headers:{ "Authorization":"Bearer "+localStorage.getItem(LS.acc), "Content-Type":"application/json" }, body: body? JSON.stringify(body): null });
    if(res.status===401){ await refreshTokenIfNeeded(); continue; }
    if(res.status===429){ const ra=+res.headers.get("Retry-After")||2; log(`â³ 429 â†’ wait ${ra}s`); await new Promise(r=>setTimeout(r,ra*1000)); continue; }
    if(!res.ok){ const t=await res.text(); throw new Error(`Spotify API error ${res.status}: ${t}`); }
    if(res.status===204) return null;
    return await res.json();
  }
  throw new Error("Spotify API max retries");
}

/* ========== FILE IO ========== */
let sourceRows=[], analyticsRows=[];
function readCSV(file){ return new Promise((resolve,reject)=>{ Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject}); }); }
async function readXLSX_allSheets(file){
  const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:"array"});
  let rows=[]; const details=[];
  for(const name of wb.SheetNames){
    const sheet=wb.Sheets[name]; const json=XLSX.utils.sheet_to_json(sheet,{defval:""});
    for(const r of json){ r.__sheet=name; }
    rows=rows.concat(json); details.push(`${name}:${json.length}`);
  }
  return { rows, details, sheetNames: wb.SheetNames };
}
function prepareIndex(rows){
  const out={};
  for(const r of rows){
    const idCol = findCol(r, ["spotify_uri","track_uri","uri","spotify_url","url","id"]);
    const id = extractTrackId(idCol? r[idCol]:"");
    if(!id) continue; out[id]=r;
  }
  return out;
}
async function loadFiles(){
  clearLog(); log("ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦");
  sourceRows = await readCSV($("fileSource").files[0]); log(`âœ… ã‚½ãƒ¼ã‚¹CSV: ${sourceRows.length} è¡Œ`);
  const f2=$("fileAnalytics").files[0];
  if(f2.name.toLowerCase().endsWith(".xlsx")){
    const res=await readXLSX_allSheets(f2); analyticsRows=res.rows;
    log(`âœ… åˆ†æï¼ˆXLSX å…¨${res.sheetNames.length}ï¼‰: ${analyticsRows.length} è¡Œ [${res.details.join(", ")}]`);
  }else{ analyticsRows=await readCSV(f2); log(`âœ… åˆ†æï¼ˆCSVï¼‰: ${analyticsRows.length} è¡Œ`); }
  $("btnPreview").disabled=!isAuthed(); $("btnRun").disabled=!isAuthed();
}

/* ========== SCORING ========== */
function computeScores(){
  const srcIdx = prepareIndex(sourceRows);
  const byId=new Map();
  for(const r of analyticsRows){
    const idCol = findCol(r, ["spotify_uri","track_uri","uri","spotify_url","url","id"]);
    const id = extractTrackId(idCol? r[idCol]:""); if(!id) continue;
    if(!srcIdx[id]) continue;
    if(!byId.has(id)) byId.set(id,{...r}); else{
      const base=byId.get(id);
      for(const k of Object.keys(r)){
        const v=r[k]; const has=base[k]!=null&&String(base[k]).trim()!==""; const vHas=v!=null&&String(v).trim()!=="";
        if(!has && vHas) base[k]=v;
      }
    }
  }
  const merged=[...byId.values()]; if(!merged.length) throw new Error("ä¸€è‡´ã™ã‚‹ãƒˆãƒ©ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆURIåˆ—ã‚’ç¢ºèªï¼‰");
  const get=(obj,cands)=>{ const k=findCol(obj,cands); return k? obj[k]:null; };
  const playsCols=[["plays_24h","p24","streams24","play_24h"],["plays_7d","p7","streams7","play_7d"],["plays_28d","p28","streams28","play_28d"]];
  const srCols=[["save_rate_24h","sr24","save24","save_rate24"],["save_rate_7d","sr7","save7","save_rate7"],["save_rate_28d","sr28","save28","save_rate28"]];
  const maxPlays=[0,0,0];
  for(const a of merged){ for(let i=0;i<3;i++){ const k=get(a,playsCols[i]); const v=+String(k??0).replace(/[, %]/g,""); if(v>maxPlays[i]) maxPlays[i]=v; } }
  const rows=[];
  for(const a of merged){
    const idCol=findCol(a,["spotify_uri","track_uri","uri","spotify_url","url","id"]);
    const id=extractTrackId(idCol? a[idCol]:""); if(!id) continue;
    const val=(k)=>+String(k??0).replace(/[, %]/g,"");
    const sr=[val(get(a,srCols[0]))/100,val(get(a,srCols[1]))/100,val(get(a,srCols[2]))/100];
    const pl=[val(get(a,playsCols[0])),val(get(a,playsCols[1])),val(get(a,playsCols[2]))];
    const plN=pl.map((v,i)=>maxPlays[i]? v/maxPlays[i]:0);
    const w=[.5,.3,.2]; const save=w[0]*sr[0]+w[1]*sr[1]+w[2]*sr[2]; const play=w[0]*plN[0]+w[1]*plN[1]+w[2]*plN[2];
    const wPop=+$("wPopularity").value||.55; const score=wPop*save+(1-wPop)*play;
    const uk=truthy(get(a,["uk","available_uk","avail_uk"]));
    const us=truthy(get(a,["us","available_us","avail_us"]));
    const eu=truthy(get(a,["eu","available_eu","avail_eu"]));
    const wo=truthy(get(a,["world","available_world","avail_world"]));
    const rem=(get(a,["remixer","remixers","remixer_name"])??"").toString().trim();
    rows.push({id,score,flags:{uk,us,eu,wo},remixer:rem});
  }
  rows.sort((a,b)=>b.score-a.score); return rows;
}

/* ========== LAYOUT & WRITE ========== */
function layoutNoAdjacent(list,maxN){
  const out=[]; for(const item of list){ if(out.length>=maxN) break;
    const r=(item.remixer||"").toLowerCase(); if(out.length>0 && r && (out[out.length-1].remixer||"").toLowerCase()===r) continue; out.push(item);
  }
  for(const item of list){ if(out.length>=maxN) break; if(out.includes(item)) continue; out.push(item); }
  return out;
}
function filterByEdition(rows,ed){
  const has=rows.some(r=>r.flags.uk||r.flags.us||r.flags.eu||r.flags.wo); if(!has) return rows;
  const k=ed.toLowerCase(); return rows.filter(r=> k==="world" ? (r.flags.wo||r.flags.uk||r.flags.us||r.flags.eu) : r.flags[k]);
}
const toUris=(items)=>items.map(x=>"spotify:track:"+x.id);
async function replacePlaylist(pid,uris){
  const chunks=[]; for(let i=0;i<uris.length;i+=100) chunks.push(uris.slice(i,i+100));
  if(!chunks.length) chunks.push([]);
  await spFetch(`/v1/playlists/${pid}/tracks`,"PUT",{uris:chunks[0]}); log(`ğŸ§¹ ç½®æ›: ${chunks[0].length}ä»¶`);
  for(let i=1;i<chunks.length;i++){ await spFetch(`/v1/playlists/${pid}/tracks`,"POST",{uris:chunks[i]}); log(`â• è¿½åŠ : ${chunks[i].length}ä»¶`); }
}

/* ========== RUN ========== */
async function run(doPreview=false){
  try{
    clearLog(); log("ğŸ” ã‚¹ã‚³ã‚¢è¨ˆç®—â€¦");
    const rows=computeScores(); const balancedN=+$("balancedN").value||150; const finalN=+$("finalN").value||130;
    const top=rows.slice(0,balancedN);
    const mk=(n)=>{ const f=filterByEdition(top,n); const p=layoutNoAdjacent(f,finalN); log(`â€¢ ${n}: å€™è£œ${f.length} â†’ å‡ºåŠ›${p.length}`); return p; };
    const UK=mk("UK"), US=mk("US"), EU=mk("EU"), WO=mk("WORLD");
    if(doPreview){ const prev=[...UK.slice(0,5),...US.slice(0,5),...EU.slice(0,5),...WO.slice(0,5)]; log("ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\n"+toUris(prev).join("\n")); return; }
    if(!isAuthed()) throw new Error("Spotifyæœªæ¥ç¶šã§ã™ã€‚");
    const pidUK=extractPlaylistId($("plUK").value), pidUS=extractPlaylistId($("plUS").value), pidEU=extractPlaylistId($("plEU").value), pidWO=extractPlaylistId($("plWORLD").value);
    if(!(pidUK&&pidUS&&pidEU&&pidWO)) throw new Error("ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURL/IDãŒä¸æ­£ã€‚");
    log("ğŸš€ ä¸Šæ›¸ãé–‹å§‹â€¦"); await replacePlaylist(pidUK,toUris(UK)); await replacePlaylist(pidUS,toUris(US)); await replacePlaylist(pidEU,toUris(EU)); await replacePlaylist(pidWO,toUris(WO)); log("âœ… å®Œäº†");
  }catch(e){ log("ğŸ’¥ ERROR: "+e.message); console.error(e); }
}

/* ========== EVENTS ========== */
$("btnConnect").onclick = startAuth;
$("btnReset").onclick = ()=>{ Object.values(LS).forEach(k=>localStorage.removeItem(k)); setStatus(); log("ğŸ§½ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤"); dumpAuthDiag("åˆæœŸåŒ–å¾Œãƒ€ã‚¤ã‚¢ã‚°"); };
$("btnCheck").onclick = async ()=>{
  try{ await refreshTokenIfNeeded(); const me=await spFetch("/v1/me","GET"); $("status").textContent=`æ¥ç¶šä¸­ï¼ˆ${me.display_name||me.id}ï¼‰`; log("âœ… APIç¢ºèª OK"); }
  catch(e){ if(String(e.message).includes("invalid_client")) log("âŒ INVALID_CLIENT: CLIENT_ID/REDIRECT_URI ã‚’å†ç¢ºèª"); log("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+e.message); }
};
$("fileSource").addEventListener("change", loadFiles);
$("fileAnalytics").addEventListener("change", loadFiles);
$("btnPreview").onclick = ()=>run(true);
$("btnRun").onclick = ()=>run(false);

setStatus();
dumpAuthDiag("èµ·å‹•æ™‚ãƒ€ã‚¤ã‚¢ã‚°");
log("Ready. ã¾ãš Spotify ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€‚");
</script>
</body>
</html>
