<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Spotify Auth — Start</title>
  <style>
    :root{color-scheme:dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#cfe3ff;
         max-width:760px;margin:24px auto;padding:0 12px}
    code{background:#091426;padding:2px 4px;border-radius:6px}
    button{padding:10px 14px;border-radius:8px;border:1px solid #3a4d75;background:#14213a;color:#e9f1ff;cursor:pointer;}
  </style>
</head>
<body>
<h1>Finishing sign-in…</h1>
<p id="log">Preparing PKCE…</p>
<p><button id="retry">Open consent manually</button></p>
<script>
const CLIENT_ID='5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI=location.origin + '/spotify-auth/callback.html';
const SCOPE='playlist-modify-public playlist-modify-private user-read-email';
const LOG=(...a)=>{document.getElementById('log').textContent=a.join(' ')};

function base64url(buf){
  return btoa(String.fromCharCode(...new Uint8Array(buf)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function genRandomString(len=96){
  const bytes=new Uint8Array(len); crypto.getRandomValues(bytes);
  const text=Array.from(bytes).map(b=>('0'+b.toString(16)).slice(-2)).join('');
  return text.slice(0,128);
}
async function sha256(verifier){
  const data=new TextEncoder().encode(verifier);
  const digest=await crypto.subtle.digest('SHA-256', data);
  return base64url(digest);
}

(async()=>{
  try{
    const ret=sessionStorage.getItem('return_to') || (location.origin + '/spotify-auth/builder.html');
    localStorage.setItem('return_to', ret);

    const code_verifier = genRandomString(64);
    localStorage.setItem('code_verifier', code_verifier);

    const code_challenge = await sha256(code_verifier);
    const state = Math.random().toString(36).slice(2);
    localStorage.setItem('oauth_state', state);

    const params = new URLSearchParams({
      response_type:'code',
      client_id:CLIENT_ID,
      redirect_uri:REDIRECT_URI,
      code_challenge_method:'S256',
      code_challenge:code_challenge,
      scope:SCOPE,
      state
    });
    const url='https://accounts.spotify.com/authorize?'+params.toString();
    LOG('Redirecting to Spotify…');
    location.href=url;
  }catch(e){
    LOG('PKCE init error:', e.message||String(e));
  }
})();

document.getElementById('retry').onclick=()=>{ location.reload(); };
</script>
</body>
</html>
