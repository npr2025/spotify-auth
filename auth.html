<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Editions Builder â€” Files Only (All Sheets, Fuzzy Match)</title>
<style>
  :root{--bg:#0b1220;--fg:#cfe3ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1180px;margin:32px auto;padding:0 12px}
  fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
  label{display:block;margin:6px 0}
  input[type="text"],input[type="number"],select{width:100%;max-width:720px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
  input[type="file"]{margin:4px 0}
  button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:240px}
  small.hint{color:#666}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>Editions Builder â€” Files Only</h1>
<p id="status">æœªæ¥ç¶š</p>
<div class="row">
  <button id="btnConnect">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button id="btnReset">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
  <button id="btnCheck">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
</div>

<fieldset>
  <legend>å›ºå®šï¼ˆDashboardã¨å®Œå…¨ä¸€è‡´ï¼‰</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled></label>
    <label>REDIRECT_URI <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>è¨­å®š</legend>
  <label>APIé–“éš”(ms) <input id="gap" type="number" value="900"></label>
  <div class="grid2">
    <label>UK <input id="plUK" type="text" value="https://open.spotify.com/playlist/1zqDXSgnbc87v4BxbHxtKK"></label>
    <label>US <input id="plUS" type="text" value="https://open.spotify.com/playlist/2oeS8QglwS4hLtLuqvPZgH"></label>
    <label>EU <input id="plEU" type="text" value="https://open.spotify.com/playlist/2JWHMN3yxLI5S4XFdDZbwt"></label>
    <label>WORLD <input id="plWORLD" type="text" value="https://open.spotify.com/playlist/4SCclM9zLNuSPOmqORdVN8"></label>
  </div>
  <div class="grid2">
    <label>Balancedå€™è£œæ•° <input id="balancedN" type="number" value="150"></label>
    <label>å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å‡ºåŠ›æ•° <input id="finalN" type="number" value="130"></label>
  </div>
  <div class="grid2">
    <label>äººæ°—ã®é‡ã¿ï¼ˆSaveRateå´ï¼‰<input id="wPopularity" type="number" step="0.01" value="0.55"></label>
    <label>ï¼ˆ24/7/28=0.5/0.3/0.2 å›ºå®šï¼‰<input type="number" value="0.45" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆã‚½ãƒ¼ã‚¹CSVï¼æ¯é›†å›£ï¼åˆ†æXLSX/CSVï¼æŒ‡æ¨™ï¼‰</legend>
  <label>ã‚½ãƒ¼ã‚¹CSVï¼ˆPropgapandaã‚½ãƒ¼ã‚¹.csvï¼‰<input id="fileSource" type="file" accept=".csv"></label>
  <label>åˆ†æãƒ‡ãƒ¼ã‚¿ï¼ˆExcel .xlsx / CSVï¼‰<input id="fileAnalytics" type="file" accept=".xlsx,.csv"></label>
  <div class="row">
    <button id="btnPreview" disabled>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè¨ºæ–­ï¼‹ä¸Šä½20ï¼‰</button>
    <button id="btnRun" disabled>4ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¸ä¸Šæ›¸ã</button>
  </div>
  <small class="hint">â€» ã¾ãšãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€‚0ä»¶ã§ã‚‚è½ã¡ãšã«å€™è£œã¨ã‚¹ã‚³ã‚¢ä¸Šä½ã‚’ãƒ­ã‚°è¡¨ç¤ºã€‚</small>
</fieldset>

<fieldset>
  <legend>åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆè‡ªå‹•æ¨æ¸¬ï¼æ‰‹å‹•å¤‰æ›´å¯ï¼‰</legend>
  <div class="grid2">
    <div>
      <h3>ã‚½ãƒ¼ã‚¹CSV</h3>
      <label>æ›²ID/URLåˆ— <select id="mapSourceId"></select></label>
      <label>ISRCåˆ— <select id="mapSourceISRC"></select></label>
      <label>æ›²ååˆ— <select id="mapSourceName"></select></label>
      <label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ— <select id="mapSourceVersion"></select></label>
      <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapSourceArtist"></select></label>
      <label>ãƒªãƒŸã‚­ã‚µãƒ¼åˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapSourceRemix"></select></label>
    </div>
    <div>
      <h3>åˆ†æãƒ‡ãƒ¼ã‚¿</h3>
      <label>æ›²ID/URLåˆ— <select id="mapAnalyticId"></select></label>
      <label>ISRCåˆ— <select id="mapAnalyticISRC"></select></label>
      <label>æ›²ååˆ— <select id="mapAnalyticName"></select></label>
      <label>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ—ï¼ˆä»»æ„ï¼‰ <select id="mapAnalyticArtist"></select></label>
    </div>
  </div>
  <hr>
  <div class="grid4">
    <label>plays 24h <select id="mapP24"></select></label>
    <label>plays 7d  <select id="mapP7"></select></label>
    <label>plays 28d <select id="mapP28"></select></label>
    <label>remixerï¼ˆåˆ†æå´ ä»»æ„ï¼‰ <select id="mapRemix"></select></label>
  </div>
  <div class="grid4">
    <label>save rate 24h <select id="mapSR24"></select></label>
    <label>save rate 7d  <select id="mapSR7"></select></label>
    <label>save rate 28d <select id="mapSR28"></select></label>
    <label>åœ°åŸŸï¼ˆä»»æ„ï¼‰ï¼šUK <select id="mapUK"></select> / US <select id="mapUS"></select> / EU <select id="mapEU"></select> / WORLD <select id="mapWO"></select></label>
  </div>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<script>
/*** å›ºå®šï¼šã‚¢ãƒ—ãƒªè¨­å®š ***/
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";

/*** util ***/
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};
const $=id=>document.getElementById(id);
const log=s=>{const el=$("log"); el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight;};
const clearLog=()=>{$("log").textContent="";};
const isAuthed=()=>!!localStorage.getItem(LS.acc)&&Date.now()<(+localStorage.getItem(LS.exp)||0)-5000;
function setStatus(){ $("status").textContent=isAuthed()?"æ¥ç¶šä¸­ï¼ˆOKï¼‰":"æœªæ¥ç¶š"; $("btnPreview").disabled=!filesReady()||!isAuthed(); $("btnRun").disabled=!filesReady()||!isAuthed(); }
function filesReady(){ return $("fileSource").files.length && $("fileAnalytics").files.length; }
const num=x=>{const s=String(x??0).replace(/[ %,ï¼Œ]/g,"");const v=parseFloat(s);return isFinite(v)?v:0;};
const NFKC=s=>String(s||"").normalize("NFKC");
const rmMarks=s=>NFKC(s).normalize("NFKD").replace(/[\p{M}]/gu,""); // ã‚¢ã‚¯ã‚»ãƒ³ãƒˆé™¤å»
const norm=s=>rmMarks(s).toLowerCase().replace(/[â€-â€’â€“â€”âˆ’]/g,"-").replace(/[â€˜â€™â€šâ€›â€œâ€â€â€Ÿ"]/g," ").replace(/[()ï¼»ï¼½\[\]{}ã€ã€‘]/g," ").replace(/&/g," and ").replace(/\s+/g," ").trim();

/*** auth ***/
async function startAuth(){
  const ver=crypto.getRandomValues(new Uint8Array(64)).reduce((s,b)=>s+String.fromCharCode(97+(b%26)),"");
  localStorage.setItem(LS.ver,ver);
  const ch=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(ver)).then(b=>btoa(String.fromCharCode(...new Uint8Array(b))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""));
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code"); u.searchParams.set("client_id",CLIENT_ID); u.searchParams.set("redirect_uri",REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256"); u.searchParams.set("code_challenge",ch); u.searchParams.set("scope",SCOPES);
  location.href=u.toString();
}
async function refreshTokenIfNeeded(){
  const exp=+localStorage.getItem(LS.exp||0); if(Date.now()<exp-5000) return;
  const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:rt,client_id:CLIENT_ID})});
  if(!res.ok){ log("âš ï¸ refreshå¤±æ•— "+res.status); return; }
  const j=await res.json(); localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000)); if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}
async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const gap=+$("gap").value||900; await new Promise(r=>setTimeout(r,gap));
  for(let a=0;a<5;a++){
    const res=await fetch("https://api.spotify.com"+path,{method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"},body:body?JSON.stringify(body):null});
    if(res.status===401){ await refreshTokenIfNeeded(); continue; }
    if(res.status===429){ const ra=+res.headers.get("Retry-After")||2; log(`â³429â†’${ra}så¾…æ©Ÿ`); await new Promise(r=>setTimeout(r,ra*1000)); continue; }
    if(!res.ok){ const t=await res.text(); throw new Error(`Spotify ${res.status}: ${t.slice(0,200)}`); }
    if(res.status===204) return null; return await res.json();
  }
  throw new Error("Spotify API max retries");
}

/*** ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼ï¼ˆXLSXã¯å…¨ã‚·ãƒ¼ãƒˆï¼‰ ***/
let sourceRows=[], analyticsRows=[];
function readCSV(file){ return new Promise((resolve,reject)=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject})); }
async function readXLSX_allSheets(file){
  const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:"array"});
  let rows=[], details=[];
  for(const name of wb.SheetNames){
    const json=XLSX.utils.sheet_to_json(wb.Sheets[name],{defval:""});
    json.forEach(r=>r.__sheet=name); rows=rows.concat(json); details.push(`${name}:${json.length}`);
  }
  return { rows, details, sheetNames: wb.SheetNames };
}

/*** åˆ—ãƒãƒƒãƒ”ãƒ³ã‚° ***/
const selects=["mapSourceId","mapSourceISRC","mapSourceName","mapSourceVersion","mapSourceArtist","mapSourceRemix","mapAnalyticId","mapAnalyticISRC","mapAnalyticName","mapAnalyticArtist","mapP24","mapP7","mapP28","mapSR24","mapSR7","mapSR28","mapRemix","mapUK","mapUS","mapEU","mapWO"];
function fillSelect(id, cols){ const el=$(id); const cur=el.value; el.innerHTML=""; const none=document.createElement("option"); none.value=""; none.textContent="ï¼ˆæœªä½¿ç”¨ï¼‰"; el.appendChild(none); cols.forEach(c=>{const o=document.createElement("option"); o.value=c; o.textContent=c; el.appendChild(o);}); if(cols.includes(cur)) el.value=cur; }
function collectColumns(rows){ const set=new Set(); rows.slice(0,200).forEach(r=>Object.keys(r).forEach(k=>set.add(k))); return [...set]; }
function autoPick(cols, aliases, forbid=[]){ const bad=new RegExp(forbid.join("|"),"i"); const L=cols.filter(c=>!bad.test(c)).map(c=>[c,norm(c)]); for(const a of aliases){ const n=norm(a); const hit=L.find(([o,nm])=>nm===n||nm.includes(n)); if(hit) return hit[0]; } return ""; }

function autoMap(){
  const sc=collectColumns(sourceRows), ac=collectColumns(analyticsRows);
  selects.forEach(id=>fillSelect(id, id.startsWith("mapSource")? sc: ac));
  $("mapSourceId").value     = autoPick(sc,["spotify_uri","track_uri","uri","url","ãƒªãƒ³ã‚¯"]);
  $("mapSourceISRC").value   = autoPick(sc,["isrc","isrc_code","isrcã‚³ãƒ¼ãƒ‰","ï¼©ï¼³ï¼²ï¼£"]);
  $("mapSourceName").value   = autoPick(sc,["track title","track_name","title","æ›²å","ã‚¿ã‚¤ãƒˆãƒ«"]);
  $("mapSourceVersion").value= autoPick(sc,["track version","version","ãƒãƒ¼ã‚¸ãƒ§ãƒ³"]);
  $("mapSourceArtist").value = autoPick(sc,["track primary artists","artists","artist","ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ"]);
  $("mapSourceRemix").value  = autoPick(sc,["remixer","ãƒªãƒŸã‚­ã‚µãƒ¼"]);

  $("mapAnalyticId").value     = autoPick(ac,["spotify_uri","track_uri","uri","url"]);
  $("mapAnalyticISRC").value   = autoPick(ac,["isrc"]);
  $("mapAnalyticName").value   = autoPick(ac,["title","track title","æ›²å","ã‚¿ã‚¤ãƒˆãƒ«"]);
  $("mapAnalyticArtist").value = autoPick(ac,["artist","artists","artist_name","ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ"],["rank_x","rank","score"]);

  $("mapP24").value=autoPick(ac,["plays_24h","p24","streams24"]);
  $("mapP7").value =autoPick(ac,["plays_7d","p7","streams7"]);
  $("mapP28").value=autoPick(ac,["plays_28d","p28","streams28"]);
  $("mapSR24").value=autoPick(ac,["save_rate_24h","sr24","save24"]);
  $("mapSR7").value =autoPick(ac,["save_rate_7d","sr7","save7"]);
  $("mapSR28").value=autoPick(ac,["save_rate_28d","sr28","save28"]);
}

/*** èª­è¾¼ ***/
async function loadFiles(){
  clearLog(); log("ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿â€¦");
  sourceRows=await readCSV($("fileSource").files[0]); log(`âœ… ã‚½ãƒ¼ã‚¹CSV: ${sourceRows.length} è¡Œ`);
  const f2=$("fileAnalytics").files[0];
  if(f2.name.toLowerCase().endsWith(".xlsx")){
    const res=await readXLSX_allSheets(f2); analyticsRows=res.rows; log(`âœ… åˆ†æ: XLSX åˆè¨ˆ ${analyticsRows.length} è¡Œ [${res.details.join(", ")}]`);
  }else{ analyticsRows=await readCSV(f2); log(`âœ… åˆ†æ: CSV ${analyticsRows.length} è¡Œ`); }
  autoMap(); $("btnPreview").disabled=!isAuthed(); $("btnRun").disabled=!isAuthed();
}

/*** ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ï¼ˆå†…å®¹ãƒ™ãƒ¼ã‚¹ï¼‰ ***/
const STOP=new Set(["feat","featuring","ft","vs","and","&","the","a","an","mix","remix","edit","version","vip","dub","club","radio","extended","original","instrumental","clean","dirty"]);
function tokensTitle(s){
  s=norm(s).replace(/ - /g," ").replace(/\((.*?)\)/g," $1 ").replace(/\[(.*?)\]/g," $1 ");
  return new Set(s.split(" ").filter(w=>w && !STOP.has(w)));
}
function canonVersion(s){
  s=norm(s);
  const map=[["original mix","original"],["orig mix","original"],["radio edit","radio"],["extended mix","extended"],["club mix","club"]];
  for(const [a,b] of map){ s=s.replace(a,b); }
  const vs=[]; const add=k=>{ if(k&& !vs.includes(k)) vs.push(k); };
  if(/original/.test(s)) add("original");
  if(/radio/.test(s)) add("radio");
  if(/extended/.test(s)) add("extended");
  if(/instrumental/.test(s)) add("instrumental");
  if(/acoustic/.test(s)) add("acoustic");
  if(/vip/.test(s)) add("vip");
  if(/dub/.test(s)) add("dub");
  if(/club/.test(s)) add("club");
  if(/remix|rmx/.test(s)) add("remix");
  // remixeråï¼ˆå˜èªï¼‰ã‚‚æˆ»ã™
  const rem = s.replace(/\b(original|radio|extended|instrumental|acoustic|vip|dub|club|remix|mix|edit)\b/g,"").trim();
  const remTok = tokensTitle(rem);
  return {kinds:new Set(vs), remTok};
}
function jaccard(a,b){ let inter=0; for(const x of a) if(b.has(x)) inter++; const union=a.size+b.size-inter; return union? inter/union:0; }

/*** ã‚½ãƒ¼ã‚¹å´ã®ç´¢å¼•ï¼ˆå®Œå…¨ä¸€è‡´ï¼‹å†…å®¹ç´¢å¼•ï¼‰ ***/
function extractTrackId(raw){ const s=String(raw||"").trim(); if(!s) return ""; let m=s.match(/spotify:track:([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/open\.spotify\.com\/track\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/\/track\/([A-Za-z0-9]{22})(?:\?|$)/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
function srcDisplayTitle(r){
  const t = String(r[$("mapSourceName").value]||"").trim();
  const v = String(r[$("mapSourceVersion").value]||"").trim();
  if(!v || /original\s*mix/i.test(v)) return t;
  return `${t} - ${v}`;
}
function buildSourceIndex(){
  const idCol=$("mapSourceId").value, isrcCol=$("mapSourceISRC").value;
  const idxExact=new Map(); // ID:/ISRC:/NM:
  const blob=[];            // ãƒ•ã‚¡ã‚¸ãƒ¼ç”¨
  for(const r of sourceRows){
    const id=idCol? extractTrackId(r[idCol]) : "";
    const isrc=isrcCol? String(r[isrcCol]||"").trim().toUpperCase() : "";
    const disp=srcDisplayTitle(r);
    const ttok=tokensTitle(disp);
    const vinfo=canonVersion(String(r[$("mapSourceVersion").value]||"")+" "+String(r[$("mapSourceRemix").value]||""));
    if(id)   idxExact.set("ID:"+id, r);
    if(isrc) idxExact.set("ISRC:"+isrc, r);
    idxExact.set("NM:"+norm(disp), r);
    blob.push({r, ttok, vinfo});
  }
  return {idxExact, blob};
}

/*** åˆ†æâ†’ã‚½ãƒ¼ã‚¹ çªåˆï¼ˆæ®µéšçš„ï¼šExactâ†’Fuzzyï¼‰ ***/
function parseAnalysisTitle(a){
  const name = String(a[$("mapAnalyticName").value]||"");
  const art  = String(a[$("mapAnalyticArtist").value]||"");
  const disp = name; // åˆ†æã¯ title ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹æƒ³å®š
  const ttok = tokensTitle(disp+" "+art);
  const vinfo= canonVersion(disp);
  return {disp, ttok, vinfo};
}
function fuzzyBest(sourceBlob, an, thresholds=[0.86,0.82,0.78]){
  let best=null;
  const titleWeight = an.vinfo.kinds.size? 0.75: 0.85; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãŒå¤šã„æ™‚ã¯ã‚¿ã‚¤ãƒˆãƒ«æ¯”é‡ã‚’å°‘ã—ä¸‹ã’ã‚‹
  const verWeight   = 1 - titleWeight;
  for(const thr of thresholds){
    best=null;
    for(const s of sourceBlob){
      const ts = jaccard(an.ttok, s.ttok);
      const vk = jaccard(an.vinfo.kinds, s.vinfo.kinds);
      const vr = jaccard(an.vinfo.remTok, s.vinfo.remTok);
      const ver = 0.6*vk + 0.4*vr;
      const score = titleWeight*ts + verWeight*ver;
      if(!best || score>best.score) best={s,score,ts,ver};
    }
    if(best && best.score>=thr) return {...best, thr};
  }
  return best; // ã‚¹ã‚³ã‚¢ã¯å‚è€ƒè¡¨ç¤º
}

function computeMatches(){
  const src=buildSourceIndex();
  const idA=$("mapAnalyticId").value, isrcA=$("mapAnalyticISRC").value;
  const rows=[], diag={exact:0, fuzzy:0, none:0, samples:[]};

  for(const a of analyticsRows){
    // 1) Exact
    const id=idA? extractTrackId(a[idA]) : "";
    const isc=isrcA? String(a[isrcA]||"").trim().toUpperCase() : "";
    const an=parseAnalysisTitle(a);

    let srow = (id && src.idxExact.get("ID:"+id)) || (isc && src.idxExact.get("ISRC:"+isc)) || src.idxExact.get("NM:"+norm(an.disp));
    let mode="exact", score=1;

    // 2) Fuzzy
    if(!srow){
      const best=fuzzyBest(src.blob, an);
      if(best && best.score>=0.78){ srow=best.s.r; mode="fuzzy"; score=best.score;
        if(diag.samples.length<6) diag.samples.push({title:an.disp, pick:srcDisplayTitle(srow), score:+best.score.toFixed(3), ts:+best.ts.toFixed(3), ver:+best.ver.toFixed(3)});
      }
    }

    if(srow){
      if(mode==="exact") diag.exact++; else diag.fuzzy++;
      rows.push({
        id: extractTrackId(srow[$("mapSourceId").value]) || "",
        isrc: String(srow[$("mapSourceISRC").value]||"").toUpperCase(),
        name: srcDisplayTitle(srow),
        artist: String(srow[$("mapSourceArtist").value]||""),
        remixer: String(srow[$("mapSourceRemix").value]||""),
        a, s: srow, _mode:mode, _score:score
      });
    }else{
      diag.none++;
      if(diag.samples.length<6) diag.samples.push({title:an.disp, pick:"(ãªã—)", score:0, ts:0, ver:0});
    }
  }
  log(`ğŸ” è¨ºæ–­: exact=${diag.exact}, fuzzy=${diag.fuzzy}, æœªä¸€è‡´=${diag.none}`);
  if(diag.samples.length){
    log("ğŸ§ª ã‚µãƒ³ãƒ—ãƒ«ï¼ˆä¸Šä½å€™è£œ/ã‚¹ã‚³ã‚¢ï¼‰:");
    diag.samples.forEach(x=> log(`  "${x.title}"  â†’  "${x.pick}"  [score=${x.score}, title=${x.ts}, ver=${x.ver}]`));
  }
  return rows;
}

/*** ã‚¹ã‚³ã‚¢è¨ˆç®— ***/
function computeScores(rows){
  const p24=$("mapP24").value, p7=$("mapP7").value, p28=$("mapP28").value;
  const s24=$("mapSR24").value, s7=$("mapSR7").value, s28=$("mapSR28").value;

  let max24=0,max7=0,max28=0; for(const r of rows){ max24=Math.max(max24,num(r.a[p24])); max7=Math.max(max7,num(r.a[p7])); max28=Math.max(max28,num(r.a[p28])); }
  for(const r of rows){
    const sr24=num(r.a[s24])/100, sr7=num(r.a[s7])/100, sr28=num(r.a[s28])/100;
    const pl24=max24? num(r.a[p24])/max24:0, pl7=max7? num(r.a[p7])/max7:0, pl28=max28? num(r.a[p28])/max28:0;
    const w=[0.5,0.3,0.2], wPop= +$("wPopularity").value || .55;
    const saveC=w[0]*sr24+w[1]*sr7+w[2]*sr28, playC=w[0]*pl24+w[1]*pl7+w[2]*pl28;
    r.score=wPop*saveC + (1-wPop)*playC;
  }
  rows.sort((a,b)=> b.score-a.score);
  return rows;
}

/*** ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ & æ›¸ãè¾¼ã¿ ***/
function layoutNoAdjacent(list, maxN){
  const out=[]; for(const it of list){ if(out.length>=maxN) break; const r=(it.remixer||"").toLowerCase(); if(out.length>0 && r && (out[out.length-1].remixer||"").toLowerCase()===r) continue; out.push(it); }
  for(const it of list){ if(out.length>=maxN) break; if(out.includes(it)) continue; out.push(it); }
  return out;
}
function filterByEdition(rows, ed){ const any=rows.some(r=> r.flags?.uk||r.flags?.us||r.flags?.eu||r.flags?.wo); if(!any) return rows; const k=ed.toLowerCase(); return rows.filter(r=> k==="world"? (r.flags.wo||r.flags.uk||r.flags.us||r.flags.eu): r.flags[k]); }
function extractPlaylistId(s){ s=String(s||""); let m=s.match(/playlist\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }

/*** URIè§£æ±ºï¼ˆIDâ†’ISRCâ†’åå‰æ¤œç´¢ï¼‰ ***/
const cache=new Map();
async function resolveUriOne(item){
  if(item.id && item.id.length===22) return "spotify:track:"+item.id;
  if(item.isrc){ const k="I:"+item.isrc; if(cache.has(k)) return cache.get(k);
    try{ const q=encodeURIComponent("isrc:"+item.isrc); const r=await spFetch(`/v1/search?q=${q}&type=track&limit=1`,"GET"); const t=r?.tracks?.items?.[0]; if(t?.id){ const u="spotify:track:"+t.id; cache.set(k,u); return u; } }catch{}
  }
  if(item.name){ try{ const q=encodeURIComponent(`track:${item.name}`); const r=await spFetch(`/v1/search?q=${q}&type=track&limit=1`,"GET"); const t=r?.tracks?.items?.[0]; if(t?.id) return "spotify:track:"+t.id; }catch{} }
  return "";
}
async function toUrisResolved(items){
  const uris=[]; let ok=0,ng=0; for(const it of items){ const u=await resolveUriOne(it); if(u){uris.push(u); ok++;} else {ng++;} } log(`ğŸ”— URIè§£æ±º: æˆåŠŸ${ok} / å¤±æ•—${ng}`); return uris;
}
async function replacePlaylist(pid, uris){
  const chunks=[]; for(let i=0;i<uris.length;i+=100) chunks.push(uris.slice(i,i+100));
  if(!chunks.length) chunks.push([]);
  await spFetch(`/v1/playlists/${pid}/tracks`,"PUT",{uris:chunks[0]}); log(`ğŸ§¹ ç½®æ›: ${chunks[0].length}ä»¶`);
  for(let i=1;i<chunks.length;i++){ await spFetch(`/v1/playlists/${pid}/tracks`,"POST",{uris:chunks[i]}); log(`â• è¿½åŠ : ${chunks[i].length}ä»¶`); }
}

/*** å®Ÿè¡Œ ***/
async function run(doPreview=false){
  try{
    clearLog();
    log("ğŸ” å†…å®¹ãƒ™ãƒ¼ã‚¹ï¼ˆãƒ•ã‚¡ã‚¸ãƒ¼ï¼‰çªåˆ â†’ ã‚¹ã‚³ã‚¢è¨ˆç®—â€¦");
    const matched=computeMatches();
    if(!matched.length){ log("â¹ï¸ ãƒãƒƒãƒ0ä»¶ â†’ åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ã‚„ã—ãã„å€¤ã‚’ç¢ºèª"); return; }
    const rows=computeScores(matched);
    const balancedN=+$("balancedN").value||150, finalN=+$("finalN").value||130;
    const top=rows.slice(0,balancedN);

    const mk=(name)=>{ const f=filterByEdition(top,name); const p=layoutNoAdjacent(f,finalN); log(`â€¢ ${name}: å€™è£œ${f.length} â†’ å‡ºåŠ›${p.length}`); return p; };
    const edUK=mk("UK"), edUS=mk("US"), edEU=mk("EU"), edWO=mk("WORLD");

    if(doPreview){
      const sample=[...edUK.slice(0,5),...edUS.slice(0,5),...edEU.slice(0,5),...edWO.slice(0,5)];
      const uris=await toUrisResolved(sample);
      log("ğŸ‘€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URIï¼ˆ"+uris.length+"ï¼‰\n"+uris.join("\n"));
      return;
    }

    if(!isAuthed()) throw new Error("Spotifyæœªæ¥ç¶šã§ã™ã€‚å…ˆã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ã€‚");
    const pidUK=extractPlaylistId($("plUK").value), pidUS=extractPlaylistId($("plUS").value), pidEU=extractPlaylistId($("plEU").value), pidWO=extractPlaylistId($("plWORLD").value);
    if(!(pidUK&&pidUS&&pidEU&&pidWO)) throw new Error("ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆURL/IDãŒä¸æ­£ã§ã™ã€‚");

    log("ğŸ”— URIè§£æ±ºâ€¦"); const uriUK=await toUrisResolved(edUK), uriUS=await toUrisResolved(edUS), uriEU=await toUrisResolved(edEU), uriWO=await toUrisResolved(edWO);
    log("ğŸš€ ä¸Šæ›¸ãé–‹å§‹â€¦"); await replacePlaylist(pidUK,uriUK); await replacePlaylist(pidUS,uriUS); await replacePlaylist(pidEU,uriEU); await replacePlaylist(pidWO,uriWO);
    log("âœ… å®Œäº†");
  }catch(e){ log("ğŸ’¥ ERROR: "+e.message); console.error(e); }
}

/*** events ***/
$("btnConnect").onclick=startAuth;
$("btnReset").onclick=()=>{ Object.values(LS).forEach(k=>localStorage.removeItem(k)); setStatus(); log("ğŸ§½ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤"); };
$("btnCheck").onclick=async()=>{ try{ await refreshTokenIfNeeded(); const me=await spFetch("/v1/me","GET"); $("status").textContent=`æ¥ç¶šä¸­ï¼ˆ${me.display_name||me.id}ï¼‰`; log("âœ… APIç¢ºèª OK"); }catch(e){ log("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+e.message);} };
$("fileSource").addEventListener("change",loadFiles);
$("fileAnalytics").addEventListener("change",loadFiles);
$("btnPreview").onclick=()=>run(true);
$("btnRun").onclick=()=>run(false);
setStatus(); log("Ready. 1) ã‚µã‚¤ãƒ³ã‚¤ãƒ³ â†’ 2) 2ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ â†’ 3) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè¨ºæ–­/ã‚¹ã‚³ã‚¢/å€™è£œï¼‰â†’ 4) ä¸Šæ›¸ã");
</script>
</body>
</html>
