<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spotify Auth (PKCE)</title>
<style>
  body{font-family:system-ui;margin:2rem}
  button{padding:.6rem 1rem;border-radius:8px;border:1px solid #999;background:#111;color:#fff;cursor:pointer}
</style>
</head>
<body>
<h1>Spotify 認証</h1>
<button id="connectBtn">Spotifyに接続</button>
<a href="./fulltracks_ultra_safe_v2.html?v=20250919" style="margin-left:1rem">戻る</a>
<script>
const CLIENT_ID="378ef0f44b36499abd10d118ddbddc98";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";

/* ★スコープは完全に要求しない（param自体を送らない） */
const SCOPE=""; // 空

function base64url(a){return btoa(String.fromCharCode.apply(null,new Uint8Array(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
async function sha256(s){return crypto.subtle.digest("SHA-256",new TextEncoder().encode(s));}
function rnd(len=64){const c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";return Array.from(crypto.getRandomValues(new Uint8Array(len)),x=>c[x%c.length]).join("");}

document.getElementById("connectBtn").onclick=async()=>{
  const verifier=rnd(); const challenge=base64url(await sha256(verifier)); const state=Math.random().toString(36).slice(2);
  sessionStorage.setItem("sp_pkce_verifier",verifier); sessionStorage.setItem("sp_state",state);
  localStorage.setItem("sp_pkce_verifier",verifier); localStorage.setItem("sp_state",state);

  const params={
    client_id:CLIENT_ID,
    response_type:"code",
    redirect_uri:REDIRECT_URI,
    code_challenge_method:"S256",
    code_challenge:challenge,
    state
  };
  // scopeは空なら付けない（Illegal scope予防）
  const usp=new URLSearchParams(params);
  if(SCOPE && SCOPE.trim()){ usp.set("scope", SCOPE.trim()); }

  const url="https://accounts.spotify.com/authorize?"+usp.toString();
  console.log("[auth] authorize URL:", url);
  location.href=url;
};
</script>
</body>
</html>
