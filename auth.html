<!doctype html>
<meta charset="utf-8">
<title>Spotify Sign-in (PKCE)</title>
<style>
  body{font:14px system-ui;color:#e6f1ff;background:#0b1220;padding:20px}
  pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;padding:12px;border-radius:8px}
  a,button{color:#cfe3ff}
</style>
<h1>Spotify Sign-in</h1>
<pre id="log">Preparing…</pre>
<script>
const LOG=(...a)=>{const el=document.getElementById('log');el.textContent+="\n"+a.join(' ')};

const CLIENT_ID = '5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI = 'https://npr2025.github.io/spotify-auth/callback.html';
const SCOPES = 'playlist-modify-public playlist-modify-private';
const AUTH_URL = 'https://accounts.spotify.com/authorize';

function b64url(bytes){
  return btoa(String.fromCharCode.apply(null, new Uint8Array(bytes)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function sha256(str){
  const enc=new TextEncoder(); const data=enc.encode(str);
  const buf=await crypto.subtle.digest('SHA-256', data);
  return b64url(buf);
}
function randString(len=64){
  const arr=new Uint8Array(len); crypto.getRandomValues(arr);
  return Array.from(arr).map(x=>('0'+(x%256).toString(16)).slice(-2)).join('');
}
(async ()=>{
  try{
    // 元のページに戻るための戻り先（任意）
    sessionStorage.setItem('return_to', document.referrer || '/');

    // PKCE: code_verifier / code_challenge
    const code_verifier = randString(96);
    const code_challenge = await sha256(code_verifier);
    sessionStorage.setItem('code_verifier', code_verifier);

    // state にはCSRFトークン＋フォールバックとして verifier のダイジェストも入れる
    const state_raw = randString(24);
    const state = state_raw;

    const params = new URLSearchParams({
      client_id: CLIENT_ID,
      response_type: 'code',
      redirect_uri: REDIRECT_URI,
      code_challenge_method: 'S256',
      code_challenge,
      scope: SCOPES,
      state
    });

    const url = `${AUTH_URL}?${params.toString()}`;
    LOG('Redirecting to Spotify…');
    location.href = url;
  }catch(e){
    LOG('ERROR:', e.message);
  }
})();
</script>
