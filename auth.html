<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth (PKCE)</title>
<body style="font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; max-width:720px; margin:40px auto">
  <h1>Spotify Auth</h1>
  <p id="msg">Click to sign in with Spotify.</p>
  <div style="display:flex; gap:10px; flex-wrap:wrap">
    <button id="btn">Sign in with Spotify</button>
    <button id="clr">Clear session</button>
  </div>
<script>
const CLIENT_ID    = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI = "https://npr2025.github.io/spotify-auth/callback.html";
// プレイリスト作成(非公開/公開)に必要なスコープ
const SCOPES = [
  "playlist-modify-private",
  "playlist-modify-public",
  "user-read-email",
  "user-read-private"
].join(" ");

function ab2b64(a){return btoa(String.fromCharCode(...new Uint8Array(a))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");}
async function sha256(t){const enc=new TextEncoder().encode(t);return await crypto.subtle.digest("SHA-256",enc);}

document.getElementById("btn").onclick = async () => {
  const verifier = ab2b64(crypto.getRandomValues(new Uint8Array(64)));
  const challenge = ab2b64(await sha256(verifier));
  const state = ab2b64(crypto.getRandomValues(new Uint8Array(24)));

  sessionStorage.setItem("pkce_verifier", verifier);
  sessionStorage.setItem("pkce_state", state);

  const p = new URLSearchParams({
    response_type: "code",
    client_id: CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    scope: SCOPES,
    code_challenge_method: "S256",
    code_challenge: challenge,
    state
  });
  location.href = "https://accounts.spotify.com/authorize?" + p.toString();
};

document.getElementById("clr").onclick = () => {
  sessionStorage.clear(); localStorage.clear();
  document.getElementById("msg").textContent = "Cleared. Ready.";
};
</script>
</body>
</html>
