<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spotify CSV Auditor — A–E Filler (TDCS, Grouped Markets, i18n + CSV/PDF)</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<!-- deps -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{
    --bd:#e5e7eb;--fg:#111;--mut:#555;--ok:#0a7a2f;--ng:#b00020;--bg:#fafafa;--ink:#111;
    --accent:#111;--chip:#f6f6f6
  }
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 10px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  label{font-size:12px;color:var(--mut);display:block;margin:0 0 6px}
  input[type=text],select,textarea{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px;background:#fff}
  textarea{min-height:100px;resize:vertical}
  input[type=file]{border:1px dashed var(--bd);background:#fff;padding:12px;border-radius:10px;width:100%}
  .btn{padding:.65rem 1rem;border:1px solid var(--ink);background:var(--ink);color:#fff;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#fff;color:#111;border:1px solid var(--bd)}
  .pill{display:inline-block;border:1px solid var(--bd);padding:.25rem .6rem;border-radius:999px;font-size:12px;margin-right:6px;background:var(--chip)}
  .mut{color:var(--mut)} .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);text-align:left;padding:8px 6px;vertical-align:top}
  th{background:#f6f6f6;position:sticky;top:0;z-index:1}
  .prog{height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:#111;transition:width .25s}
  .log{max-height:280px;overflow:auto;border:1px solid var(--bd);border-radius:10px;padding:8px;background:#fff}
  .log .line{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace;font-size:12px;padding:2px 0;border-bottom:1px dashed #f0f0f0}
  .tag{display:inline-block;padding:.1rem .5rem;border:1px solid var(--bd);border-radius:6px;font-size:11px;background:#fff;margin-right:6px}
  .badge{display:inline-block;padding:.1rem .5rem;border-radius:6px;font-size:11px}
  .badge.ok{background:#eaf6ee;color:#166534}
  .badge.ng{background:#fdeaea;color:#991b1b}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Spotify CSV Auditor — A–E Filler（TDCS, 固定4マーケット, i18n+CSV/PDF）</h1>
    <div class="row">
      <label class="mut" style="margin:0">
        <span id="lang_label" class="mut" style="font-size:12px;margin-right:6px">Language</span>
        <select id="lang_sel" style="width:auto">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Auth -->
  <div class="card">
    <div class="grid">
      <div>
        <label id="lbl_client">Client ID（Spotify Developer）</label>
        <input id="client_id" type="text" placeholder="e.g., f5b88dacf6374e0485971c59d0f528bc"/>
      </div>
      <div>
        <label id="lbl_redirect">Redirect URI（Developer Dashboardで完全一致）</label>
        <input id="redirect_uri" type="text" placeholder="https://npr2025.github.io/spotify-auth/csv_auditor.html"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn_auth" class="btn">Spotifyに接続（PKCE／スコープなし）</button>
      <span id="tok_status" class="pill mut">access_token: none</span>
      <button id="btn_clear" class="btn btn-ghost">保存トークン削除</button>
    </div>
    <div id="hint_auth" class="mut" style="font-size:12px;margin-top:6px">
      ※ scope送信なし＝公開エンドポイント（search/album/track GET）のみ使用。<br/>
      ※ Redirect URI は <b>Developer Dashboardに完全一致</b>で登録（末尾の <span class="mono">.html</span> まで）。<br/>
      ※ <span class="mono">code_verifier</span> は localStorage に保存して <span class="mono">alert_no_verifier</span> を回避。
    </div>
  </div>

  <!-- CSV Input & Mapping -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill">CSV</span>
        <span class="mut" id="csv_hint">アルバム一覧CSVを読み込み → 入力順のまま処理（CSVに無いタイトルは一切追加しない）</span>
      </div>
      <div class="row">
        <input id="ignore_djmix" type="checkbox" checked>
        <label for="ignore_djmix" id="lbl_ignore_dj" style="margin:0">DJミックス表記の曲は無視</label>
      </div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div>
        <label id="lbl_csv">CSVファイルを選択</label>
        <input id="csv_file" type="file" accept=".csv,text/csv"/>
      </div>
      <div>
        <label id="lbl_expected">期待アーティストID（PrimaryであるべきID／カンマ区切り）</label>
        <input id="expected_ids" type="text" value="55fvQ5I2IZUfcFT2DV02T3"/>
      </div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div>
        <label id="lbl_map_album">アルバムタイトル列（必須）</label>
        <select id="sel_album_col"></select>
      </div>
      <div>
        <label id="lbl_map_track">トラックタイトル列（任意／該当無しなら未選択）</label>
        <select id="sel_track_col"><option value="">—</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btn_run" class="btn" disabled>解析を実行</button>
      <button id="btn_csv_out" class="btn btn-ghost" disabled>結果CSVをダウンロード</button>
      <button id="btn_urls" class="btn btn-ghost" disabled>アルバムURL一覧（改行区切り）</button>
      <button id="btn_pdf" class="btn btn-ghost" disabled>PDFをダウンロード</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="prog" style="flex:1"><div class="bar" id="bar"></div></div>
      <span class="mut mono" id="prog_txt">0%</span>
    </div>
    <div class="log" id="log" style="margin-top:8px"></div>
  </div>

  <!-- Results -->
  <div class="card" id="results_card">
    <div class="row"><div class="pill" id="pill_results">結果</div><span id="summary" class="mut"></span></div>
    <div id="results"></div>
  </div>

  <div class="card">
    <div class="pill" id="pill_markets">Markets: 固定4グループ</div>
    <div class="mut" id="hint_markets" style="font-size:12px;margin-top:6px">
      • United States, Canada ／ • United Kingdom, Ireland ／ • European Union（UK/IE除外）／ • Worldwide（Europe＋US＋CA除外）
    </div>
  </div>
</div>

<script>
/* ===================== i18n ===================== */
const i18n = {
  en:{
    title:"Spotify CSV Auditor — A–E Filler (TDCS, Grouped Markets, i18n + CSV/PDF)",
    lang_label:"Language",
    client:"Client ID (Spotify Developer)",
    redirect:"Redirect URI (must exactly match in Developer Dashboard)",
    auth_btn:"Connect to Spotify (PKCE / no scope)",
    clear_btn:"Clear saved token",
    csv_hint:"Load an album list CSV → processed strictly in the CSV's order (absolutely no titles added beyond CSV).",
    csv_label:"Choose CSV file",
    expected:"Expected artist IDs (should be the only primaries) — comma-separated",
    map_album:"Album title column (required)",
    map_track:"Track title column (optional)",
    ignore_dj:"Ignore tracks with DJ-mix notation",
    run:"Run analysis",
    csv_out:"Download results CSV",
    urls_out:"Album URLs (newline list)",
    pdf:"Download PDF",
    results:"Results",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    parsing:"Parsing…",
    parsed:(n)=>`${n} row(s) processed. You can export CSV/URLs/PDF.`,
    tbl_core:"A–E output (per CSV row, in order)",
    tbl_market:"Grouped market availability (per album)",
    cols:{
      A:"Album title",
      B:"Spotify Available",
      C:"Spotify Album URL",
      D:"Spotify Track URL",
      E:"Primary structure (pipe-separated)"
    },
    markets_cols:["US/CA","UK/IE","EU (ex UK/IE)","World (ex EU/US/CA)"],
    status:{
      reading:"[CSV] loaded: {n} row(s).",
      searching:'[{i}/{n}] search album: "{t}"',
      found:'[{i}/{n}] found album: {name} — {id}',
      notfound:'[{i}/{n}] NOT FOUND',
      tracks:'[{i}/{n}] fetch tracks: {count} items',
      matchedTrack:'[{i}/{n}] matched track: {name}',
      exportReady:"[OK] export buttons enabled."
    }
  },
  ja:{
    title:"Spotify CSV Auditor — A–E Filler（TDCS／固定4マーケット／i18n＋CSV/PDF）",
    lang_label:"表示言語",
    client:"Client ID（Spotify Developer）",
    redirect:"Redirect URI（Developer Dashboardで完全一致）",
    auth_btn:"Spotifyに接続（PKCE／スコープなし）",
    clear_btn:"保存トークン削除",
    csv_hint:"アルバム一覧CSVを読み込み → CSVの行順のまま処理（CSVに無いタイトルは一切追加しない）",
    csv_label:"CSVファイルを選択",
    expected:"期待アーティストID（プライマリーであるべきID）※カンマ区切り",
    map_album:"アルバムタイトル列（必須）",
    map_track:"トラックタイトル列（任意）",
    ignore_dj:"DJミックス表記の曲は無視",
    run:"解析を実行",
    csv_out:"結果CSVをダウンロード",
    urls_out:"アルバムURL一覧（改行区切り）",
    pdf:"PDFをダウンロード",
    results:"結果",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    parsing:"解析中…",
    parsed:(n)=>`${n} 行を解析完了。CSV／URL一覧／PDFを出力できます。`,
    tbl_core:"A–E 出力（CSV行順）",
    tbl_market:"グループ化マーケット（アルバム別）",
    cols:{
      A:"Album title",
      B:"Spotify Available",
      C:"Spotify Album URL",
      D:"Spotify Track URL",
      E:"Primary構造（' | ' 区切り）"
    },
    markets_cols:["US/CA","UK/IE","EU（UK/IE除外）","World（EU/US/CA除外）"],
    status:{
      reading:"[CSV] 読み込み: {n} 行",
      searching:'[{i}/{n}] 検索: 「{t}」',
      found:'[{i}/{n}] ヒット: {name} — {id}',
      notfound:'[{i}/{n}] 見つからず',
      tracks:'[{i}/{n}] トラック取得: {count} 件',
      matchedTrack:'[{i}/{n}] マッチ: {name}',
      exportReady:"[OK] エクスポート準備完了"
    }
  }
};
const storage = {
  get k(){ return 'sp_csv_auditor_tdcs_v1'; },
  load(){ try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}} },
  save(obj){ localStorage.setItem(this.k, JSON.stringify(obj||{})); }
};
const state = Object.assign(
  {lang:'ja',access_token:null,expires_at:0,code_verifier:null,client_id:"",redirect_uri:""},
  storage.load()
);
const $ = sel => document.querySelector(sel);
function t(){ return i18n[state.lang]||i18n.ja; }
function applyLang(){
  const L = t();
  document.title = L.title;
  $("#title").textContent = L.title;
  $("#lang_label").textContent = L.lang_label;
  $("#lbl_client").textContent = L.client;
  $("#lbl_redirect").textContent = L.redirect;
  $("#btn_auth").textContent = L.auth_btn;
  $("#btn_clear").textContent = L.clear_btn;
  $("#csv_hint").textContent = L.csv_hint;
  $("#lbl_csv").textContent = L.csv_label;
  $("#lbl_expected").textContent = L.expected;
  $("#lbl_map_album").textContent = L.map_album;
  $("#lbl_map_track").textContent = L.map_track;
  $("#lbl_ignore_dj").textContent = L.ignore_dj;
  $("#btn_run").textContent = L.run;
  $("#btn_csv_out").textContent = L.csv_out;
  $("#btn_urls").textContent = L.urls_out;
  $("#btn_pdf").textContent = L.pdf;
  $("#pill_results").textContent = L.results;
  $("#pill_markets").textContent = "Markets: 固定4グループ";
  $("#hint_markets").innerHTML = state.lang==='ja'
    ? "• United States, Canada ／ • United Kingdom, Ireland ／ • European Union（UK/IE除外）／ • Worldwide（Europe＋US＋CA除外）"
    : "• United States, Canada / • United Kingdom, Ireland / • European Union (excl. UK & Ireland) / • Worldwide (excl. Europe, US, Canada)";
  setTokStatus();
}
function saveState(){ storage.save({lang:state.lang,access_token:state.access_token,expires_at:state.expires_at,code_verifier:state.code_verifier,client_id:state.client_id,redirect_uri:state.redirect_uri}); }
function setTokStatus(msg){
  const ok = state.access_token && Date.now()<state.expires_at;
  $("#tok_status").textContent = msg || (ok ? t().token_ok : t().token_none);
  $("#tok_status").className = "pill " + (ok?"ok":"mut");
  $("#btn_run").disabled = !ok || !loadedCSV.rows.length || !loadedCSV.albumCol;
}

/* ===================== PKCE (no scope) ===================== */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
async function sha256(buf){
  const enc = new TextEncoder().encode(buf);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function randStr(len=64){ const a=new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a).map(b=>("0"+(b&255).toString(16)).slice(-2)).join(''); }
async function startAuth(){
  const client_id = $("#client_id").value.trim(); const redirect_uri = $("#redirect_uri").value.trim();
  if(!client_id || !redirect_uri){ alert(state.lang==='en'?"Enter Client ID & Redirect URI":"Client ID と Redirect URI を入力してください"); return; }
  state.client_id = client_id; state.redirect_uri = redirect_uri; saveState();
  const code_verifier = randStr(64);
  const code_challenge = await sha256(code_verifier);
  state.code_verifier = code_verifier; saveState();
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id", client_id);
  url.searchParams.set("redirect_uri", redirect_uri);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", code_challenge);
  location.assign(url.toString());
}
async function handleCallback(){
  const params = new URLSearchParams(location.search);
  const code = params.get("code"); if(!code) return;
  const client_id = $("#client_id").value.trim() || state.client_id;
  const redirect_uri = $("#redirect_uri").value.trim() || state.redirect_uri;
  if(!client_id || !redirect_uri){ setTokStatus("invalid_client"); alert(state.lang==='en'?"Missing client_id/redirect_uri. Re-auth.":"client_id / redirect_uri が未保存です。再認可してください。"); return; }
  if(!state.code_verifier){ setTokStatus("error: no verifier"); alert(state.lang==='en'?"Missing code_verifier. Start auth again.":"code_verifier が失われました。接続からやり直してください。"); return; }
  try{
    const body = new URLSearchParams({grant_type:"authorization_code",code,redirect_uri,client_id,code_verifier:state.code_verifier});
    const res = await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    if(!res.ok){ const ttxt = await res.text(); setTokStatus("token error"); console.error(ttxt); alert((state.lang==='en'?"Token exchange failed:\n":"トークン交換失敗:\n")+ttxt); return; }
    const json = await res.json();
    state.access_token = json.access_token; state.expires_at = Date.now() + ((json.expires_in||3600)*1000) - 5000;
    saveState(); history.replaceState({}, "", location.pathname); setTokStatus();
  }catch(e){ setTokStatus("token error"); alert(e.message); }
}
function clearToken(){ state.access_token=null; state.expires_at=0; state.code_verifier=null; saveState(); setTokStatus(); }
async function spGET(path, params={}){
  const qs = new URLSearchParams(params); const url = `https://api.spotify.com/v1${path}?${qs.toString()}`;
  for(;;){
    const res = await fetch(url,{headers:{Authorization:`Bearer ${state.access_token}`}});
    if(res.status===429){ const retry=parseInt(res.headers.get("Retry-After")||"1",10); await sleep((retry+0.2)*1000); continue; }
    if(!res.ok){ const txt=await res.text(); throw new Error(`[HTTP ${res.status}] ${txt}`); }
    return res.json();
  }
}

/* ===================== CSV load / mapping ===================== */
const loadedCSV = { headers:[], rows:[], albumCol:"", trackCol:"" };
function logLine(s){ const el=document.createElement("div"); el.className="line"; el.textContent=s; $("#log").appendChild(el); el.scrollIntoView(false); }
function setProgress(i,n){ const pct = n? Math.floor(i*100/n) : 0; $("#bar").style.width = pct+"%"; $("#prog_txt").textContent = pct+"%"; }

$("#csv_file").addEventListener("change",(e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:(rs)=>{
    loadedCSV.headers = rs.meta.fields||[];
    loadedCSV.rows = rs.data||[];
    // mapping guesses
    const heads = loadedCSV.headers.map(h=>h.trim());
    const find = (...cands)=> heads.find(h=>cands.map(x=>x.toLowerCase()).includes(h.toLowerCase())) || "";
    loadedCSV.albumCol = find("Album title","album","title","Album","アルバム","アルバム名");
    loadedCSV.trackCol = find("Track title","track","曲名","トラック");
    // populate selects
    const selA = $("#sel_album_col"); selA.innerHTML="";
    heads.forEach(h=>{ const o=document.createElement("option"); o.value=h; o.textContent=h; selA.appendChild(o); });
    if(loadedCSV.albumCol) selA.value = loadedCSV.albumCol;
    const selT = $("#sel_track_col"); selT.innerHTML="<option value=''>—</option>";
    heads.forEach(h=>{ const o=document.createElement("option"); o.value=h; o.textContent=h; selT.appendChild(o); });
    if(loadedCSV.trackCol) selT.value = loadedCSV.trackCol;
    logLine((t().status.reading||"").replace("{n}", String(loadedCSV.rows.length)));
    setTokStatus();
  }});
});
$("#sel_album_col").addEventListener("change",(e)=>{ loadedCSV.albumCol = e.target.value; setTokStatus(); });
$("#sel_track_col").addEventListener("change",(e)=>{ loadedCSV.trackCol = e.target.value; });

/* ===================== Helpers ===================== */
function normalizeName(s){
  return (s||"").toLowerCase()
    .replace(/\s+/g,' ').replace(/\s*[-–—]\s*/g,'-')
    .replace(/\((?:remaster|remix|edit|version|mix|radio|extended)[^)]*\)/g,'')
    .replace(/\[(?:remaster|remix|edit|version|mix|radio|extended)[^\]]*\]/g,'')
    .trim();
}
function djMixLike(name){ const n=(name||"").toLowerCase(); return n.includes("dj mix")||n.includes("continuous mix")||n.includes("mixed"); }
function joinArtistsPipe(arr){ return (arr||[]).map(a=>a?.name||"").filter(Boolean).join(" | "); }

/* ===== Markets (fixed groups) ===== */
const EU27_NO_UK_IE = new Set(["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE"]);
const EUROPE_WIDE = new Set([...EU27_NO_UK_IE,"IE","GB","NO","IS","CH","AL","BA","ME","MK","RS","UA","MD","BY","XK","LI"]);
const ALL_MARKETS = new Set([
  "AD","AE","AL","AM","AO","AR","AT","AU","AZ","BA","BB","BD","BE","BF","BG","BH","BI","BJ","BN","BO","BR","BS","BT","BW","BY","BZ",
  "CA","CD","CG","CH","CI","CL","CM","CO","CR","CV","CW","CY","CZ",
  "DE","DJ","DK","DM","DO","DZ","EC","EE","EG","ES","ET",
  "FI","FJ","FM","FR","GA","GB","GD","GE","GH","GM","GN","GQ","GR","GT","GW","GY",
  "HK","HN","HR","HT","HU","ID","IE","IL","IN","IQ","IS","IT","JM","JO","JP","KE","KG","KH","KI","KM","KN","KR","KW","KZ",
  "LA","LB","LC","LI","LK","LR","LS","LT","LU","LV","LY","MA","MC","MD","ME","MG","MH","MK","ML","MN","MO","MR","MT","MU","MV","MW","MX","MY","MZ",
  "NA","NE","NG","NI","NL","NO","NP","NR","NZ",
  "OM","PA","PE","PG","PH","PK","PL","PS","PT","PW","PY",
  "QA","RO","RS","RU","RW","SA","SB","SC","SE","SG","SI","SK","SL","SM","SN","SR","ST","SV","SZ",
  "TD","TG","TH","TJ","TL","TN","TO","TR","TT","TV","TW","TZ",
  "UA","UG","US","UY","UZ","VC","VE","VN","VU",
  "WS","XK","ZA","ZM","ZW"
]);
const GROUPS = [
  { key:"US_CA", label:"US/CA", codes:new Set(["US","CA"]) },
  { key:"UK_IE", label:"UK/IE", codes:new Set(["GB","IE"]) },
  { key:"EU_EX_UK_IE", label:"EU (ex UK/IE)", codes:new Set([...EU27_NO_UK_IE]) },
  { key:"WORLD_EX_EU_US_CA", label:"World (ex EU/US/CA)", codes:(()=>{ const ex=new Set([...EUROPE_WIDE,"US","CA"]); return new Set([...ALL_MARKETS].filter(c=>!ex.has(c))); })() }
];
function groupFlags(avSet){
  const flags = {};
  for(const g of GROUPS){
    let hits=0; for(const c of g.codes){ if(avSet.has(c)) hits++; }
    flags[g.key] = hits>0 ? "Y" : "N";
  }
  return flags;
}

/* ===================== Main run ===================== */
let OUT_ROWS = []; // core A–E
let OUT_MARKETS = []; // per album markets
let OUT_URL_LIST = []; // album url list

async function run(){
  $("#results").innerHTML = "";
  OUT_ROWS = []; OUT_MARKETS = []; OUT_URL_LIST = [];
  $("#btn_csv_out").disabled = true; $("#btn_urls").disabled = true; $("#btn_pdf").disabled = true;
  $("#summary").textContent = t().parsing;
  $("#log").innerHTML = "";
  setProgress(0,1);

  const primaryMarket = "US";
  const expectedIDs = new Set($("#expected_ids").value.split(",").map(s=>s.trim()).filter(Boolean));
  const ignoreDJ = $("#ignore_djmix").checked;
  const rows = loadedCSV.rows;
  const albumCol = loadedCSV.albumCol; const trackCol = loadedCSV.trackCol||"";
  const total = rows.length;

  // Table containers
  const coreTable = document.createElement("div");
  const M = t();
  coreTable.innerHTML = `
    <h3>${M.tbl_core}</h3>
    <table id="tbl_core"><thead><tr>
      <th>${M.cols.A}</th><th>${M.cols.B}</th><th>${M.cols.C}</th><th>${M.cols.D}</th><th>${M.cols.E}</th>
      <th>${M.markets_cols[0]}</th><th>${M.markets_cols[1]}</th><th>${M.markets_cols[2]}</th><th>${M.markets_cols[3]}</th>
    </tr></thead><tbody></tbody></table>`;
  $("#results").appendChild(coreTable);

  const marketTable = document.createElement("div");
  marketTable.innerHTML = `<h3>${M.tbl_market}</h3><table id="tbl_market"><thead><tr>
    <th>Album</th><th>Album ID</th>
    <th>${M.markets_cols[0]}</th><th>${M.markets_cols[1]}</th><th>${M.markets_cols[2]}</th><th>${M.markets_cols[3]}</th>
    <th>Status</th>
  </tr></thead><tbody></tbody></table>`;
  $("#results").appendChild(marketTable);

  const tbodyCore = $("#tbl_core tbody");
  const tbodyMarket = $("#tbl_market tbody");

  const addRow = (cells)=>`<tr>${cells.map(c=>`<td>${c}</td>`).join("")}</tr>`;

  for(let i=0;i<total;i++){
    setProgress(i,total);
    const albumTitle = String(rows[i][albumCol]||"").trim();
    const trackTitle = trackCol ? String(rows[i][trackCol]||"").trim() : "";

    if(!albumTitle){ logLine(`[${i+1}/${total}] (empty album title) — skip`); continue; }

    logLine((M.status.searching||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{t}",albumTitle));

    let album=null, albumId="", albumName="", albumURL="", available="NO", trackURL="";
    let avSet = new Set();
    let primaryStruct = ""; // ← NEW: pipe-separated structure

    try{
      const res = await spGET(`/search`, { q: `album:"${albumTitle}"`, type:"album", limit:5, market: primaryMarket });
      const items = (res.albums?.items)||[];
      const targetNorm = normalizeName(albumTitle);
      let best=null;
      for(const a of items){
        if(normalizeName(a.name)===targetNorm){ best=a; break; }
        if(!best) best=a;
      }
      if(best){
        album = await spGET(`/albums/${best.id}`, { market: primaryMarket, limit:1 });
        albumId = album.id; albumName = album.name;
        albumURL = `https://open.spotify.com/album/${albumId}`;
        available = "YES";
        avSet = new Set(album.available_markets||[]);
        logLine((M.status.found||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{name}",albumName).replace("{id}",albumId));
      }else{
        logLine((M.status.notfound||"").replace("{i}",String(i+1)).replace("{n}",String(total)));
      }
    }catch(e){
      logLine(`[ERR ${i+1}/${total}] search ${e.message}`);
    }

    let offendersCount = 0;
    if(album){
      try{
        // gather album tracks (for track match and primary evaluation)
        let tracks = [];
        let next = album.tracks;
        while(next){
          tracks.push(...(next.items||[]));
          if(next.next){
            const u = new URL(next.next); const params = Object.fromEntries(u.searchParams.entries());
            next = await spGET(`/albums/${albumId}/tracks`, params);
          }else next=null;
        }
        logLine((M.status.tracks||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{count}",String(tracks.length)));

        // track match (if CSV provided)
        let hit = null;
        if(trackTitle){
          const normTarget = normalizeName(trackTitle);
          hit = tracks.find(t=> normalizeName(t.name)===normTarget );
          if(!hit){
            hit = tracks.find(t=> normalizeName(t.name).includes(normTarget.slice(0,Math.max(3, Math.floor(normTarget.length*0.6)))) );
          }
          if(hit){
            trackURL = `https://open.spotify.com/track/${hit.id}`;
            logLine((M.status.matchedTrack||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{name}",hit.name));
          }
        }

        // ==== Primary structure detection ====
        if(hit && hit.artists?.length){
          primaryStruct = joinArtistsPipe(hit.artists);
        }else if(album.artists?.length){
          primaryStruct = joinArtistsPipe(album.artists);
        }else{
          primaryStruct = "";
        }

        // offender check (keep for Status column)
        const tracksFull = tracks;
        for(const t of tracksFull){
          if(ignoreDJ && djMixLike(t.name)) continue;
          const firstId = (t.artists?.[0]?.id)||"";
          if(firstId && !expectedIDs.has(firstId)) offendersCount++;
        }
      }catch(e){
        logLine(`[ERR ${i+1}/${total}] album/track fetch ${e.message}`);
      }
    }

    // group flags
    const flags = groupFlags(avSet);
    const fUS = flags.US_CA||"N", fUK = flags.UK_IE||"N", fEU = flags.EU_EX_UK_IE||"N", fWW = flags.WORLD_EX_EU_US_CA||"N";

    // A–E row object（E はプライマリー構造）
    const coreObj = {
      A: albumTitle,
      B: available,
      C: albumURL,
      D: trackURL,
      E: primaryStruct
    };
    OUT_ROWS.push(Object.assign({}, coreObj, {US_CA:fUS,UK_IE:fUK,EU_EX_UK_IE:fEU,WORLD_EX_EU_US_CA:fWW}));

    // tables
    tbodyCore.insertAdjacentHTML("beforeend", addRow([
      esc(albumTitle),
      available==="YES" ? `<span class="badge ok">YES</span>` : `<span class="badge ng">NO</span>`,
      albumURL ? `<a href="${albumURL}" target="_blank">${albumURL}</a>` : "",
      trackURL ? `<a href="${trackURL}" target="_blank">${trackURL}</a>` : "",
      esc(primaryStruct),
      fUS, fUK, fEU, fWW
    ]));

    if(album){
      OUT_MARKETS.push({album:albumName,id:albumId,US_CA:fUS,UK_IE:fUK,EU_EX_UK_IE:fEU,WORLD_EX_EU_US_CA:fWW,status:offendersCount>0?"NG":"OK"});
      tbodyMarket.insertAdjacentHTML("beforeend", addRow([
        esc(albumName), `<span class="mono">${albumId}</span>`, fUS, fUK, fEU, fWW,
        offendersCount>0?`<span class="badge ng">NG</span>`:`<span class="badge ok">OK</span>`
      ]));
      OUT_URL_LIST.push(albumURL);
    }

    await sleep(80); // smooth UI
  }

  setProgress(total,total);
  $("#summary").textContent = t().parsed(OUT_ROWS.length);
  $("#btn_csv_out").disabled = OUT_ROWS.length===0;
  $("#btn_urls").disabled = OUT_URL_LIST.length===0;
  $("#btn_pdf").disabled = false;
  logLine(t().status.exportReady||"[OK] export ready");
}

// HTML esc
function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

/* ===================== Exports ===================== */
function toCSV(objs, headers){
  if(!objs.length) return "";
  const cols = headers && headers.length ? headers : Object.keys(objs[0]);
  const escv = v => {
    if(v==null) return "";
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const lines = [cols.join(",")];
  for(const o of objs){ lines.push(cols.map(h=>escv(o[h])).join(",")); }
  return lines.join("\n");
}
function dl(data, name, mime){
  const blob = new Blob([data],{type:mime||"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.click();
}
$("#btn_csv_out").addEventListener("click", ()=>{
  const L = t();
  const headers = [
    L.cols.A, L.cols.B, L.cols.C, L.cols.D, L.cols.E,
    "US_CA","UK_IE","EU_EX_UK_IE","WORLD_EX_EU_US_CA"
  ];
  const remap = OUT_ROWS.map(r=>({
    [L.cols.A]: r.A, [L.cols.B]: r.B, [L.cols.C]: r.C, [L.cols.D]: r.D, [L.cols.E]: r.E,
    "US_CA": r.US_CA, "UK_IE": r.UK_IE, "EU_EX_UK_IE": r.EU_EX_UK_IE, "WORLD_EX_EU_US_CA": r.WORLD_EX_EU_US_CA
  }));
  const csv = toCSV(remap, headers);
  dl(csv, "spotify_csv_audit_A-E.csv", "text/csv;charset=utf-8");
});
$("#btn_urls").addEventListener("click", ()=>{
  const uniq = Array.from(new Set(OUT_URL_LIST.filter(Boolean)));
  dl(uniq.join("\n"), "spotify_album_urls.txt", "text/plain;charset=utf-8");
});
$("#btn_pdf").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:"pt", format:"a4"});
  const a4w = 595.28, margin = 24;
  const node = document.querySelector("#results_card");
  const canvas = await html2canvas(node,{scale:2, backgroundColor:"#ffffff", useCORS:true});
  const imgW = a4w - margin*2;
  const imgH = canvas.height * (imgW / canvas.width);
  let y = 0, page = 0;
  while (y < canvas.height){
    const pageCanvas = document.createElement("canvas");
    pageCanvas.width = canvas.width;
    const sliceH = Math.min(canvas.height - y, Math.floor(canvas.width * (842 - margin*2) / imgW));
    pageCanvas.height = sliceH;
    const ctx = pageCanvas.getContext("2d");
    ctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
    const imgData = pageCanvas.toDataURL("image/jpeg", 0.92);
    if(page>0) pdf.addPage();
    pdf.addImage(imgData, "JPEG", margin, margin, imgW, (sliceH * imgW / canvas.width));
    y += sliceH; page++;
  }
  pdf.save("spotify_csv_audit.pdf");
});

/* ===================== Events / init ===================== */
$("#btn_auth").addEventListener("click", startAuth);
$("#btn_clear").addEventListener("click", clearToken);
$("#btn_run").addEventListener("click", run);
$("#lang_sel").addEventListener("change",(e)=>{ state.lang=e.target.value; saveState(); applyLang(); });

(async function init(){
  $("#lang_sel").value = state.lang || 'ja';
  applyLang();
  await handleCallback();
  if(state.client_id) $("#client_id").value = state.client_id;
  if(state.redirect_uri) $("#redirect_uri").value = state.redirect_uri;
  setTokStatus();
})();
</script>
</body>
</html>
