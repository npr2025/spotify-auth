<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spotify CSV Auditor — Availability & URLs (i18n + CSV/PDF)</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<!-- deps -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bd:#e5e7eb;--fg:#111;--mut:#555;--ok:#0a7a2f;--ng:#b00020;--bg:#fafafa}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  .wrap{max-width:1120px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  label{font-size:12px;color:var(--mut);display:block;margin-bottom:6px}
  input[type=text],input[type=file],select,textarea{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px;background:#fff}
  textarea{min-height:100px;resize:vertical}
  .col{flex:1 1 260px}
  .btn{padding:.65rem 1rem;border:1px solid #111;background:#111;color:#fff;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;border:1px solid var(--bd);padding:.25rem .6rem;border-radius:999px;font-size:12px;margin-right:6px}
  .mut{color:var(--mut)} .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);text-align:left;padding:8px 6px;vertical-align:top}
  th{background:#f6f6f6;position:sticky;top:0}
  .hint{font-size:12px;color:var(--mut);margin-top:6px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .right{display:flex;gap:10px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Spotify CSV Auditor — Availability & URLs</h1>
    <div class="right">
      <label class="mut" style="margin:0">
        <span id="lang_label" class="mut" style="font-size:12px;margin-right:6px">Language</span>
        <select id="lang_sel" style="width:auto">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Auth -->
  <div class="card">
    <div class="grid">
      <div class="col">
        <label id="lbl_client">Client ID（Spotify Developer）</label>
        <input id="client_id" type="text" placeholder="e.g., f5b88dacf6374e0485971c59d0f528bc"/>
      </div>
      <div class="col">
        <label id="lbl_redirect">Redirect URI（Developer Dashboardで完全一致）</label>
        <input id="redirect_uri" type="text" placeholder="https://npr2025.github.io/spotify-auth/spotify_csv_auditor.html"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn_auth" class="btn">Spotifyに接続（PKCE／スコープなし）</button>
      <span id="tok_status" class="pill mut">access_token: none</span>
      <button id="btn_clear" class="btn" style="background:#fff;color:#111">保存トークン削除</button>
    </div>
    <div id="hint_auth" class="hint">
      ※ 公開APIのみ使用（scope送信なし＝<span class="mono">search/album/track GET</span>専用）。<br/>
      ※ Redirect URI は <b>Developer Dashboardに完全一致登録</b>（末尾の<span class="mono">.html</span>まで）。
    </div>
  </div>

  <!-- CSV Load & Mapping -->
  <div class="card">
    <div class="grid">
      <div class="col">
        <label id="lbl_csv">CSVファイル（入力）</label>
        <input id="csv_file" type="file" accept=".csv"/>
        <div class="hint" id="hint_csv">ヘッダー付きCSV推奨。英字/日本語混在OK。</div>
      </div>
      <div class="col">
        <label id="lbl_mapping">列マッピング（検索優先順：ISRC → UPC → タイトル/アーティスト）</label>
        <div class="row">
          <div class="col">
            <label id="lbl_col_isrc">ISRC 列</label>
            <select id="col_isrc"></select>
          </div>
          <div class="col">
            <label id="lbl_col_upc">UPC 列</label>
            <select id="col_upc"></select>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label id="lbl_col_artist">Artist 列</label>
            <select id="col_artist"></select>
          </div>
          <div class="col">
            <label id="lbl_col_track">Track 列</label>
            <select id="col_track"></select>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label id="lbl_col_album">Album 列（任意）</label>
            <select id="col_album"></select>
          </div>
          <div class="col">
            <label id="lbl_limit">最大件数（テスト用）</label>
            <input id="limit_rows" type="text" value="0" placeholder="0=全件"/>
          </div>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btn_parse" class="btn" style="background:#444">CSVを読み込む</button>
      <button id="btn_run" class="btn" disabled>解析を実行</button>
      <button id="btn_download_results" class="btn" style="background:#fff;color:#111" disabled>結果CSVをダウンロード</button>
      <button id="btn_download_albums" class="btn" style="background:#fff;color:#111" disabled>Spotify Album URL 一覧CSV</button>
      <button id="btn_pdf" class="btn" style="background:#fff;color:#111" disabled>PDFをダウンロード</button>
    </div>
    <div id="hint_map" class="hint">※ ISRC/UPC があれば高精度。無い場合は <span class="mono">artist:"…" track:"…"</span> などのテキスト検索に自動フォールバックします。</div>
  </div>

  <!-- Results -->
  <div class="card" id="results_card">
    <div class="row"><div class="pill" id="pill_results">結果</div><span id="summary" class="mut"></span></div>
    <div id="results"></div>
  </div>
</div>

<script>
/* ---------- i18n ---------- */
const i18n = {
  en:{
    title:"Spotify CSV Auditor — Availability & URLs",
    lang_label:"Language",
    client:"Client ID (Spotify Developer)",
    redirect:"Redirect URI (must exactly match in Developer Dashboard)",
    auth_btn:"Connect to Spotify (PKCE / no scope)",
    clear_btn:"Clear saved token",
    hint_auth:`* Uses only public API (no scope = search/album/track GET).<br/>* Register Redirect URI exactly (including trailing <span class="mono">.html</span>).`,
    csv_label:"CSV file (input)",
    csv_hint:"Header row recommended. Mixed languages OK.",
    mapping:"Column mapping (search priority: ISRC → UPC → Title/Artist)",
    col_isrc:"ISRC column",
    col_upc:"UPC column",
    col_artist:"Artist column",
    col_track:"Track column",
    col_album:"Album column (optional)",
    limit:"Max rows (for testing) 0=all",
    load_csv:"Load CSV",
    run:"Run analysis",
    dl_results:"Download Results CSV",
    dl_albums:"Album URLs CSV (newline only)",
    dl_pdf:"Download PDF",
    map_hint:`* ISRC/UPC improves accuracy. Falls back to text query like <span class="mono">artist:"…"</span> & <span class="mono">track:"…"</span>.`,
    results:"Results",
    parsing:"Parsing…",
    parsed:(n)=>`${n} row(s) processed.`,
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    // table & CSV headers
    out_headers:["A_SourceIndex","B_SpotifyAvailable","C_SpotifyAlbumURL","D_SpotifyTrackURL","E_PrimaryOnAllDSPs","QueryType","MatchedAlbumName","MatchedTrackName","MatchedArtists"],
    yes:"YES", no:"NO"
  },
  ja:{
    title:"Spotify CSV Auditor — Availability & URLs",
    lang_label:"表示言語",
    client:"Client ID（Spotify Developer）",
    redirect:"Redirect URI（Developer Dashboardで完全一致）",
    auth_btn:"Spotifyに接続（PKCE／スコープなし）",
    clear_btn:"保存トークン削除",
    hint_auth:"※ 公開APIのみ（scope送信なし＝search/album/track GET）。<br/>※ Redirect URI は末尾の <span class='mono'>.html</span> まで完全一致で登録。",
    csv_label:"CSVファイル（入力）",
    csv_hint:"ヘッダー付き推奨（多言語OK）。",
    mapping:"列マッピング（検索優先：ISRC → UPC → タイトル/アーティスト）",
    col_isrc:"ISRC 列",
    col_upc:"UPC 列",
    col_artist:"Artist 列",
    col_track:"Track 列",
    col_album:"Album 列（任意）",
    limit:"最大件数（テスト用） 0=全件",
    load_csv:"CSVを読み込む",
    run:"解析を実行",
    dl_results:"結果CSVをダウンロード",
    dl_albums:"Spotify Album URL 一覧CSV（改行のみ）",
    dl_pdf:"PDFをダウンロード",
    map_hint:"※ ISRC/UPC が最優先。無い場合は artist/track のテキスト検索に自動フォールバックします。",
    results:"結果",
    parsing:"解析中…",
    parsed:(n)=>`${n} 行を処理しました。`,
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    out_headers:["A_SourceIndex","B_SpotifyAvailable","C_SpotifyAlbumURL","D_SpotifyTrackURL","E_PrimaryOnAllDSPs","QueryType","MatchedAlbumName","MatchedTrackName","MatchedArtists"],
    yes:"YES", no:"NO"
  }
};

/* ---------- state & helpers ---------- */
const storage = {
  get k(){ return 'spotify_csv_auditor_i18n_v1'; },
  load(){ try{ return JSON.parse(localStorage.getItem(this.k)||'{}'); }catch{return{}} },
  save(obj){ localStorage.setItem(this.k, JSON.stringify(obj||{})); }
};
const state = Object.assign(
  {lang:'ja',access_token:null,expires_at:0,code_verifier:null,client_id:"",redirect_uri:""},
  storage.load()
);
const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r=>setTimeout(r, ms));
let inputRows = []; // parsed CSV rows (objects)
let headers = [];   // CSV headers
let results = [];   // output objects per row
let albumUrlList = []; // collected album URLs (unique)

/* ---------- i18n apply ---------- */
function applyLang(){
  const L = i18n[state.lang]||i18n.ja;
  document.title = L.title;
  $("#title").textContent = L.title;
  $("#lang_label").textContent = L.lang_label;
  $("#lbl_client").textContent = L.client;
  $("#lbl_redirect").textContent = L.redirect;
  $("#btn_auth").textContent = L.auth_btn;
  $("#btn_clear").textContent = L.clear_btn;
  $("#hint_auth").innerHTML = L.hint_auth;

  $("#lbl_csv").textContent = L.csv_label;
  $("#hint_csv").textContent = L.csv_hint;
  $("#lbl_mapping").textContent = L.mapping;
  $("#lbl_col_isrc").textContent = L.col_isrc;
  $("#lbl_col_upc").textContent = L.col_upc;
  $("#lbl_col_artist").textContent = L.col_artist;
  $("#lbl_col_track").textContent = L.col_track;
  $("#lbl_col_album").textContent = L.col_album;
  $("#lbl_limit").textContent = L.limit;

  $("#btn_parse").textContent = L.load_csv;
  $("#btn_run").textContent = L.run;
  $("#btn_download_results").textContent = L.dl_results;
  $("#btn_download_albums").textContent = L.dl_albums;
  $("#btn_pdf").textContent = L.dl_pdf;

  $("#pill_results").textContent = L.results;
  setTokStatus();
}

/* ---------- Spotify PKCE (no scope) ---------- */
async function sha256(buf){ const enc=new TextEncoder().encode(buf); const hash=await crypto.subtle.digest('SHA-256', enc); return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function randStr(len=64){ const arr=new Uint8Array(len); crypto.getRandomValues(arr); return Array.from(arr).map(b=>("0"+(b&0xff).toString(16)).slice(-2)).join(''); }
function saveState(){ storage.save({lang:state.lang,access_token:state.access_token,expires_at:state.expires_at,code_verifier:state.code_verifier,client_id:state.client_id,redirect_uri:state.redirect_uri}); }
function setTokStatus(msg){
  const L = i18n[state.lang]||i18n.ja;
  const ok = state.access_token && Date.now() < state.expires_at;
  $("#tok_status").textContent = msg || (ok ? L.token_ok : L.token_none);
  $("#tok_status").className = "pill " + (ok?"ok":"mut");
  $("#btn_run").disabled = !ok || inputRows.length===0;
}
async function startAuth(){
  const client_id = $("#client_id").value.trim();
  const redirect_uri = $("#redirect_uri").value.trim();
  if(!client_id || !redirect_uri){ alert(state.lang==='en'?"Enter Client ID & Redirect URI":"Client ID と Redirect URI を入力してください"); return; }
  state.client_id = client_id; state.redirect_uri = redirect_uri; saveState();
  const code_verifier = randStr(64);
  const code_challenge = await sha256(code_verifier);
  state.code_verifier = code_verifier; saveState();
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id", client_id);
  url.searchParams.set("redirect_uri", redirect_uri);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", code_challenge);
  location.assign(url.toString());
}
async function handleCallback(){
  const params = new URLSearchParams(location.search);
  const code = params.get("code"); if(!code) return;
  const client_id = $("#client_id").value.trim() || state.client_id;
  const redirect_uri = $("#redirect_uri").value.trim() || state.redirect_uri;
  if(!client_id || !redirect_uri){ setTokStatus("invalid_client"); alert(state.lang==='en'?"Missing client_id/redirect_uri":"client_id / redirect_uri が見つかりません"); return; }
  if(!state.code_verifier){ setTokStatus("error: no verifier"); alert(state.lang==='en'?"Missing code_verifier. Start again.":"code_verifier が失われました。再実行してください。"); return; }
  try{
    const body = new URLSearchParams({grant_type:"authorization_code",code,redirect_uri,client_id,code_verifier:state.code_verifier});
    const res = await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    if(!res.ok){ const t=await res.text(); setTokStatus("token error"); alert((state.lang==='en'?"Token exchange failed:\n":"トークン交換失敗:\n")+t); return; }
    const js = await res.json();
    state.access_token = js.access_token;
    state.expires_at = Date.now()+((js.expires_in||3600)*1000)-5000;
    saveState(); history.replaceState({}, "", location.pathname); setTokStatus();
  }catch(e){ setTokStatus("token error"); alert(e.message); }
}
function clearToken(){ state.access_token=null; state.expires_at=0; state.code_verifier=null; saveState(); setTokStatus(); }

async function spGET(path, params={}){
  const qs = new URLSearchParams(params); const url = `https://api.spotify.com/v1${path}?${qs.toString()}`;
  for(;;){
    const res = await fetch(url, { headers:{ Authorization:`Bearer ${state.access_token}` }});
    if(res.status===429){ const retry=parseInt(res.headers.get("Retry-After")||"1",10); await sleep((retry+0.2)*1000); continue; }
    if(!res.ok){ const t=await res.text(); throw new Error(`[HTTP ${res.status}] ${t}`); }
    return res.json();
  }
}

/* ---------- CSV load & mapping ---------- */
function fillHeaderSelects(){
  const selects = ["col_isrc","col_upc","col_artist","col_track","col_album"].map(id=>$("#"+id));
  for(const sel of selects){ sel.innerHTML = `<option value="">(none)</option>` + headers.map(h=>`<option>${h}</option>`).join(""); }
}
function parseCSVFile(file){
  return new Promise((resolve,reject)=>{
    Papa.parse(file, {
      header:true, skipEmptyLines:true, encoding:"UTF-8",
      complete: res => resolve(res),
      error: err => reject(err)
    });
  });
}

/* ---------- Search Strategy ---------- */
async function searchByISRC(isrc){
  if(!isrc) return null;
  const js = await spGET("/search",{ q:`isrc:${isrc}`, type:"track", limit:1 });
  const t = js.tracks?.items?.[0]; if(!t) return null;
  const album = t.album;
  return {
    queryType:"ISRC",
    albumUrl: album?.external_urls?.spotify || "",
    trackUrl: t?.external_urls?.spotify || "",
    albumName: album?.name || "",
    trackName: t?.name || "",
    artists: (t.artists||album?.artists||[]).map(a=>a.name).join(" / "),
    primaryArtists: (album?.artists||t.artists||[]).map(a=>a.name).join(" / ")
  };
}
async function searchByUPC(upc){
  if(!upc) return null;
  const js = await spGET("/search",{ q:`upc:${upc}`, type:"album", limit:1 });
  const a = js.albums?.items?.[0]; if(!a) return null;
  return {
    queryType:"UPC",
    albumUrl: a?.external_urls?.spotify || "",
    trackUrl: "",
    albumName: a?.name || "",
    trackName: "",
    artists: (a.artists||[]).map(x=>x.name).join(" / "),
    primaryArtists: (a.artists||[]).map(x=>x.name).join(" / ")
  };
}
async function searchByText(artist,track,album){
  let t=null, a=null;
  if(track){
    const q = `track:"${track}"` + (artist?` artist:"${artist}"`:"");
    const js = await spGET("/search",{ q, type:"track", limit:1 });
    t = js.tracks?.items?.[0] || null;
    a = t?.album || null;
  }
  if(!t && album){
    const q2 = `album:"${album}"` + (artist?` artist:"${artist}"`:"");
    const js2 = await spGET("/search",{ q:q2, type:"album", limit:1 });
    a = js2.albums?.items?.[0] || a;
  }
  if(!t && !a && artist){
    const q3 = `artist:"${artist}"`;
    const js3 = await spGET("/search",{ q:q3, type:"album", limit:1 });
    a = js3.albums?.items?.[0] || null;
  }
  if(!t && !a) return null;
  return {
    queryType:"TEXT",
    albumUrl: a?.external_urls?.spotify || "",
    trackUrl: t?.external_urls?.spotify || "",
    albumName: a?.name || "",
    trackName: t?.name || "",
    artists: (t?.artists||a?.artists||[]).map(x=>x.name).join(" / "),
    primaryArtists: (a?.artists||t?.artists||[]).map(x=>x.name).join(" / ")
  };
}

/* ---------- Run ---------- */
function renderTable(rows){
  if(!rows.length){ $("#results").innerHTML=""; return; }
  const cols = Object.keys(rows[0]);
  const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>`;
  const tbody = `<tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c]??""}</td>`).join("")}</tr>`).join("")}</tbody>`;
  $("#results").innerHTML = `<table>${thead}${tbody}</table>`;
}
function toCSV(data, headers){
  const cols = headers?.length ? headers : Object.keys(data[0]||{});
  const esc = v => {
    if(v==null) return "";
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const lines = [];
  if(headers){ lines.push(cols.join(",")); }
  for(const row of data){ lines.push(cols.map(h=>esc(row[h]??"")).join(",")); }
  return lines.join("\n");
}

async function runAnalysis(){
  const L = i18n[state.lang]||i18n.ja;
  $("#btn_run").disabled = true;
  $("#btn_download_results").disabled = true;
  $("#btn_download_albums").disabled = true;
  $("#btn_pdf").disabled = true;
  $("#summary").textContent = L.parsing;
  $("#results").innerHTML = "";

  const col_isrc = $("#col_isrc").value;
  const col_upc = $("#col_upc").value;
  const col_artist = $("#col_artist").value;
  const col_track = $("#col_track").value;
  const col_album = $("#col_album").value;
  const lim = parseInt($("#limit_rows").value||"0",10);

  const rows = lim>0 ? inputRows.slice(0,lim) : inputRows.slice();
  results = []; albumUrlList = [];
  let idx = 0;

  for(const row of rows){
    idx++;
    const isrc = (col_isrc && row[col_isrc] || "").toString().trim();
    const upc  = (col_upc  && row[col_upc]  || "").toString().trim();
    const artist = (col_artist && row[col_artist] || "").toString().trim();
    const track  = (col_track  && row[col_track]  || "").toString().trim();
    const album  = (col_album  && row[col_album]  || "").toString().trim();

    let found = null;
    try{
      if(isrc){ found = await searchByISRC(isrc); }
      if(!found && upc){ found = await searchByUPC(upc); }
      if(!found){ found = await searchByText(artist, track, album); }
    }catch(e){
      // 続行（個別エラー）
      found = null;
    }

    const available = !!found && (!!found.albumUrl || !!found.trackUrl);
    const out = {
      A_SourceIndex: idx,
      B_SpotifyAvailable: available ? L.yes : L.no,
      C_SpotifyAlbumURL: found?.albumUrl || "",
      D_SpotifyTrackURL: found?.trackUrl || "",
      E_PrimaryOnAllDSPs: found?.primaryArtists || "",
      QueryType: found?.queryType || "",
      MatchedAlbumName: found?.albumName || "",
      MatchedTrackName: found?.trackName || "",
      MatchedArtists: found?.artists || ""
    };
    results.push(out);
    if(found?.albumUrl){ albumUrlList.push(found.albumUrl); }

    // 軽くスロットリング（429対策）
    await sleep(80);
  }

  // テーブル描画
  renderTable(results);
  $("#summary").textContent = L.parsed(results.length);

  // ダウンロード（結果CSV）
  $("#btn_download_results").onclick = ()=>{
    const csv = toCSV(results, i18n[state.lang].out_headers);
    const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "spotify_results.csv"; a.click();
  };
  $("#btn_download_results").disabled = false;

  // アルバムURL一覧（改行のみ）
  $("#btn_download_albums").onclick = ()=>{
    const uniq = Array.from(new Set(albumUrlList));
    // 改行区切りのみ（ヘッダ無し、CSVというより1列テキスト）
    const text = uniq.join("\n");
    const blob = new Blob([text],{type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "spotify_album_urls.csv"; a.click();
  };
  $("#btn_download_albums").disabled = false;

  // PDF
  $("#btn_pdf").onclick = async ()=>{
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:"pt", format:"a4"});
    const a4w = 595.28, a4h = 841.89, margin = 24;
    const node = document.querySelector("#results_card");
    const canvas = await html2canvas(node, {scale:2, backgroundColor:"#ffffff", useCORS:true});
    const imgW = a4w - margin*2;
    let y = 0, page = 0;
    while (y < canvas.height){
      const pageCanvas = document.createElement("canvas");
      pageCanvas.width = canvas.width;
      const sliceH = Math.min(canvas.height - y, Math.floor(canvas.width * (a4h - margin*2) / imgW));
      pageCanvas.height = sliceH;
      const ctx = pageCanvas.getContext("2d");
      ctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
      const imgData = pageCanvas.toDataURL("image/jpeg", 0.92);
      if(page>0) pdf.addPage();
      pdf.addImage(imgData, "JPEG", margin, margin, imgW, (sliceH * imgW / canvas.width));
      y += sliceH;
      page++;
    }
    pdf.save("spotify_csv_audit.pdf");
  };
  $("#btn_pdf").disabled = false;

  $("#btn_run").disabled = false;
}

/* ---------- Events ---------- */
$("#lang_sel").addEventListener("change", e=>{ state.lang=e.target.value; storage.save(state); applyLang(); });
$("#btn_auth").addEventListener("click", startAuth);
$("#btn_clear").addEventListener("click", clearToken);

$("#btn_parse").addEventListener("click", async ()=>{
  const f = $("#csv_file").files?.[0];
  if(!f){ alert(state.lang==='en'?"Choose a CSV file.":"CSVファイルを選択してください。"); return; }
  const parsed = await parseCSVFile(f);
  inputRows = parsed.data||[];
  headers = parsed.meta?.fields||Object.keys(inputRows[0]||{});
  fillHeaderSelects();
  $("#summary").textContent = (i18n[state.lang]||i18n.ja).parsed(inputRows.length);
  setTokStatus();
});
$("#btn_run").addEventListener("click", runAnalysis);

/* ---------- init ---------- */
(async function init(){
  $("#lang_sel").value = state.lang || 'ja';
  applyLang();
  await handleCallback();
  if(state.client_id) $("#client_id").value = state.client_id;
  if(state.redirect_uri) $("#redirect_uri").value = state.redirect_uri;
  setTokStatus();
})();
</script>
</body>
</html>