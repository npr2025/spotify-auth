<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spotify A–E Filler — TDCS Deep-Meta (PKCE / i18n / CSV+PDF)</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bd:#e5e7eb;--fg:#111;--mut:#555;--ok:#0a7a2f;--ng:#b00020;--bg:#fafafa;--ac:#111}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .right{display:flex;gap:10px;align-items:center}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .col{flex:1 1 260px}
  label{font-size:12px;color:var(--mut);display:block;margin-bottom:6px}
  input[type=text],textarea,select{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px;background:#fff}
  textarea{min-height:130px;resize:vertical}
  .btn{padding:.65rem 1rem;border:1px solid var(--ac);background:var(--ac);color:#fff;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .ghost{background:#fff;color:var(--ac)}
  .pill{display:inline-block;border:1px solid var(--bd);padding:.25rem .6rem;border-radius:999px;font-size:12px;margin-right:6px}
  .mut{color:var(--mut)} .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);text-align:left;padding:8px 6px;vertical-align:top}
  th{background:#f6f6f6;position:sticky;top:0}
  progress{width:100%;height:10px}
  .log{font-size:12px;background:#0b102015;color:#222;border:1px solid var(--bd);border-radius:8px;padding:8px;max-height:180px;overflow:auto;white-space:pre-wrap}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .hint{font-size:12px;color:var(--mut);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Spotify A–E Filler — TDCS Deep-Meta</h1>
    <div class="right">
      <span id="tok_status" class="pill mut">access_token: none</span>
      <label class="mut" style="margin:0">
        <span id="lang_label" class="mut" style="font-size:12px;margin-right:6px">Language</span>
        <select id="lang_sel" style="width:auto">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Auth -->
  <div class="card">
    <div class="grid">
      <div class="col">
        <label id="lbl_client">Client ID（Spotify Developer）</label>
        <input id="client_id" type="text" placeholder="e.g., f5b88dacf6374e0485971c59d0f528bc"/>
      </div>
      <div class="col">
        <label id="lbl_redirect">Redirect URI（Developer Dashboardで完全一致）</label>
        <input id="redirect_uri" type="text" placeholder="https://npr2025.github.io/spotify-auth/a2e_filler.html"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn_auth" class="btn">Spotifyに接続（PKCE／スコープなし）</button>
      <button id="btn_clear" class="btn ghost">保存トークン削除</button>
    </div>
    <div id="hint_auth" class="hint">
      ※ 公開APIのみ使用（scope送信なし＝<span class="mono">album/track GET</span>）。<br/>
      ※ Redirect URI は <b>Developer Dashboardに完全一致</b>で登録（末尾の <span class="mono">.html</span> まで）。
    </div>
  </div>

  <!-- Inputs -->
  <div class="card">
    <div class="grid">
      <div class="col">
        <label id="lbl_inputs">
          入力（1行=1アイテム）— ISRC / Spotify Track URL or ID / Spotify Album URL or ID / 検索語
        </label>
        <textarea id="lines" placeholder="例:
QZNMU2512345
https://open.spotify.com/track/2cYb2Vw2dC1hHnX...
https://open.spotify.com/album/06Yvg4vlPaVfnAWVwmJX27
The Darrow Chem Syndicate - The Hike"></textarea>
        <div class="hint" id="hint_inputs">先頭が <span class="mono">isrc:</span> でなくても、12桁/ISRC形式なら自動判定します。</div>
      </div>
      <div class="col">
        <label id="lbl_expected">期待アーティストID（Spotify）※カンマ区切り</label>
        <input id="expected_ids" type="text" value="55fvQ5I2IZUfcFT2DV02T3"/>
        <div class="hint" id="hint_expected">“Primary on All DSPs”判定の拠り所（Spotify側）。</div>

        <label id="lbl_expected_names" style="margin-top:10px">期待アーティスト名（Apple最小確認用／任意・カンマ区切り）</label>
        <input id="expected_names" type="text" placeholder="The Darrow Chem Syndicate"/>
        <div class="hint" id="hint_expected_names">ISRCが取得できた行のみ iTunes Lookup で簡易チェックします。</div>

        <div class="row" style="margin-top:10px">
          <input id="market_jp" type="checkbox" checked/>
          <label for="market_jp" id="lbl_market_jp" style="margin:0">market=JP で検索を優先（なければUS）</label>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btn_run" class="btn" disabled>解析を実行</button>
      <button id="btn_csv_rows" class="btn ghost" disabled>A–E CSVをダウンロード</button>
      <button id="btn_csv_albums" class="btn ghost" disabled>Album URLs CSV</button>
      <button id="btn_pdf" class="btn ghost" disabled>PDFをダウンロード</button>
    </div>
  </div>

  <!-- Realtime status -->
  <div class="card" id="status_card">
    <div class="row" style="align-items:flex-end;gap:12px">
      <div class="pill" id="pill_status">解析中…</div>
      <div id="summary" class="mut"></div>
    </div>
    <progress id="prog" max="100" value="0"></progress>
    <div id="log" class="log" style="margin-top:8px"></div>
  </div>

  <!-- Results -->
  <div class="card" id="results_card">
    <div class="row"><div class="pill" id="pill_results">結果（A–E）</div><span class="mut" id="res_hint">下表はリアルタイム更新されます。</span></div>
    <div id="results"></div>
  </div>
</div>

<script>
/* ===== i18n ===== */
const i18n = {
  en:{
    title:"Spotify A–E Filler — TDCS Deep-Meta",
    lang_label:"Language",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    client:"Client ID (Spotify Developer)",
    redirect:"Redirect URI (must exactly match, incl. .html)",
    connect:"Connect to Spotify (PKCE / no scope)",
    clear:"Clear saved token",
    inputs:"Input (1 per line) — ISRC / Spotify Track URL or ID / Spotify Album URL or ID / search query",
    inputs_hint:"ISRC will be auto-detected even without the 'isrc:' prefix.",
    expected:"Expected Artist IDs (Spotify) — comma-separated",
    expected_hint:"Used to judge “Primary on All DSPs” on Spotify side.",
    expected_names:"Expected Artist Names (for Apple minimal check, optional) — comma-separated",
    expected_names_hint:"Only lines with an ISRC will be checked via iTunes Lookup.",
    market_jp:"Prefer market=JP (fallback to US if not found)",
    run:"Run analysis",
    csv_rows:"Download A–E CSV",
    csv_albums:"Album URLs CSV",
    pdf:"Download PDF",
    status:"Processing…",
    res_hint:"Table below updates in realtime.",
    thA:"A: Original",
    thB:"B: Spotify Available",
    thC:"C: Spotify Album URL",
    thD:"D: Spotify Track URL",
    thE:"E: Primary on All DSPs",
    yes:"YES",
    no:"NO",
    unknown:"UNKNOWN",
    apple_ok:"Apple OK",
    apple_ng:"Apple NG",
    apple_skip:"Apple unchecked",
    sp_ok:"Spotify OK",
    sp_ng:"Spotify NG",
    parsing:(done,total)=>`Parsed ${done}/${total}`,
    finished:(n)=>`Done. ${n} row(s). CSV/PDF enabled.`
  },
  ja:{
    title:"Spotify A–E Filler — TDCS Deep-Meta",
    lang_label:"表示言語",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    client:"Client ID（Spotify Developer）",
    redirect:"Redirect URI（末尾 .html まで完全一致）",
    connect:"Spotifyに接続（PKCE／スコープなし）",
    clear:"保存トークン削除",
    inputs:"入力（1行=1アイテム）— ISRC／SpotifyトラックURL or ID／SpotifyアルバムURL or ID／検索語",
    inputs_hint:"ISRCは 'isrc:' なしでも自動判定します。",
    expected:"期待アーティストID（Spotify）※カンマ区切り",
    expected_hint:"“Primary on All DSPs”判定の根拠（Spotify側）。",
    expected_names:"期待アーティスト名（Apple最小確認／任意・カンマ区切り）",
    expected_names_hint:"ISRCが取れた行のみ iTunes Lookup で簡易チェックします。",
    market_jp:"market=JP を優先（無ければUS）",
    run:"解析を実行",
    csv_rows:"A–E CSVをダウンロード",
    csv_albums:"Album URLs CSV",
    pdf:"PDFをダウンロード",
    status:"解析中…",
    res_hint:"下表はリアルタイム更新されます。",
    thA:"A: Original",
    thB:"B: Spotify Available",
    thC:"C: Spotify Album URL",
    thD:"D: Spotify Track URL",
    thE:"E: Primary on All DSPs",
    yes:"YES",
    no:"NO",
    unknown:"UNKNOWN",
    apple_ok:"Apple OK",
    apple_ng:"Apple NG",
    apple_skip:"Apple未確認",
    sp_ok:"Spotify OK",
    sp_ng:"Spotify NG",
    parsing:(done,total)=>`${done}/${total} 件 解析`,
    finished:(n)=>`完了。${n} 行。CSV/PDF 出力が有効になりました。`
  }
};

const storageKey = 'tdcs_a2e_filler_pkce_v1';
const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r=>setTimeout(r,ms));

let state = Object.assign({
  lang:'ja', access_token:null, expires_at:0, code_verifier:null,
  client_id:'', redirect_uri:''
}, load());

function load(){ try{ return JSON.parse(localStorage.getItem(storageKey)||'{}'); }catch{return{}} }
function save(){ localStorage.setItem(storageKey, JSON.stringify({
  lang:state.lang, access_token:state.access_token, expires_at:state.expires_at,
  code_verifier:state.code_verifier, client_id:state.client_id, redirect_uri:state.redirect_uri
})); }

function L(){ return i18n[state.lang] || i18n.ja; }
function applyLang(){
  document.title = L().title;
  $("#title").textContent = L().title;
  $("#lang_label").textContent = L().lang_label;
  $("#lbl_client").textContent = L().client;
  $("#lbl_redirect").textContent = L().redirect;
  $("#btn_auth").textContent = L().connect;
  $("#btn_clear").textContent = L().clear;
  $("#lbl_inputs").textContent = L().inputs;
  $("#hint_inputs").textContent = L().inputs_hint;
  $("#lbl_expected").textContent = L().expected;
  $("#hint_expected").textContent = L().expected_hint;
  $("#lbl_expected_names").textContent = L().expected_names;
  $("#hint_expected_names").textContent = L().expected_names_hint;
  $("#lbl_market_jp").textContent = L().market_jp;
  $("#btn_run").textContent = L().run;
  $("#btn_csv_rows").textContent = L().csv_rows;
  $("#btn_csv_albums").textContent = L().csv_albums;
  $("#btn_pdf").textContent = L().pdf;
  $("#pill_status").textContent = L().status;
  $("#res_hint").textContent = L().res_hint;
  setTokStatus();
}

function setTokStatus(msg){
  const ok = state.access_token && Date.now() < state.expires_at;
  $("#tok_status").textContent = msg || (ok? L().token_ok : L().token_none);
  $("#tok_status").className = "pill " + (ok? "ok":"mut");
  $("#btn_run").disabled = !ok;
}

/* ===== PKCE Auth (no scope) ===== */
function randStr(len=64){
  const a=new Uint8Array(len); crypto.getRandomValues(a);
  return Array.from(a).map(b=>("0"+(b&0xff).toString(16)).slice(-2)).join('');
}
async function sha256(s){
  const data = new TextEncoder().encode(s);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
async function startAuth(){
  const cid = $("#client_id").value.trim();
  const red = $("#redirect_uri").value.trim();
  if(!cid || !red){ alert(state.lang==='en'?"Enter Client ID & Redirect URI":"Client ID と Redirect URI を入力してください"); return; }
  state.client_id = cid; state.redirect_uri = red; save();
  const verifier = randStr(64);
  const challenge = await sha256(verifier);
  state.code_verifier = verifier; save();
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id", cid);
  url.searchParams.set("redirect_uri", red);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", challenge);
  location.assign(url.toString());
}
async function handleCallback(){
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  if(!code) return;
  const cid = $("#client_id").value.trim() || state.client_id;
  const red = $("#redirect_uri").value.trim() || state.redirect_uri;
  if(!cid || !red){
    setTokStatus("invalid_client");
    alert(state.lang==='en'?"Missing saved client_id/redirect_uri. Enter them and reconnect.":"client_id / redirect_uri が保存されていません。入力して再接続してください。");
    return;
  }
  if(!state.code_verifier){
    setTokStatus("error: no verifier");
    alert(state.lang==='en'?"Missing code_verifier. Start auth again.":"code_verifier がありません。もう一度『Spotifyに接続』からやり直してください。");
    return;
  }
  try{
    const body = new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:red,client_id:cid,code_verifier:state.code_verifier});
    const res = await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    if(!res.ok){
      const t = await res.text();
      setTokStatus("token error");
      console.error("Token exchange failed:", t);
      alert((state.lang==='en'?"Token exchange failed:\n":"トークン交換失敗:\n")+t);
      return;
    }
    const js = await res.json();
    state.access_token = js.access_token;
    state.expires_at = Date.now() + ((js.expires_in||3600)*1000) - 5000;
    save();
    history.replaceState({}, "", location.pathname);
    setTokStatus();
  }catch(e){
    setTokStatus("token error");
    alert(e.message);
  }
}
function clearToken(){
  state.access_token = null;
  state.expires_at = 0;
  state.code_verifier = null;
  save();
  setTokStatus();
}

/* ===== Spotify / Apple helpers ===== */
async function spGET(path, params={}){
  const qs = new URLSearchParams(params);
  const url = `https://api.spotify.com/v1${path}?${qs.toString()}`;
  for(;;){
    const res = await fetch(url, { headers:{ Authorization:`Bearer ${state.access_token}` }});
    if(res.status===429){
      const retry = parseInt(res.headers.get("Retry-After")||"1",10);
      await sleep((retry+0.2)*1000); continue;
    }
    if(!res.ok){
      const t = await res.text();
      throw new Error(`[HTTP ${res.status}] ${t}`);
    }
    return res.json();
  }
}
function extractIdFromURL(s, kind){ // kind: 'track'|'album'
  const m = s.match(new RegExp(`${kind}\\/([A-Za-z0-9]{22})`));
  return m? m[1] : null;
}
function detectType(line){
  const s=line.trim();
  if(!s) return {type:'empty'};
  if(/^https?:\/\//i.test(s)){
    if(/open\.spotify\.com\/track\//.test(s)) return {type:'sp_track_url', id:extractIdFromURL(s,'track')};
    if(/open\.spotify\.com\/album\//.test(s)) return {type:'sp_album_url', id:extractIdFromURL(s,'album')};
    return {type:'other_url', raw:s};
  }
  if(/^[A-Za-z0-9]{22}$/.test(s)) return {type:'sp_maybe_id', id:s};
  if(/^[A-Z]{2}-?[A-Z0-9]{3}-?\d{2}-?\d{5}$/i.test(s)) return {type:'isrc', isrc:s.replace(/-/g,'').toUpperCase()};
  return {type:'query', q:s};
}
function uniq(arr){ return Array.from(new Set(arr)); }
function toCSV(rows, headers){
  const esc = v => {
    if(v==null) return "";
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  };
  const cols = headers && headers.length ? headers : Object.keys(rows[0]||{});
  const out = [cols.join(",")];
  for(const r of rows){ out.push(cols.map(h=>esc(r[h])).join(",")); }
  return out.join("\n");
}

/* ===== Minimal Apple (iTunes Lookup by ISRC) ===== */
async function appleCheckByISRC(isrc, expectedNames){
  if(!isrc) return {apple:'skip'};
  try{
    const url = `https://itunes.apple.com/lookup?isrc=${encodeURIComponent(isrc)}`;
    const res = await fetch(url);
    if(!res.ok) return {apple:'skip'};
    const js = await res.json();
    if(!js?.resultCount){ return {apple:'ng', reason:'no_result'}; }
    if(!expectedNames || !expectedNames.length) return {apple:'ok'};
    const lower = expectedNames.map(n=>n.trim().toLowerCase()).filter(Boolean);
    const hit = js.results.some(r=>{
      const name = (r.artistName||"").toLowerCase();
      return lower.includes(name);
    });
    return {apple: hit ? 'ok' : 'ng'};
  }catch(e){
    return {apple:'skip'};
  }
}

/* ===== UI table ===== */
function ensureTable(){
  if($("#a2e_tbl")) return $("#a2e_tbl");
  const t = document.createElement("table");
  t.id = "a2e_tbl";
  const thead = document.createElement("thead");
  thead.innerHTML = `<tr>
    <th>${L().thA}</th><th>${L().thB}</th><th>${L().thC}</th><th>${L().thD}</th><th>${L().thE}</th>
  </tr>`;
  const tbody = document.createElement("tbody");
  t.appendChild(thead); t.appendChild(tbody);
  $("#results").appendChild(t);
  return t;
}
function upsertRow(idx, data){
  const t = ensureTable();
  const tb = t.querySelector("tbody");
  let tr = tb.querySelector(`tr[data-idx="${idx}"]`);
  if(!tr){
    tr = document.createElement("tr");
    tr.dataset.idx = String(idx);
    tr.innerHTML = "<td></td><td></td><td></td><td></td><td></td>";
    tb.appendChild(tr);
  }
  const tds = tr.querySelectorAll("td");
  tds[0].textContent = data.A ?? "";
  tds[1].textContent = data.B ?? "";
  tds[2].innerHTML  = data.C ? `<a href="${data.C}" target="_blank" rel="noopener">${data.C}</a>` : "";
  tds[3].innerHTML  = data.D ? `<a href="${data.D}" target="_blank" rel="noopener">${data.D}</a>` : "";
  tds[4].textContent = data.E ?? "";
}

/* ===== Main ===== */
async function run(){
  $("#btn_run").disabled = true;
  $("#btn_csv_rows").disabled = true;
  $("#btn_csv_albums").disabled = true;
  $("#btn_pdf").disabled = true;
  $("#log").textContent = "";
  $("#prog").value = 0;
  $("#summary").textContent = L().status;

  const preferJP = $("#market_jp").checked;
  const expectedIDs = new Set($("#expected_ids").value.split(",").map(s=>s.trim()).filter(Boolean));
  const expectedNames = $("#expected_names").value.split(",").map(s=>s.trim()).filter(Boolean);

  const raw = $("#lines").value.split(/\n+/).map(s=>s.trim());
  const items = raw.map(detectType).filter(x=>x.type!=='empty');
  const total = items.length||1;
  let done = 0;

  const rowCSV = [];
  const albumURLSet = new Set();

  function logln(s){ const el=$("#log"); el.textContent += s+"\n"; el.scrollTop = el.scrollHeight; }
  function setProgress(){ $("#prog").value = Math.round(100*done/total); $("#summary").textContent = L().parsing(done,total); }

  for(let i=0;i<items.length;i++){
    const orig = raw[i];
    upsertRow(i, {A: orig, B: L().unknown, C:"", D:"", E: L().unknown});
  }

  for(let i=0;i<items.length;i++){
    const item = items[i];
    const A = raw[i];
    let B = L().no, C = "", D = "", E = L().unknown;
    let isrc = null;

    try{
      if(item.type==='sp_track_url' || (item.type==='sp_maybe_id' && item.id)){
        const id = item.id || item.id;
        let track = null;
        try{
          track = await spGET(`/tracks/${id}`, { market: preferJP?'JP':'US' });
        }catch{
          track = await spGET(`/tracks/${id}`, { market: 'US' });
        }
        if(track && track.id){
          B = L().yes;
          const alb = track.album;
          C = alb?.id ? `https://open.spotify.com/album/${alb.id}` : "";
          D = `https://open.spotify.com/track/${track.id}`;
          isrc = track.external_ids?.isrc || null;
          // Primary check (Spotify)
          let spJudge = L().unknown;
          if(expectedIDs.size){
            const firstID = (track.artists?.[0]?.id)||"";
            spJudge = expectedIDs.has(firstID) ? L().sp_ok : L().sp_ng;
          }
          // Apple minimal
          const ap = await appleCheckByISRC(isrc, expectedNames);
          let appleTag = (ap.apple==='ok')? L().apple_ok : (ap.apple==='ng'? L().apple_ng : L().apple_skip);
          E = `${spJudge} / ${appleTag}`;
          if(C) albumURLSet.add(C);
        }
      } else if(item.type==='sp_album_url' || (item.type==='sp_maybe_id' && item.id)){
        const id = item.id || item.id;
        let album = null;
        try{
          album = await spGET(`/albums/${id}`, { market: preferJP?'JP':'US' });
        }catch{
          album = await spGET(`/albums/${id}`, { market:'US' });
        }
        if(album && album.id){
          B = L().yes;
          C = `https://open.spotify.com/album/${album.id}`;
          // Track URL（代表：1曲目）
          const firstTrackId = album.tracks?.items?.[0]?.id || null;
          D = firstTrackId ? `https://open.spotify.com/track/${firstTrackId}` : "";
          // 代表曲でISRCを取ってApple最小確認
          if(firstTrackId){
            const t = await spGET(`/tracks/${firstTrackId}`, { market: preferJP?'JP':'US' });
            isrc = t.external_ids?.isrc || null;
            let spJudge = L().unknown;
            if(expectedIDs.size){
              const firstID = (t.artists?.[0]?.id)||"";
              spJudge = expectedIDs.has(firstID) ? L().sp_ok : L().sp_ng;
            }
            const ap = await appleCheckByISRC(isrc, expectedNames);
            let appleTag = (ap.apple==='ok')? L().apple_ok : (ap.apple==='ng'? L().apple_ng : L().apple_skip);
            E = `${spJudge} / ${appleTag}`;
          }else{
            E = L().unknown;
          }
          if(C) albumURLSet.add(C);
        }
      } else if(item.type==='isrc'){
        // Spotify: search by ISRC (track)
        let q = `isrc:${item.isrc}`;
        let search = await spGET(`/search`, { q, type:'track', limit:1, market: preferJP?'JP':'US' });
        if(!search.tracks?.items?.length){
          search = await spGET(`/search`, { q, type:'track', limit:1, market:'US' });
        }
        const t = search.tracks?.items?.[0] || null;
        if(t){
          B = L().yes;
          D = `https://open.spotify.com/track/${t.id}`;
          const albId = t.album?.id || "";
          C = albId ? `https://open.spotify.com/album/${albId}` : "";
          isrc = t.external_ids?.isrc || item.isrc;
          // Primary check (Spotify)
          let spJudge = L().unknown;
          if(expectedIDs.size){
            const firstID = (t.artists?.[0]?.id)||"";
            spJudge = expectedIDs.has(firstID) ? L().sp_ok : L().sp_ng;
          }
          // Apple minimal
          const ap = await appleCheckByISRC(isrc, expectedNames);
          let appleTag = (ap.apple==='ok')? L().apple_ok : (ap.apple==='ng'? L().apple_ng : L().apple_skip);
          E = `${spJudge} / ${appleTag}`;
          if(C) albumURLSet.add(C);
        }else{
          B = L().no; E = `${L().sp_ng} / ${L().apple_ng}`;
        }
      } else if(item.type==='query'){
        // Search by query (track-first)
        let search = await spGET(`/search`, { q:item.q, type:'track', limit:1, market: preferJP?'JP':'US' });
        if(!search.tracks?.items?.length){
          search = await spGET(`/search`, { q:item.q, type:'track', limit:1, market:'US' });
        }
        const t = search.tracks?.items?.[0] || null;
        if(t){
          B = L().yes;
          D = `https://open.spotify.com/track/${t.id}`;
          const albId = t.album?.id || "";
          C = albId ? `https://open.spotify.com/album/${albId}` : "";
          isrc = t.external_ids?.isrc || null;
          // Primary check (Spotify)
          let spJudge = L().unknown;
          if(expectedIDs.size){
            const firstID = (t.artists?.[0]?.id)||"";
            spJudge = expectedIDs.has(firstID) ? L().sp_ok : L().sp_ng;
          }
          // Apple minimal
          const ap = await appleCheckByISRC(isrc, expectedNames);
          let appleTag = (ap.apple==='ok')? L().apple_ok : (ap.apple==='ng'? L().apple_ng : L().apple_skip);
          E = `${spJudge} / ${appleTag}`;
          if(C) albumURLSet.add(C);
        }else{
          B = L().no; E = L().unknown;
        }
      } else {
        // other_url or unknown
        B = L().no; E = L().unknown;
      }
    }catch(err){
      console.error(err);
      logln(`[#${i+1}] ERROR: ${err.message}`);
    }

    upsertRow(i, {A,B,C,D,E});
    rowCSV.push({A,B,C,D,E});
    done++; setProgress();
    logln(`[#${i+1}] ${A} → B=${B} / C=${C||"-"} / D=${D||"-"} / E=${E}`);
    await sleep(80);
  }

  // Enable exports
  const rowsCSV = toCSV(rowCSV, ['A','B','C','D','E']);
  const albumsCSV = ['album_url', ...uniq(Array.from(albumURLSet))].join('\n');

  $("#btn_csv_rows").onclick = ()=>{
    const blob = new Blob([rowsCSV], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="a2e_result.csv"; a.click();
  };
  $("#btn_csv_albums").onclick = ()=>{
    const blob = new Blob([albumsCSV], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="album_urls.csv"; a.click();
  };
  $("#btn_pdf").onclick = async ()=>{
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:"pt", format:"a4"});
    const a4w = 595.28, a4h = 841.89, margin = 24;
    const node = document.querySelector("#results_card");
    const canvas = await html2canvas(node, {scale:2, backgroundColor:"#ffffff", useCORS:true});
    const imgW = a4w - margin*2;
    const pageH = a4h - margin*2;
    let y=0, page=0;
    while(y < canvas.height){
      const h = Math.min(canvas.height - y, pageH * (canvas.width / imgW));
      const pageCanvas = document.createElement("canvas");
      pageCanvas.width = canvas.width; pageCanvas.height = h;
      pageCanvas.getContext("2d").drawImage(canvas, 0, y, canvas.width, h, 0, 0, canvas.width, h);
      const img = pageCanvas.toDataURL("image/jpeg", .92);
      if(page>0) pdf.addPage();
      pdf.addImage(img, "JPEG", margin, margin, imgW, (h * imgW / canvas.width));
      y += h; page++;
    }
    pdf.save("a2e_result.pdf");
  };

  $("#btn_csv_rows").disabled = false;
  $("#btn_csv_albums").disabled = false;
  $("#btn_pdf").disabled = false;
  $("#summary").textContent = L().finished(items.length);
  $("#btn_run").disabled = false;
}

/* ===== Events ===== */
$("#lang_sel").addEventListener("change",(e)=>{ state.lang = e.target.value; save(); applyLang(); });
$("#btn_auth").addEventListener("click", startAuth);
$("#btn_clear").addEventListener("click", clearToken);
$("#btn_run").addEventListener("click", run);

(async function init(){
  $("#lang_sel").value = state.lang;
  applyLang();
  await handleCallback();
  if(state.client_id) $("#client_id").value = state.client_id;
  if(state.redirect_uri) $("#redirect_uri").value = state.redirect_uri;
  setTokStatus();
})();
</script>
</body>
</html>
