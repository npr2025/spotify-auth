<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spotify CSV Auditor — A–F Filler (Light / No Markets)</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<!-- deps -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bd:#e5e7eb;--fg:#111;--mut:#555;--ok:#0a7a2f;--ng:#b00020;--bg:#fafafa;--ink:#111;--chip:#f6f6f6}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 10px}
  h3{margin:14px 0 6px;font-size:16px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  label{font-size:12px;color:var(--mut);display:block;margin:0 0 6px}
  input[type=text],select,textarea{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px;background:#fff}
  input[type=number]{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px;background:#fff}
  textarea{min-height:100px;resize:vertical}
  input[type=file]{border:1px dashed var(--bd);background:#fff;padding:12px;border-radius:10px;width:100%}
  .btn{padding:.65rem 1rem;border:1px solid var(--ink);background:var(--ink);color:#fff;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#fff;color:var(--ink);border:1px solid var(--bd)}
  .pill{display:inline-block;border:1px solid var(--bd);padding:.25rem .6rem;border-radius:999px;font-size:12px;margin-right:6px;background:var(--chip)}
  .mut{color:var(--mut)} .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .badge{display:inline-block;padding:.1rem .5rem;border-radius:6px;font-size:11px}
  .badge.ok{background:#eaf6ee;color:#166534}
  .badge.ng{background:#fdeaea;color:#991b1b}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);text-align:left;padding:8px 6px;vertical-align:top}
  th{background:#f6f6f6;position:sticky;top:0;z-index:1}
  .prog{height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:#111;transition:width .2s}
  .log{max-height:220px;overflow:auto;border:1px solid var(--bd);border-radius:10px;padding:8px;background:#fff}
  .log .line{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace;font-size:12px;padding:2px 0;border-bottom:1px dashed #f0f0f0}
  .hint{font-size:12px;color:var(--mut)}
  .skeleton{background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:sh 1.2s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Spotify CSV Auditor — A–F Filler（Light／マーケット解析なし）</h1>
    <div class="row">
      <label class="mut" style="margin:0">
        <span id="lang_label" class="mut" style="font-size:12px;margin-right:6px">Language</span>
        <select id="lang_sel" style="width:auto">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Auth -->
  <div class="card">
    <div class="grid">
      <div>
        <label id="lbl_client">Client ID（Spotify Developer）</label>
        <input id="client_id" type="text" placeholder="e.g., f5b88dacf6374e0485971c59d0f528bc"/>
      </div>
      <div>
        <label id="lbl_redirect">Redirect URI（Developer Dashboardで完全一致）</label>
        <input id="redirect_uri" type="text" placeholder="https://npr2025.github.io/spotify-auth/csv_auditor_light.html"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn_auth" class="btn">Spotifyに接続（PKCE／スコープなし）</button>
      <span id="tok_status" class="pill mut">access_token: none</span>
      <button id="btn_clear" class="btn btn-ghost">保存トークン削除</button>
    </div>
    <div id="hint_auth" class="hint" style="margin-top:6px">
      ※ 公開GETのみ使用（search/track）。Redirect URI は Dashboard に完全一致登録。<br/>
      ※ <span class="mono">code_verifier</span> は localStorage に保存。<br/>
      ※ 軽量モードは <b>/albums</b> を呼ばず、<b>available_markets</b> を取得しません（マップ速度重視）。
    </div>
  </div>

  <!-- CSV Input & Options -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill">CSV</span>
        <span class="mut" id="csv_hint">アルバム一覧CSVを読み込み → CSVの行順のまま処理（CSVに無いタイトルは追加しない）</span>
      </div>
      <div class="row">
        <input id="ignore_djmix" type="checkbox" checked>
        <label for="ignore_djmix" id="lbl_ignore_dj" style="margin:0">DJミックス表記の曲は無視</label>
      </div>
    </div>

    <div class="grid" style="margin-top:8px">
      <div>
        <label id="lbl_csv">CSVファイルを選択</label>
        <input id="csv_file" type="file" accept=".csv,text/csv"/>
      </div>
      <div>
        <label id="lbl_expected">期待アーティストID（参考／カンマ区切り／軽量モードでは未検証）</label>
        <input id="expected_ids" type="text" value=""/>
      </div>
    </div>

    <div class="grid" style="margin-top:8px">
      <div>
        <label id="lbl_map_album">アルバムタイトル列（既定: Album title）</label>
        <select id="sel_album_col"></select>
      </div>
      <div>
        <label id="lbl_map_track">トラックタイトル列（既定: Track title）</label>
        <select id="sel_track_col"><option value="">—</option></select>
      </div>
    </div>

    <!-- Fast options -->
    <div class="grid" style="margin-top:8px">
      <div>
        <label>モードと並列数</label>
        <div class="row">
          <label style="margin:0"><input type="checkbox" id="opt_light" checked/> 軽量モード（/albums呼ばない・マーケット解析なし）</label>
          <label style="margin:0"><input type="checkbox" id="opt_skip_track" checked/> トラック検索を省略</label>
          <label style="margin:0"><input type="checkbox" id="opt_verbose"/> 詳細ログ</label>
        </div>
        <div class="row">
          <label style="margin:0">並列数</label>
          <input id="opt_conc" type="number" min="1" max="12" step="1" value="6" style="width:120px"/>
        </div>
      </div>
      <div>
        <label>Search market（応答縮小で高速化・任意）</label>
        <select id="sel_market">
          <option value="">— (none)</option>
          <option value="JP">JP</option>
          <option value="US">US</option>
          <option value="GB">GB</option>
          <option value="DE">DE</option>
          <option value="FR">FR</option>
        </select>
        <div class="hint" style="margin-top:6px">指定すると検索応答から巨大なavailable_marketsが省略されることがあり、体感が速くなります。</div>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="btn_run" class="btn" disabled>解析を実行</button>
      <button id="btn_csv_out" class="btn btn-ghost" disabled>結果CSVをダウンロード</button>
      <button id="btn_csv_meta" class="btn btn-ghost" disabled>META CSVをダウンロード</button>
      <button id="btn_urls" class="btn btn-ghost" disabled>アルバムURL一覧（改行区切り）</button>
      <button id="btn_pdf" class="btn btn-ghost" disabled>PDFをダウンロード</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="prog" style="flex:1"><div class="bar" id="bar"></div></div>
      <span class="mut mono" id="prog_txt">0%</span>
    </div>
    <div class="log" id="log" style="margin-top:8px"></div>
  </div>

  <!-- Results -->
  <div class="card" id="results_card">
    <div class="row"><div class="pill" id="pill_results">結果</div><span id="summary" class="mut"></span></div>
    <div id="results"></div>
  </div>

  <!-- META (CSV基準) -->
  <div class="card" id="meta_card">
    <div class="row"><div class="pill">META（CSV基準・監査／軽量）</div><span class="mut" id="meta_summary"></span></div>
    <div id="meta_results"></div>
  </div>
</div>

<script>
/* ===================== i18n ===================== */
const i18n = {
  en:{
    title:"Spotify CSV Auditor — A–F Filler (Light / No Markets)",
    lang_label:"Language",
    client:"Client ID (Spotify Developer)",
    redirect:"Redirect URI (must exactly match in Developer Dashboard)",
    auth_btn:"Connect to Spotify (PKCE / no scope)",
    clear_btn:"Clear saved token",
    csv_hint:"Load an album list CSV → strictly in its order (no extra titles).",
    csv_label:"Choose CSV file",
    expected:"Expected artist IDs (optional, comma-separated / not verified in Light mode)",
    map_album:"Album title column (default: Album title)",
    map_track:"Track title column (default: Track title)",
    ignore_dj:"Ignore tracks with DJ-mix notation",
    run:"Run analysis",
    csv_out:"Download results CSV",
    csv_meta:"Download META CSV",
    urls_out:"Album URLs (newline list)",
    pdf:"Download PDF",
    results:"Results",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    parsing:"Parsing…",
    parsed:(n)=>`${n} row(s) processed. You can export CSV/URLs/PDF.`,
    tbl_core:"A–F output (per CSV row, in order)",
    tbl_meta:"CSV-based META checks (light)",
    cols:{A:"Album title",B:"Spotify Available",C:"Spotify Album URL",D:"Spotify Track URL",E:"Primary structure (CSV, ' | ')",F:"Remixers (CSV, ' | ')" },
    meta_cols:["Album (CSV)","Remixer→Primary overlap","Overlap names","'feat.' in Primary","DJ Mix ignored","Primary count","Remixer count"],
    status:{reading:"[CSV] loaded: {n} row(s).", searching:'[{i}/{n}] album search: "{t}"', found:'[{i}/{n}] album: {name} — {id}', notfound:'[{i}/{n}] NOT FOUND', matchedTrack:'[{i}/{n}] matched track: {name}', exportReady:"[OK] export buttons enabled."}
  },
  ja:{
    title:"Spotify CSV Auditor — A–F Filler（軽量／マーケット解析なし）",
    lang_label:"表示言語",
    client:"Client ID（Spotify Developer）",
    redirect:"Redirect URI（Developer Dashboardで完全一致）",
    auth_btn:"Spotifyに接続（PKCE／スコープなし）",
    clear_btn:"保存トークン削除",
    csv_hint:"アルバム一覧CSVを読み込み → CSVの行順のまま処理（CSVに無いタイトルは追加しない）",
    csv_label:"CSVファイルを選択",
    expected:"期待アーティストID（任意／カンマ区切り／軽量モードでは未検証）",
    map_album:"アルバムタイトル列（既定: Album title）",
    map_track:"トラックタイトル列（既定: Track title）",
    ignore_dj:"DJミックス表記の曲は無視",
    run:"解析を実行",
    csv_out:"結果CSVをダウンロード",
    csv_meta:"META CSVをダウンロード",
    urls_out:"アルバムURL一覧（改行区切り）",
    pdf:"PDFをダウンロード",
    results:"結果",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    parsing:"解析中…",
    parsed:(n)=>`${n} 行を解析完了。CSV／URL一覧／PDFを出力できます。`,
    tbl_core:"A–F 出力（CSV行順）",
    tbl_meta:"CSV基準のMETAチェック（軽量）",
    cols:{A:"Album title",B:"Spotify Available",C:"Spotify Album URL",D:"Spotify Track URL",E:"Primary構造（CSV由来／' | '）",F:"Remixers（CSV由来／' | '）"},
    meta_cols:["Album (CSV)","Remixer→Primary重複","重複名（詳細）","Primaryに'feat.'混入","DJ Mix無視","Primary件数","Remixer件数"],
    status:{reading:"[CSV] 読み込み: {n} 行", searching:'[{i}/{n}] アルバム検索: 「{t}」', found:'[{i}/{n}] ヒット: {name} — {id}', notfound:'[{i}/{n}] 見つからず', matchedTrack:'[{i}/{n}] マッチ: {name}', exportReady:"[OK] エクスポート準備完了"}
  }
};
const storage = { get k(){ return 'sp_csv_auditor_tdcs_light_v1'; }, load(){ try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}} }, save(obj){ localStorage.setItem(this.k, JSON.stringify(obj||{})); }};
const state = Object.assign({lang:'ja',access_token:null,expires_at:0,code_verifier:null,client_id:"",redirect_uri:""}, storage.load());
const $ = sel => document.querySelector(sel);
function t(){ return i18n[state.lang]||i18n.ja; }
function applyLang(){
  const L = t();
  document.title = L.title; $("#title").textContent = L.title;
  $("#lang_label").textContent = L.lang_label;
  $("#lbl_client").textContent = L.client; $("#lbl_redirect").textContent = L.redirect;
  $("#btn_auth").textContent = L.auth_btn; $("#btn_clear").textContent = L.clear_btn;
  $("#csv_hint").textContent = L.csv_hint; $("#lbl_csv").textContent = L.csv_label;
  $("#lbl_expected").textContent = L.expected; $("#lbl_map_album").textContent = L.map_album; $("#lbl_map_track").textContent = L.map_track;
  $("#lbl_ignore_dj").textContent = L.ignore_dj;
  $("#btn_run").textContent = L.run; $("#btn_csv_out").textContent = L.csv_out; $("#btn_csv_meta").textContent = L.csv_meta; $("#btn_urls").textContent = L.urls_out; $("#btn_pdf").textContent = L.pdf;
  $("#pill_results").textContent = L.results; $("#meta_summary").textContent = "";
  setTokStatus();
}
function saveState(){ storage.save({lang:state.lang,access_token:state.access_token,expires_at:state.expires_at,code_verifier:state.code_verifier,client_id:state.client_id,redirect_uri:state.redirect_uri}); }
function setTokStatus(msg){
  const ok = state.access_token && Date.now()<state.expires_at;
  $("#tok_status").textContent = msg || (ok ? t().token_ok : t().token_none);
  $("#tok_status").className = "pill " + (ok?"ok":"mut");
  $("#btn_run").disabled = !ok || !loadedCSV.rows.length || !loadedCSV.albumCol;
}

/* ===================== PKCE (no scope) ===================== */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
async function sha256(buf){ const enc = new TextEncoder().encode(buf); const hash = await crypto.subtle.digest('SHA-256', enc); return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function randStr(len=64){ const a=new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a).map(b=>("0"+(b&255).toString(16)).slice(-2)).join(''); }
async function startAuth(){
  const client_id = $("#client_id").value.trim(); const redirect_uri = $("#redirect_uri").value.trim();
  if(!client_id || !redirect_uri){ alert(state.lang==='en'?"Enter Client ID & Redirect URI":"Client ID と Redirect URI を入力してください"); return; }
  state.client_id = client_id; state.redirect_uri = redirect_uri; saveState();
  const code_verifier = randStr(64); const code_challenge = await sha256(code_verifier); state.code_verifier = code_verifier; saveState();
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code"); url.searchParams.set("client_id", client_id);
  url.searchParams.set("redirect_uri", redirect_uri); url.searchParams.set("code_challenge_method","S256"); url.searchParams.set("code_challenge", code_challenge);
  location.assign(url.toString());
}
async function handleCallback(){
  const params = new URLSearchParams(location.search); const code = params.get("code"); if(!code) return;
  const client_id = $("#client_id").value.trim() || state.client_id; const redirect_uri = $("#redirect_uri").value.trim() || state.redirect_uri;
  if(!client_id || !redirect_uri){ setTokStatus("invalid_client"); alert(state.lang==='en'?"Missing client_id/redirect_uri. Re-auth.":"client_id / redirect_uri が未保存です。再認可してください。"); return; }
  if(!state.code_verifier){ setTokStatus("error: no verifier"); alert(state.lang==='en'?"Missing code_verifier. Start auth again.":"code_verifier が失われました。接続からやり直してください。"); return; }
  try{
    const body = new URLSearchParams({grant_type:"authorization_code",code,redirect_uri,client_id,code_verifier:state.code_verifier});
    const res = await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    if(!res.ok){ const ttxt = await res.text(); setTokStatus("token error"); console.error(ttxt); alert((state.lang==='en'?"Token exchange failed:\n":"トークン交換失敗:\n")+ttxt); return; }
    const json = await res.json();
    state.access_token = json.access_token; state.expires_at = Date.now() + ((json.expires_in||3600)*1000) - 5000;
    saveState(); history.replaceState({}, "", location.pathname); setTokStatus();
  }catch(e){ setTokStatus("token error"); alert(e.message); }
}
function clearToken(){ state.access_token=null; state.expires_at=0; state.code_verifier=null; saveState(); setTokStatus(); }
async function spGET(path, params={}){
  const qs = new URLSearchParams(params); const url = `https://api.spotify.com/v1${path}?${qs.toString()}`;
  for(;;){
    const res = await fetch(url,{headers:{Authorization:`Bearer ${state.access_token}`}});
    if(res.status===429){ const retry=parseInt(res.headers.get("Retry-After")||"1",10); await sleep((retry+0.2)*1000); continue; }
    if(!res.ok){ const txt=await res.text(); throw new Error(`[HTTP ${res.status}] ${txt}`); }
    return res.json();
  }
}

/* ===================== CSV load / mapping ===================== */
const loadedCSV = { headers:[], rows:[], albumCol:"", trackCol:"" };
function logLine(s,force){ if(!$("#opt_verbose").checked && !force) return; const el=document.createElement("div"); el.className="line"; el.textContent=s; $("#log").appendChild(el); el.scrollIntoView(false); }
function setProgress(i,n){ const pct = n? Math.floor(i*100/n) : 0; $("#bar").style.width = pct+"%"; $("#prog_txt").textContent = pct+"%"; }

$("#csv_file").addEventListener("change",(e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:(rs)=>{
    loadedCSV.headers = rs.meta.fields||[]; loadedCSV.rows = rs.data||[];
    const heads = loadedCSV.headers.map(h=>String(h||'').trim());
    const find = (...cands)=> heads.find(h=>cands.map(x=>x.toLowerCase()).includes(String(h||'').toLowerCase())) || "";
    loadedCSV.albumCol = find("Album title","アルバム","アルバム名") || heads.find(h=>/album\s*title/i.test(h)) || "";
    loadedCSV.trackCol = find("Track title","トラック","曲名") || heads.find(h=>/track\s*title/i.test(h)) || "";
    // populate selects
    const selA = $("#sel_album_col"); selA.innerHTML=""; heads.forEach(h=>{ const o=document.createElement("option"); o.value=h; o.textContent=h; selA.appendChild(o); });
    if(loadedCSV.albumCol) selA.value = loadedCSV.albumCol;
    const selT = $("#sel_track_col"); selT.innerHTML="<option value=''>—</option>"; heads.forEach(h=>{ const o=document.createElement("option"); o.value=h; o.textContent=h; selT.appendChild(o); });
    if(loadedCSV.trackCol) selT.value = loadedCSV.trackCol;
    logLine((t().status.reading||"").replace("{n}", String(loadedCSV.rows.length)), true); setTokStatus();
  }});
});
$("#sel_album_col").addEventListener("change",(e)=>{ loadedCSV.albumCol = e.target.value; setTokStatus(); });
$("#sel_track_col").addEventListener("change",(e)=>{ loadedCSV.trackCol = e.target.value; });

/* ===================== Helpers ===================== */
function stripDecorations(s){
  return String(s||"").replace(/\s*-\s*(single|ep|remixes?|deluxe|expanded|bonus(?:\s+tracks?)?|remaster(?:ed)?(?:\s*\d{2,4})?|anniversary|special edition)\b/ig,'')
                      .replace(/\s*\((?:deluxe|expanded|bonus|remaster(?:ed)?(?:\s*\d{2,4})?|anniversary|special edition)[^)]*\)/ig,'');
}
function normalizeName(s){
  return stripDecorations(s).toLowerCase().replace(/\s+feat\.?.*$/i,'').replace(/\s+/g,' ')
         .replace(/\s*[-–—]\s*/g,'-').trim();
}
function djMixLike(name){ const n=(name||"").toLowerCase(); return n.includes("dj mix")||n.includes("continuous mix")||/\bmixed\b/i.test(n); }
function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function nameKey(n){ return String(n||"").toLowerCase().normalize("NFKC").replace(/[.\-_'’`"]/g,'').replace(/\s+/g,' ').trim(); }
function splitPeopleCSV(v){
  return String(v||"")
    .replace(/\b(feat\.?|featuring)\b.+$/i,'')
    .split(/(?:\s*\|\s*|,|、|，|＆|&| and | with | vs | x | × |\/|\+|;)/i)
    .map(s=>s.replace(/^by\s+/i,'').trim())
    .filter(Boolean);
}
function uniqueJoinPipe(arr){ const seen = new Set(); const out=[]; for(const n of arr){ const k = nameKey(n); if(!k || seen.has(k)) continue; seen.add(k); out.push(n.trim()); } return out.join(" | "); }

/* ===================== Fast Search (no /albums) ===================== */
async function searchAlbumFast(title, market){
  const q = { q:`album:"${title}"`, type:"album", limit:10 };
  if(market) q.market = market; // 応答縮小で高速化
  const rs = await spGET(`/search`, q);
  const items = rs.albums?.items||[];
  if(!items.length){
    const alt = stripDecorations(title);
    if(alt && alt!==title){
      const rs2 = await spGET(`/search`, { q:`album:"${alt}"`, type:"album", limit:10, ...(market?{market}: {}) });
      return (rs2.albums?.items||[])[0] || null;
    }
    return null;
  }
  // 先頭優先（正確同名は先頭に来るケースが多い）＋簡易一致
  const tn = normalizeName(title);
  let best = null, score = -1;
  for(const it of items){
    const cn = normalizeName(it.name||"");
    let s = (cn===tn)?100 : (cn.includes(tn)||tn.includes(cn)?80 : (cn.startsWith(tn.split(' ')[0])?60:0));
    if(s>score){ score=s; best=it; if(s===100) break; }
  }
  return best;
}
async function searchTrackFast(trackTitle, albumTitle, market){
  const base = { q:`track:"${trackTitle}" album:"${albumTitle}"`, type:"track", limit:10 };
  if(market) base.market = market;
  const rs = await spGET(`/search`, base);
  const items = rs.tracks?.items||[];
  if(!items.length){
    const altT = stripDecorations(trackTitle), altA = stripDecorations(albumTitle);
    const rs2 = await spGET(`/search`, { q:`track:"${altT||trackTitle}" album:"${altA||albumTitle}"`, type:"track", limit:10, ...(market?{market}:{}) });
    return (rs2.tracks?.items||[])[0] || null;
  }
  return items[0];
}

/* ===================== Light META (CSV-only) ===================== */
function buildMetaFromCSV(row, cols, ignoreDJ, albumTitle, trackTitle){
  const primSrc = String(row[cols.trackPrimary] || row[cols.albumPrimary] || row[cols.albumDisplay] || "").trim();
  const featSrc = String(row[cols.trackFeaturing] || row[cols.albumFeaturing] || "").trim();
  const remixSrc = String(row[cols.remixer]||"").trim();

  const primArrRaw = splitPeopleCSV(primSrc);
  const remixArrRaw = splitPeopleCSV(remixSrc);

  const primSet = new Set(primArrRaw.map(nameKey));
  const remixSet = new Set(remixArrRaw.map(nameKey));
  const overlap = [];
  for(const k of remixSet){ if(primSet.has(k)) overlap.push(k); }
  const overlapNames = overlap.length ? uniqueJoinPipe(remixArrRaw.filter(n=>overlap.includes(nameKey(n)))) : "";

  const featInPrimary = /\b(feat\.?|featuring)\b/i.test(primSrc);
  const isDJIgnored = ignoreDJ && (djMixLike(albumTitle) || djMixLike(trackTitle));

  return {
    primaryStruct: uniqueJoinPipe(primArrRaw),
    remixersStruct: uniqueJoinPipe(remixArrRaw),
    meta: {
      Album: albumTitle,
      RemixInPrimary: overlap.length ? "Y" : "N",
      OverlapNames: overlapNames || "",
      FeatInPrimary: featInPrimary ? "Y" : "N",
      DJMixIgnored: isDJIgnored ? "Y" : "N",
      PrimaryCount: primArrRaw.filter(Boolean).length,
      RemixerCount: remixArrRaw.filter(Boolean).length
    }
  };
}

/* ===================== Main (concurrent) ===================== */
let OUT_ROWS = []; let OUT_URL_LIST = []; let META_ROWS = [];

function toCSV(objs, headers){
  if(!objs.length) return "";
  const cols = headers && headers.length ? headers : Object.keys(objs[0]);
  const escv = v => { if(v==null) return ""; const s = String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; };
  const lines = [cols.join(",")]; for(const o of objs){ lines.push(cols.map(h=>escv(o[h])).join(",")); } return lines.join("\n");
}
function dl(data, name, mime){ const blob = new Blob([data],{type:mime||"text/plain;charset=utf-8"}); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.click(); }

async function run(){
  $("#results").innerHTML = "";
  $("#meta_results").innerHTML = "";
  OUT_ROWS = []; OUT_URL_LIST = []; META_ROWS = [];
  $("#btn_csv_out").disabled = true; $("#btn_csv_meta").disabled = true; $("#btn_urls").disabled = true; $("#btn_pdf").disabled = true;
  $("#summary").textContent = t().parsing; $("#meta_summary").textContent = ""; $("#log").innerHTML = ""; setProgress(0,1);

  const rows = loadedCSV.rows; const albumCol = loadedCSV.albumCol; const trackCol = loadedCSV.trackCol||"";
  const total = rows.length; const L = t(); const ignoreDJ = $("#ignore_djmix").checked;
  const light = $("#opt_light").checked; const skipTrack = $("#opt_skip_track").checked;
  const conc = Math.max(1, Math.min(12, parseInt($("#opt_conc").value||"6",10)));
  const searchMarket = $("#sel_market").value.trim();

  // CSVヘッダ推定
  const heads = loadedCSV.headers;
  const find = (...cands)=> heads.find(h=>cands.map(x=>x.toLowerCase()).includes(String(h||'').toLowerCase())) || "";
  const COL = {
    albumDisplay: find("Album display artist"),
    albumPrimary: find("Primary artists"),
    trackPrimary: find("Track primary artists"),
    trackFeaturing: find("Track featuring artists"),
    albumFeaturing: find("Featuring artists"),
    remixer: find("Remixer","Remixers"),
    spAlbumURL: find("Spotify Album URL","Album URL","Spotify album URL"),
    spTrackURL: find("Spotify Track URL","Track URL","Spotify track URL"),
    spAvail: find("Spotify Available YES/NO","Spotify Available","Spotify Available YES/NO ")
  };

  // Core table skeleton
  const coreBox = document.createElement("div");
  coreBox.innerHTML = `
    <h3>${L.tbl_core}</h3>
    <table id="tbl_core"><thead><tr>
      <th>${L.cols.A}</th><th>${L.cols.B}</th><th>${L.cols.C}</th><th>${L.cols.D}</th><th>${L.cols.E}</th><th>${L.cols.F}</th>
    </tr></thead><tbody></tbody></table>`;
  $("#results").appendChild(coreBox);
  const tbodyCore = $("#tbl_core tbody");

  const metaBox = document.createElement("div");
  metaBox.innerHTML = `<h3>${L.tbl_meta}</h3><table id="tbl_meta"><thead><tr>
    ${L.meta_cols.map(c=>`<th>${c}</th>`).join("")}
  </tr></thead><tbody></tbody></table>`;
  $("#meta_results").appendChild(metaBox);
  const tbodyMeta = $("#tbl_meta tbody");

  // プレースホルダー行（順序維持）
  const rowEls = Array.from({length:total}, ()=> {
    const tr=document.createElement("tr");
    tr.innerHTML = `<td class="skeleton" colspan="6">&nbsp;</td>`;
    tbodyCore.appendChild(tr);
    const trm=document.createElement("tr");
    trm.innerHTML = `<td class="skeleton" colspan="${L.meta_cols.length}">&nbsp;</td>`;
    tbodyMeta.appendChild(trm);
    return {core:tr, meta:trm};
  });

  let done = 0;
  const tasks = rows.map((row, idx)=> async ()=>{
    const albumTitle = String(row[albumCol]||"").trim();
    const trackTitle = trackCol ? String(row[trackCol]||"").trim() : "";
    if(!albumTitle){ logLine(`[${idx+1}/${total}] (empty album title) — skip`); return {idx}; }

    // CSVベースの構造＆META
    const {primaryStruct, remixersStruct, meta} = buildMetaFromCSV(row, COL, ignoreDJ, albumTitle, trackTitle);

    // 既存URL
    let albumURL = String(row[COL.spAlbumURL]||"").trim();
    let trackURL = String(row[COL.spTrackURL]||"").trim();
    let available = (String(row[COL.spAvail]||"").trim().toUpperCase().startsWith("Y")) ? "YES" : (albumURL?"YES":"NO");

    // DJ MixならSpotifyアクセス省略
    if(djMixLike(albumTitle) || (trackTitle && djMixLike(trackTitle))){
      logLine(`[${idx+1}/${total}] DJ Mix ignored`);
    } else {
      try{
        // アルバムURLが無い場合のみ検索（軽量）
        if(!albumURL){
          logLine((L.status.searching||"").replace("{i}",String(idx+1)).replace("{n}",String(total)).replace("{t}",albumTitle));
          const hit = await searchAlbumFast(albumTitle, searchMarket||undefined);
          if(hit){
            albumURL = `https://open.spotify.com/album/${hit.id}`;
            available = "YES";
            logLine((L.status.found||"").replace("{i}",String(idx+1)).replace("{n}",String(total)).replace("{name}",hit.name||albumTitle).replace("{id}",hit.id));
          }else{
            logLine((L.status.notfound||"").replace("{i}",String(idx+1)).replace("{n}",String(total)));
          }
        }
        // トラック検索（任意・既定で省略）
        if(!skipTrack && !trackURL && trackTitle){
          const thit = await searchTrackFast(trackTitle, albumTitle, searchMarket||undefined);
          if(thit){ trackURL = `https://open.spotify.com/track/${thit.id}`; logLine((L.status.matchedTrack||"").replace("{i}",String(idx+1)).replace("{n}",String(total)).replace("{name}",thit.name)); }
        }
      }catch(e){ logLine(`[ERR ${idx+1}/${total}] ${e.message}`, true); }
    }

    // 出力
    const coreObj = { A: albumTitle, B: available, C: albumURL, D: trackURL, E: primaryStruct, F: remixersStruct };
    OUT_ROWS[idx] = coreObj;
    META_ROWS[idx] = meta;
    if(albumURL) OUT_URL_LIST.push(albumURL);

    // 表描画（この行だけ更新）
    rowEls[idx].core.innerHTML = [
      `<td>${esc(coreObj.A)}</td>`,
      `<td>${coreObj.B==="YES" ? `<span class="badge ok">YES</span>` : `<span class="badge ng">NO</span>`}</td>`,
      `<td>${coreObj.C?`<a href="${coreObj.C}" target="_blank">${coreObj.C}</a>`:""}</td>`,
      `<td>${coreObj.D?`<a href="${coreObj.D}" target="_blank">${coreObj.D}</a>`:""}</td>`,
      `<td>${esc(coreObj.E||"")}</td>`,
      `<td>${esc(coreObj.F||"")}</td>`
    ].join("");

    rowEls[idx].meta.innerHTML = [
      `<td>${esc(meta.Album)}</td>`,
      `<td>${meta.RemixInPrimary==="Y" ? `<span class="badge ng">Y</span>` : `<span class="badge ok">N</span>`}</td>`,
      `<td>${esc(meta.OverlapNames||"")}</td>`,
      `<td>${meta.FeatInPrimary==="Y" ? `<span class="badge ng">Y</span>` : `<span class="badge ok">N</span>`}</td>`,
      `<td>${meta.DJMixIgnored==="Y" ? `<span class="badge ng">Y</span>` : `<span class="badge ok">N</span>`}</td>`,
      `<td>${String(meta.PrimaryCount)}</td>`,
      `<td>${String(meta.RemixerCount)}</td>`
    ].join("");

    done++; setProgress(done,total);
    return {idx};
  });

  // セマフォ並列実行
  async function runPool(limit){
    let i=0; const inFlight=[];
    const launch = async ()=>{
      if(i>=tasks.length) return;
      const my = tasks[i++]().finally(()=>{ inFlight.splice(inFlight.indexOf(my),1); });
      inFlight.push(my);
      if(inFlight.length>=limit){ await Promise.race(inFlight); }
      return launch();
    };
    const starters = Array.from({length:Math.min(limit,tasks.length)}, ()=>launch());
    await Promise.all(starters.concat(inFlight));
  }

  await runPool(conc);

  $("#summary").textContent = t().parsed(OUT_ROWS.filter(Boolean).length);
  $("#meta_summary").textContent = `${META_ROWS.filter(Boolean).length} 行の監査メタを作成（軽量）`;
  $("#btn_csv_out").disabled = OUT_ROWS.length===0;
  $("#btn_csv_meta").disabled = META_ROWS.length===0;
  $("#btn_urls").disabled = OUT_URL_LIST.length===0;
  $("#btn_pdf").disabled = false;
  logLine(t().status.exportReady||"[OK] export ready", true);
}

/* ===================== Exports ===================== */
$("#btn_csv_out").addEventListener("click", ()=>{
  const L = t();
  const headers = [L.cols.A, L.cols.B, L.cols.C, L.cols.D, L.cols.E, L.cols.F];
  const remap = OUT_ROWS.map(r=>r?({[L.cols.A]: r.A, [L.cols.B]: r.B, [L.cols.C]: r.C, [L.cols.D]: r.D, [L.cols.E]: r.E, [L.cols.F]: r.F}):null).filter(Boolean);
  const csv = toCSV(remap, headers); dl(csv, "spotify_csv_audit_A-F_light.csv", "text/csv;charset=utf-8");
});
$("#btn_csv_meta").addEventListener("click", ()=>{
  const L = t(); const headers = L.meta_cols;
  const csvObjs = META_ROWS.map(m=>m?({
    [headers[0]]: m.Album,
    [headers[1]]: m.RemixInPrimary,
    [headers[2]]: m.OverlapNames,
    [headers[3]]: m.FeatInPrimary,
    [headers[4]]: m.DJMixIgnored,
    [headers[5]]: m.PrimaryCount,
    [headers[6]]: m.RemixerCount
  }):null).filter(Boolean);
  const csv = toCSV(csvObjs, headers);
  dl(csv, "spotify_csv_audit_META_light.csv", "text/csv;charset=utf-8");
});
$("#btn_urls").addEventListener("click", ()=>{
  const uniq = Array.from(new Set(OUT_URL_LIST.filter(Boolean)));
  dl(uniq.join("\n"), "spotify_album_urls.txt", "text/plain;charset=utf-8");
});
$("#btn_pdf").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf; const pdf = new jsPDF({unit:"pt", format:"a4"});
  const a4w = 595.28, margin = 24; const node = document.querySelector("#results_card");
  const canvas = await html2canvas(node,{scale:2, backgroundColor:"#ffffff", useCORS:true});
  const imgW = a4w - margin*2; let y = 0, page = 0;
  while (y < canvas.height){
    const pageCanvas = document.createElement("canvas"); pageCanvas.width = canvas.width;
    const sliceH = Math.min(canvas.height - y, Math.floor(canvas.width * (842 - margin*2) / imgW));
    pageCanvas.height = sliceH; const ctx = pageCanvas.getContext("2d");
    ctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
    const imgData = pageCanvas.toDataURL("image/jpeg", 0.92);
    if(page>0) pdf.addPage(); pdf.addImage(imgData, "JPEG", margin, margin, imgW, (sliceH * imgW / canvas.width));
    y += sliceH; page++;
  }
  pdf.save("spotify_csv_audit_light.pdf");
});

/* ===================== Events / init ===================== */
$("#btn_auth").addEventListener("click", startAuth);
$("#btn_clear").addEventListener("click", clearToken);
$("#btn_run").addEventListener("click", run);
$("#lang_sel").addEventListener("change",(e)=>{ state.lang=e.target.value; saveState(); applyLang(); });

(async function init(){
  $("#lang_sel").value = state.lang || 'ja'; applyLang(); await handleCallback();
  if(state.client_id) $("#client_id").value = state.client_id; if(state.redirect_uri) $("#redirect_uri").value = state.redirect_uri;
  setTokStatus();
})();
</script>
</body>
</html>
