<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spotify CSV Auditor — A–F Filler (TDCS, Grouped Markets, i18n + CSV/PDF)</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<!-- deps -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
  :root{--bd:#e5e7eb;--fg:#111;--mut:#555;--ok:#0a7a2f;--ng:#b00020;--bg:#fafafa;--ink:#111;--chip:#f6f6f6}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 10px}
  h3{margin:14px 0 6px;font-size:16px}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  label{font-size:12px;color:var(--mut);display:block;margin:0 0 6px}
  input[type=text],select,textarea{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px;font-size:14px;background:#fff}
  textarea{min-height:100px;resize:vertical}
  input[type=file]{border:1px dashed var(--bd);background:#fff;padding:12px;border-radius:10px;width:100%}
  .btn{padding:.65rem 1rem;border:1px solid var(--ink);background:var(--ink);color:#fff;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#fff;color:var(--ink);border:1px solid var(--bd)}
  .pill{display:inline-block;border:1px solid var(--bd);padding:.25rem .6rem;border-radius:999px;font-size:12px;margin-right:6px;background:var(--chip)}
  .mut{color:var(--mut)} .mono{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace}
  .badge{display:inline-block;padding:.1rem .5rem;border-radius:6px;font-size:11px}
  .badge.ok{background:#eaf6ee;color:#166534}
  .badge.ng{background:#fdeaea;color:#991b1b}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border-bottom:1px solid var(--bd);text-align:left;padding:8px 6px;vertical-align:top}
  th{background:#f6f6f6;position:sticky;top:0;z-index:1}
  .prog{height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:#111;transition:width .25s}
  .log{max-height:280px;overflow:auto;border:1px solid var(--bd);border-radius:10px;padding:8px;background:#fff}
  .log .line{font-family:ui-monospace,Consolas,Menlo,Monaco,monospace;font-size:12px;padding:2px 0;border-bottom:1px dashed #f0f0f0}
  .hint{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Spotify CSV Auditor — A–F Filler（TDCS, 固定4マーケット, i18n+CSV/PDF）</h1>
    <div class="row">
      <label class="mut" style="margin:0">
        <span id="lang_label" class="mut" style="font-size:12px;margin-right:6px">Language</span>
        <select id="lang_sel" style="width:auto">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Auth -->
  <div class="card">
    <div class="grid">
      <div>
        <label id="lbl_client">Client ID（Spotify Developer）</label>
        <input id="client_id" type="text" placeholder="e.g., f5b88dacf6374e0485971c59d0f528bc"/>
      </div>
      <div>
        <label id="lbl_redirect">Redirect URI（Developer Dashboardで完全一致）</label>
        <input id="redirect_uri" type="text" placeholder="https://npr2025.github.io/spotify-auth/csv_auditor.html"/>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btn_auth" class="btn">Spotifyに接続（PKCE／スコープなし）</button>
      <span id="tok_status" class="pill mut">access_token: none</span>
      <button id="btn_clear" class="btn btn-ghost">保存トークン削除</button>
    </div>
    <div id="hint_auth" class="hint" style="margin-top:6px">
      ※ 公開GETのみ使用（search/album/track）。Redirect URI は Dashboard に完全一致登録。<br/>
      ※ <span class="mono">code_verifier</span> は localStorage に保存。
    </div>
  </div>

  <!-- CSV Input & Mapping -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill">CSV</span>
        <span class="mut" id="csv_hint">アルバム一覧CSVを読み込み → CSVの行順のまま処理（CSVに無いタイトルは追加しない）</span>
      </div>
      <div class="row">
        <input id="ignore_djmix" type="checkbox" checked>
        <label for="ignore_djmix" id="lbl_ignore_dj" style="margin:0">DJミックス表記の曲は無視</label>
      </div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div>
        <label id="lbl_csv">CSVファイルを選択</label>
        <input id="csv_file" type="file" accept=".csv,text/csv"/>
      </div>
      <div>
        <label id="lbl_expected">期待アーティストID（参考／カンマ区切り）</label>
        <input id="expected_ids" type="text" value=""/>
      </div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div>
        <label id="lbl_map_album">アルバムタイトル列（既定: Album title）</label>
        <select id="sel_album_col"></select>
      </div>
      <div>
        <label id="lbl_map_track">トラックタイトル列（既定: Track title）</label>
        <select id="sel_track_col"><option value="">—</option></select>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btn_run" class="btn" disabled>解析を実行</button>
      <button id="btn_csv_out" class="btn btn-ghost" disabled>結果CSVをダウンロード</button>
      <button id="btn_csv_meta" class="btn btn-ghost" disabled>META CSVをダウンロード</button>
      <button id="btn_urls" class="btn btn-ghost" disabled>アルバムURL一覧（改行区切り）</button>
      <button id="btn_pdf" class="btn btn-ghost" disabled>PDFをダウンロード</button>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="prog" style="flex:1"><div class="bar" id="bar"></div></div>
      <span class="mut mono" id="prog_txt">0%</span>
    </div>
    <div class="log" id="log" style="margin-top:8px"></div>
  </div>

  <!-- Results -->
  <div class="card" id="results_card">
    <div class="row"><div class="pill" id="pill_results">結果</div><span id="summary" class="mut"></span></div>
    <div id="results"></div>
  </div>

  <div class="card">
    <div class="pill" id="pill_markets">Markets: 固定4グループ</div>
    <div class="hint" id="hint_markets" style="margin-top:6px">
      • United States, Canada ／ • United Kingdom, Ireland ／ • European Union（UK/IE除外）／ • Worldwide（Europe＋US＋CA除外）
    </div>
  </div>

  <!-- META (CSV基準) -->
  <div class="card" id="meta_card">
    <div class="row"><div class="pill">META（CSV基準・監査）</div><span class="mut" id="meta_summary"></span></div>
    <div id="meta_results"></div>
  </div>
</div>

<script>
/* ===================== i18n ===================== */
const i18n = {
  en:{
    title:"Spotify CSV Auditor — A–F Filler (TDCS, Grouped Markets, i18n + CSV/PDF)",
    lang_label:"Language",
    client:"Client ID (Spotify Developer)",
    redirect:"Redirect URI (must exactly match in Developer Dashboard)",
    auth_btn:"Connect to Spotify (PKCE / no scope)",
    clear_btn:"Clear saved token",
    csv_hint:"Load an album list CSV → strictly in its order (no extra titles).",
    csv_label:"Choose CSV file",
    expected:"Expected artist IDs (optional, comma-separated)",
    map_album:"Album title column (default: Album title)",
    map_track:"Track title column (default: Track title)",
    ignore_dj:"Ignore tracks with DJ-mix notation",
    run:"Run analysis",
    csv_out:"Download results CSV",
    csv_meta:"Download META CSV",
    urls_out:"Album URLs (newline list)",
    pdf:"Download PDF",
    results:"Results",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    parsing:"Parsing…",
    parsed:(n)=>`${n} row(s) processed. You can export CSV/URLs/PDF.`,
    tbl_core:"A–F output (per CSV row, in order)",
    tbl_market:"Grouped market availability (per album)",
    tbl_meta:"CSV-based META checks",
    cols:{A:"Album title",B:"Spotify Available",C:"Spotify Album URL",D:"Spotify Track URL",E:"Primary structure (CSV, ' | ')",F:"Remixers (CSV, ' | ')" },
    markets_cols:["US/CA","UK/IE","EU (ex UK/IE)","World (ex EU/US/CA)"],
    meta_cols:["Album (CSV)","Remixer→Primary混入","重複名（詳細）","feat.混入","DJ Mix無視","Primary件数","Remixer件数","ExpectedID一致","Album artists(ids)"],
    status:{reading:"[CSV] loaded: {n} row(s).", searching:'[{i}/{n}] find album for: "{t}"', found:'[{i}/{n}] album: {name} — {id}', notfound:'[{i}/{n}] NOT FOUND', tracks:'[{i}/{n}] tracks fetched: {count}', matchedTrack:'[{i}/{n}] matched track: {name}', exportReady:"[OK] export buttons enabled."}
  },
  ja:{
    title:"Spotify CSV Auditor — A–F Filler（TDCS／固定4マーケット／i18n＋CSV/PDF）",
    lang_label:"表示言語",
    client:"Client ID（Spotify Developer）",
    redirect:"Redirect URI（Developer Dashboardで完全一致）",
    auth_btn:"Spotifyに接続（PKCE／スコープなし）",
    clear_btn:"保存トークン削除",
    csv_hint:"アルバム一覧CSVを読み込み → CSVの行順のまま処理（CSVに無いタイトルは追加しない）",
    csv_label:"CSVファイルを選択",
    expected:"期待アーティストID（任意／カンマ区切り）",
    map_album:"アルバムタイトル列（既定: Album title）",
    map_track:"トラックタイトル列（既定: Track title）",
    ignore_dj:"DJミックス表記の曲は無視",
    run:"解析を実行",
    csv_out:"結果CSVをダウンロード",
    csv_meta:"META CSVをダウンロード",
    urls_out:"アルバムURL一覧（改行区切り）",
    pdf:"PDFをダウンロード",
    results:"結果",
    token_none:"access_token: none",
    token_ok:"access_token: OK",
    parsing:"解析中…",
    parsed:(n)=>`${n} 行を解析完了。CSV／URL一覧／PDFを出力できます。`,
    tbl_core:"A–F 出力（CSV行順）",
    tbl_market:"グループ化マーケット（アルバム別）",
    tbl_meta:"CSV基準のMETAチェック",
    cols:{A:"Album title",B:"Spotify Available",C:"Spotify Album URL",D:"Spotify Track URL",E:"Primary構造（CSV由来／' | '）",F:"Remixers（CSV由来／' | '）"},
    markets_cols:["US/CA","UK/IE","EU（UK/IE除外）","World（EU/US/CA除外）"],
    meta_cols:["Album (CSV)","Remixer→Primary混入","重複名（詳細）","feat.混入","DJ Mix無視","Primary件数","Remixer件数","ExpectedID一致","Album artists(ids)"],
    status:{reading:"[CSV] 読み込み: {n} 行", searching:'[{i}/{n}] アルバム検索: 「{t}」', found:'[{i}/{n}] ヒット: {name} — {id}', notfound:'[{i}/{n}] 見つからず', tracks:'[{i}/{n}] トラック取得: {count} 件', matchedTrack:'[{i}/{n}] マッチ: {name}', exportReady:"[OK] エクスポート準備完了"}
  }
};
const storage = { get k(){ return 'sp_csv_auditor_tdcs_v2'; }, load(){ try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}} }, save(obj){ localStorage.setItem(this.k, JSON.stringify(obj||{})); }};
const state = Object.assign({lang:'ja',access_token:null,expires_at:0,code_verifier:null,client_id:"",redirect_uri:""}, storage.load());
const $ = sel => document.querySelector(sel);
function t(){ return i18n[state.lang]||i18n.ja; }
function applyLang(){
  const L = t();
  document.title = L.title; $("#title").textContent = L.title;
  $("#lang_label").textContent = L.lang_label;
  $("#lbl_client").textContent = L.client; $("#lbl_redirect").textContent = L.redirect;
  $("#btn_auth").textContent = L.auth_btn; $("#btn_clear").textContent = L.clear_btn;
  $("#csv_hint").textContent = L.csv_hint; $("#lbl_csv").textContent = L.csv_label;
  $("#lbl_expected").textContent = L.expected; $("#lbl_map_album").textContent = L.map_album; $("#lbl_map_track").textContent = L.map_track;
  $("#lbl_ignore_dj").textContent = L.ignore_dj;
  $("#btn_run").textContent = L.run; $("#btn_csv_out").textContent = L.csv_out; $("#btn_csv_meta").textContent = L.csv_meta; $("#btn_urls").textContent = L.urls_out; $("#btn_pdf").textContent = L.pdf;
  $("#pill_results").textContent = L.results; $("#pill_markets").textContent = "Markets: 固定4グループ";
  $("#hint_markets").innerHTML = state.lang==='ja'
    ? "• United States, Canada ／ • United Kingdom, Ireland ／ • European Union（UK/IE除外）／ • Worldwide（Europe＋US＋CA除外）"
    : "• United States, Canada / • United Kingdom, Ireland / • European Union (excl. UK & Ireland) / • Worldwide (excl. Europe, US, Canada)";
  setTokStatus();
}
function saveState(){ storage.save({lang:state.lang,access_token:state.access_token,expires_at:state.expires_at,code_verifier:state.code_verifier,client_id:state.client_id,redirect_uri:state.redirect_uri}); }
function setTokStatus(msg){
  const ok = state.access_token && Date.now()<state.expires_at;
  $("#tok_status").textContent = msg || (ok ? t().token_ok : t().token_none);
  $("#tok_status").className = "pill " + (ok?"ok":"mut");
  $("#btn_run").disabled = !ok || !loadedCSV.rows.length || !loadedCSV.albumCol;
}

/* ===================== PKCE (no scope) ===================== */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
async function sha256(buf){ const enc = new TextEncoder().encode(buf); const hash = await crypto.subtle.digest('SHA-256', enc); return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
function randStr(len=64){ const a=new Uint8Array(len); crypto.getRandomValues(a); return Array.from(a).map(b=>("0"+(b&255).toString(16)).slice(-2)).join(''); }
async function startAuth(){
  const client_id = $("#client_id").value.trim(); const redirect_uri = $("#redirect_uri").value.trim();
  if(!client_id || !redirect_uri){ alert(state.lang==='en'?"Enter Client ID & Redirect URI":"Client ID と Redirect URI を入力してください"); return; }
  state.client_id = client_id; state.redirect_uri = redirect_uri; saveState();
  const code_verifier = randStr(64); const code_challenge = await sha256(code_verifier); state.code_verifier = code_verifier; saveState();
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code"); url.searchParams.set("client_id", client_id);
  url.searchParams.set("redirect_uri", redirect_uri); url.searchParams.set("code_challenge_method","S256"); url.searchParams.set("code_challenge", code_challenge);
  // scopeなし（公開GETのみ）
  location.assign(url.toString());
}
async function handleCallback(){
  const params = new URLSearchParams(location.search); const code = params.get("code"); if(!code) return;
  const client_id = $("#client_id").value.trim() || state.client_id; const redirect_uri = $("#redirect_uri").value.trim() || state.redirect_uri;
  if(!client_id || !redirect_uri){ setTokStatus("invalid_client"); alert(state.lang==='en'?"Missing client_id/redirect_uri. Re-auth.":"client_id / redirect_uri が未保存です。再認可してください。"); return; }
  if(!state.code_verifier){ setTokStatus("error: no verifier"); alert(state.lang==='en'?"Missing code_verifier. Start auth again.":"code_verifier が失われました。接続からやり直してください。"); return; }
  try{
    const body = new URLSearchParams({grant_type:"authorization_code",code,redirect_uri,client_id,code_verifier:state.code_verifier});
    const res = await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    if(!res.ok){ const ttxt = await res.text(); setTokStatus("token error"); console.error(ttxt); alert((state.lang==='en'?"Token exchange failed:\n":"トークン交換失敗:\n")+ttxt); return; }
    const json = await res.json();
    state.access_token = json.access_token; state.expires_at = Date.now() + ((json.expires_in||3600)*1000) - 5000;
    saveState(); history.replaceState({}, "", location.pathname); setTokStatus();
  }catch(e){ setTokStatus("token error"); alert(e.message); }
}
function clearToken(){ state.access_token=null; state.expires_at=0; state.code_verifier=null; saveState(); setTokStatus(); }
async function spGET(path, params={}){
  const qs = new URLSearchParams(params); const url = `https://api.spotify.com/v1${path}?${qs.toString()}`;
  for(;;){
    const res = await fetch(url,{headers:{Authorization:`Bearer ${state.access_token}`}});
    if(res.status===429){ const retry=parseInt(res.headers.get("Retry-After")||"1",10); await sleep((retry+0.2)*1000); continue; }
    if(!res.ok){ const txt=await res.text(); throw new Error(`[HTTP ${res.status}] ${txt}`); }
    return res.json();
  }
}

/* ===================== CSV load / mapping ===================== */
const loadedCSV = { headers:[], rows:[], albumCol:"", trackCol:"" };
function logLine(s){ const el=document.createElement("div"); el.className="line"; el.textContent=s; $("#log").appendChild(el); el.scrollIntoView(false); }
function setProgress(i,n){ const pct = n? Math.floor(i*100/n) : 0; $("#bar").style.width = pct+"%"; $("#prog_txt").textContent = pct+"%"; }

$("#csv_file").addEventListener("change",(e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  Papa.parse(file,{header:true,skipEmptyLines:true,complete:(rs)=>{
    loadedCSV.headers = rs.meta.fields||[]; loadedCSV.rows = rs.data||[];
    const heads = loadedCSV.headers.map(h=>String(h||'').trim());
    const find = (...cands)=> heads.find(h=>cands.map(x=>x.toLowerCase()).includes(String(h||'').toLowerCase())) || "";
    // default mapping
    loadedCSV.albumCol = find("Album title","アルバム","アルバム名") || heads.find(h=>/album\s*title/i.test(h)) || "";
    loadedCSV.trackCol = find("Track title","トラック","曲名") || heads.find(h=>/track\s*title/i.test(h)) || "";
    // populate selects
    const selA = $("#sel_album_col"); selA.innerHTML=""; heads.forEach(h=>{ const o=document.createElement("option"); o.value=h; o.textContent=h; selA.appendChild(o); });
    if(loadedCSV.albumCol) selA.value = loadedCSV.albumCol;
    const selT = $("#sel_track_col"); selT.innerHTML="<option value=''>—</option>"; heads.forEach(h=>{ const o=document.createElement("option"); o.value=h; o.textContent=h; selT.appendChild(o); });
    if(loadedCSV.trackCol) selT.value = loadedCSV.trackCol;
    logLine((t().status.reading||"").replace("{n}", String(loadedCSV.rows.length))); setTokStatus();
  }});
});
$("#sel_album_col").addEventListener("change",(e)=>{ loadedCSV.albumCol = e.target.value; setTokStatus(); });
$("#sel_track_col").addEventListener("change",(e)=>{ loadedCSV.trackCol = e.target.value; });

/* ===================== Helpers ===================== */
function stripDecorations(s){
  return String(s||"").replace(/\s*-\s*(single|ep|remixes?|deluxe|expanded|bonus(?:\s+tracks?)?|remaster(?:ed)?(?:\s*\d{2,4})?|anniversary|special edition)\b/ig,'')
                      .replace(/\s*\((?:deluxe|expanded|bonus|remaster(?:ed)?(?:\s*\d{2,4})?|anniversary|special edition)[^)]*\)/ig,'');
}
function normalizeName(s){
  return stripDecorations(s).toLowerCase().replace(/\s+feat\.?.*$/i,'').replace(/\s+/g,' ')
         .replace(/\s*[-–—]\s*/g,'-').trim();
}
function djMixLike(name){ const n=(name||"").toLowerCase(); return n.includes("dj mix")||n.includes("continuous mix")||/\bmixed\b/i.test(n); }
function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

// name→比較キー
function nameKey(n){ return String(n||"").toLowerCase().normalize("NFKC").replace(/[.\-_'’`"]/g,'').replace(/\s+/g,' ').trim(); }

/* ==== 人名分割（CSVのみを信頼） ==== */
function splitPeopleCSV(v){
  return String(v||"")
    .replace(/\b(feat\.?|featuring)\b.+$/i,'') // Primary末尾の feat. は切る（E には入れない）
    .split(/(?:\s*\|\s*|,|、|，|＆|&| and | with | vs | x | × |\/|\+|;)/i)
    .map(s=>s.replace(/^by\s+/i,'').trim())
    .filter(Boolean);
}
function uniqueJoinPipe(arr){
  const seen = new Set(); const out=[];
  for(const n of arr){
    const k = nameKey(n);
    if(!k || seen.has(k)) continue; seen.add(k); out.push(n.trim());
  }
  return out.join(" | ");
}

/* ===== Markets (fixed groups) ===== */
const EU27_NO_UK_IE = new Set(["AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR","DE","GR","HU","IT","LV","LT","LU","MT","NL","PL","PT","RO","SK","SI","ES","SE"]);
const EUROPE_WIDE = new Set([...EU27_NO_UK_IE,"IE","GB","NO","IS","CH","AL","BA","ME","MK","RS","UA","MD","BY","XK","LI"]);
const ALL_MARKETS = new Set(["AD","AE","AL","AM","AO","AR","AT","AU","AZ","BA","BB","BD","BE","BF","BG","BH","BI","BJ","BN","BO","BR","BS","BT","BW","BY","BZ","CA","CD","CG","CH","CI","CL","CM","CO","CR","CV","CW","CY","CZ","DE","DJ","DK","DM","DO","DZ","EC","EE","EG","ES","ET","FI","FJ","FM","FR","GA","GB","GD","GE","GH","GM","GN","GQ","GR","GT","GW","GY","HK","HN","HR","HT","HU","ID","IE","IL","IN","IQ","IS","IT","JM","JO","JP","KE","KG","KH","KI","KM","KN","KR","KW","KZ","LA","LB","LC","LI","LK","LR","LS","LT","LU","LV","LY","MA","MC","MD","ME","MG","MH","MK","ML","MN","MO","MR","MT","MU","MV","MW","MX","MY","MZ","NA","NE","NG","NI","NL","NO","NP","NR","NZ","OM","PA","PE","PG","PH","PK","PL","PS","PT","PW","PY","QA","RO","RS","RU","RW","SA","SB","SC","SE","SG","SI","SK","SL","SM","SN","SR","ST","SV","SZ","TD","TG","TH","TJ","TL","TN","TO","TR","TT","TV","TW","TZ","UA","UG","US","UY","UZ","VC","VE","VN","VU","WS","XK","ZA","ZM","ZW"]);
const GROUPS = [
  { key:"US_CA", label:"US/CA", codes:new Set(["US","CA"]) },
  { key:"UK_IE", label:"UK/IE", codes:new Set(["GB","IE"]) },
  { key:"EU_EX_UK_IE", label:"EU (ex UK/IE)", codes:new Set([...EU27_NO_UK_IE]) },
  { key:"WORLD_EX_EU_US_CA", label:"World (ex EU/US/CA)", codes:(()=>{ const ex=new Set([...EUROPE_WIDE,"US","CA"]); return new Set([...ALL_MARKETS].filter(c=>!ex.has(c))); })() }
];
function groupFlags(avSet){
  const flags = {};
  for(const g of GROUPS){
    let hits=0; for(const c of g.codes){ if(avSet.has(c)) hits++; }
    flags[g.key] = hits>0 ? "Y" : "N";
  }
  return flags;
}

/* ===================== Search helpers (Album/Track URLだけ) ===================== */
const PRIMARY_MARKET = "US";
function bestNameMatch(cands, target){
  const tn = normalizeName(target); let best=null, score=-1;
  for(const c of cands){
    const name = c.name || c.album?.name || "";
    const cn = normalizeName(name); let s = 0;
    if(cn===tn) s=100; else if(cn.includes(tn)||tn.includes(cn)) s=80; else { const t0 = tn.split(' ')[0]; if(cn.startsWith(t0)) s=60; }
    if(s>score){ score=s; best=c; } if(score===100) break;
  } return best;
}
async function searchAlbumByTitle(title){
  let items = (await spGET(`/search`, { q:`album:"${title}"`, type:"album", limit:20 })).albums?.items||[];
  if(!items.length){ items = (await spGET(`/search`, { q:`album:"${title}"`, type:"album", limit:20, market:PRIMARY_MARKET })).albums?.items||[]; }
  if(!items.length){ const alt = stripDecorations(title); if(alt && alt!==title){ items = (await spGET(`/search`, { q:`album:"${alt}"`, type:"album", limit:20 })).albums?.items||[]; } }
  const pick = bestNameMatch(items, title); if(!pick) return null;
  // market パラメータは付けず available_markets をそのまま取得
  return spGET(`/albums/${pick.id}`);
}
async function searchTrackFast(trackTitle, albumTitle){
  const q = await spGET(`/search`, { q:`track:"${trackTitle}" album:"${albumTitle}"`, type:"track", limit:20, market:PRIMARY_MARKET });
  const items = q.tracks?.items||[];
  if(!items.length){
    const altT = stripDecorations(trackTitle), altA = stripDecorations(albumTitle);
    const q2 = await spGET(`/search`, { q:`track:"${altT||trackTitle}" album:"${altA||albumTitle}"`, type:"track", limit:20, market:PRIMARY_MARKET });
    return bestNameMatch(q2.tracks?.items||[], trackTitle);
  }
  return bestNameMatch(items, trackTitle);
}

/* ===================== Main run ===================== */
let OUT_ROWS = []; let OUT_URL_LIST = []; let META_ROWS = [];

function parseExpectedIDs(){ const v=$("#expected_ids").value.trim(); if(!v) return new Set(); return new Set(v.split(/[,，\s]+/).map(s=>s.trim()).filter(Boolean)); }

async function run(){
  $("#results").innerHTML = "";
  $("#meta_results").innerHTML = "";
  OUT_ROWS = []; OUT_URL_LIST = []; META_ROWS = [];
  $("#btn_csv_out").disabled = true; $("#btn_csv_meta").disabled = true; $("#btn_urls").disabled = true; $("#btn_pdf").disabled = true;
  $("#summary").textContent = t().parsing; $("#meta_summary").textContent = ""; $("#log").innerHTML = ""; setProgress(0,1);

  const rows = loadedCSV.rows; const albumCol = loadedCSV.albumCol; const trackCol = loadedCSV.trackCol||"";
  const total = rows.length; const M = t(); const expectedIDs = parseExpectedIDs(); const ignoreDJ = $("#ignore_djmix").checked;

  // === CSVカラム（このファイル構成を前提にオート検出） ===
  const heads = loadedCSV.headers;
  const find = (...cands)=> heads.find(h=>cands.map(x=>x.toLowerCase()).includes(String(h||'').toLowerCase())) || "";
  const COL = {
    albumDisplay: find("Album display artist"),
    albumPrimary: find("Primary artists"),
    trackPrimary: find("Track primary artists"),
    trackFeaturing: find("Track featuring artists"),
    albumFeaturing: find("Featuring artists"),
    remixer: find("Remixer","Remixers"),
    // URL/可用列（表記ゆれ対応）
    spAlbumURL: find("Spotify Album URL","Album URL","Spotify album URL"),
    spTrackURL: find("Spotify Track URL","Track URL","Spotify track URL"),
    spAvail: find("Spotify Available YES/NO","Spotify Available","Spotify Available YES/NO ")
  };

  // === 表を作る（Core / Markets） ===
  const coreBox = document.createElement("div");
  coreBox.innerHTML = `
    <h3>${M.tbl_core}</h3>
    <table id="tbl_core"><thead><tr>
      <th>${M.cols.A}</th><th>${M.cols.B}</th><th>${M.cols.C}</th><th>${M.cols.D}</th><th>${M.cols.E}</th><th>${M.cols.F}</th>
      <th>${M.markets_cols[0]}</th><th>${M.markets_cols[1]}</th><th>${M.markets_cols[2]}</th><th>${M.markets_cols[3]}</th>
    </tr></thead><tbody></tbody></table>`;
  $("#results").appendChild(coreBox);

  const marketBox = document.createElement("div");
  marketBox.innerHTML = `<h3>${M.tbl_market}</h3><table id="tbl_market"><thead><tr>
    <th>Album</th><th>Album ID</th>
    <th>${M.markets_cols[0]}</th><th>${M.markets_cols[1]}</th><th>${M.markets_cols[2]}</th><th>${M.markets_cols[3]}</th>
    <th>Status</th>
  </tr></thead><tbody></tbody></table>`;
  $("#results").appendChild(marketBox);

  // === META表 ===
  const metaBox = document.createElement("div");
  metaBox.innerHTML = `<h3>${M.tbl_meta}</h3><table id="tbl_meta"><thead><tr>
    ${M.meta_cols.map(c=>`<th>${c}</th>`).join("")}
  </tr></thead><tbody></tbody></table>`;
  $("#meta_results").appendChild(metaBox);

  const tbodyCore = $("#tbl_core tbody"); const tbodyMarket = $("#tbl_market tbody"); const tbodyMeta = $("#tbl_meta tbody");
  const addRow = (cells)=>`<tr>${cells.map(c=>`<td>${c}</td>`).join("")}</tr>`;

  for(let i=0;i<total;i++){
    setProgress(i,total);
    const row = rows[i]||{};
    const albumTitle = String(row[albumCol]||"").trim();
    const trackTitle = trackCol ? String(row[trackCol]||"").trim() : "";

    if(!albumTitle){ logLine(`[${i+1}/${total}] (empty album title) — skip`); continue; }
    logLine((M.status.searching||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{t}",albumTitle));

    // === E/F（CSVに100%準拠） ===
    const primSrc = String(row[COL.trackPrimary] || row[COL.albumPrimary] || row[COL.albumDisplay] || "").trim();
    const featSrc = String(row[COL.trackFeaturing] || row[COL.albumFeaturing] || "").trim();
    const remixSrc = String(row[COL.remixer]||"").trim();

    const primArrRaw = splitPeopleCSV(primSrc);
    const remixArrRaw = splitPeopleCSV(remixSrc);
    const primaryStruct = uniqueJoinPipe(primArrRaw);
    const remixersStruct = uniqueJoinPipe(remixArrRaw);

    // === CSV基準のメタ判定 ===
    const primSet = new Set(primArrRaw.map(nameKey));
    const remixSet = new Set(remixArrRaw.map(nameKey));
    const overlap = [];
    for(const k of remixSet){ if(primSet.has(k)) overlap.push(k); }
    const overlapNames = overlap.length ? uniqueJoinPipe(remixArrRaw.filter(n=>overlap.includes(nameKey(n)))) : "";

    const featInPrimary = /\b(feat\.?|featuring)\b/i.test(primSrc);
    const isDJIgnored = ignoreDJ && (djMixLike(albumTitle) || djMixLike(trackTitle));

    // === Spotify URL/Markets ===
    let album=null, albumId="", albumName="", albumURL=String(row[COL.spAlbumURL]||"").trim(), trackURL=String(row[COL.spTrackURL]||"").trim();
    let available = (String(row[COL.spAvail]||"").trim().toUpperCase().startsWith("Y")) ? "YES" : (albumURL?"YES":"NO");
    let avSet = new Set(); let expectedHit = "";

    try{
      if(!isDJIgnored){ // DJ Mix 無視時はSpotify検索をスキップ
        if(!albumURL){ // アルバムURLなければSpotify検索
          const got = await searchAlbumByTitle(albumTitle);
          if(got){
            album = got; albumId = got.id; albumName = got.name;
            albumURL = `https://open.spotify.com/album/${albumId}`; available = "YES";
            avSet = new Set(got.available_markets||[]);
            logLine((M.status.found||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{name}",albumName).replace("{id}",albumId));
          }else{
            logLine((M.status.notfound||"").replace("{i}",String(i+1)).replace("{n}",String(total)));
          }
        }else{
          const m = albumURL.match(/album\/([a-zA-Z0-9]{10,})/); if(m){ albumId = m[1]; }
          if(albumId){
            try{ const got = await spGET(`/albums/${albumId}`); album = got; albumName = got.name; avSet = new Set(got.available_markets||[]); }
            catch(_){} // 市場取得失敗は無視
          }
        }
        // Track URL（なければ検索）
        if(!trackURL && trackTitle){
          const hit = await searchTrackFast(trackTitle, albumTitle);
          if(hit) { trackURL = `https://open.spotify.com/track/${hit.id}`; logLine((M.status.matchedTrack||"").replace("{i}",String(i+1)).replace("{n}",String(total)).replace("{name}",hit.name)); }
        }
      } else {
        logLine(`[${i+1}/${total}] DJ Mix ignored`);
        available = albumURL ? "YES" : "NO";
      }
    }catch(e){ logLine(`[ERR ${i+1}/${total}] Spotify lookup ${e.message}`); }

    // Expected Artist IDs ↔ album.artists.id 突合（任意）
    let albumArtistIDs="";
    if(album && album.artists){
      const ids = (album.artists||[]).map(a=>a.id).filter(Boolean);
      albumArtistIDs = ids.join(" | ");
      if(expectedIDs.size){
        const hit = ids.some(id=>expectedIDs.has(id));
        expectedHit = hit ? "Y" : "N";
      } else {
        expectedHit = "";
      }
    }

    // Markets flags
    const flags = groupFlags(avSet);
    const fUS = flags.US_CA||"N", fUK = flags.UK_IE||"N", fEU = flags.EU_EX_UK_IE||"N", fWW = flags.WORLD_EX_EU_US_CA||"N";

    // === A–F row（CSV順を尊重） ===
    const coreObj = { A: albumTitle, B: available, C: albumURL, D: trackURL, E: primaryStruct, F: remixersStruct, US_CA:fUS,UK_IE:fUK,EU_EX_UK_IE:fEU,WORLD_EX_EU_US_CA:fWW };
    OUT_ROWS.push(coreObj);

    // 表示 Core
    tbodyCore.insertAdjacentHTML("beforeend", addRow([
      esc(albumTitle),
      available==="YES" ? `<span class="badge ok">YES</span>` : `<span class="badge ng">NO</span>`,
      albumURL ? `<a href="${albumURL}" target="_blank">${albumURL}</a>` : "",
      trackURL ? `<a href="${trackURL}" target="_blank">${trackURL}</a>` : "",
      esc(primaryStruct||""), esc(remixersStruct||""),
      fUS, fUK, fEU, fWW
    ]));

    // 表示 Market
    if(album){
      tbodyMarket.insertAdjacentHTML("beforeend", addRow([
        esc(albumName||albumTitle), `<span class="mono">${albumId||""}</span>`, fUS, fUK, fEU, fWW, "—"
      ]));
      if(albumURL) OUT_URL_LIST.push(albumURL);
    }

    // === META 行 ===
    const metaRow = {
      Album: albumTitle,
      RemixInPrimary: overlap.length ? "Y" : "N",
      OverlapNames: overlapNames || "",
      FeatInPrimary: featInPrimary ? "Y" : "N",
      DJMixIgnored: isDJIgnored ? "Y" : "N",
      PrimaryCount: primArrRaw.filter(Boolean).length,
      RemixerCount: remixArrRaw.filter(Boolean).length,
      ExpectedIDHit: expectedHit,
      AlbumArtistIDs: albumArtistIDs
    };
    META_ROWS.push(metaRow);

    tbodyMeta.insertAdjacentHTML("beforeend", addRow([
      esc(metaRow.Album),
      metaRow.RemixInPrimary==="Y" ? `<span class="badge ng">Y</span>` : `<span class="badge ok">N</span>`,
      esc(metaRow.OverlapNames||""),
      metaRow.FeatInPrimary==="Y" ? `<span class="badge ng">Y</span>` : `<span class="badge ok">N</span>`,
      metaRow.DJMixIgnored==="Y" ? `<span class="badge ng">Y</span>` : `<span class="badge ok">N</span>`,
      String(metaRow.PrimaryCount),
      String(metaRow.RemixerCount),
      esc(metaRow.ExpectedIDHit||""),
      esc(metaRow.AlbumArtistIDs||"")
    ]));

    await sleep(30);
  }

  setProgress(total,total);
  $("#summary").textContent = t().parsed(OUT_ROWS.length);
  $("#meta_summary").textContent = `${META_ROWS.length} 行の監査メタを作成`;
  $("#btn_csv_out").disabled = OUT_ROWS.length===0;
  $("#btn_csv_meta").disabled = META_ROWS.length===0;
  $("#btn_urls").disabled = OUT_URL_LIST.length===0;
  $("#btn_pdf").disabled = false;
  logLine(t().status.exportReady||"[OK] export ready");
}

/* ===================== Exports ===================== */
function toCSV(objs, headers){
  if(!objs.length) return "";
  const cols = headers && headers.length ? headers : Object.keys(objs[0]);
  const escv = v => { if(v==null) return ""; const s = String(v).replace(/"/g,'""'); return /[",\n]/.test(s) ? `"${s}"` : s; };
  const lines = [cols.join(",")]; for(const o of objs){ lines.push(cols.map(h=>escv(o[h])).join(",")); } return lines.join("\n");
}
function dl(data, name, mime){ const blob = new Blob([data],{type:mime||"text/plain;charset=utf-8"}); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=name; a.click(); }

$("#btn_csv_out").addEventListener("click", ()=>{
  const L = t();
  const headers = [L.cols.A, L.cols.B, L.cols.C, L.cols.D, L.cols.E, L.cols.F, "US_CA","UK_IE","EU_EX_UK_IE","WORLD_EX_EU_US_CA"];
  const remap = OUT_ROWS.map(r=>({[L.cols.A]: r.A, [L.cols.B]: r.B, [L.cols.C]: r.C, [L.cols.D]: r.D, [L.cols.E]: r.E, [L.cols.F]: r.F, "US_CA": r.US_CA, "UK_IE": r.UK_IE, "EU_EX_UK_IE": r.EU_EX_UK_IE, "WORLD_EX_EU_US_CA": r.WORLD_EX_EU_US_CA}));
  const csv = toCSV(remap, headers); dl(csv, "spotify_csv_audit_A-F.csv", "text/csv;charset=utf-8");
});

$("#btn_csv_meta").addEventListener("click", ()=>{
  const L = t();
  const headers = i18n.ja.meta_cols; // 日本語でも英語でも列名は表示用でOK
  const csvObjs = META_ROWS.map(m=>({
    [headers[0]]: m.Album,
    [headers[1]]: m.RemixInPrimary,
    [headers[2]]: m.OverlapNames,
    [headers[3]]: m.FeatInPrimary,
    [headers[4]]: m.DJMixIgnored,
    [headers[5]]: m.PrimaryCount,
    [headers[6]]: m.RemixerCount,
    [headers[7]]: m.ExpectedIDHit,
    [headers[8]]: m.AlbumArtistIDs
  }));
  const csv = toCSV(csvObjs, headers);
  dl(csv, "spotify_csv_audit_META.csv", "text/csv;charset=utf-8");
});

$("#btn_urls").addEventListener("click", ()=>{
  const uniq = Array.from(new Set(OUT_URL_LIST.filter(Boolean)));
  dl(uniq.join("\n"), "spotify_album_urls.txt", "text/plain;charset=utf-8");
});

$("#btn_pdf").addEventListener("click", async ()=>{
  const { jsPDF } = window.jspdf; const pdf = new jsPDF({unit:"pt", format:"a4"});
  const a4w = 595.28, margin = 24; const node = document.querySelector("#results_card");
  const canvas = await html2canvas(node,{scale:2, backgroundColor:"#ffffff", useCORS:true});
  const imgW = a4w - margin*2; let y = 0, page = 0;
  while (y < canvas.height){
    const pageCanvas = document.createElement("canvas"); pageCanvas.width = canvas.width;
    const sliceH = Math.min(canvas.height - y, Math.floor(canvas.width * (842 - margin*2) / imgW));
    pageCanvas.height = sliceH; const ctx = pageCanvas.getContext("2d");
    ctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
    const imgData = pageCanvas.toDataURL("image/jpeg", 0.92);
    if(page>0) pdf.addPage(); pdf.addImage(imgData, "JPEG", margin, margin, imgW, (sliceH * imgW / canvas.width));
    y += sliceH; page++;
  }
  pdf.save("spotify_csv_audit.pdf");
});

/* ===================== Events / init ===================== */
$("#btn_auth").addEventListener("click", startAuth);
$("#btn_clear").addEventListener("click", clearToken);
$("#btn_run").addEventListener("click", run);
$("#lang_sel").addEventListener("change",(e)=>{ state.lang=e.target.value; saveState(); applyLang(); });

(async function init(){
  $("#lang_sel").value = state.lang || 'ja'; applyLang(); await handleCallback();
  if(state.client_id) $("#client_id").value = state.client_id; if(state.redirect_uri) $("#redirect_uri").value = state.redirect_uri;
  setTokStatus();
})();
</script>
</body>
</html>
