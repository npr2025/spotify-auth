<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify サインイン専用 — harden v10.19</title>
<style>
body{font-family:system-ui;max-width:720px;margin:40px auto;padding:0 14px}
button{padding:10px 14px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
input[type="text"]{width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
pre{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px}
small{color:#666}
</style>
</head>
<body>
<h1>Spotify サインイン（専用ランチャ）</h1>
<p>CLIENT_ID を確認し「サインイン」を押してください（同一タブ遷移）。</p>
<label>CLIENT_ID <input id="cid" type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e"></label>
<p><small>Redirect URI は <code>https://npr2025.github.io/spotify-auth/callback.html</code> を Spotify Dashboard に登録してください。</small></p>
<p>
  <button id="go">サインイン</button>
  <button id="plain">サインイン（PLAIN直）</button>
  <button id="home" onclick="location.assign('index.html')">indexへ戻る</button>
</p>
<pre id="log">Booting…</pre>
<script>
const LOG=(...a)=>{const el=document.getElementById('log');el.textContent+=(el.textContent?'\n':'')+a.join(' ')};
const LS={ver:"sp_code_verifier",cid:"sp_client_id",acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",st:"sp_state"};
const FIXED_REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
const zws=/[\u200B-\u200D\uFEFF]/g;
const b64url=(u8)=>btoa(String.fromCharCode(...u8)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
function setVerifier(v){
  try{localStorage.setItem(LS.ver,v)}catch(e){LOG("ls fail",e.message)}
  try{sessionStorage.setItem(LS.ver,v)}catch(e){LOG("ss fail",e.message)}
  try{document.cookie=`${LS.ver}=${encodeURIComponent(v)}; Max-Age=900; SameSite=Lax; Path=/spotify-auth/`}catch(e){LOG("cookie fail",e.message)}
}
function readCID(){const ui=(document.getElementById("cid").value||"").replace(zws,"").trim(); if(ui){try{localStorage.setItem(LS.cid,ui);sessionStorage.setItem(LS.cid,ui)}catch(_){}} return ui||localStorage.getItem(LS.cid)||"1fd6350fcf4945a0b3ddffa2d5730d4e";}
function stateWithCV(cid,cv){ // 非常時復元用に state へ cv も封入（URL-safe base64）
  const payload=`{"t":${Date.now()},"cid":"${cid}","cv":"${cv}"}`;
  return "s3."+b64url(new TextEncoder().encode(payload));
}
async function authS256(){
  const cid=readCID();
  if(!(crypto&&crypto.subtle)) throw new Error("no subtle crypto");
  // 64文字 ランダム ASCII
  let v=""; crypto.getRandomValues(new Uint8Array(64)).forEach(x=>v+=String.fromCharCode(97+(x%26)));
  setVerifier(v);
  const digest=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v));
  const ch=b64url(new Uint8Array(digest));
  const st=stateWithCV(cid,v);
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",cid);
  u.searchParams.set("redirect_uri",FIXED_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",ch);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",st);
  try{localStorage.setItem(LS.st,st)}catch(_){}
  location.assign(u.toString());
}
function randAlpha(n){const a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let s="";for(let i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)];return s;}
function authPLAIN(){
  const cid=readCID();
  const v=randAlpha(64);
  setVerifier(v);
  const st=stateWithCV(cid,v); // ← ここにcvも封入
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",cid);
  u.searchParams.set("redirect_uri",FIXED_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","plain");
  u.searchParams.set("code_challenge",v);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",st);
  try{localStorage.setItem(LS.st,st)}catch(_){}
  location.assign(u.toString());
}
document.getElementById("go").onclick=async()=>{ try{ await authS256(); }catch(e){ LOG("S256不可→PLAINへ",e.message); authPLAIN(); } };
document.getElementById("plain").onclick=()=>authPLAIN();

// 簡易診断
(function diag(){
  try{localStorage.setItem("_t","1");localStorage.removeItem("_t");LOG("localStorage OK")}catch(e){LOG("localStorage NG:",e.message)}
  try{sessionStorage.setItem("_t","1");sessionStorage.removeItem("_t");LOG("sessionStorage OK")}catch(e){LOG("sessionStorage NG:",e.message)}
  try{document.cookie="__cktest=1; Max-Age=30; SameSite=Lax; Path=/spotify-auth/";LOG("cookie set (Lax/Path=/spotify-auth/)")}catch(e){LOG("cookie NG:",e.message)}
  LOG("crypto.subtle:", !!(crypto&&crypto.subtle));
  LOG("origin:", location.origin);
})();
</script>
</body>
</html>