<!doctype html>
<html lang="ja"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spotify Primary Artist Auditor — All Markets</title>
<link rel="preconnect" href="https://accounts.spotify.com"/><link rel="preconnect" href="https://api.spotify.com"/>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans JP';background:#0b0b0b;color:#e9e9e9}
.wrap{max-width:1200px;margin:0 auto;padding:16px}.card{background:#151515;border:1px solid #242424;border-radius:14px;padding:12px;margin-bottom:12px}
input,textarea,button{font-size:16px}input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff}
button{padding:10px 14px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;cursor:pointer}
button.primary{background:#00d672;border-color:#00d672;color:#001a0d;font-weight:600}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #2a2a2a}progress{width:100%;height:10px}</style></head>
<body><div class="wrap">
<h1>All Markets Primary Auditor <small>PKCE / scopeなし</small></h1>
<div class="card"><label>Client ID</label><input id="clientId"><label>Redirect URI</label><input id="redirectUri" placeholder="https://npr2025.github.io/spotify-auth/callback.html">
<label>Scopes（空）</label><input id="scopes" placeholder=""><div style="margin-top:6px"><button id="btnConnect" class="primary">Spotifyに接続</button> <button id="btnClear">保存トークン削除</button> <span id="tokStat" style="opacity:.8;font-size:12px"></span></div></div>
<div class="card"><label>アーティストID</label><input id="artistId" value="55fvQ5I2IZUfcFT2DV02T3">
<label>期待プライマリーID（カンマ区切り）</label><input id="expectedIds" value="55fvQ5I2IZUfcFT2DV02T3">
<div style="margin-top:6px"><label><input type="checkbox" id="grp_album" checked> album</label> <label><input type="checkbox" id="grp_single" checked> single</label> <label><input type="checkbox" id="grp_comp" checked> compilation</label> <label><input type="checkbox" id="grp_appears" checked> appears_on</label></div>
<div style="margin-top:6px"><label><input type="checkbox" id="allMkts" checked> 全マーケット横断</label> <small style="opacity:.8">/markets → /artists/{id}/albums for each</small></div>
<div style="margin-top:6px"><label>閾値</label><select id="flagThresh"><option value="0.3">30%</option><option value="0.5" selected>50%</option><option value="0.7">70%</option></select>
<label>デフォMarket（全マーケットOFF時）</label><input id="market" value="JP"></div>
<div style="margin-top:8px"><button id="btnAuditArtist" class="primary">アーティスト全カタログを監査</button> <span id="progressText" style="opacity:.8;font-size:12px"></span></div>
<progress id="prog" value="0" max="1" style="display:none;margin-top:6px"></progress></div>
<div class="card"><label>アルバムURL/ID（改行区切り）</label>
<textarea id="albumList" rows="4">https://open.spotify.com/album/06Yvg4vlPaVfnAWVwmJX27
https://open.spotify.com/album/4aeD4BUM5mAA1v1hCp9irx
https://open.spotify.com/album/4jTT5tjAMFfS58xawRjTsV</textarea>
<div style="margin-top:6px"><button id="btnAuditAlbums">指定アルバムを監査</button> <input type="file" id="csvFile" accept=".csv"> <button id="btnUseCsv">CSVから抽出→監査</button> <button id="btnExport">結果CSV書き出し</button></div></div>
<div class="card"><h3>結果</h3><div id="summary" style="opacity:.85;font-size:12px"></div>
<div style="overflow:auto;max-height:60vh;border:1px solid #2a2a2a;border-radius:10px">
<table id="tbl"><thead><tr><th>#</th><th>アルバム</th><th>album_type</th><th>album_group</th><th>アルバムアーティスト</th><th>総曲数</th><th>要注意</th><th>比率</th></tr></thead><tbody></tbody></table></div></div>
</div>
<script>
const qs=new URLSearchParams(location.search); function $(i){return document.getElementById(i)}; function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
const LS={cfg:'cfg',tok:'tok',ver:'ver'}; function uniq(a){return Array.from(new Set(a))}
function saveCfg(){const g=[ $('grp_album').checked?'album':null,$('grp_single').checked?'single':null,$('grp_comp').checked?'compilation':null,$('grp_appears').checked?'appears_on':null ].filter(Boolean).join(','); const c={clientId:$('clientId').value.trim(),redirectUri:$('redirectUri').value.trim(),scopes:$('scopes').value.trim(),artistId:$('artistId').value.trim(),expectedIds:$('expectedIds').value.trim(),market:$('market').value.trim()||'JP',allMkts:$('allMkts').checked,groups:g,flagThresh:parseFloat($('flagThresh').value||'0.5')}; localStorage.setItem(LS.cfg,JSON.stringify(c)); return c}
function loadCfg(){try{const c=JSON.parse(localStorage.getItem(LS.cfg)||'null'); if(!c) return; $('clientId').value=c.clientId||''; $('redirectUri').value=c.redirectUri||''; $('scopes').value=c.scopes||''; $('artistId').value=c.artistId||''; $('expectedIds').value=c.expectedIds||''; $('market').value=c.market||'JP'; $('allMkts').checked=!!c.allMkts; const g=(c.groups||'album,single,compilation,appears_on').split(','); $('grp_album').checked=g.includes('album'); $('grp_single').checked=g.includes('single'); $('grp_comp').checked=g.includes('compilation'); $('grp_appears').checked=g.includes('appears_on'); $('flagThresh').value=(c.flagThresh||0.5).toString()}catch(_){}}
function base64url(a){return btoa(String.fromCharCode.apply(null,new Uint8Array(a))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
async function sha256(s){return await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s))}
function randHex(n=64){const a=new Uint8Array(n);crypto.getRandomValues(a);return Array.from(a).map(x=>('0'+x.toString(16)).slice(-2)).join('')}
async function doAuth(){const c=saveCfg(); if(!c.clientId||!c.redirectUri){alert('Client ID/Redirect URI');return} const ver=randHex(64); const chall=base64url(await sha256(ver)); localStorage.setItem(LS.ver, JSON.stringify({ver,ts:Date.now()})); const u=new URL('https://accounts.spotify.com/authorize'); u.searchParams.set('response_type','code'); u.searchParams.set('client_id', c.clientId); u.searchParams.set('redirect_uri', c.redirectUri); u.searchParams.set('code_challenge_method','S256'); u.searchParams.set('code_challenge', chall); if(c.scopes) u.searchParams.set('scope', c.scopes); location.href=u.toString()}
async function exchangeToken(code){const c=loadCfg()||saveCfg(); const ver=JSON.parse(localStorage.getItem(LS.ver)||'{}').ver||''; const p=new URLSearchParams(); p.set('client_id', $('clientId').value.trim()); p.set('grant_type','authorization_code'); p.set('code', code); p.set('redirect_uri', $('redirectUri').value.trim()); p.set('code_verifier', ver); const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:p.toString()}); if(!r.ok){throw new Error(await r.text())} const tok=await r.json(); tok.obtained_at=Date.now(); localStorage.setItem(LS.tok, JSON.stringify(tok)); history.replaceState({},document.title, location.pathname)}
function getTok(){try{return JSON.parse(localStorage.getItem(LS.tok)||'null')}catch(_){return null}} async function ensureTok(){const t=getTok(); if(!t) throw new Error('未認証'); if(Date.now()<(t.obtained_at+(t.expires_in-60)*1000)) return t; throw new Error('期限切れ')}
function setTokStat(){const t=getTok(); const el=$('tokStat'); if(!t){el.textContent='未接続';return} const left=(t.obtained_at+t.expires_in*1000-Date.now())/1000; el.textContent=left>0?`トークンOK（残り ${Math.floor(left/60)}:${('0'+Math.floor(left%60)).slice(-2)})`:'期限切れ'}
setInterval(setTokStat,1000);
async function api(path, params={}, method='GET'){const tok=await ensureTok(); const url=new URL('https://api.spotify.com/v1'+path); Object.entries(params).forEach(([k,v])=>{if(v!==undefined&&v!==null&&v!=='') url.searchParams.set(k,v)}); const r=await fetch(url.toString(),{method,headers:{Authorization:`Bearer ${tok.access_token}`}}); if(r.status===429){const ra=parseInt(r.headers.get('Retry-After')||'1',10); await sleep((ra+0.05)*1000); return api(path,params,method)} if(!r.ok){throw new Error(await r.text())} return await r.json()}
async function getAllMarkets(){const d=await api('/markets'); return d.markets||[]}
function parseId(s){s=(s||'').trim(); if(/^[A-Za-z0-9]{22}$/.test(s)) return s; const m=s.match(/(album|track|artist)\/([A-Za-z0-9]{22})/); return m?m[2]:null}
async function fetchArtistAlbumsUnion(artistId, includeGroups, allMkts, fallbackMarket){const seen=new Set(); const group=new Map(); const mkts=allMkts?(await getAllMarkets()):[fallbackMarket||'JP']; $('prog').style.display='block'; $('prog').max=mkts.length; $('prog').value=0; let i=0; for(const m of mkts){let offset=0,next=true; while(next){const res=await api(`/artists/${artistId}/albums`,{include_groups:includeGroups,market:m,limit:50,offset}); for(const it of (res.items||[])){ if(!seen.has(it.id)){seen.add(it.id); if(it.album_group) group.set(it.id,it.album_group)} } if(res.next){const u=new URL(res.next); offset=parseInt(u.searchParams.get('offset')||'0',10)+50}else next=false} i++; $('prog').value=i; $('progressText').textContent=`取得 ${i}/${mkts.length}`; await sleep(20)} $('prog').style.display='none'; return {ids:Array.from(seen),groupById:group}}
async function fetchAlbumTracksAll(id){let items=[],offset=0,next=true; while(next){const res=await api(`/albums/${id}/tracks`,{limit:50,offset}); items=items.concat(res.items||[]); if(res.next){const u=new URL(res.next); offset=parseInt(u.searchParams.get('offset')||'0',10)+50}else next=false} return items}
function heur(album,rows,expected){const albIds=new Set((album.artists||[]).map(a=>a.id)); const off=rows.filter(r=>r.extraPrimaryIds.length>0); const ratio=rows.length?off.length/rows.length:0; return {off,ratio}}
async function analyzeAlbum(id, expected, groupHint){const album=await api(`/albums/${id}`,{}); const tracks=await fetchAlbumTracksAll(id); const albIds=new Set((album.artists||[]).map(a=>a.id)); const rows=tracks.map((t,i)=>{const ids=(t.artists||[]).map(a=>a.id); const names=(t.artists||[]).map(a=>a.name); const extra=ids.filter(x=>!albIds.has(x)&&!expected.has(x)); return {name:t.name,extraPrimaryIds:extra,extraPrimaryNames:extra.map(id=>names[ids.indexOf(id)]).filter(Boolean),no:t.track_number??(i+1)} }); return {album,rows,groupHint,heur:heur(album,rows,expected)}}
function addRow(i,res){const a=res.album; const tbody=document.querySelector('#tbl tbody'); const url=`https://open.spotify.com/album/${a.id}`; const tr=document.createElement('tr'); const bad=Math.round(res.heur.ratio*100); tr.innerHTML=`<td>${i}</td><td><a href="${url}" target="_blank" rel="noopener">${a.name}</a></td><td>${a.album_type}</td><td>${res.groupHint||''}</td><td>${(a.artists||[]).map(x=>x.name).join(', ')}</td><td>${a.total_tracks}</td><td>${res.heur.off.length}</td><td>${bad}%</td>`; tbody.appendChild(tr)}
async function auditArtist(){try{$('summary').textContent='取得中…'; document.querySelector('#tbl tbody').innerHTML=''; const c=saveCfg(); const expected=new Set((c.expectedIds||'').split(',').map(s=>s.trim()).filter(Boolean)); const {ids,groupById}=await fetchArtistAlbumsUnion(c.artistId,c.groups,c.allMkts,c.market); $('summary').textContent=`監査：ユニーク ${ids.length}`; let i=0; for(const id of ids){const r=await analyzeAlbum(id,expected,groupById.get(id)||''); addRow(++i,r); await sleep(20)} $('summary').textContent=`完了：${i}件`}catch(e){$('summary').textContent='エラー: '+e.message; console.error(e)}}
function parseIdsFromTextarea(){return ($('albumList').value||'').split(/\r?\n/).map(parseId).filter(Boolean)}
async function auditAlbums(){try{$('summary').textContent='監査中…'; document.querySelector('#tbl tbody').innerHTML=''; const c=saveCfg(); const expected=new Set((c.expectedIds||'').split(',').map(s=>s.trim()).filter(Boolean)); const ids=parseIdsFromTextarea(); let i=0; for(const id of ids){const r=await analyzeAlbum(id,expected,''); addRow(++i,r); await sleep(20)} $('summary').textContent=`完了：${i}件`}catch(e){$('summary').textContent='エラー: '+e.message; console.error(e)}}
async function auditFromCsv(){const f=$('csvFile').files[0]; if(!f){alert('CSVを選択');return} $('summary').textContent='CSV解析…'; const text=await f.text(); const parsed=Papa.parse(text,{header:true,skipEmptyLines:true}).data||[]; const cols=['spotify_url','url','URL','Link','link']; const col=cols.find(c=>parsed[0]&&c in parsed[0]); const urls=parsed.map(r=>r[col]).filter(Boolean); const ids=[]; const tids=[]; for(const u of urls){const m=String(u).match(/open\.spotify\.com\/(album|track)\/([A-Za-z0-9]{22})/); if(m){ if(m[1]==='album') ids.push(m[2]); else tids.push(m[2]); }} for(const tid of tids){try{const t=await api(`/tracks/${tid}`,{}); if(t&&t.album&&t.album.id) ids.push(t.album.id)}catch(_){}} const uniqIds=uniq(ids); $('albumList').value=uniqIds.map(id=>'https://open.spotify.com/album/'+id).join('\n'); await auditAlbums()}
$('btnConnect').addEventListener('click', doAuth); $('btnClear').addEventListener('click', ()=>{localStorage.removeItem(LS.tok); setTokStat(); alert('削除しました')}); $('btnAuditArtist').addEventListener('click', auditArtist); $('btnAuditAlbums').addEventListener('click', auditAlbums); $('btnUseCsv').addEventListener('click', auditFromCsv); $('btnExport').addEventListener('click', ()=>{const rows=Array.from(document.querySelectorAll('#tbl tbody tr')); const header=['index','album_name','album_type','album_group','album_artists','total_tracks','warning_tracks','warning_ratio_percent']; const data=rows.map((tr,i)=>{const td=tr.querySelectorAll('td'); return {index:i+1,album_name:td[1].innerText,album_type:td[2].innerText,album_group:td[3].innerText,album_artists:td[4].innerText,total_tracks:td[5].innerText,warning_tracks:td[6].innerText,warning_ratio_percent:td[7].innerText}}); const esc=v=>{const s=String(v??''); return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s}; const csv=[header.join(','),...data.map(r=>header.map(k=>esc(r[k])).join(','))].join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='spotify_primary_audit_all_markets.csv'; a.click()});
(function init(){loadCfg(); if(qs.get('code')){document.getElementById('summary').textContent='Token交換中…'; exchangeToken(qs.get('code')).then(()=>document.getElementById('summary').textContent='接続完了').catch(e=>document.getElementById('summary').textContent='交換エラー: '+e.message)} setInterval(setTokStat,1000)})();
</script></body></html>
