<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ISRC → Spotify プレイリスト上書き（PKCE / CSV対応）</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<style>
  :root{--bd:#e5e7eb;--fg:#111;--mut:#555;--ok:#0a7a2f;--ng:#b00020;--bg:#fafafa;--chip:#f6f6f6}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif}
  .wrap{max-width:980px;margin:40px auto;padding:24px;border:1px solid var(--bd);border-radius:12px;background:#fff}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;align-items:center;margin:8px 0}
  input[type="text"],input[type="url"]{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px}
  input[type="file"]{border:1px dashed var(--bd);padding:12px;border-radius:8px;background:var(--chip)}
  .btn{display:inline-block;padding:10px 14px;border:1px solid var(--bd);border-radius:8px;background:#111;color:#fff;text-decoration:none;cursor:pointer}
  .btn.alt{background:#fff;color:#111}
  .mut{color:var(--mut);font-size:12px}
  .log{background:#0a0a0a;color:#ddd;min-height:240px;padding:12px;border-radius:8px;font:12px ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label.inline{gap:6px}
  .section{margin:18px 0 6px;font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>ISRC → Spotify プレイリスト上書き</h1>
  <p class="mut">CSVの ISRC カラムを使い、優先度（≤3曲 → ≤10曲 → アルバム）で該当トラックを検索し、指定プレイリストを <b>全入れ替え</b> します。</p>

  <div class="row"><div>Client ID</div><div><input id="client_id" type="text" placeholder="Spotify App Client ID"/></div></div>
  <div class="row"><div>User ID</div><div><input id="user_id" type="text" value="22fqn5mozguuegi2t3l2zeugy"/></div></div>
  <div class="row"><div>Playlist ID</div><div><input id="playlist_id" type="text" value="0x0VWK9NrDvb830vLIcMqr"/></div></div>
  <div class="row"><div>CSV (ISRC)</div><div><input id="csv" type="file" accept=".csv"/></div></div>

  <div class="row"><div>優先ロジック</div>
    <div class="inline">
      <label class="inline"><input id="avoid_album" type="checkbox" checked/> アルバム曲は極力回避</label>
      <label class="inline"><input id="dedupe_isrc" type="checkbox" checked/> ISRC重複は除外</label>
      <label class="inline"><input id="limit_total" type="checkbox" checked/> 合計最大曲数を設定</label>
      <input id="total_cap" type="text" value="200" style="width:100px"/>
    </div>
  </div>

  <div class="inline" style="margin:10px 0 14px">
    <button class="btn" id="auth">① 認可（PKCE）</button>
    <button class="btn alt" id="dryrun">② ドライラン（検索のみ）</button>
    <button class="btn" id="overwrite">③ 上書き実行（元の中身は削除されます）</button>
  </div>

  <div class="section">ログ</div>
  <div id="log" class="log">準備中…</div>
</div>

<script>
// ---------------- Helpers ----------------
const log = (msg, cls="") => {
  const el = document.getElementById("log");
  const line = cls ? `<span class="${cls}">${msg}</span>` : msg;
  el.innerHTML += (el.innerHTML ? "\n" : "") + line;
  el.scrollTop = el.scrollHeight;
};
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const backoff = async (res) => {
  const retry = (res.headers.get("Retry-After") || 1)*1000;
  log(`429 → backoff ${retry}ms`, "mut");
  await sleep(retry);
};

// 起動時：?cid= からClient IDを自動セット／sessionStorage復元／file://警告
window.addEventListener("DOMContentLoaded", () => {
  const u = new URL(location.href);
  const cid = u.searchParams.get("cid");
  if (cid) {
    sessionStorage.setItem("spotify_client_id", cid);
    const ci = document.getElementById("client_id");
    if (ci) ci.value = cid;
    history.replaceState({}, "", u.origin + u.pathname); // URL掃除
  }
  const storedCID = sessionStorage.getItem("spotify_client_id");
  if (storedCID) {
    const ci = document.getElementById("client_id");
    if (ci && !ci.value) ci.value = storedCID;
  }
  const storedUID = sessionStorage.getItem("spotify_user_id");
  if (storedUID) {
    const ui = document.getElementById("user_id");
    if (ui && !ui.value) ui.value = storedUID;
  }
  const storedPID = sessionStorage.getItem("spotify_playlist_id");
  if (storedPID) {
    const pi = document.getElementById("playlist_id");
    if (pi && !pi.value) pi.value = storedPID;
  }
  if (location.protocol === "file:") {
    log("⚠ file:// ではSpotify認可に失敗します。http(s)でホストし、そのURLをRedirect URIに登録してください。", "ng");
  }
});

// ---------------- PKCE Auth ----------------
let access_token = null;
function base64urlencode(buf){return btoa(String.fromCharCode.apply(null,new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}
async function sha256(plain){const enc=new TextEncoder().encode(plain);const digest=await crypto.subtle.digest("SHA-256",enc);return digest}

async function authorize(){
  const client_id = document.getElementById("client_id").value.trim();
  const user_id = document.getElementById("user_id").value.trim();
  const playlist_id = document.getElementById("playlist_id").value.trim();
  if(!client_id){alert("Client ID を入れてください");return}

  // 入力値を保存（リダイレクト後の復元＆トークン交換用）
  sessionStorage.setItem("spotify_client_id", client_id);
  if (user_id) sessionStorage.setItem("spotify_user_id", user_id);
  if (playlist_id) sessionStorage.setItem("spotify_playlist_id", playlist_id);

  const verifier = base64urlencode(crypto.getRandomValues(new Uint8Array(32)));
  const challenge = base64urlencode(await sha256(verifier));
  sessionStorage.setItem("pkce_verifier", verifier);

  const redirect_uri = location.origin + location.pathname; // このHTML自身
  const scope = [
    "playlist-read-private","playlist-modify-private","playlist-modify-public"
  ].join(" ");
  const url = new URL("https://accounts.spotify.com/authorize");
  url.searchParams.set("response_type","code");
  url.searchParams.set("client_id", client_id);
  url.searchParams.set("scope", scope);
  url.searchParams.set("redirect_uri", redirect_uri);
  url.searchParams.set("code_challenge_method","S256");
  url.searchParams.set("code_challenge", challenge);
  // 任意: show_dialog=false で既存同意があればサイレント
  url.searchParams.set("show_dialog","false");
  location.href = url.toString();
}

async function maybeExchangeToken(){
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  if(!code) return;

  // 入力 or sessionStorage から client_id を必ず復元
  let client_id = (document.getElementById("client_id").value || "").trim();
  if (!client_id) client_id = sessionStorage.getItem("spotify_client_id") || "";
  if (!client_id) { log("Token 交換失敗: client_id が空です（Redirect URI登録/入力を確認）", "ng"); return; }

  const verifier = sessionStorage.getItem("pkce_verifier");
  if(!verifier){log("alert_no_verifier: 認可を最初からやり直してください。","ng");return;}

  const redirect_uri = location.origin + location.pathname;
  const body = new URLSearchParams({
    grant_type: "authorization_code",
    code, redirect_uri, client_id, code_verifier: verifier
  });

  const res = await fetch("https://accounts.spotify.com/api/token", {
    method:"POST",
    headers: {"Content-Type":"application/x-www-form-urlencoded"},
    body
  });
  if(!res.ok){
    const t = await res.text();
    log("Token 交換失敗: "+t,"ng");
    if (t && /invalid_client/i.test(t)) {
      log("対処: (1) Spotify Dashboardで Redirect URI がこのページURLと完全一致か確認 (2) Client ID の誤り/空白を除去 (3) ① 認可からやり直し", "mut");
    }
    return;
  }
  const json = await res.json();
  access_token = json.access_token;

  // クエリ掃除
  history.replaceState({}, "", redirect_uri);

  // 入力へ復元（目視確認/再操作しやすく）
  const ci = document.getElementById("client_id"); if (ci && !ci.value) ci.value = client_id;
  const ui = document.getElementById("user_id"); if (ui && !ui.value) ui.value = (sessionStorage.getItem("spotify_user_id")||"");
  const pi = document.getElementById("playlist_id"); if (pi && !pi.value) pi.value = (sessionStorage.getItem("spotify_playlist_id")||"");

  log("✔ 認可完了: access_token 取得","ok");
}

// ---------------- CSV → ISRCs ----------------
async function parseISRCs(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = reader.result;
      const lines = text.split(/\r?\n/);
      const header = (lines[0]||"").split(",");
      let isrcIdx = -1;
      for(let i=0;i<header.length;i++){
        if(/isrc/i.test(header[i])) { isrcIdx = i; break; }
      }
      if(isrcIdx===-1){ reject(new Error("ISRC カラムが見つかりません。ヘッダに 'ISRC' を含めてください。")); return; }
      const isrcs = [];
      for(let i=1;i<lines.length;i++){
        if(!lines[i]?.trim()) continue;
        const cols = lines[i].split(",");
        const v = (cols[isrcIdx]||"").trim();
        if(v) isrcs.push(v);
      }
      resolve(isrcs);
    };
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

// ---------------- Spotify API ----------------
async function sp(path, init={}){
  if(!access_token) throw new Error("未認可です");
  const res = await fetch("https://api.spotify.com/v1"+path, {
    ...init,
    headers: {"Authorization":"Bearer "+access_token, "Content-Type":"application/json", ...(init.headers||{})}
  });
  if(res.status===429){ await backoff(res); return sp(path, init); }
  return res;
}

function pickBestTrack(items, avoidAlbum){
  const scored = items.map(t=>{
    const n = t.album?.total_tracks ?? 999;
    const type = t.album?.album_type || "";
    let score = 0;
    if(n<=3) score += 100;
    else if(n<=10) score += 60;
    else score += 10;
    if(avoidAlbum && type==="album") score -= 30;
    if(type==="single") score += 20;
    if(type==="compilation") score += 10;
    if(t.explicit===false) score += 2;
    return {t, score};
  });
  scored.sort((a,b)=>b.score-a.score);
  return scored[0]?.t || null;
}

async function searchByISRC(isrc, avoidAlbum){
  const params = new URLSearchParams({ q: `isrc:${isrc}`, type: "track", limit: "50" });
  const res = await sp("/search?"+params.toString());
  if(!res.ok){ return null; }
  const json = await res.json();
  const items = json?.tracks?.items || [];
  if(items.length===0) return null;
  return pickBestTrack(items, avoidAlbum);
}

async function overwritePlaylist({playlist_id, tracks}){
  if(tracks.length===0) throw new Error("追加対象がありません");
  const uris = tracks.map(t=>t.uri);
  const first = uris.slice(0,100);
  const rest = uris.slice(100);

  let res = await sp(`/playlists/${playlist_id}/tracks`, { method:"PUT", body: JSON.stringify({ uris: first }) });
  if(!res.ok){ const t = await res.text(); throw new Error("置換失敗: "+t); }
  log(`置換: ${first.length} 件`, "ok");

  for(let i=0;i<rest.length;i+=100){
    const chunk = rest.slice(i,i+100);
    res = await sp(`/playlists/${playlist_id}/tracks`, { method:"POST", body: JSON.stringify({ uris: chunk }) });
    if(!res.ok){ const t = await res.text(); throw new Error("追加失敗: "+t); }
    log(`追加: ${chunk.length} 件 (累計 ${first.length+i+chunk.length})`, "ok");
  }
}

// ---------------- Run ----------------
async function run(dryRun=false){
  const user_id = document.getElementById("user_id").value.trim();
  const playlist_id = document.getElementById("playlist_id").value.trim();
  const file = document.getElementById("csv").files[0];
  const avoidAlbum = document.getElementById("avoid_album").checked;
  const dedupe = document.getElementById("dedupe_isrc").checked;
  const capOn = document.getElementById("limit_total").checked;
  const cap = parseInt(document.getElementById("total_cap").value||"0",10) || 0;

  if(!file){ alert("CSV を選択してください"); return; }
  if(!access_token){ alert("先に ① 認可 を実行してください"); return; }

  // 念のため保存（次回復元用）
  if (user_id) sessionStorage.setItem("spotify_user_id", user_id);
  if (playlist_id) sessionStorage.setItem("spotify_playlist_id", playlist_id);

  log("CSV 解析中…");
  let isrcs = await parseISRCs(file);
  if(dedupe){ isrcs = [...new Set(isrcs)]; }
  log(`ISRC 読込: ${isrcs.length} 件`);

  const found = [];
  const missing = [];
  for(let i=0;i<isrcs.length;i++){
    const code = isrcs[i];
    log(`検索 ${i+1}/${isrcs.length}: ${code}`,"mut");
    const track = await searchByISRC(code, avoidAlbum);
    if(track){ found.push(track); log(` → ${track.name} — ${track.artists.map(a=>a.name).join(", ")} [${track.album.album_type}/${track.album.total_tracks}]`,"ok"); }
    else { missing.push(code); log(` → 見つからず: ${code}`,"ng"); }
    await sleep(120);
    if(capOn && cap>0 && found.length>=cap){
      log(`上限 ${cap} に達したため打ち切り`,"mut");
      break;
    }
  }

  log(`検索完了: 見つかった曲 ${found.length} / 見つからない ISRC ${missing.length}`);

  if(dryRun) return;

  log("プレイリスト置換開始… 元の中身は削除されます","ng");
  await overwritePlaylist({ playlist_id, tracks: found });
  log("✅ 完了: プレイリストを上書きしました","ok");
}

// ---------------- Wire UI ----------------
document.getElementById("auth").addEventListener("click", authorize);
document.getElementById("dryrun").addEventListener("click", ()=>run(true));
document.getElementById("overwrite").addEventListener("click", ()=>run(false));

// リダイレクト後のトークン交換
maybeExchangeToken().catch(e=>log("認可処理エラー: "+e.message,"ng"));
</script>
</body>
</html>
