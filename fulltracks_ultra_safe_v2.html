<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TDCS Full Tracks Harvester — Ultra Ultra Safe</title>
<link rel="preconnect" href="https://accounts.spotify.com"/>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans JP';margin:2rem}
  .card{border:1px solid #ddd;border-radius:10px;padding:1rem;margin-bottom:1rem}
  .row{display:flex;flex-wrap:wrap;gap:1rem;align-items:center}
  button{padding:.6rem 1rem;border-radius:8px;border:1px solid #999;background:#111;color:#fff;cursor:pointer}
  button[disabled]{opacity:.5;cursor:not-allowed}
  input[type=file]{border:1px dashed #bbb;padding:.75rem;border-radius:8px;background:#fafafa}
  code,.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
  .muted{color:#666}.ok{color:#0a7f29}.bad{color:#b00020}
  progress{width:100%;height:14px}
  table{border-collapse:collapse;width:100%}th,td{border:1px solid #eee;padding:.5rem;font-size:.9rem;text-align:left}
  .pill{display:inline-block;padding:.1rem .5rem;border:1px solid #ccc;border-radius:999px;font-size:.8rem;background:#f6f6f6}
  .small{font-size:.85rem}
</style>
</head>
<body>
<header class="card">
  <h1>TDCS Full Tracks Harvester — Ultra Ultra Safe</h1>
  <div class="small muted">Client ID: <code>378ef0f44b36499abd10d118ddbddc98</code> | Redirect: <code>https://npr2025.github.io/spotify-auth/callback.html</code></div>
  <div class="row">
    <a href="./auth.html"><button>Spotifyに接続</button></a>
    <button id="clearBtn" style="background:#eee;color:#111;border-color:#bbb">保存トークン削除</button>
    <span id="authStatus" class="muted">未接続</span>
  </div>
</header>

<section class="card">
  <h2>入力と実行設定</h2>
  <div class="row">
    <input type="file" id="csvFile" accept=".csv"/>
    <label>最小間隔(ms)：<input id="minDelayMs" type="number" value="4000"></label>
    <label>RPM上限(1分)：<input id="rpmCap" type="number" value="5"></label>
    <label>1時間予算(req)：<input id="hourBudget" type="number" value="300"></label>
    <label>最大バックオフ(ms)：<input id="maxBackoffMs" type="number" value="30000"></label>
    <label>最大リトライ：<input id="maxRetries" type="number" value="9"></label>
    <label>429ロングCD(ms)：<input id="cooldownMs" type="number" value="600000"></label>
  </div>
  <div class="row">
    <label>アルバムバッチ間隔(ms)：<input id="batchPauseMs" type="number" value="1500"></label>
    <label>トラックページ間隔(ms)：<input id="pagePauseMs" type="number" value="400"></label>
    <label>tracks?ids バッチ(≤50)：<input id="trkBatch" type="number" value="20"></label>
    <label>albums?ids バッチ(≤20)：<input id="albBatch" type="number" value="20"></label>
    <label>ロングブレイク：<input id="longBreakEvery" type="number" value="120"> req毎 / <input id="longBreakMs" type="number" value="300000"> ms</label>
    <label><input id="slowJitter" type="checkbox" checked> ジッターON</label>
    <label><input id="emergencyMode" type="checkbox" checked> エマージェンシー自動化</label>
    <label>エマージェンシー間隔(ms)：<input id="emgPerReqMs" type="number" value="30000"></label>
  </div>
  <div class="row">
    <label><input id="scanAllTracks" type="checkbox" checked> 全アルバムでトラック走査（フル）</label>
    <button id="startBtn" disabled>開始</button>
    <button id="pauseBtn" disabled>一時停止</button>
    <button id="resumeBtn" disabled>再開</button>
    <button id="clearChkBtn">チェックポイント削除</button>
    <button id="diagBtn">接続診断</button>
  </div>
</section>

<section class="card">
  <h2>進捗 <span id="ratePill" class="pill">idle</span></h2>
  <progress id="prog" value="0" max="100"></progress>
  <div id="log" class="mono" style="white-space:pre-wrap;max-height:260px;overflow:auto"></div>
</section>

<section class="card">
  <h2>エクスポート</h2>
  <div class="row">
    <button id="downloadTracksBtn" disabled>フルトラックCSV</button>
    <button id="downloadCheckpointBtn" disabled>チェックポイントCSV</button>
  </div>
</section>

<script>
const CHECKPOINT_KEY="tdcs_fulltracks_checkpoint_v2";

function $(s){return document.querySelector(s);}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function log(m){$("#log").textContent+=m+"\\n";$("#log").scrollTop=$("#log").scrollHeight;}

function token(){
  const raw=localStorage.getItem("sp_token");
  if(raw){
    try{
      const o=JSON.parse(raw);
      if(o.access_token && Date.now()<o.expires_at){return o.access_token;}
    }catch{}
  }
  return null;
}
function refreshAuthStatus(){
  const el=$("#authStatus");
  const raw=localStorage.getItem("sp_token"); let msg="未接続",ok=false;
  if(raw){
    try{
      const o=JSON.parse(raw);
      if(o.access_token && o.expires_at){
        ok=Date.now()<o.expires_at;
        msg=ok?"トークンOK（有効）":"未接続（期限切れ）";
      }
    }catch{msg="未接続（JSON不正）";}
  }
  el.textContent=msg;el.className=ok?"ok":"bad";
}
refreshAuthStatus();
window.addEventListener("focus",refreshAuthStatus);
</script>
</body>
</html>
