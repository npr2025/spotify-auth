<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder — BUILD v10.9</title>
<style>
:root{--bg:#0b1220;--fg:#cfe3ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1180px;margin:32px auto;padding:0 12px}
h1{margin:0 0 8px}
.badge{display:inline-block;margin-left:8px;padding:3px 10px;border:1px solid #999;border-radius:999px;font-size:12px;background:#fff}
fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
legend{font-weight:600}
label{display:block;margin:6px 0}
input[type="text"],input[type="number"],select,textarea{width:100%;max-width:880px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
input[type="file"]{margin:4px 0}
textarea{min-height:96px}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
button:disabled{opacity:.5;cursor:not-allowed}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
small.hint{color:#666}
#log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:240px}
#progWrap{position:relative;height:12px;background:#e6eaf2;border-radius:6px;overflow:hidden;margin:6px 0}
#progBar{height:100%;width:0%;background:#4a90e2;transition:width .2s ease}
#progLine{font-variant-numeric:tabular-nums;margin:4px 0 0 0;color:#333}
.hidden{display:none}
.inline{display:inline-block;margin-right:16px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
a.btn{display:inline-block;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;color:#000;margin:6px 8px 0 0}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>TDCS Editions Builder <span class="badge" id="buildBadge">BUILD v10.9</span><span class="badge">Auth-Hardening</span><span class="badge">Latest20</span><span class="badge">Divergence++</span></h1>
<p id="status">未接続</p>
<div>
  <button id="btnConnect" disabled>Spotifyにサインイン</button>
  <a id="aConnectS256" class="btn" href="#">サインイン(S256)</a>
  <a id="aConnectPLAIN" class="btn" href="#">サインイン(PLAIN直リンク)</a>
  <a id="aCopy" class="btn" href="#">URLをコピー</a>
  <a id="aHard" class="btn" href="#">ハードリロード</a>
  <button id="btnReset">初期化（保存トークン削除）</button>
  <button id="btnCheck">接続チェック</button>
</div>

<fieldset>
  <legend>固定</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" id="clientId" value="1fd6350fcf4945a0b3ddffa2d5730d4e"></label>
    <label>REDIRECT_URI <input type="text" id="redir" value="https://npr2025.github.io/spotify-auth/callback.html" disabled></label>
  </div>
  <small class="hint">Redirect URIs に https://npr2025.github.io/spotify-auth/callback.html を登録</small>
</fieldset>

<!-- ……（ビルダー本体のフォームはそのまま）…… -->

<!-- 進捗＆ログ（省略なし） -->
<fieldset>
  <legend>進捗</legend>
  <div id="progWrap" class="hidden"><div id="progBar"></div></div>
  <div id="progLine">0% — 待機中</div>
</fieldset>
<fieldset>
  <legend>ログ</legend>
  <pre id="log">Booting…</pre>
</fieldset>

<script>
/* ====== 共通 ====== */
const BUILD_ID="v10.9";
(function(){const u=new URL(location.href);let ch=false;if(u.searchParams.get("v")!==BUILD_ID){u.searchParams.set("v",BUILD_ID);ch=true}u.searchParams.set("bust",Date.now().toString());const k="boot_"+BUILD_ID;if(ch||!sessionStorage.getItem(k)){sessionStorage.setItem(k,"1");location.replace(u.toString())}})();

const FIXED_REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const zws=/[\u200B-\u200D\uFEFF]/g;
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",pend:"csv_auto_pend",cid:"client_id_pref"};
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
const $=(id)=>document.getElementById(id);
const val=(id,f="")=>{ const el=$(id); return el && "value" in el ? el.value : f; };
const log=(s)=>{ const el=$("log"); if(el){el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight;} };
const progress=(p,msg)=>{ $("progWrap").classList.remove("hidden"); $("progBar").style.width=Math.max(0,Math.min(100,p))+"%"; if(msg) $("progLine").textContent=Math.round(p)+"% — "+msg; }
if($("redir")) $("redir").value=FIXED_REDIRECT_URI;

/* ====== 認可：同一タブ遷移 & 三重保存 ====== */
let AUTH_READY_S256=false, AUTH_URL_S256="", AUTH_URL_PLAIN="";

function getClientId(){ 
  const x=(val("clientId","")||"").replace(zws,"").trim() || localStorage.getItem(LS.cid) || "1fd6350fcf4945a0b3ddffa2d5730d4e";
  try{localStorage.setItem(LS.cid,x)}catch(_){}
  if($("clientId")) $("clientId").value=x;
  return x;
}
function setVerifier(v){
  try{ localStorage.setItem(LS.ver,v); }catch(_){}
  try{ sessionStorage.setItem(LS.ver,v); }catch(_){}
  try{ document.cookie=`${LS.ver}=${encodeURIComponent(v)}; Max-Age=900; SameSite=Lax; Path=/spotify-auth/`; }catch(_){}
}
function readVerifier(){
  try{const v1=sessionStorage.getItem(LS.ver); if(v1) return v1;}catch(_){}
  try{const v2=localStorage.getItem(LS.ver); if(v2) return v2;}catch(_){}
  try{const m=document.cookie.split(";").map(s=>s.trim().split("=")).find(a=>a[0]===LS.ver); if(m&&m[1]) return decodeURIComponent(m[1]);}catch(_){}
  return "";
}
function b64url(buf){ let b=""; const u8=new Uint8Array(buf); for(let i=0;i<u8.length;i++) b+=String.fromCharCode(u8[i]); return btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
function randAlpha(n){ const a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; let s=""; for(let i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }

async function buildS256URL(){
  const CLIENT_ID=getClientId();
  let v=""; crypto.getRandomValues(new Uint8Array(64)).forEach(x=>v+=String.fromCharCode(97+(x%26)));
  setVerifier(v);
  const ch=b64url(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v)));
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",FIXED_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",ch);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state","ci_"+CLIENT_ID+"_"+Date.now());
  AUTH_URL_S256=u.toString(); AUTH_READY_S256=true;
}

function buildPlainURL(){
  const CLIENT_ID=getClientId();
  const v=randAlpha(64); setVerifier(v);
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",FIXED_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","plain");
  u.searchParams.set("code_challenge",v);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state","ci_"+CLIENT_ID+"_"+Date.now());
  AUTH_URL_PLAIN=u.toString();
}

function openAuth(url){ // 同一タブで遷移（code が確実に残る）
  try{ localStorage.setItem(LS.cid, getClientId()); }catch(_){}
  window.location.assign(url);
}

function prepareAuthLinks(){
  buildPlainURL();
  buildS256URL().catch(()=>{ AUTH_READY_S256=false; });
  $("btnConnect").disabled=false;
  $("aConnectS256").onclick=(e)=>{ e.preventDefault(); if(AUTH_READY_S256) openAuth(AUTH_URL_S256); else { buildS256URL().then(()=>openAuth(AUTH_URL_S256)); } };
  $("aConnectPLAIN").onclick=(e)=>{ e.preventDefault(); openAuth(AUTH_URL_PLAIN); };
  $("aCopy").onclick=async(e)=>{ e.preventDefault(); const u=AUTH_READY_S256?AUTH_URL_S256:AUTH_URL_PLAIN; try{ await navigator.clipboard.writeText(u); alert("コピーしました"); }catch(_){ prompt("URLをコピー",u); } };
  $("aHard").onclick=(e)=>{ e.preventDefault(); location.replace(`index.html?v=${BUILD_ID}&bust=${Date.now()}`); };
}

window.addEventListener("DOMContentLoaded",prepareAuthLinks);
window.addEventListener("focus",()=>{ buildS256URL(); });

/* ====== トークン管理 & API ====== */
const isAuthed=()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0)-5000;
function setStatus(){ $("status").textContent=isAuthed()?"接続中（OK）":"未接続"; if(isAuthed() && window._pending) resolveAndWrite(window._pending); }
async function refreshTokenIfNeeded(){
  const exp=+(localStorage.getItem(LS.exp)||0);
  if(Date.now()<exp-5000) return;
  const CLIENT_ID=getClientId(); const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const body=new URLSearchParams(); body.set("grant_type","refresh_token"); body.set("refresh_token",rt); body.set("client_id",CLIENT_ID);
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body,cache:"no-store"});
  if(!r.ok){ log("refresh失敗 "+r.status); return; }
  const j=await r.json(); localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000)); if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}

async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const gap=+(document.getElementById("gap")?.value||1000); await new Promise(r=>setTimeout(r,gap));
  for(let a=0;a<5;a++){
    const init={method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
    if(body) init.body=JSON.stringify(body);
    const r=await fetch("https://api.spotify.com"+path,init);
    if(r.status===401){ await refreshTokenIfNeeded(); continue; }
    if(r.status===429){ const ra=+(r.headers.get("Retry-After")||2); await new Promise(r=>setTimeout(r,ra*1000)); continue; }
    if(!r.ok){
      const t=await r.text();
      if(r.status===403 && method==="GET"){ log(`403 GET ${path.slice(0,60)} … 続行`); return null; }
      throw new Error(`Spotify ${r.status}: ${(t||"").slice(0,200)} @ ${path}`);
    }
    if(r.status===204) return null;
    return await r.json();
  }
  throw new Error("Spotify API max retries");
}

/* ====== ここから下はビルド機能（あなたの既存コードそのまま） ====== */
/*  ……（ビルダーの関数群は省略せず貼ってください。動いている現行のものをそのまま使えます） ……  */

/* 既存のハンドラも有効化 */
$("btnReset").onclick=()=>{ for(const k in LS) localStorage.removeItem(LS[k]); window._me=null; setStatus(); log("ローカルトークン削除"); };
$("btnCheck").onclick=async()=>{ try{ await refreshTokenIfNeeded(); const me=await spFetch("/v1/me","GET"); if(me) {$("status").textContent="接続中（"+(me.display_name||me.id)+")"; log("API確認 OK"); if(window._pending) await resolveAndWrite(window._pending);} else {$("status").textContent="接続中（OK）";} }catch(e){ log("接続エラー: "+(e.message||e)); } };

setStatus();
document.getElementById("buildBadge").textContent="BUILD "+BUILD_ID;
</script>
</body>
</html>
