<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder â€” Safe Mode</title>
<style>
  :root{--bg:#0b1220;--fg:#cfe3ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:960px;margin:32px auto;padding:0 12px}
  h1{margin:0 0 8px}
  fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
  label{display:block;margin:6px 0}
  button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
  button:disabled{opacity:.5;cursor:not-allowed}
  input[type="text"]{width:100%;max-width:720px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
  #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:220px}
  a.fallback{display:inline-block;margin-left:8px}
  small code{background:#f3f4f6;padding:1px 4px;border-radius:4px}
</style>
</head>
<body>
<h1>TDCS Editions Builder â€” Safe Mode</h1>
<p id="status">æœªæ¥ç¶š</p>

<div>
  <button id="btnConnect" data-action="connect" type="button">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <!-- â˜… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯â€œè¦‹ãˆã‚‹â€ç›´è¡Œãƒªãƒ³ã‚¯ã€‚JSãŒå‹•ã„ãŸã‚‰è‡ªå‹•ã§éš ã™ -->
  <a id="linkConnect" class="fallback" href="/spotify-auth/auth.html">â† ãƒœã‚¿ãƒ³ãŒå‹•ã‹ãªã„/JSå£Šã‚Œã¦ã‚‹æ™‚ã¯ã“ã“ã‹ã‚‰</a>
  <button id="btnCheck" type="button">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
  <button id="btnReset" type="button">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
</div>

<fieldset>
  <legend>å›ºå®šï¼ˆDashboardã¨å®Œå…¨ä¸€è‡´ï¼‰</legend>
  <label>CLIENT_ID
    <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled>
  </label>
  <label>REDIRECT_URI
    <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled>
  </label>
  <small>â€» Spotify Developer Dashboard â†’ Redirect URIs ã« <code>https://npr2025.github.io/spotify-auth/callback.html</code> ã‚’<strong>å®Œå…¨ä¸€è‡´</strong>ç™»éŒ²ã€‚</small>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<script>
/* ====== å³æ™‚ï¼šè‡´å‘½ã‚¨ãƒ©ãƒ¼ã‚’å¿…ãšç”»é¢ã«å‡ºã™ ====== */
(function hardenConsole(){
  const logEl = ()=>document.getElementById('log');
  const add = (s)=>{ const el=logEl(); if(!el) return; el.textContent += (el.textContent?'\n':'') + s; el.scrollTop = el.scrollHeight; };
  window.addEventListener('error', e=> add('ğŸ›‘ JS Error: '+ (e.message||e)));
  window.addEventListener('unhandledrejection', e=> add('ğŸ›‘ Promise Rejection: '+ (e.reason && (e.reason.message||e.reason))));
  add('ğŸ§ª Self-check: logger armed');
})();

/* =========================
   å…±æœ‰å®šæ•°
========================= */
const zws=/[\u200B-\u200D\uFEFF]/g;
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e".replace(zws,"").trim();
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html".replace(zws,"").trim();
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
const LS={ acc:"sp_access_token", ref:"sp_refresh_token", exp:"sp_token_exp", ver:"sp_code_verifier", state:"sp_auth_state" };

/* =========================
   ãƒ­ã‚° & ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
========================= */
const $=(id)=>document.getElementById(id);
const log=(s)=>{ const el=$("log"); el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight; };
const isAuthed=()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0) - 5000;
function setStatus(){ $("status").textContent = isAuthed()? "æ¥ç¶šä¸­ï¼ˆOKï¼‰" : "æœªæ¥ç¶š"; }

/* =========================
   PKCE èªå¯ï¼ˆstate ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
========================= */
async function startAuth(){
  // 1) PKCE verifier
  let verifier=""; const u8=new Uint8Array(64);
  crypto.getRandomValues(u8); for(let i=0;i<u8.length;i++) verifier+=String.fromCharCode(97+(u8[i]%26));
  localStorage.setItem(LS.ver, verifier);

  // 2) code_challenge
  const hash=new Uint8Array(await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier)));
  let b=""; for(const x of hash) b+=String.fromCharCode(x);
  const challenge=btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");

  // 3) stateï¼ˆåˆ¥ã‚ªãƒªã‚¸ãƒ³é–‹å§‹å¯¾ç­–ï¼‰
  const state="v."+btoa(verifier).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_");
  localStorage.setItem(LS.state, state);

  // 4) Authorizeã¸
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",challenge);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",state);

  log("â†’ authorize ã¸é·ç§»: "+u.toString());
  location.href = u.toString();
}

/* =========================
   API ãƒ˜ãƒ«ãƒ‘
========================= */
async function refreshTokenIfNeeded(){
  const exp=+(localStorage.getItem(LS.exp)||0);
  if(Date.now()<exp-5000) return;
  const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const body=new URLSearchParams({grant_type:"refresh_token",refresh_token:rt,client_id:CLIENT_ID});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!r.ok){ log("âš ï¸ refreshå¤±æ•—: "+r.status); return; }
  const j=await r.json();
  localStorage.setItem(LS.acc,j.access_token);
  localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}
async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const init={method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
  if(body) init.body=JSON.stringify(body);
  const r=await fetch("https://api.spotify.com"+path,init);
  if(r.status===204) return null;
  const t=await r.text();
  if(!r.ok) throw new Error(`Spotify ${r.status}: ${t.slice(0,160)}`);
  return t?JSON.parse(t):null;
}

/* =========================
   ãƒœã‚¿ãƒ³ãŒåŠ¹ã‹ãªã„ç’°å¢ƒã§ã‚‚å‹•ã‹ã™â€œå§”è­²ãƒãƒ¼ãƒã‚¹â€
========================= */
(function(){
  function showFallback(reason){
    try{
      const a=$("linkConnect"); if(a) a.style.display='inline-block';
      log("âš ï¸ Authãƒœã‚¿ãƒ³å¤±æ•—: "+(reason && (reason.message||reason)));
    }catch(_){}
  }
  async function goAuth(ev){
    if(ev && ev.preventDefault) ev.preventDefault();
    try{
      if(typeof startAuth==="function") return startAuth();
    }catch(err){
      console.error(err); showFallback(err); location.href="/spotify-auth/auth.html"; return;
    }
    showFallback("handler-not-found");
    location.href="/spotify-auth/auth.html";
  }
  document.addEventListener("click",(ev)=>{
    const t = ev.target.closest('#btnConnect,[data-action="connect"]');
    if(!t) return; goAuth(ev);
  }, true);
})();

/* =========================
   èµ·å‹•å®Œäº†ã‚µã‚¤ãƒ³ & UI
========================= */
(function ready(){
  // JSèµ·å‹•OKãªã‚‰ç›´è¡Œãƒªãƒ³ã‚¯ã‚’éš ã™ï¼ˆJSå£Šã‚Œã¦ã„ã‚‹æ™‚ã ã‘è¦‹ãˆã‚‹è¨­è¨ˆï¼‰
  const a=$("linkConnect"); if(a) a.style.display='none';
  setStatus();
  log("âœ… JSèµ·å‹•OK");
  log("info: origin="+location.origin+" path="+location.pathname);
  if(new URLSearchParams(location.search).get("authed")==="1"){
    log("â†©ï¸ èªå¯å¾©å¸°ã€‚æ¥ç¶šãƒã‚§ãƒƒã‚¯ä¸­â€¦");
    $("btnCheck").click();
  }
})();

/* =========================
   UI ã‚¤ãƒ™ãƒ³ãƒˆ
========================= */
$("btnCheck").onclick = async ()=>{
  try{
    await refreshTokenIfNeeded();
    const me=await spFetch("/v1/me","GET");
    $("status").textContent=`æ¥ç¶šä¸­ï¼ˆ${me.display_name||me.id}ï¼‰`;
    log("âœ… APIç¢ºèª OK");
  }catch(e){ log("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+(e.message||e)); }
};
$("btnReset").onclick = ()=>{
  Object.values(LS).forEach(k=>localStorage.removeItem(k));
  setStatus(); log("ğŸ§½ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤");
};
</script>
</body>
</html>
