<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder — サインイン修正版</title>
<style>
  :root{--bg:#0b1220;--fg:#cfe3ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:960px;margin:32px auto;padding:0 12px}
  h1{margin:0 0 8px}
  fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
  label{display:block;margin:6px 0}
  button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
  button:disabled{opacity:.5;cursor:not-allowed}
  input[type="text"]{width:100%;max-width:720px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
  #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:220px}
  a.fallback{display:none;margin-left:8px}
</style>
</head>
<body>
<h1>TDCS Editions Builder — サインイン修正版</h1>
<p id="status">未接続</p>

<div>
  <button id="btnConnect" data-action="connect" type="button">Spotifyにサインイン</button>
  <a id="linkConnect" class="fallback" href="./auth.html">← ボタンが動かない時はここから</a>
  <button id="btnCheck" type="button">接続チェック</button>
  <button id="btnReset" type="button">初期化（保存トークン削除）</button>
</div>

<fieldset>
  <legend>固定（Dashboardと完全一致）</legend>
  <label>CLIENT_ID
    <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled>
  </label>
  <label>REDIRECT_URI
    <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled>
  </label>
  <small>※ Developer Dashboard の Redirect URIs に <code>https://npr2025.github.io/spotify-auth/callback.html</code> を 1文字違わず登録。</small>
</fieldset>

<fieldset>
  <legend>ログ</legend>
  <pre id="log">Booting…</pre>
</fieldset>

<script>
/* =========================
   共有定数
========================= */
const zws=/[\u200B-\u200D\uFEFF]/g;
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e".replace(zws,"").trim();
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html".replace(zws,"").trim();
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
const LS={ acc:"sp_access_token", ref:"sp_refresh_token", exp:"sp_token_exp", ver:"sp_code_verifier", state:"sp_auth_state" };

/* =========================
   ログ & ステータス
========================= */
const $=(id)=>document.getElementById(id);
const log=(s)=>{ const el=$("log"); el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight; };
const isAuthed=()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0) - 5000;
function setStatus(){
  $("status").textContent = isAuthed()? "接続中（OK）" : "未接続";
}

/* =========================
   PKCE 認可（state フォールバック付き）
========================= */
async function startAuth(){
  // 1) PKCE verifier 生成
  let verifier=""; const u8=new Uint8Array(64);
  crypto.getRandomValues(u8);
  for(let i=0;i<u8.length;i++) verifier+=String.fromCharCode(97+(u8[i]%26));
  localStorage.setItem(LS.ver, verifier);

  // 2) code_challenge
  const hash=new Uint8Array(await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier)));
  let b=""; for(const x of hash) b+=String.fromCharCode(x);
  const challenge=btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");

  // 3) state に verifier を格納（別オリジン開始対策）
  const state="v."+btoa(verifier).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_");
  localStorage.setItem(LS.state, state);

  // 4) Authorize に飛ばす
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",challenge);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",state);
  location.href = u.toString();
}

/* =========================
   API ヘルパ
========================= */
async function refreshTokenIfNeeded(){
  const exp=+(localStorage.getItem(LS.exp)||0);
  if(Date.now()<exp-5000) return;
  const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const body=new URLSearchParams();
  body.set("grant_type","refresh_token");
  body.set("refresh_token",rt);
  body.set("client_id",CLIENT_ID);
  const r=await fetch("https://accounts.spotify.com/api/token",{
    method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body
  });
  if(!r.ok){ log("⚠️ refresh失敗: "+r.status); return; }
  const j=await r.json();
  localStorage.setItem(LS.acc,j.access_token);
  localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}
async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const init={method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
  if(body) init.body=JSON.stringify(body);
  const r=await fetch("https://api.spotify.com"+path,init);
  if(r.status===204) return null;
  const t=await r.text();
  if(!r.ok) throw new Error(`Spotify ${r.status}: ${t.slice(0,160)}`);
  return t?JSON.parse(t):null;
}

/* =========================
   ボタンが効かない環境でも動かす“委譲ハーネス”
========================= */
(function(){
  function showFallback(reason){
    try{
      $("linkConnect").style.display='inline-block';
      log("⚠️ Authボタン失敗: "+(reason && (reason.message||reason)));
    }catch(_){}
  }
  async function goAuth(ev){
    if(ev && typeof ev.preventDefault==="function") ev.preventDefault();
    try{
      if(typeof startAuth==="function") return startAuth();
    }catch(err){
      console.error(err); showFallback(err);
      location.href="./auth.html"; return;
    }
    // 未定義・拾えない場合は即フォールバック
    showFallback("handler-not-found");
    location.href="./auth.html";
  }
  // クリック委譲（id でも data-action でも拾う）
  document.addEventListener("click",(ev)=>{
    const t = ev.target.closest('#btnConnect,[data-action="connect"]');
    if(!t) return;
    goAuth(ev);
  }, true);
})();

/* =========================
   UI イベント
========================= */
$("btnCheck").onclick = async ()=>{
  try{
    await refreshTokenIfNeeded();
    const me=await spFetch("/v1/me","GET");
    $("status").textContent=`接続中（${me.display_name||me.id}）`;
    log("✅ API確認 OK");
  }catch(e){ log("⚠️ 接続エラー: "+(e.message||e)); }
};
$("btnReset").onclick = ()=>{
  Object.values(LS).forEach(k=>localStorage.removeItem(k));
  setStatus(); log("🧽 ローカルトークン削除");
};
setStatus();
if(new URLSearchParams(location.search).get("authed")==="1"){
  log("↩︎ 認可復帰。接続チェック中…");
  $("btnCheck").click();
}
</script>
</body>
</html>
