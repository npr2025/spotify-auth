<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RESCUE index | spotify-auth</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:760px;margin:40px auto;padding:0 12px}
  a.btn,button{display:inline-block;padding:10px 14px;border:1px solid #bbb;border-radius:8px;background:#f6f6f6;text-decoration:none;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  #status{margin-top:10px;color:#2d7a2d}
  #warn{margin-top:4px;color:#a53}
  #log{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:10px;border-radius:8px;margin-top:14px;max-height:420px;overflow:auto}
</style>
</head>
<body>
<h1>RESCUE Index <span style="font-size:12px;border:1px solid #bbb;border-radius:999px;padding:0 6px">vR-01</span></h1>
<p>ã¾ãšã¯ãƒšãƒ¼ã‚¸ã¨ãƒœã‚¿ãƒ³ã®åå¿œã‚’ç¢ºèªã™ã‚‹æœ€å°æ§‹æˆã€‚ã‚µã‚¤ãƒ³ã‚¤ãƒ³â†’ /v1/me â†’ ãƒ­ã‚°ãŒå‹•ã‘ã°OKã€‚</p>
<p>
  <a class="btn" href="./auth.html">Sign in with Spotify</a>
  <button id="btnMe">/v1/me</button>
  <button id="btnRepair">ğŸ”§ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ</button>
</p>
<p id="status" class="muted">çŠ¶æ…‹ç¢ºèªä¸­â€¦</p>
<div id="warn"></div>
<pre id="log"></pre>

<script>
"use strict";
/*** å›ºå®šï¼šã‚ãªãŸã®ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ« ***/
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const K={access:"sp_access_token",type:"sp_token_type",expAt:"sp_expires_at",refresh:"sp_refresh_token",scope:"sp_scope"};

/*** ãƒ­ã‚°/UI ***/
const $=s=>document.querySelector(s);
const log=m=>{ const d=new Date().toLocaleTimeString(); const el=$("#log"); el.textContent+=`[${d}] ${m}\n`; el.scrollTop=el.scrollHeight; console.log(m); };
const warn=m=>$("#warn").textContent=m||"";
function renderStatus(){
  try{
    const a=sessionStorage.getItem(K.access);
    const e=parseInt(sessionStorage.getItem(K.expAt)||"0",10);
    if(!a){ $("#status").textContent="æœªã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼ˆä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚µã‚¤ãƒ³ã‚¤ãƒ³ï¼‰"; return; }
    const left=e-Date.now();
    if(left>60000) $("#status").textContent="Signed in â€“ æœ‰åŠ¹æœŸé™ã¾ã§ç´„ "+Math.floor(left/1000)+" ç§’";
    else if(left>0) $("#status").textContent="Signed in â€“ ã¾ã‚‚ãªãæœŸé™åˆ‡ã‚Œ";
    else $("#status").textContent="ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œï¼ˆå†ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ï¼‰";
  }catch(err){ $("#status").textContent="çŠ¶æ…‹è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: "+(err.message||err); }
}
window.addEventListener("error", e => log("SCRIPT ERROR: "+e.message));
window.addEventListener("unhandledrejection", e => log("UNHANDLED: "+(e?.reason?.message||e?.reason)));

/*** Token refresh + fetch ***/
let lastApiTs=0, MIN_API_GAP_MS=800;
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
let refreshInflight=null;
async function ensureFreshToken(){
  const a=sessionStorage.getItem(K.access), expAt=parseInt(sessionStorage.getItem(K.expAt)||"0",10), r=sessionStorage.getItem(K.refresh);
  if(a && Date.now()<(expAt-5000)) return a;
  if(!r) return null;
  if(!refreshInflight){
    refreshInflight=(async()=>{
      let attempt=0;
      while(true){
        attempt++;
        const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:CLIENT_ID,grant_type:"refresh_token",refresh_token:r,redirect_uri:REDIRECT_URI})});
        if(res.status===429){const ra=parseInt(res.headers.get("Retry-After")||"1",10); await sleep((isNaN(ra)?1:Math.min(60,ra))*1000+200); continue;}
        const txt=await res.text(); let data=null; try{data=JSON.parse(txt);}catch(_){}
        if(!res.ok) throw new Error("refresh failed: "+res.status+" "+txt);
        const expAt=Date.now()+data.expires_in*1000;
        sessionStorage.setItem(K.access,data.access_token);
        sessionStorage.setItem(K.type,data.token_type||"Bearer");
        sessionStorage.setItem(K.expAt,String(expAt));
        if(data.refresh_token) sessionStorage.setItem(K.refresh,data.refresh_token);
        if(data.scope) sessionStorage.setItem(K.scope,data.scope);
        renderStatus(); return data.access_token;
      }
    })().finally(()=>{refreshInflight=null;});
  }
  return refreshInflight;
}
async function callSpotifyJSON(url,{method="GET",headers={},body=null}={}){
  const wait=Math.max(0,MIN_API_GAP_MS-(Date.now()-lastApiTs)); if(wait) await sleep(wait);
  let token=await ensureFreshToken(); if(!token) throw new Error("No valid token. Sign in again.");
  const h=new Headers(headers); h.set("Authorization","Bearer "+token); h.set("Accept","application/json");
  if(body && !(body instanceof FormData) && !h.has("Content-Type")) h.set("Content-Type","application/json");
  const res=await fetch(url,{method,headers:h,body}); lastApiTs=Date.now();
  if(res.status===429){ const ra=parseInt(res.headers.get("Retry-After")||"1",10); log("429 â†’ "+(isNaN(ra)?1:ra)+"ç§’å¾…æ©Ÿ"); await sleep((isNaN(ra)?1:Math.min(60,ra))*1000+200); return callSpotifyJSON(url,{method,headers,body}); }
  const txt=await res.text(); let data=null; try{data=JSON.parse(txt);}catch(_){}
  if(!res.ok) throw new Error("HTTP "+res.status+": "+txt);
  return data||{};
}

/*** HOTFIX: clickå§”ä»» + ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ ***/
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button,a.btn'); if(!btn) return;
  const id=btn.id||btn.getAttribute('href')||'(no-id)'; log("â–¶ click: "+id);
  if(btn.tagName==='A') return; // Sign inãƒªãƒ³ã‚¯ã¯é€šå¸¸é·ç§»
  e.preventDefault();
  if(id==='btnMe'){
    try{ const me=await callSpotifyJSON("https://api.spotify.com/v1/me"); log(`/v1/me OK: ${me.display_name||'(no name)'} / ${me.id}`); }
    catch(err){ log("ã‚¨ãƒ©ãƒ¼: "+(err.message||err)); alert("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚"); }
  }else if(id==='btnRepair'){
    try{
      localStorage.removeItem('sp_build_lock_v1');
      [K.access,K.expAt,K.refresh,K.scope].forEach(k=>sessionStorage.removeItem(k));
      renderStatus(); log("ğŸ”§ ãƒªã‚»ãƒƒãƒˆå®Œäº†ã€‚å¿…è¦ãªã‚‰å†ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚’ã€‚");
      alert("ãƒªã‚»ãƒƒãƒˆå®Œäº†ã€‚'Sign in with Spotify' ã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
    }catch(err){ log("ã‚¨ãƒ©ãƒ¼: "+(err.message||err)); }
  }
});

/*** èµ·å‹•ãƒ­ã‚° ***/
(function boot(){
  log("âœ… RESCUE index loaded");
  log("href="+location.href);
  renderStatus();
})();
</script>
</body>
</html>
