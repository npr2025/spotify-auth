<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder â€” CSVé™å®š / å¼·åˆ¶130 / ç›¸äº’é‡è¤‡å¯</title>
<style>
:root{--bg:#0b1220;--fg:#cfe3ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1180px;margin:32px auto;padding:0 12px}
h1{margin:0 0 8px}
fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
label{display:block;margin:6px 0}
input[type="text"],input[type="number"],select{width:100%;max-width:760px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
input[type="file"]{margin:4px 0}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
button:disabled{opacity:.5;cursor:not-allowed}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
small.hint{color:#666}
#log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:280px}
#progWrap{position:relative;height:12px;background:#e6eaf2;border-radius:6px;overflow:hidden;margin:6px 0}
#progBar{height:100%;width:0%;background:#4a90e2;transition:width .2s ease}
#progLine{font-variant-numeric:tabular-nums;margin:4px 0 0 0;color:#333}
.hidden{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>TDCS Editions Builder â€” CSVé™å®šï¼ˆå¼·åˆ¶130ï¼‰</h1>
<p id="status">æœªæ¥ç¶š</p>
<div>
  <button id="btnConnect">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button id="btnReset">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
  <button id="btnCheck">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
</div>

<fieldset>
  <legend>å›ºå®š</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" id="clientId" value="1fd6350fcf4945a0b3ddffa2d5730d4e"></label>
    <label>REDIRECT_URI <input type="text" id="redir" value="" disabled></label>
  </div>
  <small class="hint">â€» REDIRECT_URI ã¯è‡ªå‹•ã§ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã® <code>callback.html</code> ã«è¨­å®šï¼ˆãƒšãƒ¼ã‚¸å…¬é–‹URLã«åˆã‚ã›ã¦è‡ªå‹•è§£æ±ºï¼‰ã€‚</small>
</fieldset>

<fieldset>
  <legend>è¨­å®šï¼ˆ4ãƒªã‚¹ãƒˆï¼‰</legend>
  <div class="grid2">
    <label>UK <input id="plUK" type="text" value=""></label>
    <label>US <input id="plUS" type="text" value=""></label>
    <label>EU <input id="plEU" type="text" value=""></label>
    <label>WORLD <input id="plWORLD" type="text" value=""></label>
  </div>
  <div class="grid3">
    <label>APIé–“éš”(ms) <input id="gap" type="number" value="1200"></label>
    <label>å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å‡ºåŠ›æ•° <input id="finalN" type="number" value="130"></label>
    <label>ä¸»è¦ãƒãƒ¼ã‚±ãƒƒãƒˆï¼ˆå„ªå…ˆé †ï¼‰<input id="markets" type="text" value="AU,NZ,US,GB,ES,NL"></label>
  </div>

  <div class="grid3">
    <label>UKãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetUK"><option>waves</option><option selected>rise</option><option>drop</option><option>dj</option></select>
    </label>
    <label>USãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetUS"><option selected>rise</option><option>waves</option><option>drop</option><option>dj</option></select>
    </label>
    <label>EUãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetEU"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
  </div>

  <label><input id="strictMarket" type="checkbox"> å¸‚å ´ä¸€è‡´ã‚’ã€Œå„ªå…ˆæ¡ç”¨ã€ã«ã™ã‚‹ï¼ˆä¸è¶³åˆ†ã¯CSVå†…ã§è£œå®Œï¼‰</label>
  <label><input id="allowCrossDup" type="checkbox" checked> ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é–“ã®é‡è¤‡ã‚’è¨±å¯ï¼ˆUK/US/EU/WORLDã§åŒä¸€URIå¯ï¼‰</label>
  <label><input id="allowWithinDup" type="checkbox" checked> ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å†…ã®é‡è¤‡ã‚‚è¨±å¯ï¼ˆå¿…ãš130æ›²ã‚’æº€ãŸã™ï¼‰</label>
  <label><input id="onlyCsv" type="checkbox" checked> CSVã®æ›²ã ã‘ã‚’ä½¿ç”¨ï¼ˆå¤–éƒ¨è£œå……ã‚¼ãƒ­ï¼‰</label>
</fieldset>

<fieldset>
  <legend>CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã“ã®æ›²ã ã‘ã§çµ„ã‚€ï¼‰</legend>
  <label>ã‚½ãƒ¼ã‚¹CSV<input id="fileCSV" type="file" accept=".csv"></label>
  <small class="hint">åˆ—ã¯è‡ªå‹•æ¤œå‡ºã€‚å„ªå…ˆï¼štrack_uri/url/id, isrc, title/version, artistã€‚CSVã®é †åºã‚’åŸºæœ¬ã«ä¸¦ã¹ã€ãƒ—ãƒªã‚»ãƒƒãƒˆã«åˆã‚ã›ã¦æµã‚Œæœ€é©åŒ–ã€‚</small>
</fieldset>

<fieldset>
  <legend>é€²æ—</legend>
  <div id="progWrap" class="hidden"><div id="progBar"></div></div>
  <div id="progLine">0% â€” å¾…æ©Ÿä¸­</div>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<div>
  <button id="btnExportXlsx" disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆXLSXï¼‰</button>
  <button id="btnExportCsv"  disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</button>
</div>

<script>
/* ===== ä¾‹å¤–è¡¨ç¤º ===== */
window.onerror=(m,src,lin,col,err)=>{ const el=document.getElementById("log"); el.textContent+=(el.textContent?"\n":"")+"ğŸ’¥ ScriptError: "+m+" @"+lin+":"+col; console.error(err||m); };
window.addEventListener("unhandledrejection",(e)=>{ const el=document.getElementById("log"); el.textContent+=(el.textContent?"\n":"")+"ğŸ’¥ PromiseRejection: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)); console.error(e.reason); });

/* ===== å›ºå®š ===== */
const zws=/[\u200B-\u200D\uFEFF]/g;
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";

/* ===== DOM/UTIL ===== */
const $=(id)=>document.getElementById(id);
const log=(s)=>{ const el=$("log"); el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight; };
const progress=(p,msg)=>{ $("progWrap").classList.remove("hidden"); $("progBar").style.width=Math.max(0,Math.min(100,p))+"%"; if(msg) $("progLine").textContent=Math.round(p)+"% â€” "+msg; }
const subProgress=(i,t,s,e,l)=>{ const f=t?i/t:0; progress(s+(e-s)*f,`${l} (${i}/${t})`); }
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
const num=(x)=>{ const s=String(x==null?0:x).replace(/[ %,ï¼Œ]/g,""); const v=parseFloat(s); return isFinite(v)?v:0; }
const round4=(x)=> (typeof x==="number"&&isFinite(x))?Math.round(x*10000)/10000:"";
const uniq=(a)=>Array.from(new Set(a));

/* ===== REDIRECT_URI ã‚’ç¾åœ¨ãƒ•ã‚©ãƒ«ãƒ€ã® callback.html ã«è‡ªå‹•è¨­å®š ===== */
(function setDynamicRedirect(){
  const base = location.origin + location.pathname.replace(/index\.html?$/,'');
  const uri = base + "callback.html";
  $("redir").value = uri;
})();

/* ===== Auth ===== */
const isAuthed=()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0)-5000;
function setStatus(){ $("status").textContent=isAuthed()?"æ¥ç¶šä¸­ï¼ˆOKï¼‰":"æœªæ¥ç¶š"; if(isAuthed() && _pending) resolveAndWrite(_pending); }
async function startAuth(){
  const CLIENT_ID = ($("#clientId").value||"").replace(zws,"").trim();
  const REDIRECT_URI = $("redir").value.trim();
  if(!CLIENT_ID){ alert("CLIENT_ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  // PKCE
  let v=""; const u8=new Uint8Array(64); crypto.getRandomValues(u8); for(let i=0;i<u8.length;i++) v+=String.fromCharCode(97+(u8[i]%26));
  localStorage.setItem(LS.ver,v);
  const h=new Uint8Array(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v)));
  let b=""; for(const x of h) b+=String.fromCharCode(x);
  const ch=btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",ch);
  u.searchParams.set("scope",SCOPES);
  location.href=u.toString();
}
async function refreshTokenIfNeeded(){
  const exp=+(localStorage.getItem(LS.exp)||0);
  if(Date.now()<exp-5000) return;
  const CLIENT_ID = ($("#clientId").value||"").replace(zws,"").trim();
  const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const body=new URLSearchParams(); body.set("grant_type","refresh_token"); body.set("refresh_token",rt); body.set("client_id",CLIENT_ID);
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!r.ok){ log("âš ï¸ refreshå¤±æ•— "+r.status); return; }
  const j=await r.json();
  localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}
async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const gap=+($("gap").value||1200); await sleep(gap);
  for(let a=0;a<5;a++){
    const init={method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
    if(body) init.body=JSON.stringify(body);
    const r=await fetch("https://api.spotify.com"+path,init);
    if(r.status===401){ await refreshTokenIfNeeded(); continue; }
    if(r.status===429){ const ra=+(r.headers.get("Retry-After")||2); log("â³429â†’"+ra+"så¾…æ©Ÿ"); await sleep(ra*1000); continue; }
    if(!r.ok){
      const t=await r.text();
      if(r.status===403 && method==="GET"){ log(`âš ï¸ 403 GET ${path.slice(0,60)} â€¦ ç¶šè¡Œ`); return null; }
      throw new Error(`Spotify ${r.status}: ${(t||"").slice(0,200)} @ ${path}`);
    }
    if(r.status===204) return null;
    return await r.json();
  }
  throw new Error("Spotify API max retries");
}
let _me=null; async function getMe(){ if(_me) return _me; _me=await spFetch("/v1/me","GET"); return _me; }

/* ===== CSV ===== */
let csvRows=[];
function readCSV(file){return new Promise((res,rej)=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej}));}
const ISRC_RE=/^[A-Z]{2}-?[A-Z0-9]{3}-?\d{2}-?\d{5}$/i;
const extractTrackId=(raw)=>{const s=String(raw||"").trim(); if(!s) return ""; let m=s.match(/spotify:track:([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/open\.spotify\.com\/track\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/\/track\/([A-Za-z0-9]{22})(?:\?|$)/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
function columns(rows){const s={},out=[]; for(let i=0;i<Math.min(400,rows.length);i++){ for(const k of Object.keys(rows[i])) if(!s[k]){s[k]=1; out.push(k);} } return out;}
function pickByName(cols,pref){ const L=cols.map(c=>[c,c.toLowerCase()]); for(const p of pref){const n=p.toLowerCase(); const hit=L.find(([,m])=>m===n||m.includes(n)); if(hit) return hit[0];} return ""; }
function guessCsvColumns(rows){
  const cols=columns(rows);
  const scId=c=>{let m=0,n=0; for(let i=0;i<rows.length&&i<1500;i++){const v=String(rows[i][c]||""); if(!v)continue; n++; if(/spotify:track:[A-Za-z0-9]{22}/.test(v)||/open\.spotify\.com\/track\/[A-Za-z0-9]{22}/.test(v)||/^[A-Za-z0-9]{22}$/.test(v))m++;} return n?m/n:0;}
  const scIsrc=c=>{let m=0,n=0; for(let i=0;i<rows.length&&i<1500;i++){const v=String(rows[i][c]||""); if(!v)continue; n++; if(ISRC_RE.test(v))m++;} return n?m/n:0;}
  let idCol=""; let best=-1; for(const c of cols){const sc=scId(c); if(sc>best){best=sc; idCol=c;}}
  const isrcCol=cols.reduce((a,c)=> (scIsrc(c)>(a.score||-1)?{c,score:scIsrc(c)}:a),{}).c || pickByName(cols,["isrc","isrc_code"]);
  const tCol=pickByName(cols,["title","track","name","æ›²å","ã‚¿ã‚¤ãƒˆãƒ«"])||cols[0];
  const vCol=pickByName(cols,["version","ãƒãƒ¼ã‚¸ãƒ§ãƒ³","mix","remix","edit"]);
  const aCol=pickByName(cols,["artist","artists","ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ"])||cols[0];
  return {idCol,isrcCol,tCol,vCol,aCol};
}

/* ===== æ¤œç´¢/URIè§£æ±ºï¼ˆCSVã®ã¿ï¼‰ ===== */
const _isrcCache=new Map();
async function searchOnce(q,m){ const r=await spFetch(`/v1/search?q=${encodeURIComponent(q)}&type=track&limit=10&market=${m}`,"GET"); return (r&&r.tracks&&r.tracks.items)?r.tracks.items:[]; }
function isrcVariants(s){ s=String(s||"").trim(); if(!s) return []; const up=s.toUpperCase(); const no=up.replace(/-/g,""); const hy=up.indexOf("-")>=0?up:up.replace(/^(.{2})(.{3})(.{2})(.{5})$/,"$1-$2-$3-$4"); return uniq([up,no,hy]); }
function makeQueriesFromRow(row,cols){
  const id=cols.idCol?extractTrackId(row[cols.idCol]):"";
  const isrc=String(cols.isrcCol?row[cols.isrcCol]:"").trim();
  const title=(row[cols.tCol]||"").toString().trim();
  const version=(cols.vCol? (row[cols.vCol]||"") : "").toString().trim();
  const artist=(row[cols.aCol]||"").toString().trim();
  const name=version && !/original\s*mix/i.test(version)? `${title} - ${version}` : title;
  const q=[];
  if(id) q.push({type:"id",q:id});
  if(isrc && ISRC_RE.test(isrc)){ for(const v of isrcVariants(isrc)) q.push({type:"isrc",q:"isrc:"+v}); }
  if(title && artist){
    const base=title.split(/\s+-\s+/)[0];
    q.push({type:"field",q:`track:"${base}" artist:"${artist}"`});
    if(version) q.push({type:"field",q:`track:"${title}" artist:"${artist}"`});
    q.push({type:"free",q:`"${base}" ${artist}`});
  }else if(title){ q.push({type:"free",q:title}); }
  return {q,name,artist,isrc,id};
}
async function resolveOne(row,cols,markets){
  const {q,name,artist,isrc,id}=makeQueriesFromRow(row,cols);
  if(id) return "spotify:track:"+id;
  if(isrc){ for(const v of isrcVariants(isrc)){ if(_isrcCache.has(v)) return _isrcCache.get(v); } }
  for(const qq of q){
    if(qq.type==="id"||qq.type==="isrc"||qq.type==="field"||qq.type==="free"){
      for(const m of markets){
        try{
          const items=await searchOnce(qq.q,m);
          if(items && items.length){ const u="spotify:track:"+items[0].id; if(isrc) for(const v of isrcVariants(isrc)) _isrcCache.set(v,u); return u; }
        }catch(_){}
      }
    }
  }
  return ""; // è¦‹ã¤ã‹ã‚‰ãªã„
}

/* ===== è©³ç´°/å¯ç”¨æ€§ ===== */
async function fetchTrackDetailsByUris(uris){
  const ids=[], map=new Map();
  for(const u of uris){ if(u) ids.push(u.replace("spotify:track:","")); }
  for(let i=0;i<ids.length;i+=50){
    const slice=ids.slice(i,i+50); if(!slice.length) continue;
    const r=await spFetch("/v1/tracks?ids="+slice.join(","),"GET");
    const arr=(r&&r.tracks)||[]; for(const t of arr){ if(t&&t.id) map.set("spotify:track:"+t.id,t); }
  }
  return map;
}

/* ===== ä¸¦ã³ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆå¯¾å¿œï¼‰ ===== */
const camelot=(key,mode)=>({num:[8,3,10,5,0,7,2,9,4,11,6,1][(key||0)%12],isMinor:mode===0});
const keyDistance=(a,b)=>{ if(!a||!b||a.key==null||b.key==null) return 2; const A=camelot(a.key,a.mode), B=camelot(b.key,b.mode); let d=Math.abs(A.num-B.num); d=Math.min(d,12-d); let pen=d/6; if(A.isMinor!==B.isMinor) pen+=0.4; return pen; }
function nextCost(a,b,preset){
  const dTempo=(a&&b&&a.tempo&&b.tempo)?Math.min(1,Math.abs(a.tempo-b.tempo)/16):0.5;
  const dKey=keyDistance(a,b); const dEner=(a&&b)?Math.abs((a.energy||0)-(b.energy||0)):0.5;
  const dVal=(a&&b)?Math.abs((a.valence||0)-(b.valence||0)):0.5;
  if(preset==="dj")   return 0.45*dTempo+0.35*dKey+0.15*dEner+0.05*dVal;
  if(preset==="rise") return 0.35*dTempo+0.20*dKey+0.35*dEner+0.10*dVal;
  if(preset==="drop") return 0.35*dTempo+0.20*dKey+0.35*dEner+0.10*dVal;
  return               0.40*dTempo+0.25*dKey+0.25*dEner+0.10*dVal; /* ä¿®æ­£æ¸ˆ */
}
function orderFlow(uris,featMap,preset){
  if(uris.length<=2) return uris.slice(0);
  const seq=[uris[0]];
  const pool=uris.slice(1);
  while(pool.length){
    const prev=seq[seq.length-1];
    let bestIdx=0, best=1e9;
    for(let i=0;i<pool.length;i++){
      const a=featMap.get(prev)||{}, b=featMap.get(pool[i])||{};
      let cost=nextCost(a,b,preset);
      if(cost<best){best=cost; bestIdx=i;}
    }
    seq.push(pool.splice(bestIdx,1)[0]);
  }
  return seq;
}

/* ===== åˆ†é…ï¼ˆé‡è¤‡è¨±å®¹ã§å¼·åˆ¶130ï¼‰ ===== */
function fillToN(baseUris, N, allowWithinDup){
  if(baseUris.length===0) return [];
  if(allowWithinDup){
    const out=[]; let i=0; while(out.length<N){ out.push(baseUris[i%baseUris.length]); i++; if(i> N*20) break; }
    return out.slice(0,N);
  }else{
    return baseUris.slice(0,N);
  }
}
function makeEditionPacks(allUris, feats){
  const N=+($("finalN").value||130);
  const allowWithinDup = $("allowWithinDup").checked;
  const allowCrossDup  = $("allowCrossDup").checked;
  let base = allUris.slice(0);
  if(!allowCrossDup){
    // ï¼ˆä»»æ„ï¼‰ç‰ˆé–“ã§ç›¸äº’éé‡è¤‡ã«ã—ãŸã„å ´åˆã®å®Ÿè£…ã¯åˆ¥é€”ã€‚æ—¢å®šã¯é‡è¤‡è¨±å¯ã€‚
    // ã“ã“ã§ã¯ base ã®é‡è¤‡ã‚’é™¤å»ã™ã‚‹ã®ã¿ï¼ˆæ—¢å®šONãªã®ã§é€šå¸¸ã¯æœªä½¿ç”¨ï¼‰
    base = Array.from(new Set(base));
  }
  const mkUK = orderFlow(fillToN(base, N, allowWithinDup), feats, ($("#presetUK").value||"waves"));
  const mkUS = orderFlow(fillToN(base, N, allowWithinDup), feats, ($("#presetUS").value||"rise"));
  const mkEU = orderFlow(fillToN(base, N, allowWithinDup), feats, ($("#presetEU").value||"waves"));
  const mkWO = orderFlow(fillToN(base, N, allowWithinDup), feats, ("dj"));
  return {UK:mkUK, US:mkUS, EU:mkEU, WORLD:mkWO};
}

/* ===== æ›¸ãè¾¼ã¿ & ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ===== */
const extractPlaylistId=(s)=>{s=String(s||""); let m=s.match(/playlist\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
async function replacePlaylist(pid,uris){
  const chunks=[]; for(let i=0;i<uris.length;i+=100) chunks.push(uris.slice(i,i+100));
  if(!chunks.length) chunks.push([]);
  await spFetch("/v1/playlists/"+pid+"/tracks","PUT",{uris:chunks[0]}); log("ğŸ§¹ ç½®æ›: "+chunks[0].length+"ä»¶");
  for(let k=1;k<chunks.length;k++){ await spFetch(`/v1/playlists/${pid}/tracks`,"POST",{uris:chunks[k]}); log("â• è¿½åŠ : "+chunks[k].length+"ä»¶"); }
}
async function createPlaylistAndFill(name,desc,isPublic,uris){
  const me=await getMe();
  const pl=await spFetch("/v1/users/"+encodeURIComponent(me.id)+"/playlists","POST",{name,description:desc,public:!!isPublic});
  const pid=(pl&&pl.id)?pl.id:""; await replacePlaylist(pid,uris); return pid;
}

let _exportData=null; const enableExportButtons=(on)=>{ $("btnExportXlsx").disabled=!on; $("btnExportCsv").disabled=!on; }
function exportXlsx(){
  if(!_exportData){log("â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ãªã—");return;}
  const wb=XLSX.utils.book_new();
  const add=(name,key)=>{ const ws=XLSX.utils.json_to_sheet(_exportData[key],{header:["position","edition","spotify_uri","tempo","energy","valence","key","mode"]}); XLSX.utils.book_append_sheet(wb,ws,name); }
  add("UK","uk"); add("US","us"); add("EU","eu"); add("WORLD","wo");
  XLSX.writeFile(wb,"editions_"+new Date().toISOString().slice(0,10)+".xlsx");
}
function exportCsv(){
  if(!_exportData){log("â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ãªã—");return;}
  const all=[].concat(_exportData.uk,_exportData.us,_exportData.eu,_exportData.wo);
  const H=["position","edition","spotify_uri","tempo","energy","valence","key","mode"];
  const esc=(v)=>'"'+String(v==null?"":v).replace(/"/g,'""')+'"';
  const rows=[H.join(",")];
  for(const r of all){ rows.push(H.map(h=>esc(r[h])).join(",")); }
  const blob=new Blob([rows.join("\r\n")],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="editions_"+new Date().toISOString().slice(0,10)+".csv"; document.body.appendChild(a); a.click(); a.remove();
}

/* ===== å„ªå…ˆæ¡ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function buildBasePool(list, preferred, N){
  // preferredï¼ˆå¸‚å ´ä¸€è‡´ï¼‰ã‚’å…ˆé ­ã«ã€ãã®å¾Œ list ã§è£œå®Œã€‚é‡è¤‡ã¯é™¤å»ã€‚
  const used = new Set();
  const seq = [];
  const pushUnique = (u)=>{ if(u && !used.has(u)){ used.add(u); seq.push(u); } };
  for (const u of preferred) pushUnique(u);
  for (const u of list)      pushUnique(u);
  return seq; // æœ€çµ‚130åŒ–ã¯ fillToN ãŒæ‹…å½“ï¼ˆdupå¯ï¼‰
}

/* ===== ãƒ¡ã‚¤ãƒ³ ===== */
let _pending=null;

function getMarkets(){
  const raw=($("markets")?.value||"").toUpperCase();
  const arr=raw.split(",").map(s=>s.trim()).filter(Boolean);
  return arr.length?uniq(arr):["AU","NZ","US","GB","ES","NL"];
}

async function runCsvOnly(){
  try{
    progress(8,"CSVæ¤œå‡ºâ€¦");
    const cols=guessCsvColumns(csvRows);
    log("ğŸ” åˆ—: id="+cols.idCol+", isrc="+cols.isrcCol+", title="+cols.tCol+", version="+cols.vCol+", artist="+cols.aCol);

    progress(20,"URIè§£æ±ºï¼ˆCSVã®ã¿ï¼‰â€¦");
    const mkts=getMarkets();
    const uris=[]; let ok=0;
    for(let i=0;i<csvRows.length;i++){
      const u=await resolveOne(csvRows[i],cols,mkts);
      uris.push(u);
      if(u) ok++;
      if(((i+1)%20===0)||i+1===csvRows.length) subProgress(i+1,csvRows.length,20,48,"URIè§£æ±º");
    }
    log(`ğŸ”— URIè§£æ±º: ${ok}/${csvRows.length}`);

    const list=uris.filter(Boolean);
    if(list.length===0){ throw new Error("CSVã‹ã‚‰è§£æ±ºã§ãã‚‹URIãŒã‚ã‚Šã¾ã›ã‚“"); }

    progress(55,"æ›²è©³ç´°â†’å¸‚å ´å„ªå…ˆåº¦ãƒã‚§ãƒƒã‚¯â€¦");
    const tracksMap=await fetchTrackDetailsByUris(list);
    const strict=$("strictMarket").checked;
    const mk=getMarkets();
    let preferred=list; // æ—¢å®šï¼šå…¨æ›²åŒåˆ—
    if(strict){
      preferred=list.filter(u=>{
        const t=tracksMap.get(u);
        if(!t || !Array.isArray(t.available_markets)) return false;
        return mk.some(m=>t.includes ? t.includes(m) : t.available_markets.includes(m));
      });
      // å¿µã®ãŸã‚ includes å®‰å…¨åŒ–ï¼ˆä¸Šã§ t.available_markets ã«çµ±ä¸€ã—ã¦ã„ã‚‹ãŒä¿é™ºï¼‰
      preferred=list.filter(u=>{
        const t=tracksMap.get(u);
        if(!t || !Array.isArray(t.available_markets)) return false;
        return mk.some(m=>t.available_markets.includes(m));
      });
      log(`ğŸŒ å¸‚å ´ä¸€è‡´(å„ªå…ˆæ¡ç”¨): ${preferred.length}/${list.length}ï¼ˆä¸è¶³åˆ†ã¯CSVã§è£œå®Œï¼‰`);
    }

    // å¸¸ã«CSVå†…ã ã‘ã§å€™è£œã‚’æ§‹ç¯‰ï¼ˆå¤–éƒ¨è£œå……ã‚¼ãƒ­ï¼‰
    const N=+($("finalN").value||130);
    const basePool=buildBasePool(list, preferred, N);

    progress(68,"Audio Features å–å¾—â€¦");
    let feats=new Map();
    try{ feats=await fetchAudioFeaturesByUris(basePool); }
    catch(e){ log("âš ï¸ audio-features å–å¾—ã‚¹ã‚­ãƒƒãƒ—: "+(e.message||e)); }

    progress(78,"ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³åˆ†é…ï¼ˆå¼·åˆ¶130/é‡è¤‡è¨±å®¹ï¼‰â€¦");
    const packs=makeEditionPacks(basePool, feats);

    progress(86,"æ›²é †æœ€é©åŒ–ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆåæ˜ ï¼‰â€¦");
    // orderFlowæ¸ˆã¿

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨æ•´å½¢
    function packRows(arr,ed){ const out=[]; for(let i=0;i<arr.length;i++){ const f=feats.get(arr[i])||{}; out.push({position:i+1,edition:ed,spotify_uri:arr[i],tempo:round4(f.tempo),energy:round4(f.energy),valence:round4(f.valence),key:(f.key==null?"":f.key),mode:(f.mode==null?"":f.mode)}); } return out; }
    _exportData={uk:packRows(packs.UK,"UK"),us:packRows(packs.US,"US"),eu:packRows(packs.EU,"EU"),wo:packRows(packs.WORLD,"WORLD")};
    enableExportButtons(true);

    if(isAuthed()) await resolveAndWrite(packs);
    else { _pending=packs; log("ğŸ”‘ æ¥ç¶šå¾…ã¡ï¼šã€Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã€â†’ã€æ¥ç¶šãƒã‚§ãƒƒã‚¯ã€"); }

    progress(100,"å®Œäº†");
    log("âœ… å®Œäº†ï¼ˆCSVé™å®šï¼å¼·åˆ¶130ï¼å¸‚å ´ä¸€è‡´ã¯å„ªå…ˆæ¡ç”¨ï¼ç‰ˆé–“é‡è¤‡OKï¼from_tokenç„¡ï¼403 GETç¶™ç¶šï¼‰");
  }catch(e){
    progress(100,"ã‚¨ãƒ©ãƒ¼");
    log("ğŸ’¥ ERROR: "+(e.message||e));
  }
}

async function resolveAndWrite(packs){
  try{
    const toUris=(list)=>list.slice(0); // ãã®ã¾ã¾
    const pidUK=extractPlaylistId($("plUK").value), pidUS=extractPlaylistId($("plUS").value), pidEU=extractPlaylistId($("plEU").value), pidWO=extractPlaylistId($("plWORLD").value);
    if(pidUK) { progress(90,"UK æ›¸è¾¼ã¿â€¦"); await replacePlaylist(pidUK,toUris(packs.UK)); }
    if(pidUS) { progress(92,"US æ›¸è¾¼ã¿â€¦"); await replacePlaylist(pidUS,toUris(packs.US)); }
    if(pidEU) { progress(94,"EU æ›¸è¾¼ã¿â€¦"); await replacePlaylist(pidEU,toUris(packs.EU)); }
    if(pidWO) { progress(96,"WORLD æ›¸è¾¼ã¿â€¦"); await replacePlaylist(pidWO,toUris(packs.WORLD)); }
    log("âœ… æ›¸è¾¼ã¿å®Œäº†");
    _pending=null;
  }catch(e){
    log("ğŸ’¥ ERROR(resolveAndWrite): "+(e.message||e));
  }
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
$("btnConnect").onclick=startAuth;
$("btnReset").onclick=()=>{ for(const k in LS) localStorage.removeItem(LS[k]); _me=null; setStatus(); log("ğŸ§½ ãƒ­ãƒ¼ã‚«ãƒ«ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤"); };
$("btnCheck").onclick=async()=>{ try{ await refreshTokenIfNeeded(); const me=await spFetch("/v1/me","GET"); if(me) {$("status").textContent="æ¥ç¶šä¸­ï¼ˆ"+(me.display_name||me.id)+")"; log("âœ… APIç¢ºèª OK"); if(_pending) await resolveAndWrite(_pending);} else {$("status").textContent="æ¥ç¶šä¸­ï¼ˆOKï¼‰";} }catch(e){ log("âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+(e.message||e)); } };
$("fileCSV").addEventListener("change",async()=>{
  $("log").textContent=""; progress(3,"CSVèª­ã¿è¾¼ã¿â€¦");
  if(!$("fileCSV").files.length){ log("âš ï¸ CSVæœªé¸æŠ"); return; }
  csvRows=await readCSV($("fileCSV").files[0]); log("âœ… CSV: "+csvRows.length+" è¡Œ");
  progress(6,"åˆ†æé–‹å§‹â€¦");
  await runCsvOnly();
});
$("btnExportXlsx").onclick=exportXlsx; $("btnExportCsv").onclick=exportCsv;
setStatus();
log("Ready. CSVâ†’URIè§£æ±º(from_tokenç„¡/403è€æ€§)â†’å¸‚å ´â€œå„ªå…ˆâ€â†’AudioFeaturesâ†’ãƒ—ãƒªã‚»ãƒƒãƒˆåˆ¥ä¸¦ã³â†’4Ã—130ã‚’å¼·åˆ¶å……è¶³â†’æ—¢å­˜ãƒ—ãƒ¬ã‚¤ãƒªã‚¹ãƒˆã«æ›¸è¾¼ã¿ã€‚");
</script>
</body></html>
