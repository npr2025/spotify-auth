<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder â€” ã‚½ãƒ¼ã‚¹é™å®š/TDCSå³æ ¼ + ãƒãƒ¼ã‚¸ãƒ§ãƒ³é‡è¤‡OK</title>
<style>
:root{--bg:#0b1220;--fg:#cfe3ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1180px;margin:32px auto;padding:0 12px}
h1{margin:0 0 8px}
fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
label{display:block;margin:6px 0}
input[type="text"],input[type="number"],select{width:100%;max-width:760px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
input[type="file"]{margin:4px 0}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
button:disabled{opacity:.5;cursor:not-allowed}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
small.hint{color:#666}
#log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:280px}
#progWrap{position:relative;height:12px;background:#e6eaf2;border-radius:6px;overflow:hidden;margin:6px 0}
#progBar{height:100%;width:0%;background:#4a90e2;transition:width .2s ease}
#progLine{font-variant-numeric:tabular-nums;margin:4px 0 0 0;color:#333}
.hidden{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>TDCS Editions Builder â€” è‡ªå‹•ï¼ˆã‚½ãƒ¼ã‚¹é™å®š/TDCSå³æ ¼ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³é‡è¤‡OKï¼‰</h1>
<p id="status">æœªæ¥ç¶š</p>
<div>
  <button id="btnConnect">Spotifyã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
  <button id="btnReset">åˆæœŸåŒ–ï¼ˆä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼‰</button>
  <button id="btnCheck">æ¥ç¶šãƒã‚§ãƒƒã‚¯</button>
</div>

<fieldset>
  <legend>å›ºå®š</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" value="1fd6350fcf4945a0b3ddffa2d5730d4e" disabled></label>
    <label>REDIRECT_URI <input type="text" value="https://npr2025.github.io/spotify-auth/callback.html" disabled></label>
  </div>
</fieldset>

<fieldset>
  <legend>è¨­å®šï¼ˆ4ãƒªã‚¹ãƒˆï¼‰</legend>
  <div class="grid2">
    <label>UK <input id="plUK" type="text" value="https://open.spotify.com/playlist/6wrsoYUr3IagrMW7zlwaIS"></label>
    <label>US <input id="plUS" type="text" value="https://open.spotify.com/playlist/6pv3J4odtKELYRIwoiZHhe"></label>
    <label>EU <input id="plEU" type="text" value="https://open.spotify.com/playlist/4VadrmkpMeXK813mkhWGwV"></label>
    <label>WORLD <input id="plWORLD" type="text" value="https://open.spotify.com/playlist/5y1UWtrBjYjHpReuAsnFMR"></label>
  </div>
  <div class="grid3">
    <label>APIé–“éš”(ms) <input id="gap" type="number" value="1100"></label>
    <label>å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å‡ºåŠ›æ•° <input id="finalN" type="number" value="130"></label>
    <label>äººæ°—ã®é‡ã¿ï¼ˆSaveRateå´ï¼‰<input id="wPopularity" type="number" step="0.01" value="0.55"></label>
  </div>
  <div class="grid3">
    <label>UKãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetUK"><option>waves</option><option selected>rise</option><option>drop</option><option>dj</option></select>
    </label>
    <label>USãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetUS"><option selected>rise</option><option>waves</option><option>drop</option><option>dj</option></select>
    </label>
    <label>EUãƒ—ãƒªã‚»ãƒƒãƒˆ
      <select id="presetEU"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
  </div>

  <label>ä¸»è¦ãƒãƒ¼ã‚±ãƒƒãƒˆï¼ˆå„ªå…ˆé †ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰<input id="markets" type="text" value="AU,NZ,US,GB,ES,NL"></label>
  <small class="hint">ä¾‹: AU,NZ,US,GB,ES,NLï¼ˆå·¦ã»ã©å„ªå…ˆï¼‰ã€‚</small>

  <div class="grid3">
    <label>åŒãƒªãƒŸã‚­ã‚µãƒ¼æœ€å°é–“éš”ï¼ˆæ›²ï¼‰<input id="gapRemixer" type="number" value="2"></label>
    <label>åŒã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæœ€å°é–“éš”ï¼ˆæ›²ï¼‰<input id="gapArtist" type="number" value="3"></label>
    <label><input id="appendDate" type="checkbox" checked> æ–°è¦åã«æ—¥ä»˜ï¼ˆYYYY-MM-DDï¼‰</label>
  </div>

  <div>
    <label><input id="fastMode" type="checkbox" checked> é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¤œç´¢ãƒãƒ¼ã‚±ãƒƒãƒˆæœ€å°åŒ–ï¼æ—©æœŸçµ‚äº†ï¼‰</label>
  </div>

  <div>
    <label><input id="sourceOnly" type="checkbox" checked> ã‚½ãƒ¼ã‚¹å¤–è£œå……ã‚’ç¦æ­¢ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è¡Œã ã‘ï¼‰</label>
    <label><input id="strictTDCS" type="checkbox" checked> TDCSå³æ ¼ï¼ˆartist.id å®Œå…¨ä¸€è‡´ã®ã¿ï¼‰</label>
  </div>

  <div>
    <label><input id="allowVersionDup" type="checkbox" checked> ãƒãƒ¼ã‚¸ãƒ§ãƒ³é‡è¤‡ã‚’è¨±å¯ï¼ˆåŒä¸€ISRC/ãƒ™ãƒ¼ã‚¹åã§ã‚‚åˆ¥æ‰±ã„ï¼‰</label>
    <label><input id="allowCrossDupIfShort" type="checkbox" checked> ä¸è¶³æ™‚ã¯ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³é–“ã®é‡è¤‡ã‚’è¨±å¯ï¼ˆURIã¯å„ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å†…ã§ä¸€æ„ï¼‰</label>
  </div>

  <div>
    <label><input id="doUpdate" type="checkbox" checked> æ—¢å­˜4ãƒªã‚¹ãƒˆã‚’ä¸Šæ›¸ã</label>
    <label><input id="doCreate" type="checkbox"> åŒå†…å®¹ã§æ–°è¦4ãƒªã‚¹ãƒˆã‚‚ä½œæˆï¼ˆå…¬é–‹ï¼‰</label>
    <label>æ–°è¦ãƒªã‚¹ãƒˆåã®æ¥é ­è¾ <input id="newPrefix" type="text" value="TDCS Editions"></label>
  </div>

  <small class="hint">â€»ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å†…ã¯ã€ŒåŒã˜URIã ã‘ã€é‡è¤‡ç¦æ­¢ã€‚<br>â€»ãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ï¼ˆradio/extended/remixç­‰ï¼‰ãƒ»ISRCåŒä¸€ãƒ»ãƒ™ãƒ¼ã‚¹æ›²ååŒä¸€ã§ã‚‚æ¡ç”¨ã—ã¾ã™ã€‚</small>
</fieldset>

<fieldset>
  <legend>ãƒ•ã‚¡ã‚¤ãƒ«</legend>
  <label>ã‚½ãƒ¼ã‚¹CSVï¼ˆå¿…é ˆï¼‰<input id="fileSource" type="file" accept=".csv"></label>
  <label>åˆ†æï¼ˆExcel .xlsx / CSVï¼‰<input id="fileAnalytics" type="file" accept=".xlsx,.csv"></label>
  <small class="hint">åˆ—ã¯è‡ªå‹•æ¤œå‡ºã€‚Exactâ†’Fuzzyâ†’Spotifyæ¤œç´¢ã€‚<b>ã‚½ãƒ¼ã‚¹å¤–è£œå……ã¯ã‚ªãƒ•å›ºå®š</b>ï¼ˆã“ã®ç”»é¢ã§ã¯ä½¿ã„ã¾ã›ã‚“ï¼‰ã€‚</small>
</fieldset>

<fieldset>
  <legend>é€²æ—</legend>
  <div id="progWrap" class="hidden"><div id="progBar"></div></div>
  <div id="progLine">0% â€” å¾…æ©Ÿä¸­</div>
</fieldset>

<fieldset>
  <legend>ãƒ­ã‚°</legend>
  <pre id="log">Bootingâ€¦</pre>
</fieldset>

<div>
  <button id="btnExportXlsx" disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆXLSXï¼‰</button>
  <button id="btnExportCsv"  disabled>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSVï¼‰</button>
</div>

<script>
/* ====== ä¾‹å¤– ====== */
window.onerror=(m,src,lin,col,err)=>{ const el=document.getElementById("log"); el.textContent+=(el.textContent?"\n":"")+"ğŸ’¥ ScriptError: "+m+" @"+lin+":"+col; console.error(err||m); };
window.addEventListener("unhandledrejection",(e)=>{ const el=document.getElementById("log"); el.textContent+=(el.textContent?"\n":"")+"ğŸ’¥ PromiseRejection: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)); console.error(e.reason); });

/* ====== å›ºå®š ====== */
const FORCED_ARTIST_IDS=["55fvQ5I2IZUfcFT2DV02T3"]; // The Darrow Chem Syndicate
const zws=/[\u200B-\u200D\uFEFF]/g;
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e".replace(zws,"").trim();
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html".replace(zws,"").trim();
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};

/* ====== DOM/UTIL ====== */
const $=(id)=>document.getElementById(id);
const log=(s)=>{const el=$("log"); el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight;}
const progress=(p,msg)=>{ $("progWrap").classList.remove("hidden"); $("progBar").style.width=Math.max(0,Math.min(100,p))+"%"; if(msg) $("progLine").textContent=Math.round(p)+"% â€” "+msg; }
const subProgress=(i,t,s,e,l)=>{ const f=t?i/t:0; progress(s+(e-s)*f,`${l} (${i}/${t})`); }
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
const num=(x)=>{const s=String(x==null?0:x).replace(/[ %,ï¼Œ]/g,""); const v=parseFloat(s); return isFinite(v)?v:0;}
const round4=(x)=> (typeof x==="number"&&isFinite(x))?Math.round(x*10000)/10000:"";

/* ====== Auth ====== */
const isAuthed=()=> !!localStorage.getItem(LS.acc) && Date.now() < (+localStorage.getItem(LS.exp)||0)-5000;
function setStatus(){ $("status").textContent=isAuthed()?"æ¥ç¶šä¸­ï¼ˆOKï¼‰":"æœªæ¥ç¶š"; if(isAuthed() && _pending) resolveAndWrite(_pending); }
async function startAuth(){
  let v=""; const u8=new Uint8Array(64); crypto.getRandomValues(u8); for(let i=0;i<u8.length;i++) v+=String.fromCharCode(97+(u8[i]%26));
  localStorage.setItem(LS.ver,v);
  const h=new Uint8Array(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v)));
  let b=""; for(const x of h) b+=String.fromCharCode(x);
  const ch=btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code"); u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256"); u.searchParams.set("code_challenge",ch);
  u.searchParams.set("scope",SCOPES);
  location.href=u.toString();
}
async function refreshTokenIfNeeded(){
  const exp=+(localStorage.getItem(LS.exp)||0);
  if(Date.now()<exp-5000) return;
  const rt=localStorage.getItem(LS.ref); if(!rt) return;
  const body=new URLSearchParams(); body.set("grant_type","refresh_token"); body.set("refresh_token",rt); body.set("client_id",CLIENT_ID);
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!r.ok){ log("âš ï¸ refreshå¤±æ•— "+r.status); return; }
  const j=await r.json();
  localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}
async function spFetch(path,method="GET",body=null){
  await refreshTokenIfNeeded();
  const gap=+($("gap").value||1100); await sleep(gap);
  for(let a=0;a<5;a++){
    const init={method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
    if(body) init.body=JSON.stringify(body);
    const r=await fetch("https://api.spotify.com"+path,init);
    if(r.status===401){ await refreshTokenIfNeeded(); continue; }
    if(r.status===429){ const ra=+(r.headers.get("Retry-After")||2); log("â³429â†’"+ra+"så¾…æ©Ÿ"); await sleep(ra*1000); continue; }
    if(!r.ok){
      const t=await r.text();
      if(r.status===403 && method==="GET"){ log(`âš ï¸ 403 GET ${path.slice(0,60)} â€¦ ç¶šè¡Œ`); return null; }
      throw new Error(`Spotify ${r.status}: ${(t||"").slice(0,200)} @ ${path}`);
    }
    if(r.status===204) return null;
    return await r.json();
  }
  throw new Error("Spotify API max retries");
}
let _me=null; async function getMe(){ if(_me) return _me; _me=await spFetch("/v1/me","GET"); return _me; }

/* ====== ãƒãƒ¼ã‚±ãƒƒãƒˆ ====== */
function getMarkets(){
  const raw=($("markets")?.value||"").toUpperCase();
  const arr=raw.split(",").map(s=>s.trim()).filter(Boolean);
  const out=arr.length?arr:["AU","NZ","US","GB","ES","NL"];
  return Array.from(new Set(out));
}

/* ====== ãƒ•ã‚¡ã‚¤ãƒ« ====== */
let sourceRows=[], analyticsRows=[];
function readCSV(file){return new Promise((res,rej)=>Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej}));}
async function readXLSX_allSheets(file){
  const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:"array"}); let rows=[],details=[];
  for(const n of wb.SheetNames){ const js=XLSX.utils.sheet_to_json(wb.Sheets[n],{defval:""}); for(const r of js) r.__sheet=n; rows=rows.concat(js); details.push(n+":"+js.length); }
  return {rows,details};
}
async function loadFiles(){
  $("log").textContent=""; progress(3,"ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿â€¦");
  if(!$("fileSource").files.length){ log("âš ï¸ ã‚½ãƒ¼ã‚¹CSVã¯å¿…é ˆã§ã™"); progress(100,"ã‚¨ãƒ©ãƒ¼"); return; }
  sourceRows=await readCSV($("fileSource").files[0]); log("âœ… ã‚½ãƒ¼ã‚¹: "+sourceRows.length+" è¡Œ");
  const f=$("fileAnalytics").files[0];
  if(!f){ log("â„¹ï¸ åˆ†æãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠï¼ˆã‚¹ã‚³ã‚¢ãªã—ã§ã‚‚ç¶šè¡Œï¼‰"); analyticsRows=[]; progress(8,"èª­ã¿è¾¼ã¿å®Œäº†"); await runAnalysis(); return; }
  if((f.name||"").toLowerCase().endsWith(".xlsx")){ const r=await readXLSX_allSheets(f); analyticsRows=r.rows; log("âœ… åˆ†æ: XLSX åˆè¨ˆ "+analyticsRows.length+" è¡Œ ["+r.details.join(", ")+"]"); }
  else{ analyticsRows=await readCSV(f); log("âœ… åˆ†æ: CSV "+analyticsRows.length+" è¡Œ"); }
  progress(8,"èª­ã¿è¾¼ã¿å®Œäº†"); await runAnalysis();
}

/* ====== æ­£è¦åŒ–ãƒ»åˆ—æ¨å®šãªã©ï¼ˆç•¥è¨˜ï¼šå®Ÿè£…ã¯å‰ç‰ˆã¨åŒç­‰ï¼‰ ====== */
const ISRC_RE=/^[A-Z]{2}-?[A-Z0-9]{3}-?\d{2}-?\d{5}$/i;
const NFKC=(s)=>String(s||"").normalize("NFKC");
const rmMarks=(s)=>NFKC(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"");
const norm=(s)=>rmMarks(s).toLowerCase().replace(/[â€-â€’â€“â€”âˆ’]/g,"-").replace(/[â€˜â€™â€šâ€›â€œâ€â€â€Ÿ"]/g," ").replace(/[()ï¼»ï¼½\[\]{}ã€ã€‘]/g," ").replace(/&/g," and ").replace(/\s+/g," ").trim();
const tokensTitle=(s)=>{s=norm(s).replace(/ - /g," ").replace(/\((.*?)\)/g," $1 ").replace(/\[(.*?)\]/g," $1 "); const arr=s.split(" "); const stop=new Set(["feat","featuring","ft","vs","and","&","the","a","an","mix","remix","edit","version","vip","dub","club","radio","extended","original","instrumental","clean","dirty"]); const set={},out=[]; for(const w of arr){ if(w && !stop.has(w)){ if(!set[w]){set[w]=1;out.push(w);} } } return out; }
function setJaccard(A,B){let inter=0,sa={},sb={}; A.forEach(x=>sa[x]=1); B.forEach(x=>sb[x]=1); for(const x in sa){ if(sb[x]) inter++; } const ua=Object.keys(sa).length+Object.keys(sb).length-inter; return ua?inter/ua:0; }
function canonVersion(s){
  s=norm(s); const pairs=[["original mix","original"],["orig mix","original"],["radio edit","radio"],["extended mix","extended"],["club mix","club"]];
  pairs.forEach(([a,b])=>s=s.replace(a,b));
  const kinds=[],seen={}; const add=k=>{if(k&&!seen[k]){kinds.push(k);seen[k]=1;}}
  if(/original/.test(s))add("original"); if(/radio/.test(s))add("radio"); if(/extended/.test(s))add("extended");
  if(/instrumental/.test(s))add("instrumental"); if(/acoustic/.test(s))add("acoustic"); if(/vip/.test(s))add("vip");
  if
