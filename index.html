<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TDCS Editions Builder — BUILD v10.22</title>
<style>
:root{--bg:#0b1220;--fg:#cfe3ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1180px;margin:32px auto;padding:0 12px}
h1{margin:0 0 8px}
.badge{display:inline-block;margin-left:8px;padding:3px 10px;border:1px solid #999;border-radius:999px;font-size:12px;background:#fff}
fieldset{border:1px solid #ddd;border-radius:10px;padding:14px;margin:14px 0}
legend{font-weight:600}
label{display:block;margin:6px 0}
input[type="text"],input[type="number"],select,textarea{width:100%;max-width:880px;padding:6px 8px;border:1px solid #ccc;border-radius:6px}
input[type="file"]{margin:4px 0}
textarea{min-height:96px}
button{padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
button:disabled{opacity:.5;cursor:not-allowed}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
small.hint{color:#666}
#log{white-space:pre-wrap;background:var(--bg);color:var(--fg);padding:12px;border-radius:8px;min-height:240px}
#progWrap{position:relative;height:12px;background:#e6eaf2;border-radius:6px;overflow:hidden;margin:6px 0}
#progBar{height:100%;width:0%;background:#4a90e2;transition:width .2s ease}
#progLine{font-variant-numeric:tabular-nums;margin:4px 0 0 0;color:#333}
.hidden{display:none}
.inline{display:inline-block;margin-right:16px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
a.btn{display:inline-block;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;color:#000;margin:6px 8px 0 0}
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<h1>TDCS Editions Builder <span class="badge" id="buildBadge">BUILD v10.22</span><span class="badge">Auth-Hardening</span><span class="badge">Latest20</span><span class="badge">Divergence++++</span></h1>
<p id="status">未接続</p>
<div>
  <button id="btnConnect">Spotifyにサインイン</button>
  <a id="aConnectS256" class="btn" href="javascript:void(0)">サインイン(S256)</a>
  <a id="aConnectPLAIN" class="btn" href="javascript:void(0)">サインイン(PLAIN直リンク)</a>
  <a id="aCopy" class="btn" href="javascript:void(0)">URLをコピー</a>
  <a id="aHard" class="btn" href="javascript:void(0)">ハードリロード</a>
  <button id="btnReset">初期化（保存トークン削除）</button>
  <button id="btnCheck">接続チェック</button>
</div>

<fieldset>
  <legend>固定</legend>
  <div class="grid2">
    <label>CLIENT_ID <input type="text" id="clientId" value="1fd6350fcf4945a0b3ddffa2d5730d4e"></label>
    <label>REDIRECT_URI <input type="text" id="redir" value="" disabled></label>
  </div>
  <small class="hint">Spotify Dashboard の Redirect URIs に <code>この欄と同じ値</code>（自動表示）を登録してください。</small>
</fieldset>

<fieldset>
  <legend>モード選択</legend>
  <label class="inline"><input type="radio" name="mode" id="modeCsv" checked> CSVモード</label>
  <label class="inline"><input type="radio" name="mode" id="modeAuto"> Autoモード</label>
</fieldset>

<fieldset id="boxCommon">
  <legend>共通設定（5エディション）</legend>
  <div class="grid4">
    <label>UK PL <input id="plUK" type="text" placeholder="空なら新規作成"></label>
    <label>US PL <input id="plUS" type="text" placeholder="空なら新規作成"></label>
    <label>EU PL <input id="plEU" type="text" placeholder="空なら新規作成"></label>
    <label>WORLD PL <input id="plWORLD" type="text" placeholder="空なら新規作成"></label>
  </div>
  <div class="grid4">
    <label>BEATPORT PL <input id="plBP" type="text" placeholder="空なら新規作成（150曲）"></label>
    <label>API間隔(ms) <input id="gap" type="number" value="1000"></label>
    <label>各エディション出力数<input id="finalN" type="number" value="130"></label>
    <label>主要マーケット（優先順）<input id="markets" type="text" value="ES,US,GB,NZ"></label>
  </div>
  <div class="grid4">
    <label>UKプリセット
      <select id="presetUK"><option selected>waves</option><option>rise</option><option>drop</option><option>dj</option></select>
    </label>
    <label>USプリセット
      <select id="presetUS"><option>waves</option><option selected>rise</option><option>drop</option><option>dj</option></select>
    </label>
    <label>EUプリセット
      <select id="presetEU"><option>waves</option><option>rise</option><option selected>drop</option><option>dj</option></select>
    </label>
    <label>WORLDプリセット
      <select id="presetWORLD"><option>waves</option><option>rise</option><option>drop</option><option selected>dj</option></select>
    </label>
  </div>
  <div class="grid3">
    <label>BEATPORTプリセット
      <select id="presetBP"><option selected>bp</option><option>drop</option><option>dj</option></select>
    </label>
    <label>Beatport追加曲数<input id="bpExtra" type="number" value="20" min="0" max="50"></label>
    <label>公開可否
      <select id="pub"><option value="0" selected>非公開</option><option value="1">公開</option></select>
    </label>
  </div>
  <label><input id="strictMarket" type="checkbox" checked> 市場一致を「優先採用」</label>
  <label><input id="allowCrossDup" type="checkbox"> 版間重複を許可</label>
  <label><input id="allowWithinDup" type="checkbox"> 版内重複を許可</label>
  <div class="grid3">
    <label>差別化レベル
      <select id="diverge"><option value="high" selected>HIGH</option><option value="medium">MEDIUM</option><option value="low">LOW</option></select>
    </label>
    <label>新規作成ベース名 <input id="baseName" type="text" value="TDCS Editions"></label>
    <label>説明文追記 <input id="descNote" type="text" value="Auto-built (Latest20 pinned; single-first; unique; dispersion; BP+20)"></label>
  </div>
  <label><input id="excludeLP" type="checkbox"> LP(7曲以上)を候補から除外（固定20は除外対象外）</label>
</fieldset>

<fieldset id="boxIntro">
  <legend>イントロ固定（最新20）</legend>
  <div class="grid2">
    <label>テンプレPL ID/URL
      <input id="introTpl" type="text" value="https://open.spotify.com/playlist/1v9JLD4ZxaCDApz2iPKGcJ?si=9f139dac68686449">
    </label>
    <label>固定曲数(10–20)
      <input id="introLen" type="number" value="20" min="10" max="20">
    </label>
  </div>
</fieldset>

<fieldset id="boxCsv">
  <legend>CSVモード</legend>
  <label>ソースCSV <input id="fileCSV" type="file" accept=".csv"></label>
</fieldset>

<fieldset id="boxAuto" class="hidden">
  <legend>Autoモード</legend>
  <label>検索クエリ（1行1クエリ）
    <textarea id="autoQueries" class="mono">artist:"The Darrow Chem Syndicate" "drum and bass" year:1994-2016 -bootleg -"unofficial" -"DJ Mix" -"Continuous Mix" -podcast -mashup -cover -karaoke</textarea>
  </label>
  <div class="grid3">
    <label>1クエリ最大取得 <input id="autoLimit" type="number" value="60"></label>
    <label>全体最大候補数 <input id="autoCap" type="number" value="300"></label>
    <label>重複除去
      <select id="autoDedup"><option value="1" selected>する</option><option value="0">しない</option></select>
    </label>
  </div>
</fieldset>

<div>
  <button id="btnRun">ビルド実行（CSV/Auto）</button>
  <button id="btnExportXlsx" disabled>エクスポート（XLSX）</button>
  <button id="btnExportCsv"  disabled>エクスポート（CSV）</button>
</div>

<fieldset>
  <legend>進捗</legend>
  <div id="progWrap" class="hidden"><div id="progBar"></div></div>
  <div id="progLine">0% — 待機中</div>
</fieldset>

<fieldset>
  <legend>ログ</legend>
  <pre id="log">Booting…</pre>
</fieldset>

<script>
/* ===== Build / Storage Keys ===== */
const BUILD_ID="v10.22";
const DYN_REDIRECT_URI=(function(){
  try{
    var base = location.origin + location.pathname.replace(/\/[^\/]*$/, "");
    if(base.charAt(base.length-1)==="/") base=base.slice(0,-1);
    return base + "/callback.html";
  }catch(_){
    return "https://npr2025.github.io/spotify-auth/callback.html";
  }
})();
var COOKIE_PATH=(function(){ try{ return location.pathname.replace(/\/[^\/]*$/,"/"); }catch(_){ return "/spotify-auth/"; }})();

var zws=/[\u200B-\u200D\uFEFF]/g;
var LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",cid:"sp_client_id",st:"sp_state",pend:"csv_auto_pend"};
var SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";

/* ===== Tiny DOM Utils ===== */
function $(id){ return document.getElementById(id); }
function val(id,f){ var el=$(id); return (el && ("value" in el)) ? el.value : (f||""); }
function setHidden(id,on){ var el=$(id); if(!el)return; if(on) el.classList.add("hidden"); else el.classList.remove("hidden"); }
function log(s){ var el=$("log"); if(el){ el.textContent+=(el.textContent?"\n":"")+s; el.scrollTop=el.scrollHeight; } }
function progress(p,msg){ $("progWrap").classList.remove("hidden"); $("progBar").style.width=Math.max(0,Math.min(100,p))+"%"; if(msg)$("progLine").textContent=Math.round(p)+"% — "+msg; }
function subProgress(i,t,s,e,l){ var f=t?i/t:0; progress(s+(e-s)*f, (l+" ("+i+"/"+t+")")); }
function sleep(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }
function round4(x){ return (typeof x==="number" && isFinite(x)) ? Math.round(x*10000)/10000 : ""; }
function uniq(a){ return Array.from(new Set(a)); }
function nf(v,def){ return (v===undefined||v===null)?def:v; }
function downloadBlob(name,blob){ var a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },500); }

window.onerror=function(m,src,lin,col,err){ log("ScriptError: "+m+" @"+lin+":"+col); };
window.addEventListener("unhandledrejection",function(e){ try{ e.preventDefault(); }catch(_){ } log("Unhandled: "+(e && e.reason && e.reason.message ? e.reason.message : String(e.reason))); });

/* ===== Numeric sanitize ===== */
function _toHalfNum(s){ return String(s||"").replace(/[０-９]/g,function(c){return String.fromCharCode(c.charCodeAt(0)-0xFEE0);}).replace(/[^\d\.\-]/g,""); }
function numFromInput(id,def,opt){ opt=opt||{}; var n=Number(_toHalfNum(val(id,""))); if(!isFinite(n)) n=def; if(opt.min!=null && n<opt.min) n=opt.min; if(opt.max!=null && n>opt.max) n=opt.max; return Math.floor(n); }

/* ===== Status ===== */
function isAuthed(){ return !!localStorage.getItem(LS.acc) && Date.now() < ((+localStorage.getItem(LS.exp))||0)-5000; }
function setStatus(){ $("status").textContent=isAuthed()?"接続中（OK）":"未接続"; if(isAuthed()&&_pending) resolveAndWrite(_pending); }

/* ===== PKCE helpers ===== */
function setVerifier(v){
  try{localStorage.setItem(LS.ver,v);}catch(_){}
  try{sessionStorage.setItem(LS.ver,v);}catch(_){}
  try{document.cookie=LS.ver+"="+encodeURIComponent(v)+"; Max-Age=900; SameSite=Lax; Path="+COOKIE_PATH;}catch(_){}
}
function b64url(buf){ var b=""; var u8=new Uint8Array(buf); for(var i=0;i<u8.length;i++) b+=String.fromCharCode(u8[i]); return btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
function randAlpha(n){ var a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789", s=""; for(var i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)]; return s; }
function readClientId(){ var ui=(val("clientId","")||"").replace(zws,"").trim(); if(ui){ try{localStorage.setItem(LS.cid,ui);}catch(_){} } return ui || localStorage.getItem(LS.cid) || "1fd6350fcf4945a0b3ddffa2d5730d4e"; }
function makeState(cid){ var s="s2."+Date.now()+"."+cid; try{localStorage.setItem(LS.st,s);sessionStorage.setItem(LS.st,s);}catch(_){ } return s; }

/* ===== Auth URL builders ===== */
async function buildAuthURL_S256(){
  if(!(window.crypto && crypto.subtle && crypto.getRandomValues)) throw new Error("no subtle");
  var CLIENT_ID=readClientId();
  var v=""; var r=new Uint8Array(64); crypto.getRandomValues(r); for(var i=0;i<r.length;i++) v+=String.fromCharCode(97+(r[i]%26));
  setVerifier(v);
  var buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v));
  var ch=b64url(buf);
  var state=makeState(CLIENT_ID);
  var u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",DYN_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",ch);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",state);
  try{localStorage.setItem(LS.cid,CLIENT_ID);}catch(_){}
  return u.toString();
}
function buildAuthURL_PLAIN(){
  var CLIENT_ID=readClientId();
  var v=randAlpha(64); setVerifier(v);
  var state=makeState(CLIENT_ID);
  var u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("redirect_uri",DYN_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","plain");
  u.searchParams.set("code_challenge",v);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",state);
  return u.toString();
}

/* ===== クリック時生成（href不要でも動く） ===== */
async function startAuthS256(e){ if(e) e.preventDefault(); try{ location.assign(await buildAuthURL_S256()); }catch(_){ location.assign(buildAuthURL_PLAIN()); } }
function startAuthPLAIN(e){ if(e) e.preventDefault(); location.assign(buildAuthURL_PLAIN()); }
async function copyAuth(e){ if(e) e.preventDefault(); try{ var u=await buildAuthURL_S256(); await navigator.clipboard.writeText(u); }catch(_){ var up=buildAuthURL_PLAIN(); try{await navigator.clipboard.writeText(up);}catch(__){ prompt("URLをコピー",up); } } }

/* ===== Click handlers ===== */
$("btnConnect").addEventListener("click", startAuthS256);
$("aConnectS256").addEventListener("click", startAuthS256);
$("aConnectPLAIN").addEventListener("click", startAuthPLAIN);
$("aCopy").addEventListener("click", copyAuth);
$("aHard").addEventListener("click", function(e){ e.preventDefault(); location.assign("index.html?v="+BUILD_ID+"&bust="+Date.now()); });

/* ===== Token refresh + Spotify fetch ===== */
async function refreshTokenIfNeeded(){
  var exp=+(localStorage.getItem(LS.exp)||0);
  if(Date.now()<exp-5000) return;
  var CLIENT_ID=readClientId(); var rt=localStorage.getItem(LS.ref); if(!rt) return;
  var body=new URLSearchParams(); body.set("grant_type","refresh_token"); body.set("refresh_token",rt); body.set("client_id",CLIENT_ID);
  var r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body});
  if(!r.ok){ log("refresh失敗 "+r.status); return; }
  var j=await r.json();
  localStorage.setItem(LS.acc,j.access_token);
  localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
  if(j.refresh_token) localStorage.setItem(LS.ref,j.refresh_token);
}
async function spFetch(path,method,body){
  method=method||"GET";
  await refreshTokenIfNeeded();
  var gap=numFromInput("gap",1000,{min:100,max:10000}); await sleep(gap);
  for(var a=0;a<5;a++){
    var init={method:method,headers:{"Authorization":"Bearer "+localStorage.getItem(LS.acc),"Content-Type":"application/json"}};
    if(body) init.body=JSON.stringify(body);
    var r=await fetch("https://api.spotify.com"+path,init);
    if(r.status===401){ await refreshTokenIfNeeded(); continue; }
    if(r.status===429){ var ra=+(r.headers.get("Retry-After")||2); await sleep(ra*1000); continue; }
    if(!r.ok){
      var t=await r.text();
      if(r.status===403 && method==="GET"){ log("403 GET "+path.slice(0,60)+" … 続行"); return null; }
      throw new Error("Spotify "+r.status+": "+(t||"").slice(0,200)+" @ "+path);
    }
    if(r.status===204) return null;
    return await r.json();
  }
  throw new Error("Spotify API max retries");
}
var _me=null; async function getMe(){ if(_me) return _me; _me=await spFetch("/v1/me","GET"); return _me; }

/* ===== CSV helpers ===== */
var csvRows=[]; 
function readCSV(file){return new Promise(function(res,rej){Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(r){res(r.data);},error:rej});});}
var ISRC_RE=/^[A-Z]{2}-?[A-Z0-9]{3}-?\d{2}-?\d{5}$/i;
function extractTrackId(raw){var s=String(raw||"").trim(); if(!s) return ""; var m=s.match(/spotify:track:([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/open\.spotify\.com\/track\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/\/track\/([A-Za-z0-9]{22})(?:\?|$)/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
function columns(rows){var s={},out=[]; for(var i=0;i<Math.min(400,rows.length);i++){ var klist=Object.keys(rows[i]); for(var j=0;j<klist.length;j++){ var k=klist[j]; if(!s[k]){s[k]=1; out.push(k);} } } return out;}
function pickByName(cols,pref){ var L=cols.map(function(c){return [c,c.toLowerCase()]}); for(var p=0;p<pref.length;p++){var n=pref[p].toLowerCase(); var hit=L.find(function(x){return x[1]===n||x[1].indexOf(n)>=0;}); if(hit) return hit[0];} return ""; }
function guessCsvColumns(rows){
  var cols=columns(rows);
  function scId(c){var m=0,n=0; for(var i=0;i<rows.length&&i<1500;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(/spotify:track:[A-Za-z0-9]{22}/.test(v)||/open\.spotify\.com\/track\/[A-Za-z0-9]{22}/.test(v)||/^[A-Za-z0-9]{22}$/.test(v))m++;} return n?m/n:0;}
  function scIsrc(c){var m=0,n=0; for(var i=0;i<rows.length&&i<1500;i++){var v=String(rows[i][c]||""); if(!v)continue; n++; if(ISRC_RE.test(v))m++;} return n?m/n:0;}
  var idCol=""; var best=-1; for(var i=0;i<cols.length;i++){var c=cols[i]; var sc=scId(c); if(sc>best){best=sc; idCol=c;}}
  var bestIs={c:"",score:-1}; for(var i2=0;i2<cols.length;i2++){var c2=cols[i2]; var s2=scIsrc(c2); if(s2>(bestIs.score||-1)) bestIs={c:c2,score:s2};}
  var isrcCol=bestIs.c || pickByName(cols,["isrc","isrc_code"]);
  var tCol=pickByName(cols,["title","track","name","曲名","タイトル"])||cols[0];
  var vCol=pickByName(cols,["version","バージョン","mix","remix","edit"]);
  var aCol=pickByName(cols,["artist","artists","アーティスト"])||cols[0];
  return {idCol:idCol,isrcCol:isrcCol,tCol:tCol,vCol:vCol,aCol:aCol};
}

/* ===== Search helpers ===== */
var _isrcCache=new Map();
async function searchOnce(q,m,limit,offset){ limit=limit||10; offset=offset||0; var r=await spFetch("/v1/search?q="+encodeURIComponent(q)+"&type=track&limit="+limit+"&offset="+offset+"&market="+m,"GET"); return (r&&r.tracks&&r.tracks.items)?r.tracks.items:[]; }
async function searchMany(q,m,need){ need=need||60; var out=[]; var step=50; for(var off=0; off<need; off+=step){ var items=await searchOnce(q,m,Math.min(step,need-off),off); if(!items||!items.length) break; out.push.apply(out,items);} return out; }
function isrcVariants(s){ s=String(s||"").trim(); if(!s) return []; var up=s.toUpperCase(); var no=up.replace(/-/g,""); var hy=(up.indexOf("-")>=0)?up:up.replace(/^(.{2})(.{3})(.{2})(.{5})$/,"$1-$2-$3-$4"); return Array.from(new Set([up,no,hy])); }
function makeQueriesFromRow(row,cols){
  var id=cols.idCol?extractTrackId(row[cols.idCol]):""; var isrc=String(cols.isrcCol?row[cols.isrcCol]:"").trim();
  var title=(row[cols.tCol]||"").toString().trim(); var version=(cols.vCol? (row[cols.vCol]||"") : "").toString().trim(); var artist=(row[cols.aCol]||"").toString().trim();
  var q=[]; if(id) q.push({type:"id",q:id}); if(isrc && ISRC_RE.test(isrc)) { var v=isrcVariants(isrc); for(var i=0;i<v.length;i++) q.push({type:"isrc",q:"isrc:"+v[i]}); }
  if(title && artist){ var base=title.split(/\s+-\s+/)[0]; q.push({type:"field",q:'track:"'+base+'" artist:"'+artist+'"'}); if(version) q.push({type:"field",q:'track:"'+title+'" artist:"'+artist+'"'}); q.push({type:"free",q:'"'+base+'" '+artist}); }
  else if(title){ q.push({type:"free",q:title}); }
  return {q:q,isrc:isrc,id:id};
}
async function resolveOne(row,cols,markets){
  var qa=makeQueriesFromRow(row,cols); var q=qa.q, isrc=qa.isrc, id=qa.id;
  if(id) return "spotify:track:"+id;
  if(isrc){ var v=isrcVariants(isrc); for(var i=0;i<v.length;i++){ if(_isrcCache.has(v[i])) return _isrcCache.get(v[i]); } }
  for(var k=0;k<q.length;k++){ for(var m=0;m<markets.length;m++){ try{ var items=await searchOnce(q[k].q,markets[m],10,0); if(items&&items.length){ var u="spotify:track:"+items[0].id; if(isrc){ var vv=isrcVariants(isrc); for(var t=0;t<vv.length;t++) _isrcCache.set(vv[t],u); } return u; } }catch(_){}} }
  return "";
}

/* ===== Bulk detail fetch ===== */
var _lastTracksMap=new Map(), _lastAlbumsMap=new Map(), _lastFeats=new Map();
async function fetchTrackDetailsByUris(uris){
  var ids=[], map=new Map(); for(var i=0;i<uris.length;i++){ var u=uris[i]; if(u) ids.push(u.replace("spotify:track:","")); }
  for(var j=0;j<ids.length;j+=50){ var slice=ids.slice(j,j+50); if(!slice.length) continue; var r=await spFetch("/v1/tracks?ids="+slice.join(","),"GET"); var arr=(r&&r.tracks)||[]; for(var a=0;a<arr.length;a++){ var t=arr[a]; if(t&&t.id) map.set("spotify:track:"+t.id,t); } }
  _lastTracksMap=map; return map;
}
async function fetchAudioFeaturesByUris(uris){
  var ids=[], feats=new Map(); for(var i=0;i<uris.length;i++){ var u=uris[i]; if(u) ids.push(u.replace("spotify:track:","")); }
  for(var j=0;j<ids.length;j+=100){ var slice=ids.slice(j,j+100); if(!slice.length) continue; var r=await spFetch("/v1/audio-features?ids="+slice.join(","),"GET"); var arr=(r&&r.audio_features)||[]; for(var a=0;a<arr.length;a++){ var f=arr[a]; if(f&&f.id) feats.set("spotify:track:"+f.id,f); } }
  _lastFeats=feats; return feats;
}
async function fetchAlbumsForTracks(tracksMap){
  var albumIds=uniq(Array.from(tracksMap.values()).map(function(t){return t&&t.album&&t.album.id;}).filter(Boolean)); var map=new Map();
  for(var i=0;i<albumIds.length;i+=20){ var slice=albumIds.slice(i,i+20); if(!slice.length) continue; var r=await spFetch("/v1/albums?ids="+slice.join(","),"GET"); var arr=(r&&r.albums)||[]; for(var a=0;a<arr.length;a++){ var al=arr[a]; if(al&&al.id) map.set(al.id,al); } }
  _lastAlbumsMap=map; return map;
}

/* ===== Mix logic ===== */
function camelot(key,mode){ return {num:[8,3,10,5,0,7,2,9,4,11,6,1][(key||0)%12],isMinor:mode===0}; }
function keyDistance(a,b){ if(!a||!b||a.key==null||b.key==null) return 2; var A=camelot(a.key,a.mode), B=camelot(b.key,b.mode); var d=Math.abs(A.num-B.num); d=Math.min(d,12-d); var pen=d/6; if(A.isMinor!==B.isMinor) pen+=0.4; return pen; }
function nextCost(a,b,preset){
  var dTempo=(a&&b&&a.tempo&&b.tempo)?Math.min(1,Math.abs(a.tempo-b.tempo)/16):0.5;
  var dKey=keyDistance(a,b), dEner=(a&&b)?Math.abs((a.energy||0)-(b.energy||0)):0.5, dVal=(a&&b)?Math.abs((a.valence||0)-(b.valence||0)):0.5;
  if(preset==="dj")   return 0.45*dTempo+0.35*dKey+0.15*dEner+0.05*dVal;
  if(preset==="rise") return 0.35*dTempo+0.20*dKey+0.35*dEner+0.10*dVal;
  if(preset==="drop") return 0.35*dTempo+0.20*dKey+0.35*dEner+0.10*dVal;
  if(preset==="bp")   return 0.25*dTempo+0.25*dKey+0.45*dEner+0.05*dVal;
  return               0.40*dTempo+0.25*dKey+0.25*dEner+0.10*dVal;
}

/* ===== Random helpers ===== */
function seedHash(s){ var h=2166136261>>>0; for(var i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619)>>>0; } return h>>>0; }
function rng(seed){ var x=seedHash(String(seed))||1; return function(){ x^=x<<13; x^=x>>>17; x^=x<<5; return (x>>>0)/4294967296; }; }
function seededShuffle(arr, seed){ var r=rng(seed); var a=arr.slice(0); for(var i=a.length-1;i>0;i--){ var j=Math.floor(r()*(i+1)); var tmp=a[i]; a[i]=a[j]; a[j]=tmp; } return a; }

/* ===== Tail build with tiny randomness ===== */
function buildTailByPreset(prev, tail, feats, preset, editionSeed){
  tail = Array.isArray(tail) ? tail : []; if(tail.length===0) return [];
  function id8(u){ return (u||"").slice(-8); }
  var jitter = (parseInt(String(editionSeed).slice(-5),10)%997)/9970;
  if(preset==="rise"||preset==="drop"||preset==="bp"){
    var scored = tail.map(function(u){
      var f=feats.get(u)||{};
      var base=(preset==="rise")? (0.6*nf(f.energy,0.5)+0.4*(nf(f.tempo,120)/200))
                 :(preset==="drop")? (0.7*nf(f.energy,0.5)+0.3*(nf(f.tempo,120)/200))
                 : (nf(f.energy,0.5)*0.75 + (nf(f.tempo,120)/260)*0.25);
      var tie = ((parseInt(id8(u),36)%997)/997-0.5)*0.06 + jitter;
      return {u:u,score:base + tie};
    });
    scored.sort(function(a,b){ return (preset==="rise")? (a.score-b.score) : (b.score-a.score); });
    return scored.map(function(x){return x.u;});
  }
  if(preset==="dj"){
    var seq=[]; var pool=tail.slice(0); var cur=prev||pool[0];
    while(pool.length){
      var bestI=0, best=1e9;
      for(var i=0;i<pool.length;i++){
        var a=feats.get(cur)||{}, b=feats.get(pool[i])||{};
        var cost=nextCost(a,b,"dj") + ((parseInt((pool[i]||"").slice(-6),36)%89)/1000) + jitter;
        if(cost<best){ best=cost; bestI=i; }
      }
      var pick=pool.splice(bestI,1)[0]; seq.push(pick); cur=pick;
    }
    return seq;
  }
  // waves
  var withE = tail.map(function(u){ var fe=feats.get(u)||{}; return {u:u,e: nf(fe.energy,0.5)};});
  var low=withE.slice().sort(function(a,b){return a.e-b.e;}), high=withE.slice().sort(function(a,b){return b.e-a.e;});
  var snake=[]; var iL=0,iH=0; while(iL<low.length||iH<high.length){ if(iH<high.length) snake.push(high[iH++].u); if(iL<low.length) snake.push(low[iL++].u); }
  var r=editionSeed%2147483647; var x=r; var a=snake;
  for(var k=a.length-1;k>0;k--){ x=(x*48271)%2147483647; var t=Math.floor((x/2147483647)*(k+1)); var tmp=a[k]; a[k]=a[t]; a[t]=tmp; }
  return a;
}

/* ===== URI meta ===== */
var URI_META=new Map();
function normalizeRemixer(s){ s=String(s||"").trim(); if(!s) return ""; s=s.replace(/\b(original|radio|extended|club)\b.*$/i,"").trim(); return s.toLowerCase(); }
function parseRemixerFromName(name){ name=String(name||""); var pats=[/\(([^)]+?)\s+(?:re-?mix|mix|edit|version)\)/i, /-\s*([^-\(\[]+?)\s+(?:re-?mix|mix|edit|version)\b/i]; for(var p=0;p<pats.length;p++){ var re=pats[p]; var m=name.match(re); if(m){ var r=m[1].trim(); if(/original|radio|extended/i.test(r)) return ""; return r; } } return ""; }
function normLabel(s){ s=String(s||"").toLowerCase(); s=s.replace(/[.,()[\]\-]/g," ").replace(/\b(records?|recordings?|music|ltd|limited|inc|corp|company|co|the)\b/g,"").replace(/\s+/g," ").trim(); return s; }
function parseCatNo(albumName, trackName, labelName){ var S=(albumName+" "+trackName+" "+labelName).toUpperCase(); var m=S.match(/\b([A-Z]{2,5}\d{3,6}[A-Z]?)\b/); return m?m[1]:""; }
function buildUriMeta(uriList, tracksMap, albumsMap, hintRows, cols){
  var meta=new Map();
  for(var i=0;i<uriList.length;i++){
    var u=uriList[i]; var t=tracksMap.get(u);
    if(!u||!t) continue;
    var rem = (hintRows&&cols&&cols.vCol)? String((hintRows[i] && hintRows[i][cols.vCol])||"") : "";
    if(!rem) rem=parseRemixerFromName(t.name);
    rem=normalizeRemixer(rem);
    var artistId=(t.artists && t.artists[0] && t.artists[0].id) || "";
    var albumId=t.album && t.album.id || "";
    var albumObj=albumsMap.get(albumId)||{};
    var labelRaw=albumObj.label || "";
    var label=normLabel(labelRaw);
    var catNo=parseCatNo(t.album?t.album.name:"", t.name||"", labelRaw||"");
    var albumType=albumObj.album_type || "";
    var totalTracks=+(albumObj.total_tracks||0);
    meta.set(u,{remixer:rem,artistId:artistId,albumId:albumId,catalog:label,catNo:catNo,albumType:albumType,totalTracks:totalTracks});
  }
  return meta;
}

/* ===== Market / weighting ===== */
function getMarkets(){ var raw=(val("markets","")||"").toUpperCase(); var arr=raw.split(",").map(function(s){return s.trim();}).filter(Boolean); return arr.length?uniq(arr):["ES","US","GB","NZ"]; }
function marketScore(t,tags){ var mk=new Set(((t && t.available_markets)||[])); var sc=0; for(var i=0;i<tags.length;i++){ var code=tags[i][0], w=tags[i][1]; if(mk.has(code)) sc+=w; } return Math.min(sc,1); }
function gauss(x,c,w){ if(x==null) return 0.3; var z=(x-c)/w; return Math.exp(-0.5*z*z); }

function editionWeight(u,feats,tracksMap,edition){
  var f=feats.get(u)||{}, t=tracksMap.get(u)||{}; var feat=0, mkt=0;
  var meta=URI_META.get(u)||{};
  var isSingle = (meta.albumType==="single") || ((meta.totalTracks||0)<=4);
  var isLong   = (meta.totalTracks||0)>=10;
  var singleBoost = isSingle? 0.06 : 0;
  var longPenalty = isLong? -0.08 : 0;

  if(edition==="UK"){ feat=0.5*gauss(f.tempo,170,7)+0.3*gauss(f.energy,0.65,0.2)+0.2*gauss(f.valence,0.45,0.25); mkt=marketScore(t,[["GB",1]]); }
  else if(edition==="US"){ feat=0.5*gauss(f.tempo,170,6)+0.3*gauss(f.energy,0.7,0.2)+0.2*gauss(f.valence,0.6,0.25); mkt=marketScore(t,[["US",1]]); }
  else if(edition==="EU"){ feat=0.45*gauss(f.tempo,172,5)+0.4*gauss(f.energy,0.8,0.2)+0.15*gauss(f.valence,0.35,0.25)+(f.mode===0?0.08:0); mkt=marketScore(t,[["ES",0.7],["NL",0.3]]); }
  else { feat=0.5*gauss(f.tempo,170,8)+0.3*gauss(f.energy,0.7,0.25)+0.2*gauss(f.valence,0.5,0.3); mkt=marketScore(t,[["ES","US","GB","NZ"].map(function(c){return c;})]); }
  var noRemixBonus=(meta && meta.remixer)?0:0.04;

  var micro=((seedHash(u)%997)/9970);
  return 0.55*feat + 0.45*mkt + noRemixBonus + singleBoost + longPenalty + micro;
}

/* ===== profiles ===== */
var EDITION_PROFILES={
  UK:{ tempo:[166,178], energy:[0.55,0.85], valence:[0.30,0.55], danceability:[0.45,0.85], speechiness:[0.00,0.06], instrumentalness:[0.40,1.00], mode:0 },
  US:{ tempo:[168,176], energy:[0.70,0.98], valence:[0.50,0.85], danceability:[0.55,1.00], speechiness:[0.03,0.18], instrumentalness:[0.00,0.70], mode:1 },
  EU:{ tempo:[170,180], energy:[0.75,1.00], valence:[0.15,0.45], danceability:[0.45,0.85], speechiness:[0.00,0.10], instrumentalness:[0.30,1.00], mode:0 },
  WORLD:{ tempo:[160,182], energy:[0.45,0.95], valence:[0.20,0.80], danceability:[0.35,0.95] }
};

/* ===== Divergence caps ===== */
var DIV_LEVELS={
  high:{gate:1.00, artistCap:1, remixerCap:1, albumCap:1, catalogCap:3, catNoCap:1, winRem:16, winRemMax:1, winAlb:14, winAlbMax:1, winCat:12, winCatMax:2, winCatNo:16, winCatNoMax:1},
  medium:{gate:0.75, artistCap:2, remixerCap:2, albumCap:2, catalogCap:4, catNoCap:1, winRem:12, winRemMax:2, winAlb:12, winAlbMax:2, winCat:10, winCatMax:3, winCatNo:12, winCatNoMax:1},
  low:{gate:0.55, artistCap:3, remixerCap:2, albumCap:3, catalogCap:5, catNoCap:2, winRem:10, winRemMax:2, winAlb:10, winAlbMax:2, winCat:8,  winCatMax:3, winCatNo:10, winCatNoMax:2}
};

/* ===== Base pool (single-first 2:1 interleave) ===== */
function buildBasePoolSmart(allUris, pinnedSet){
  var cb=$("excludeLP"); var excludeLP = !!(cb && cb.checked);
  var keep = [];
  for(var i=0;i<allUris.length;i++){
    var u=allUris[i]; if(!u) continue;
    if(pinnedSet && pinnedSet.has(u)) { keep.push(u); continue; }
    var meta = URI_META.get(u)||{};
    if(excludeLP && (meta.totalTracks||0)>=7) continue;
    keep.push(u);
  }
  var singles = keep.filter(function(u){ var m=URI_META.get(u)||{}; return (m.albumType==="single") || ((m.totalTracks||0)<=4); });
  var others  = keep.filter(function(u){ return singles.indexOf(u)<0; });

  var used=new Set(), seq=[];
  var iS=0,iO=0;
  while(iS<singles.length || iO<others.length){
    for(var k=0;k<2 && iS<singles.length;k++){ var u1=singles[iS++]; if(u1 && !used.has(u1)){ used.add(u1); seq.push(u1);} }
    if(iO<others.length){ var u2=others[iO++]; if(u2 && !used.has(u2)){ used.add(u2); seq.push(u2);} }
  }
  return seq;
}

/* ===== No adjacency + window dispersion ===== */
function postProcessNoAdjacencyAndDispersion(fullSeq,pinnedLen,level){
  function remKey(u){ var m=URI_META.get(u)||{}; return m.remixer||""; }
  function artKey(u){ var m=URI_META.get(u)||{}; return m.artistId||""; }
  function albKey(u){ var m=URI_META.get(u)||{}; return m.albumId||""; }
  function catKey(u){ var m=URI_META.get(u)||{}; return m.catalog||""; }
  function catNoKey(u){ var m=URI_META.get(u)||{}; return m.catNo||""; }
  function deAdj(keyFn){ var swaps=0, prevKey = pinnedLen>0 ? keyFn(fullSeq[pinnedLen-1]) : ""; for(var i=pinnedLen;i<fullSeq.length;i++){ var k=keyFn(fullSeq[i]); if(prevKey && k && k===prevKey){ var j=i+1; while(j<fullSeq.length && keyFn(fullSeq[j])===k) j++; if(j<fullSeq.length){ var tmp=fullSeq[i]; fullSeq[i]=fullSeq[j]; fullSeq[j]=tmp; swaps++; } } prevKey = keyFn(fullSeq[i]); } return swaps; }
  function winDisp(keyFn,ws,max){ var swaps=0; for(var i=pinnedLen;i<fullSeq.length;i++){ var k=keyFn(fullSeq[i]); if(!k) continue; var a=Math.max(pinnedLen, i-ws+1), b=i-1; var c=0; for(var p=a;p<=b;p++) if(keyFn(fullSeq[p])===k) c++; if(c>=max){ var j=i+1; while(j<fullSeq.length && keyFn(fullSeq[j])===k) j++; if(j<fullSeq.length){ var tmp=fullSeq[i]; fullSeq[i]=fullSeq[j]; fullSeq[j]=tmp; swaps++; } } } return swaps; }
  var s1=deAdj(remKey), s2=deAdj(artKey), s3=deAdj(albKey), s4=deAdj(catKey), s5=deAdj(catNoKey);
  var dA=winDisp(albKey,level.winAlb,level.winAlbMax);
  var dC=winDisp(catKey,level.winCat,level.winCatMax);
  var d1=winDisp(remKey,level.winRem,level.winRemMax), d2=winDisp(catNoKey,level.winCatNo,level.winCatNoMax);
  return {remix_swaps:s1, artist_swaps:s2, album_swaps:s3, catalog_swaps:s4, catno_swaps:s5, win_album_swaps:dA, win_catalog_swaps:dC, win_remix_swaps:d1, win_catno_swaps:d2};
}

/* ===== Uniqueness caps ===== */
function enforceUniqueWithin(seq,pinnedLen,primaryPool,fallbackPool,label,banSet,caps){
  seq = Array.isArray(seq) ? seq : [];
  pinnedLen = Math.max(0,Math.min(seq.length,Math.floor(pinnedLen||0)));
  var targetLen = Math.floor(seq.length||0);
  var fixed=seq.slice(0,pinnedLen);
  var tail = seq.slice(pinnedLen);
  var seen=new Set(fixed);
  var uniqTail=[];
  var cnt = {artist:new Map(), rem:new Map(), album:new Map(), catalog:new Map(), catno:new Map()};
  function meta(u){ return URI_META.get(u)||{}; }
  var cap=Object.assign({artist:99, rem:99, album:99, catalog:99, catno:99}, (caps||{}));
  var drop=0;
  function canPush(u){
    if(seen.has(u)) return false;
    if(banSet && banSet.has(u)) return false;
    var m=meta(u);
    if(m.artistId && (cnt.artist.get(m.artistId)||0)>=cap.artist) return false;
    if(m.remixer && (cnt.rem.get(m.remixer)||0)>=cap.rem) return false;
    if(m.albumId && (cnt.album.get(m.albumId)||0)>=cap.album) return false;
    if(m.catalog && (cnt.catalog.get(m.catalog)||0)>=cap.catalog) return false;
    if(m.catNo && (cnt.catno.get(m.catNo)||0)>=cap.catno) return false;
    return true;
  }
  function push(u){
    uniqTail.push(u); seen.add(u);
    var m=meta(u);
    if(m.artistId) cnt.artist.set(m.artistId,(cnt.artist.get(m.artistId)||0)+1);
    if(m.remixer)   cnt.rem.set(m.remixer,(cnt.rem.get(m.remixer)||0)+1);
    if(m.albumId)   cnt.album.set(m.albumId,(cnt.album.get(m.albumId)||0)+1);
    if(m.catalog)   cnt.catalog.set(m.catalog,(cnt.catalog.get(m.catalog)||0)+1);
    if(m.catNo)     cnt.catno.set(m.catno,(cnt.catno.get(m.catNo)||0)+1);
  }
  for(var i=0;i<tail.length;i++){ var u=tail[i]; if(canPush(u)) push(u); else drop++; }
  var want = Math.floor(tail.length);
  function refill(fromPool){ var src=Array.isArray(fromPool)?fromPool:[]; for(var i=0;i<src.length;i++){ if(uniqTail.length>=want) break; var u=src[i]; if(!u) continue; if(canPush(u)) push(u); } }
  refill(primaryPool); if(uniqTail.length<want) refill(fallbackPool);
  var result = fixed.concat(uniqTail).slice(0, targetLen);
  if(drop>0) log("内重複/上限修正 "+(label||"")+": -"+drop+"件 → 最終"+result.length);
  return result;
}

/* ===== Pinned 20 ===== */
async function fetchPlaylistNewestUris(pid,want){
  var items=[]; var off=0;
  while(true){
    var r=await spFetch("/v1/playlists/"+pid+"/tracks?limit=100&offset="+off,"GET");
    if(!r||!r.items||!r.items.length) break;
    for(var i=0;i<r.items.length;i++){ var it=r.items[i]; var t=it&&it.track; if(t && t.id && it.added_at){ items.push({u:"spotify:track:"+t.id, ts:Date.parse(it.added_at)||0}); } }
    off+=r.items.length; if(r.items.length<100) break;
  }
  items.sort(function(a,b){return b.ts-a.ts;});
  return uniq(items.map(function(x){return x.u;})).slice(0,want);
}
async function getPinnedIntroLatest20_UNCONDITIONAL(basePool,tracksMap,albums,feats){
  var want=Math.max(10,Math.min(20,+(val("introLen","20")||20)));
  var tpl=(val("introTpl","")||"").trim();
  var pool=Array.isArray(basePool)?basePool.slice(0):[];
  if(!tpl){ log("イントロ: テンプレ未指定 → ベースから採用"); return uniq(pool).slice(0,want); }
  var m=tpl.match(/playlist\/([A-Za-z0-9]{22})/)||tpl.match(/^([A-Za-z0-9]{22})$/); var pid=m?m[1]:"";
  if(!pid){ log("イントロ: プレイリストID不可 → ベースから採用"); return uniq(pool).slice(0,want); }
  var newest=await fetchPlaylistNewestUris(pid,want*3);
  var pinned=uniq(newest).slice(0,want);
  var notInBase=pinned.filter(function(u){return pool.indexOf(u)<0;});
  if(notInBase.length){
    var t2=await fetchTrackDetailsByUris(notInBase);
    t2.forEach(function(v,k){ _lastTracksMap.set(k,v); });
    var a2=await fetchAlbumsForTracks(t2);
    a2.forEach(function(v,k){ _lastAlbumsMap.set(k,v); });
    var f2=await fetchAudioFeaturesByUris(notInBase);
    f2.forEach(function(v,k){ _lastFeats.set(k,v); });
  }
  log("最新固定 "+pinned.length+"曲（無条件採用）");
  return pinned.slice(0,want);
}

/* ===== Edition builders ===== */
function fitsProfile(feat,prof,gate){
  if(!feat) return false;
  function _in(x,range,g){ if(x==null) return false; var a=range[0], b=range[1]; var c=(a+b)/2,w=(b-a)/2; var W=w*(1/Math.max(g,0.01)); return x>=c-W && x<=c+W; }
  var okTempo=prof.tempo? _in(feat.tempo,prof.tempo,gate):true;
  var okEner =prof.energy? _in(feat.energy,prof.energy,gate):true;
  var okVal  =prof.valence?_in(feat.valence,prof.valence,gate):true;
  var okDance=prof.danceability?_in(feat.danceability,prof.danceability,gate):true;
  var okSpeech=prof.speechiness?_in(feat.speechiness,prof.speechiness,gate):true;
  var okInstr=prof.instrumentalness?_in(feat.instrumentalness,prof.instrumentalness,gate):true;
  var okMode=(typeof prof.mode==="number")?(gate>=0.9?(feat.mode===prof.mode):true):true;
  return okTempo && okEner && okVal && okDance && okSpeech && okInstr && okMode;
}

function makeEditionPacksFallback(baseUris,feats,pinned,tracksMap){
  var N=Math.floor(val("finalN","130")||130); var P=Math.min(pinned.length,N);
  var fixed=pinned.slice(0,P); var tailN=Math.max(0,N-P);
  var remain=baseUris.filter(function(u){return fixed.indexOf(u)<0;});
  var timeSeed=Math.floor(Date.now()/60000);
  var seeds={UK:11+timeSeed,US:22+timeSeed,EU:33+timeSeed,WORLD:44+timeSeed};
  function build(ed){ var shuffled=seededShuffle(remain,seeds[ed]); var tail=buildTailByPreset(fixed[fixed.length-1]||shuffled[0], shuffled, _lastFeats, val("preset"+ed,"waves"), seeds[ed]).slice(0,tailN); return fixed.concat(tail); }
  return {UK:build("UK"),US:build("US"),EU:build("EU"),WORLD:build("WORLD")};
}

function makeEditionPacksV3(baseUris,feats,pinned,tracksMap){
  try{
    baseUris=Array.isArray(baseUris)?baseUris:[]; feats=(feats instanceof Map)?feats:new Map(); tracksMap=(tracksMap instanceof Map)?tracksMap:new Map(); pinned=Array.isArray(pinned)?pinned:[];
    var N=Math.floor(val("finalN","130")||130); var P=Math.min(pinned.length,N); var fixed=pinned.slice(0,P);
    var tailN=Math.max(0,N-P);
    var withinDupAllowed=!!( $("allowWithinDup") && $("allowWithinDup").checked ); var allowCrossDup=!!( $("allowCrossDup") && $("allowCrossDup").checked );
    var pinnedSet=new Set(fixed); var remainder=baseUris.filter(function(u){return typeof u==="string" && u && !pinnedSet.has(u);}); if(!allowCrossDup) remainder=[].concat(Array.from(new Set(remainder)));

    var GLOBAL_SEEN = {uri:new Set(), catno:new Set()};
    var buckets=[[],[],[],[]]; for(var i=0;i<remainder.length;i++){ var u=remainder[i]; buckets[seedHash(u)%4].push(u); }
    var mapEd={UK:0,US:1,EU:2,WORLD:3};
    var timeSeed=Math.floor(Date.now()/60000);
    var sigSeeds={UK:101+timeSeed,US:202+timeSeed,EU:303+timeSeed,WORLD:404+timeSeed};
    var dv=$("diverge"); var diverge=(dv&&dv.value)||"high"; var level=DIV_LEVELS[diverge]||DIV_LEVELS.high; var packs={}, usedGlobal=new Set();

    function canFollow(u,prev){
      if(!prev) return true;
      var m=URI_META.get(u)||{}, p=URI_META.get(prev)||{};
      if(m.catNo && p.catNo && m.catNo===p.catNo) return false;
      if(m.albumId && p.albumId && m.albumId===p.albumId) return false;
      if(m.catalog && p.catalog && m.catalog===p.catalog) return false;
      return true;
    }

    function pickByProfile(home,others,edition){
      home=Array.isArray(home)?home:[]; others=Array.isArray(others)?others:[]; var prof=EDITION_PROFILES[edition]||{};
      var gates=[level.gate, Math.max(0.01,level.gate*0.85), Math.max(0.01,level.gate*0.70), Math.max(0.01,level.gate*0.55), Math.max(0.01,level.gate*0.40), 0.30, 0.20];
      var pools=[home,others]; var out=[], artistCount=new Map(), remCount=new Map(), albumCount=new Map(), catalogCount=new Map(), catNoCount=new Map();

      function stratified(cand,seed){
        var rr=rng(seed); var low=[],mid=[],high=[];
        for(var i=0;i<cand.length;i++){ var u=cand[i]; var e=nf((feats.get(u)||{}).energy,0.5); if(e<0.45) low.push(u); else if(e<0.7) mid.push(u); else high.push(u); }
        var mix=[]; var li=0,mi=0,hi=0; while(li<low.length||mi<mid.length||hi<high.length){
          if(hi<high.length && rr()>0.3) mix.push(high[hi++]);
          if(mi<mid.length) mix.push(mid[mi++]);
          if(li<low.length && rr()>0.2) mix.push(low[li++]);
        }
        return mix;
      }

      function pushIf(u,strictCap,prevU){
        strictCap = (strictCap!==false);
        if(!u||out.length>=tailN) return false; 
        if(!allowCrossDup && usedGlobal.has(u)) return false; 
        if(out.indexOf(u)>=0) return false;

        var m=URI_META.get(u)||{};
        // 版間 catNo ブロック（緩和まで）
        if(strictCap && !allowCrossDup && m.catNo && GLOBAL_SEEN.catno.has(m.catNo)) return false;

        // 直前連続の禁止
        var prev=prevU || (out.length? out[out.length-1] : (fixed.length? fixed[fixed.length-1] : null));
        if(strictCap && !canFollow(u,prev)) return false;

        if(strictCap){
          if(m.artistId&&(artistCount.get(m.artistId)||0)>= (level.artistCap||1)) return false;
          if(m.remixer&&(remCount.get(m.remixer)||0)>= (level.remixerCap||1)) return false;
          if(m.albumId&&(albumCount.get(m.albumId)||0)>= (level.albumCap||1)) return false;
          if(m.catalog&&(catalogCount.get(m.catalog)||0)>= (level.catalogCap||3)) return false;
          if(m.catNo&&(catNoCount.get(m.catNo)||0)>= (level.catNoCap||1)) return false;
        }
        out.push(u); 
        if(!allowCrossDup) usedGlobal.add(u);
        if(m.catNo) GLOBAL_SEEN.catno.add(m.catNo);
        if(m.artistId) artistCount.set(m.artistId,(artistCount.get(m.artistId)||0)+1);
        if(m.remixer)  remCount.set(m.remixer,(remCount.get(m.remixer)||0)+1);
        if(m.albumId)  albumCount.set(m.albumId,(albumCount.get(m.albumId)||0)+1);
        if(m.catalog)  catalogCount.set(m.catalog,(catalogCount.get(m.catalog)||0)+1);
        if(m.catNo)    catNoCount.set(m.catNo,(catNoCount.get(m.catNo)||0)+1);
        return true;
      }

      for(var g=0; g<gates.length; g++){
        for(var pi=0; pi<pools.length; pi++){
          var pool=pools[pi];
          var cand0=pool.filter(function(u){return fitsProfile(feats.get(u),prof,gates[g]);});
          cand0.sort(function(a,b){return editionWeight(b,feats,tracksMap,edition)-editionWeight(a,feats,tracksMap,edition);});
          var cand=stratified(cand0, sigSeeds[edition] + g*17 + pi*7);
          var idx=0;
          while(idx<cand.length && out.length<tailN){
            var u=cand[idx];
            if(pushIf(u,true,null)){ idx++; continue; }
            // 先読み6で連続/上限を回避できる後続を探す
            var placed=false;
            for(var look=1; look<=6 && idx+look<cand.length; look++){
              var v=cand[idx+look];
              var prev=out.length? out[out.length-1] : (fixed.length? fixed[fixed.length-1] : null);
              if(pushIf(v,true,prev)){ 
                placed=true; 
                // 元のuは後でまた試す
                break;
              }
            }
            if(!placed) idx++; // 無理なら次へ
          }
          if(out.length>=tailN) break;
        }
        if(out.length>=tailN) break;
      }
      // 緩和1：strictのまま母集団広げ
      if(out.length<tailN){
        var fb=home.concat(others).filter(function(u){return out.indexOf(u)<0;});
        for(var i2=0;i2<fb.length && out.length<tailN;i2++){ pushIf(fb[i2],true,null); }
      }
      // 緩和2：版間 catNo 禁止のみ外す
      if(out.length<tailN){
        var fb2=home.concat(others).filter(function(u){return out.indexOf(u)<0;});
        for(var i3=0;i3<fb2.length && out.length<tailN;i3++){ pushIf(fb2[i3],false,null); }
      }
      return out.slice(0,tailN);
    }

    function buildOne(edition){
      var idx=mapEd[edition], seed=sigSeeds[edition]; var home=buckets[idx].slice(0); var others=remainder.filter(function(u){return home.indexOf(u)<0;});
      home.sort(function(a,b){return editionWeight(b,feats,tracksMap,edition)-editionWeight(a,feats,tracksMap,edition);});
      others.sort(function(a,b){return editionWeight(b,feats,tracksMap,edition)-editionWeight(a,feats,tracksMap,edition);});
      var tail=pickByProfile(home,others,edition);
      var prev=fixed[fixed.length-1]||tail[0];
      var orderedTail=buildTailByPreset(prev,tail,feats,val("preset"+edition,edition==="US"?"rise":edition==="EU"?"drop":edition==="WORLD"?"dj":"waves"),seed);
      var seq0=fixed.concat(orderedTail);
      if(!withinDupAllowed){
        var caps={artist:level.artistCap, rem:level.remixerCap, album:level.albumCap, catalog:level.catalogCap, catno:level.catNoCap};
        orderedTail=enforceUniqueWithin(seq0,fixed.length,home.concat(others),remainder,edition,allowCrossDup?null:new Set(),caps).slice(fixed.length);
      }
      var seq=fixed.concat(orderedTail);
      var swaps=postProcessNoAdjacencyAndDispersion(seq,fixed.length,level);
      for(var q=P;q<seq.length;q++){ var m=URI_META.get(seq[q])||{}; if(!allowCrossDup && m.catNo) GLOBAL_SEEN.catno.add(m.catNo); }
      function uniqBy(fn){ var s=new Set(); for(var i=0;i<seq.length;i++){ var k=fn(seq[i]); if(k) s.add(k); } return s.size; }
      var uAlb=uniqBy(function(u){ var m=URI_META.get(u)||{}; return m.albumId; });
      var uCat=uniqBy(function(u){ var m=URI_META.get(u)||{}; return m.catNo; });
      var uRem=uniqBy(function(u){ var m=URI_META.get(u)||{}; return m.remixer; });
      log("分散 "+edition+": albumU="+uAlb+" catNoU="+uCat+" remixerU="+uRem+" | swaps rem="+swaps.remix_swaps+"/"+swaps.win_remix_swaps+" alb="+swaps.album_swaps+"/"+swaps.win_album_swaps+" cat="+swaps.catalog_swaps+"/"+swaps.win_catalog_swaps+" catNo="+swaps.catno_swaps+"/"+swaps.win_catno_swaps);
      return seq;
    }

    var packs={}; packs.UK=buildOne("UK"); packs.US=buildOne("US"); packs.EU=buildOne("EU"); packs.WORLD=buildOne("WORLD");
    var need=Math.floor(val("finalN","130")||130);
    ["UK","US","EU","WORLD"].forEach(function(k){ if(packs[k].length>need) packs[k]=packs[k].slice(0,need); if(packs[k].length<need) packs[k]=packs[k].concat(baseUris.slice(0,need-packs[k].length)); });
    return packs;
  }catch(e){
    log("V3分配で例外 → Fallback適用: "+(e.message||e));
    return makeEditionPacksFallback(baseUris,feats,pinned,tracksMap);
  }
}

/* ===== Beatport 150 fill ===== */
function buildBeatportFromConsensus(baseUris,feats,pinned,packs4,tracksMap){
  var N=Math.floor(val("finalN","130")||130); var extra=Math.floor(val("bpExtra","20")||20); var total=N+extra; var P=Math.min(pinned.length,total);
  var fixed=pinned.slice(0,P); var tailN=total-P;

  var freq=new Map();
  ["UK","US","EU","WORLD"].forEach(function(name){ var arr=(packs4[name]||[]).slice(P); for(var i=0;i<arr.length;i++){ var u=arr[i]; freq.set(u,(freq.get(u)||0)+1); } });
  var scored=Array.from(freq.entries()).map(function(e){ var u=e[0], f=e[1]; var ft=feats.get(u)||{}; var t=tracksMap.get(u)||{}; var mk=new Set(((t&&t.available_markets)||[]));
    var mkt=0; ["ES","US","GB","NZ"].forEach(function(c){ if(mk.has(c)) mkt+=0.25; });
    var sc=f*10+nf(ft.energy,0.5)*3+nf(ft.tempo,120)/300+mkt + ((seedHash(u)%991)/9910);
    return {u:u,sc:sc};
  }).sort(function(a,b){return b.sc-a.sc;}).map(function(x){return x.u;});

  var consensus=scored.slice(0,Math.min(80,tailN));
  var used=new Set(fixed.concat(consensus));
  var rr=[], rrNames=["UK","US","EU","WORLD"]; var idx=0;
  while(rr.length < tailN && idx < 20000){
    var name = rrNames[idx % rrNames.length];
    var arr = (packs4[name]||[]).slice(P);
    for(var i=0;i<arr.length;i++){
      var u=arr[i];
      if(rr.length >= tailN) break;
      if(!used.has(u)){ rr.push(u); used.add(u); break; }
    }
    idx++; if(idx>4000) break;
  }
  if(rr.length < tailN){
    var timeSeed=Math.floor(Date.now()/60000);
    var shuffled=seededShuffle(baseUris.filter(function(u){return !used.has(u);}),505+timeSeed);
    for(var j=0;j<shuffled.length && rr.length<tailN;j++){ var u2=shuffled[j]; rr.push(u2); used.add(u2); }
  }
  var seq = fixed.concat( (consensus.concat(rr)).slice(0,tailN) );
  if(seq.length < total){
    var all = [].concat(packs4.UK,packs4.US,packs4.EU,packs4.WORLD,baseUris);
    for(var k=0;k<all.length && seq.length<total;k++){ var u3=all[k]; if(!used.has(u3)){ seq.push(u3); used.add(u3);} }
  }
  return seq.slice(0,total);
}

/* ===== Analyze pinned adjacency (log only) ===== */
function analyzePinnedAdjacency(pinned){
  function remKey(u){ var m=URI_META.get(u)||{}; return m.remixer||""; }
  function albKey(u){ var m=URI_META.get(u)||{}; return m.albumId||""; }
  function catKey(u){ var m=URI_META.get(u)||{}; return m.catalog||""; }
  function catNoKey(u){ var m=URI_META.get(u)||{}; return m.catNo||""; }
  function countAdj(fn){ var a=0; for(var i=1;i<pinned.length;i++){ if(fn(pinned[i]) && fn(pinned[i])===fn(pinned[i-1])) a++; } return a; }
  var rep={rem:countAdj(remKey), alb:countAdj(albKey), cat:countAdj(catKey), catno:countAdj(catNoKey)};
  if(rep.rem||rep.alb||rep.cat||rep.catno){ log("イントロ固定内に連打 rem="+rep.rem+" album="+rep.alb+" catalog="+rep.cat+" catNo="+rep.catno+"（固定部は順序維持）"); }
}

/* ===== Export write ===== */
var _pending=null, _exportRows=[];
function enableExportButtons(on){ $("btnExportXlsx").disabled=!on; $("btnExportCsv").disabled=!on; }

async function replacePlaylist(pid,uris){
  var chunks=[]; for(var i=0;i<uris.length;i+=100) chunks.push(uris.slice(i,i+100));
  if(!chunks.length) chunks.push([]);
  await spFetch("/v1/playlists/"+pid+"/tracks","PUT",{uris:chunks[0]}); log("置換: "+chunks[0].length+"件");
  for(var k=1;k<chunks.length;k++){ await spFetch("/v1/playlists/"+pid+"/tracks","POST",{uris:chunks[k]}); log("追加: "+chunks[k].length+"件"); }
}
function extractPlaylistId(s){ s=String(s||""); var m=s.match(/playlist\/([A-Za-z0-9]{22})/); if(m) return m[1]; m=s.match(/^([A-Za-z0-9]{22})$/); if(m) return m[1]; return ""; }
async function createPlaylistAndFill(name,desc,isPublic,uris){ var me=await getMe(); var pl=await spFetch("/v1/users/"+encodeURIComponent(me.id)+"/playlists","POST",{name:name,description:desc,public:!!isPublic}); var pid=(pl&&pl.id)?pl.id:""; await replacePlaylist(pid,uris); return pid; }
async function ensureWrite(which,uris){
  var inputId=(which==="BEATPORT")?"plBP":("pl"+which); var inputVal=val(inputId,"").trim(); var pid=extractPlaylistId(inputVal);
  var base=val("baseName","TDCS Editions").trim()||"TDCS Editions"; var descNote=val("descNote",""); var isPub=val("pub","0")==="1";
  if(pid){ await replacePlaylist(pid,uris); return pid; }
  var name=base+" ["+which+"]"; var desc=descNote+" / BUILD "+BUILD_ID+" ("+new Date().toISOString().slice(0,10)+")";
  log("新規作成: "+name); return await createPlaylistAndFill(name,desc,isPub,uris);
}

function buildExportRows(packs){
  function rowOf(u,i,ed){
    var t=_lastTracksMap.get(u)||{};
    var a=(t.artists||[]).map(function(x){return x.name}).join(", ");
    var al=(t.album||{}).name||"";
    var albId=(t.album||{}).id||"";
    var albObj=_lastAlbumsMap.get(albId)||{};
    var label=albObj.label||"";
    var meta=URI_META.get(u)||{};
    var f=_lastFeats.get(u.replace("spotify:track:","")) || _lastFeats.get(u) || {};
    return {position:i+1, edition:ed, spotify_uri:u, name:(t.name||""), artists:a, album:al, label:label, catNo:(meta.catNo||""), tempo:round4(f.tempo), energy:round4(f.energy), valence:round4(f.valence), key:(f.key==null?"":f.key), mode:(f.mode==null?"":f.mode), danceability:round4(f.danceability), speechiness:round4(f.speechiness), instrumentalness:round4(f.instrumentalness)};
  }
  var out=[];
  ["UK","US","EU","WORLD","BEATPORT"].forEach(function(ed){
    var arr=packs[ed]||[];
    for(var i=0;i<arr.length;i++){ out.push(rowOf(arr[i],i,ed)); }
  });
  return out;
}

async function exportPrepAndWrite(packs,feats){
  _exportRows=buildExportRows(packs);
  enableExportButtons(true);
  if(isAuthed()){
    progress(92,"書込み…"); await ensureWrite("UK",packs.UK);
    progress(94,"書込み…"); await ensureWrite("US",packs.US);
    progress(96,"書込み…"); await ensureWrite("EU",packs.EU);
    progress(97,"書込み…"); await ensureWrite("WORLD",packs.WORLD);
    progress(99,"書込み…"); await ensureWrite("BEATPORT",packs.BEATPORT);
    log("書込み完了（BUILD "+BUILD_ID+"）");
  }else{
    _pending=packs; log("接続待ち：『サインイン』→『接続チェック』");
  }
  progress(100,"完了");
  log("完了（連続catNo/album/catalog抑止・バリエーション強化／エクスポート可）");
}

async function resolveAndWrite(packs){
  try{
    progress(90,"書込み再開…");
    await ensureWrite("UK",packs.UK); progress(92,"書込み再開…");
    await ensureWrite("US",packs.US); progress(94,"書込み再開…");
    await ensureWrite("EU",packs.EU); progress(96,"書込み再開…");
    await ensureWrite("WORLD",packs.WORLD); progress(98,"書込み再開…");
    await ensureWrite("BEATPORT",packs.BEATPORT); log("書込み完了"); _pending=null;
  }catch(e){ log("ERROR(resolveAndWrite): "+(e.message||e)); }
}

/* ===== Export buttons ===== */
$("btnExportCsv").onclick=function(){
  if(!_exportRows.length){ log("エクスポート対象がありません"); return; }
  var csv=Papa.unparse(_exportRows,{columns:["position","edition","spotify_uri","name","artists","album","label","catNo","tempo","energy","valence","key","mode","danceability","speechiness","instrumentalness"]});
  var blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  downloadBlob("TDCS_editions_"+new Date().toISOString().slice(0,10)+".csv",blob);
  log("CSVエクスポートOK");
};
$("btnExportXlsx").onclick=function(){
  if(!_exportRows.length){ log("エクスポート対象がありません"); return; }
  function sheet(rows,ed){ var r=rows.filter(function(x){return x.edition===ed;}).map(function(x){ var y=Object.assign({},x); delete y.edition; return y; }); return XLSX.utils.json_to_sheet(r); }
  var wb=XLSX.utils.book_new();
  var eds=["UK","US","EU","WORLD","BEATPORT"];
  for(var i=0;i<eds.length;i++){
    var ed=eds[i];
    var rows=_exportRows.filter(function(r){return r.edition===ed;});
    var ws=XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb,ws,ed);
  }
  var wbout=XLSX.write(wb,{bookType:"xlsx",type:"array"});
  downloadBlob("TDCS_editions_"+new Date().toISOString().slice(0,10)+".xlsx",new Blob([wbout],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}));
  log("XLSXエクスポートOK");
};

/* ===== Runners (EXPORTED) ===== */
window.runCsvOnly = async function runCsvOnly(){
  progress(8,"CSV検出…");
  var cols=guessCsvColumns(csvRows);
  log("列: id="+cols.idCol+", isrc="+cols.isrcCol+", title="+cols.tCol+", version="+cols.vCol+", artist="+cols.aCol);
  progress(20,"URI解決…");
  var mkts=getMarkets(); var uris=[]; var ok=0;
  for(var i=0;i<csvRows.length;i++){ var u=await resolveOne(csvRows[i],cols,mkts); uris.push(u); if(u) ok++; if(((i+1)%20===0)||i+1===csvRows.length) subProgress(i+1,csvRows.length,20,48,"URI解決"); }
  log("URI解決: "+ok+"/"+csvRows.length);
  var list=uris.filter(Boolean); if(list.length===0){ throw new Error("CSVから解決できるURIがありません"); }

  progress(55,"曲詳細取得…"); var tracksMap=await fetchTrackDetailsByUris(list);
  progress(60,"アルバム取得…"); var albums=await fetchAlbumsForTracks(tracksMap);
  progress(66,"Audio Features…"); var feats=new Map(); try{ feats=await fetchAudioFeaturesByUris(list); }catch(e){ log("audio-features 取得スキップ: "+(e.message||e)); }

  URI_META=buildUriMeta(list,tracksMap,albums,csvRows,cols);

  progress(72,"固定20（無条件）…"); var pinned=await getPinnedIntroLatest20_UNCONDITIONAL(list,tracksMap,albums,feats); analyzePinnedAdjacency(pinned);
  var pinnedSet=new Set(pinned);

  var basePool=buildBasePoolSmart(list,pinnedSet);

  progress(78,"分配…");
  var packs4=null; try{ packs4=makeEditionPacksV3(basePool,feats,pinned,tracksMap); }catch(e){ log("V3分配で例外 → Fallback: "+(e.message||e)); packs4=makeEditionPacksFallback(basePool,feats,pinned,tracksMap); }
  progress(82,"Beatport版(+20) 充足…"); var packBP=buildBeatportFromConsensus(basePool,feats,pinned,packs4,tracksMap);
  progress(90,"書込み/エクスポート準備…"); await exportPrepAndWrite(Object.assign({},packs4,{ BEATPORT:packBP}),feats);
};

window.runAutoOnly = async function runAutoOnly(){
  progress(10,"検索クエリ…");
  var mkts=getMarkets(); var queries=(val("autoQueries","")||"").split(/\r?\n/).map(function(s){return s.trim();}).filter(Boolean);
  var perQ=Math.floor(val("autoLimit","60")||60); var cap=Math.floor(val("autoCap","300")||300); var doDedup=val("autoDedup","1")==="1";
  log("クエリ="+queries.length+" / 各"+perQ+" / cap="+cap+" / dedup="+doDedup);
  var pool=[];
  for(var qi=0; qi<queries.length; qi++){
    var q=queries[qi]; var got=0;
    for(var mi=0; mi<mkts.length; mi++){
      if(got>=perQ) break;
      var need=Math.min(perQ-got,100);
      var items=await searchMany(q,mkts[mi],need);
      for(var it=0; it<items.length; it++) pool.push("spotify:track:"+items[it].id);
      got+=items.length;
      if((pool.length%60)===0) subProgress(pool.length,cap,10,40,"候補取得");
      if(pool.length>=cap) break;
    }
    if(pool.length>=cap) break;
  }
  var list=doDedup?Array.from(new Set(pool)):pool; if(list.length===0) throw new Error("Autoモード：検索で候補が得られませんでした"); if(list.length>cap) list=list.slice(0,cap);

  progress(55,"曲詳細取得…"); var tracksMap=await fetchTrackDetailsByUris(list);
  progress(60,"アルバム取得…"); var albums=await fetchAlbumsForTracks(tracksMap);
  progress(66,"Audio Features…"); var feats=new Map(); try{ feats=await fetchAudioFeaturesByUris(list); }catch(e){ log("audio-features 取得スキップ: "+(e.message||e)); }

  URI_META=buildUriMeta(list,tracksMap,albums,null,null);

  progress(72,"固定20（無条件）…"); var pinned=await getPinnedIntroLatest20_UNCONDITIONAL(list,tracksMap,albums,feats); analyzePinnedAdjacency(pinned);
  var pinnedSet=new Set(pinned);
  var basePool=buildBasePoolSmart(list,pinnedSet);

  progress(78,"分配…");
  var packs4=null; try{ packs4=makeEditionPacksV3(basePool,feats,pinned,tracksMap); }catch(e){ log("V3分配で例外 → Fallback: "+(e.message||e)); packs4=makeEditionPacksFallback(basePool,feats,pinned,tracksMap); }
  progress(82,"Beatport版(+20) 充足…"); var packBP=buildBeatportFromConsensus(basePool,feats,pinned,packs4,tracksMap);
  progress(90,"書込み/エクスポート準備…"); await exportPrepAndWrite(Object.assign({},packs4,{ BEATPORT:packBP}),feats);
};

/* ===== UI bindings ===== */
$("modeCsv").onchange=function(){ setHidden("boxCsv",!$("modeCsv").checked); setHidden("boxAuto",$("modeCsv").checked); };
$("modeAuto").onchange=$("modeCsv").onchange; $("modeCsv").onchange();

$("btnReset").onclick=function(){ for(var k in LS) try{localStorage.removeItem(LS[k]);}catch(_){} _me=null; setStatus(); log("ローカルトークン削除"); };
$("btnCheck").onclick=async function(){ try{ await refreshTokenIfNeeded(); var me=await spFetch("/v1/me","GET"); if(me) {$("status").textContent="接続中（"+(me.display_name||me.id)+")"; log("API確認 OK"); if(_pending) await resolveAndWrite(_pending);} else {$("status").textContent="接続中（OK）";} }catch(e){ log("接続エラー: "+(e.message||e)); } };

$("fileCSV").addEventListener("change", async function () {
  if(!$("modeCsv").checked) return;
  $("log").textContent="";
  progress(3,"CSV読み込み…");
  if(!$("fileCSV").files.length){ log("CSV未選択"); return; }
  csvRows = await readCSV($("fileCSV").files[0]);
  log("CSV: "+csvRows.length+" 行");
  progress(6,"分析開始…");
  await window.runCsvOnly();
});

$("btnRun").onclick=async function(){
  $("log").textContent="";
  progress(1,"開始…");
  if(!isAuthed()){ $("status").textContent="未接続（サインインしてください）"; return; }
  var useCsv = $("modeCsv").checked && $("fileCSV").files.length>0;
  try{ if(useCsv){ await window.runCsvOnly(); } else { $("modeAuto").checked=true; $("modeCsv").onchange(); await window.runAutoOnly(); } }
  catch(e){ log("ERROR: "+(e.message||e)); }
};

/* ===== Boot once ===== */
document.addEventListener("DOMContentLoaded", function(){
  try{ $("buildBadge").textContent="BUILD "+BUILD_ID; }catch(_){}
  try{ $("btnConnect").disabled=false; }catch(_){}
  try{ $("aConnectS256").removeAttribute("target"); $("aConnectPLAIN").removeAttribute("target"); }catch(_){}
  try{ $("redir").value=DYN_REDIRECT_URI; }catch(_){}
  setStatus();
});
</script>
</body>
</html>
