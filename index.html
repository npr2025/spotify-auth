<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TDCS Tools — Index</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans JP';margin:2rem}
    .card{border:1px solid #ddd;border-radius:10px;padding:1rem;max-width:880px;margin:0 0 1rem}
    .row{display:flex;gap:1rem;flex-wrap:wrap;align-items:center}
    button{padding:.6rem 1rem;border-radius:8px;border:1px solid #999;background:#111;color:#fff;cursor:pointer}
    code{background:#f6f6f6;padding:.2rem .35rem;border-radius:4px}
    .muted{color:#666}.ok{color:#0a7f29}.bad{color:#b00020}
    .kv{display:grid;grid-template-columns:12rem 1fr;gap:.35rem .8rem}
    .small{font-size:.9rem}
    .warn{background:#fff7e6;border:1px solid #ffd591;padding:.5rem;border-radius:6px}
  </style>
</head>
<body>
  <div class="card">
    <h1>TDCS Tools — Home</h1>
    <div class="small muted">
      Client ID: <code>378ef0f44b36499abd10d118ddbddc98</code> /
      Redirect: <code>https://npr2025.github.io/spotify-auth/callback.html</code>
    </div>
  </div>

  <div class="card">
    <h2>接続</h2>
    <div class="row">
      <a href="./auth.html"><button>Spotifyに接続</button></a>
      <button id="clearBtn" style="background:#eee;color:#111;border-color:#bbb">保存トークン削除</button>
      <span id="authStatus" class="muted">未接続</span>
    </div>
    <p class="small muted">※ 認証成功後、<code>localStorage</code> の <code>sp_token</code> に保存します。期限切れの場合は再接続してください。</p>
    <div id="diag" class="small"></div>
  </div>

  <div class="card">
    <h2>ツール</h2>
    <ul>
      <li><a href="./index.html">監査ツール（詳細版）</a> / <a href="./fulltracks_ultra_safe_v2.html">フルトラック回収（超保守）</a></li>
      <li><a href="./auth.html">認証ページ（auth.html）</a> / <a href="./callback.html">コールバック（callback.html）</a></li>
    </ul>
  </div>

<script>
(function(){
  const statusEl = document.getElementById('authStatus');
  const diagEl = document.getElementById('diag');

  function fmt(ts){
    try{
      return new Date(ts).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' });
    }catch{ return String(ts); }
  }

  function parseHashToken(){
    // もし callback 指定じゃなく index に戻ってきた場合のフォールバック
    // 例: https://.../index.html#access_token=...&token_type=Bearer&expires_in=3600&state=...
    const h = location.hash.startsWith('#') ? location.hash.slice(1) : '';
    if(!h) return null;
    const p = new URLSearchParams(h);
    const at = p.get('access_token');
    const tt = p.get('token_type');
    const ei = p.get('expires_in');
    if(at && tt){
      const now = Date.now();
      const expires_at = now + (parseInt(ei||'3600',10)*1000) - 10_000; // 少し余裕を引く
      return { access_token: at, token_type: tt, scope: p.get('scope')||'', expires_at };
    }
    return null;
  }

  function loadToken(){
    const raw = localStorage.getItem('sp_token');
    if(!raw) return null;
    try{
      const obj = JSON.parse(raw);
      if(!obj || !obj.access_token || !obj.expires_at) return null;
      if(Date.now() >= obj.expires_at) return { ...obj, __expired: true };
      return obj;
    }catch{ return null; }
  }

  function saveToken(obj){
    try{
      localStorage.setItem('sp_token', JSON.stringify(obj));
    }catch(e){}
  }

  function showStatus(tok){
    diagEl.innerHTML = '';
    if(tok && !tok.__expired){
      statusEl.textContent = 'トークンOK（有効）';
      statusEl.className = 'ok';
      const rows = [];
      rows.push(['token_type', tok.token_type||'']);
      rows.push(['scope', tok.scope||'(none)']);
      rows.push(['expires_at', fmt(tok.expires_at)]);
      rows.push(['now', fmt(Date.now())]);
      diagEl.innerHTML = '<div class="kv">'+rows.map(r=>`<div class="muted">${r[0]}</div><div><code>${String(r[1])}</code></div>`).join('')+'</div>';
    }else if(tok && tok.__expired){
      statusEl.textContent = '未接続（保存トークンは期限切れ）';
      statusEl.className = 'bad';
      diagEl.innerHTML = '<div class="warn">保存されているトークンは期限切れです。<br>「Spotifyに接続」を押して再認証してください。</div>';
    }else{
      statusEl.textContent = '未接続';
      statusEl.className = 'bad';
      const has = !!localStorage.getItem('sp_token');
      diagEl.innerHTML =
        `<div class="warn">
          sp_token: ${has ? '<code>存在するが不正</code>' : '<code>なし</code>'}<br>
          もし <code>#access_token=...</code> がURLについていれば自動保存を試みます。
        </div>`;
    }
  }

  // 1) URLハッシュにトークンがあれば保存（フォールバック）
  const fromHash = parseHashToken();
  if(fromHash){
    saveToken(fromHash);
    // ハッシュを消して綺麗に
    history.replaceState(null, '', location.pathname + location.search);
  }

  // 2) ローカルストレージから読み、状態反映
  const tok = loadToken();
  showStatus(tok);

  // 3) クリア
  document.getElementById('clearBtn').addEventListener('click', () => {
    localStorage.removeItem('sp_token');
    showStatus(null);
  });
})();
</script>
</body>
</html>
