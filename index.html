<script>
// === HOTFIX vS-EDL-01: clickå§”ä»» + ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ + å¼·åˆ¶å®Ÿè¡Œ ===

// 1) ã‚¯ãƒªãƒƒã‚¯å§”ä»»ï¼ˆå€‹åˆ¥ã®addEventListenerãŒå¤±æ•—ã—ã¦ã‚‚æ‹¾ã†ï¼‰
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button, a.btn');
  if (!btn) return;

  // ãƒ­ã‚°å¼·åˆ¶è¡¨ç¤º
  const id = btn.id || btn.getAttribute('href') || '(no-id)';
  try { log(`â–¶ click: ${id}`); } catch(_) { /* logãŒã¾ã ç„¡ã‘ã‚Œã°ç„¡è¦– */ }

  // æ—¢å­˜ã®a.btnã®ãƒ‡ãƒ•ã‚©å‹•ä½œã¯é€šã™ï¼ˆSign inãƒªãƒ³ã‚¯ãªã©ï¼‰
  if (btn.tagName === 'A') return;

  // ãƒœã‚¿ãƒ³ã”ã¨ã®å¼·åˆ¶å®Ÿè¡Œï¼ˆæ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒ‰ãŒæ­»ã‚“ã§ã¦ã‚‚ã“ã“ã§å‹•ãï¼‰
  e.preventDefault();
  switch (btn.id) {
    case 'btnMe':
      try { const me = await callSpotifyJSON('https://api.spotify.com/v1/me', {}, {tag:'/me'}); log(`/me OK: ${me.display_name||'(no name)'} / ${me.id}`); }
      catch(err){ alert('ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'); log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnSignOut':
      try { Object.values(K).forEach(k=>sessionStorage.removeItem(k)); log('ä¿å­˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚'); renderStatus(); }
      catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnFast':
      try { await doFastBuild(); } catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnTrim':
      try { await doTrim(); } catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnBalance':
      try { await doBalance(); } catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnBuildEditions':
      try { await buildEditions(); } catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); alert('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnCommit':
      try {
        if (!window.final100 || !final100.length) { alert('â‘¢Balanced ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„'); return; }
        const name=(el('plName').value||'TDCS â€“ Breaks Remix Only 100 (2010+)').trim();
        const desc=(el('plDesc').value||'Breaks/Breakbeaté™å®šãƒ»2010+ãƒ»Remixã®ã¿ãƒ»Pinså›ºå®šãƒ»ãƒãƒ©ãƒ³ã‚¹é…ç½®').trim();
        const isPublic=el('plPublic').value==='true';
        const existing=el('existingId').value.trim()||null;
        await putPlaylist(name, desc, isPublic, final100.map(t=>`spotify:track:${t.id}`), existing);
      } catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); alert('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
    case 'btnRepair': // ä¸‹ã®(2)ã§è¿½åŠ ã™ã‚‹ç·Šæ€¥ãƒœã‚¿ãƒ³
      try {
        localStorage.removeItem('sp_build_lock_v1');
        sessionStorage.removeItem(K.access);
        sessionStorage.removeItem(K.expAt);
        sessionStorage.removeItem(K.refresh);
        sessionStorage.removeItem(K.scope);
        log('ğŸ”§ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ: ãƒ­ãƒƒã‚¯ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        renderStatus();
        alert('ãƒªã‚»ãƒƒãƒˆå®Œäº†ã€‚å¿…è¦ãªã‚‰ Sign in ã—ç›´ã—ã¦ãã ã•ã„ã€‚');
      } catch(err){ log('ã‚¨ãƒ©ãƒ¼: '+(err.message||err)); }
      break;
  }
});

// 2) ç”»é¢ã«ã€Œç·Šæ€¥ãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆè¦‹å¤±ã£ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«å‹•çš„è¿½åŠ ï¼‰
(function addRepairButton(){
  try{
    if (!document.getElementById('btnRepair')) {
      const holder = document.querySelector('fieldset legend')?.parentElement || document.body;
      const b = document.createElement('button');
      b.id = 'btnRepair'; b.textContent = 'ğŸ”§ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ­ãƒƒã‚¯/ãƒˆãƒ¼ã‚¯ãƒ³ã‚¯ãƒªã‚¢ï¼‰';
      b.style.marginLeft = '8px';
      holder.querySelector('.progress')?.appendChild(b) || holder.appendChild(b);
    }
  }catch(_){}
})();

// 3) ãƒ“ãƒ«ãƒ‰ãƒ­ãƒƒã‚¯ãŒæ®‹ã£ã¦ã„ãŸã‚‰è‡ªå‹•è§£æ”¾ï¼ˆ2åˆ†å¾…ã¡ã‚’é¿ã‘ã‚‹ï¼‰
try{
  const raw = localStorage.getItem('sp_build_lock_v1');
  if (raw) {
    const obj = JSON.parse(raw);
    const tooOld = !obj || (Date.now() - (obj.ts||0) > 30*1000); // 30ç§’ã§å¤ã„ã¨ã¿ãªã™ï¼ˆå¾“æ¥ã¯120ç§’ï¼‰
    if (tooOld) localStorage.removeItem('sp_build_lock_v1');
  }
}catch(_){}

// 4) åˆå›ã«ã€ŒDOM Readyã€ãƒ­ã‚°ã‚’å¼·åˆ¶è¡¨ç¤ºï¼ˆãƒã‚¤ãƒ³ãƒ‰ç¢ºèªç”¨ï¼‰
try{ log('âœ… HOTFIX wired: DOM ready & click-delegate active'); }catch(_){}
</script>
