<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TDCS Builder — Singles(1–4) • ArtistID lock • Primary-only • Pin @19 • Fallback Search</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
           max-width:1060px;margin:24px auto;padding:0 12px;
           background:#0b1220;color:#cfe3ff;}
    h1{margin:0 0 8px;font-size:20px;}
    fieldset{border:1px solid #22324f;border-radius:10px;margin:10px 0;padding:12px;}
    legend{padding:0 8px;color:#bcd1f5;}
    label{display:block;margin:8px 0 4px;}
    input[type="text"],input[type="number"],select{width:100%;max-width:640px;padding:9px;border-radius:8px;
      border:1px solid #2d3e60;background:#091426;color:#cfe3ff;}
    input[type="checkbox"]{transform:scale(1.05);margin-right:6px;}
    button{padding:10px 14px;border-radius:8px;border:1px solid #3a4d75;background:#14213a;color:#e9f1ff;cursor:pointer;}
    #log{white-space:pre-wrap;background:#091426;color:#d6e6ff;border:1px solid #20304a;padding:12px;
      border-radius:10px;margin-top:12px;max-height:560px;overflow:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
    .row>*{flex:1 1 auto;}
    .muted{color:#8ea6cc;}
  </style>
</head>
<body>
<h1>TDCS Builder — Singles(1–4) • ArtistID lock • Primary-only • Pin @19 • Fallback Search</h1>

<fieldset>
  <legend>Auth</legend>
  <div id="authStatus" class="muted">No token.</div>
  <div class="row" style="margin-top:8px">
    <button onclick="location.href='auth.html'">Sign in</button>
    <button id="btnSignOut">Sign out (local)</button>
  </div>
</fieldset>

<fieldset>
  <legend>Constraints</legend>
  <label>Artist IDs
    <input id="artistIds" type="text" value="55fvQ5I2IZUfcFT2DV02T3">
  </label>
  <label><input id="primaryOnly" type="checkbox" checked> Primary-artist only</label>
  <label><input id="strictSingles" type="checkbox" checked> Singles only (1–4 tracks)</label>
  <div class="row">
    <label>Pin track (URI/URL)<input id="pinUri" type="text" value="https://open.spotify.com/track/3bBCxxbNkrl1DlBlxATNVQ"></label>
    <label>Pin position<input id="pinPos" type="number" min="1" value="19"></label>
  </div>
</fieldset>

<fieldset>
  <legend>CSV</legend>
  <label>Choose CSV<input id="csvFiles" type="file" accept=".csv" multiple></label>
  <div class="row" style="margin-top:8px">
    <button id="btnBuild">Build playlists</button>
  </div>
</fieldset>

<pre id="log">Ready.</pre>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const LOG=(...a)=>{const el=document.getElementById('log');el.textContent+="\n"+a.join(' ');el.scrollTop=el.scrollHeight;}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
function token(){return sessionStorage.getItem('access_token')}
function needToken(){const t=token();if(!t)throw new Error('no_token');return t}
async function api(url,opt={}){const h=Object.assign({'Authorization':'Bearer '+needToken()},opt.headers||{});const r=await fetch(url,Object.assign({},opt,{headers:h}));
 if(r.status===429){const retry=Number(r.headers.get('Retry-After')||'2');LOG('429 wait',retry,'s');await sleep(retry*1000);return api(url,opt);}
 if(!r.ok){throw new Error('API '+r.status)}return r.json();}

// 正規化
function normTitle(s){return(s||'').toLowerCase().replace(/[‐–—−]/g,'-').replace(/[’`]/g,"'").replace(/\s+/g,' ').trim();}
function stripParens(s){return(s||'').replace(/\s*$begin:math:text$[^)]*$end:math:text$\s*/g,' ').replace(/\s+/g,' ').trim();}

function extractISRC(s){if(!s)return'';const m=String(s).match(/\b[A-Z]{2}[A-Z0-9]{3}\d{7}\b/);return m?m[0]:'';}
function normalizeRow(raw){const lower={};for(const k in raw)lower[k.toLowerCase()]=k;const pick=k=>raw[lower[k]];
 const row={};row.order=pick('order')||'';row.title=pick('title')||raw.title||'';row.remixer=pick('remixer')||'';let isrc=pick('isrc')||'';if(!isrc){isrc=extractISRC(pick('original file name')||'');}
 row.isrc=isrc;row.spotify_query=pick('spotify_query')||'';row._order=Number(row.order||0);return row;}

function buildQueries(row){
 const qs=[];const tRaw=String(row.title||'').trim();const tClean=stripParens(tRaw);const r=String(row.remixer||'').trim();
 if(row.isrc)qs.push('isrc:'+row.isrc);
 if(row.spotify_query)qs.push(row.spotify_query);
 if(tRaw)qs.push(`track:"${tRaw}" artist:"The Darrow Chem Syndicate"`);
 if(tClean&&tClean!==tRaw)qs.push(`track:"${tClean}" artist:"The Darrow Chem Syndicate"`);
 if(tRaw&&r)qs.push(`track:"${tRaw}" ${r} remix artist:"The Darrow Chem Syndicate"`);
 if(tRaw)qs.push(`${tRaw} "The Darrow Chem Syndicate"`);
 return qs;
}

function parseArtistIds(){return document.getElementById('artistIds').value.split(/[\s,]+/).map(s=>s.trim()).filter(Boolean);}
function hasArtist(track,whitelist,primaryOnly){const arts=track.artists||[];if(primaryOnly){return whitelist.includes(arts[0]?.id);}return arts.some(a=>whitelist.includes(a.id));}

const albumCache=new Map();
async function getAlbumTotalTracks(id){if(albumCache.has(id))return albumCache.get(id);const d=await api('https://api.spotify.com/v1/albums/'+id);albumCache.set(id,d.total_tracks);await sleep(40);return d.total_tracks;}

function singleCheck(track){if(track.album.album_type!=='single')return false;const tt=track.album.total_tracks;if(typeof tt==='number')return (tt>=1&&tt<=4);return 'unknown';}

async function resolveTrack(row,market,strict,whitelist,primaryOnly){
 const qs=buildQueries(row);
 for(const q of qs){
   const r=await api('https://api.spotify.com/v1/search?q='+encodeURIComponent(q)+'&type=track&limit=10&market='+market);
   let items=(r.tracks.items||[]).filter(x=>hasArtist(x,whitelist,primaryOnly));
   for(const t of items){
     const chk=singleCheck(t);
     if(chk===true)return t.uri;
     if(chk==='unknown'){const tt=await getAlbumTotalTracks(t.album.id);if(tt>=1&&tt<=4)return t.uri;}
   }
   await sleep(100);
 }
 return null;
}

function toTrackUri(s){if(!s)return null;if(String(s).startsWith('http')){const m=String(s).match(/track\/([a-zA-Z0-9]+)/);if(m)return'spotify:track:'+m[1];}return s;}

async function buildOneCSV(file,market,strict,whitelist,primaryOnly,pinUri,pinPos){
 LOG('--- CSV:',file.name,'---');const rows=await new Promise((res,rej)=>{Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>res(r.data),error:rej});});
 const norm=rows.map(normalizeRow).sort((a,b)=>a._order-b._order);LOG('rows:',norm.length);
 const uris=[];let okCount=0;
 for(let i=0;i<norm.length;i++){const r=norm[i];const uri=await resolveTrack(r,market,strict,whitelist,primaryOnly);
   if(uri){okCount++;if(okCount===pinPos){uris.push(pinUri);}uris.push(uri);LOG('[ok]',i+1,uri);}
   else{LOG('[x] not found',i+1,r.title||'');}
 }
 LOG('final len',uris.length);
 // ここでプレイリスト作成処理を追加可能
}

document.getElementById('btnBuild').onclick=async()=>{
 try{needToken();}catch(_){alert('Sign in first');return;}
 const files=[...(document.getElementById('csvFiles').files||[])];if(!files.length){alert('Choose CSV');return;}
 const strict=document.getElementById('strictSingles').checked;const primaryOnly=document.getElementById('primaryOnly').checked;
 const whitelist=parseArtistIds();const pinUri=toTrackUri(document.getElementById('pinUri').value);const pinPos=Number(document.getElementById('pinPos').value||19);
 for(const f of files){await buildOneCSV(f,'JP',strict,whitelist,primaryOnly,pinUri,pinPos);}
};

document.getElementById('btnSignOut').onclick=()=>{sessionStorage.clear();LOG('Signed out.');};
</script>
</body>
</html>
