<script>
// --- 設定 ---
const USER_ID_OVERRIDE = "22fqn5mozguuegi2t3l2zeugy"; // ←固定
const ENFORCE_UNIQUE = true; // 同一trackの重複禁止にしたいとき true

function needToken(){ const t=sessionStorage.getItem('access_token'); if(!t) throw new Error('no_token'); return t }
async function api(url,opts={}){ 
  const h=Object.assign({'Authorization':'Bearer '+needToken()},opts.headers||{});
  const r=await fetch(url,Object.assign({},opts,{headers:h}));
  if(r.status===429){ const s=Number(r.headers.get('Retry-After')||'2'); await new Promise(z=>setTimeout(z,s*1000)); return api(url,opts); }
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function me(){ return api('https://api.spotify.com/v1/me') }
async function createPlaylist(name,desc='Auto-built',isPublic=false){
  const uid = USER_ID_OVERRIDE || (await me()).id;
  return api(`https://api.spotify.com/v1/users/${encodeURIComponent(uid)}/playlists`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name, public:isPublic, description:desc})
  });
}

// ★ アルバム禁止・ISRC優先の検索
async function resolveTrackUri(row){
  const isrc = (row.isrc||'').trim();
  const title = String(row.title||row['Title (Remixer Remix)']||'').trim();
  const rem   = String(row.remixer||'').trim();

  const candidates = [];
  if (isrc) candidates.push(`isrc:${isrc}`);
  if (row.spotify_query) candidates.push(String(row.spotify_query).trim());
  // フォールバック
  candidates.push(`track:"${title}" artist:"The Darrow Chem Syndicate"`);
  if (rem) candidates.push(`track:"${title}" ${rem} remix artist:"The Darrow Chem Syndicate"`);

  for (const q of candidates){
    if(!q) continue;
    const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=5&market=from_token`;
    const res = await api(url);
    const items = (res?.tracks?.items || []).filter(x => x?.type==='track' && x?.uri?.startsWith('spotify:track:'));
    if (items.length) return items[0].uri; // トラックのみ受理（アルバムは絶対使わない）
  }
  return null;
}

// ★ CSVの全行を使う（フィルタ無し）
function useAllRows(rows){
  return rows
    .map(r => ({...r, _order: Number(r.order||0)}))
    .sort((a,b)=>a._order-b._order);
}

async function addUris(pid, uris){
  for(let i=0;i<uris.length;i+=100){
    const chunk=uris.slice(i,i+100);
    await api(`https://api.spotify.com/v1/playlists/${pid}/tracks`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({uris:chunk})
    });
  }
}

// エントリポイント（既存のPapa.parse完了後に呼んでOK）
async function buildFromRows(rows, playlistName){
  const pl = await createPlaylist(playlistName, 'All rows / Track-only (no albums)', false);
  const uris = [];
  const seen = new Set();

  for (const row of useAllRows(rows)){
    const uri = await resolveTrackUri(row);
    if (!uri) continue;
    if (ENFORCE_UNIQUE && seen.has(uri)) continue;
    seen.add(uri);
    uris.push(uri);
  }
  if(!uris.length) throw new Error('No tracks resolved');

  await addUris(pl.id, uris);
  alert('Done: '+(pl.external_urls?.spotify||'')); 
}
</script>
