<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spotify 認可リダイレクト</title>
<style>
 body{font-family:system-ui;margin:2rem}
 .ok{color:#0a7f29}.bad{color:#b00020}
</style>
</head>
<body>
<h1>Spotify 認可リダイレクト</h1>
<div id="msg">処理中…</div>
<p><a href="./fulltracks_ultra_safe_v2.html?v=20250919">戻る</a></p>

<script>
const CLIENT_ID="378ef0f44b36499abd10d118ddbddc98";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";

async function exchange(code,verifier){
  const body=new URLSearchParams({
    client_id:CLIENT_ID,grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,code_verifier:verifier
  });
  const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!res.ok)throw new Error(await res.text());
  return res.json();
}

(function(){
  const sp=new URLSearchParams(location.search);
  const code=sp.get("code"); const state=sp.get("state");
  const msgEl=document.getElementById("msg");
  if(!code){msgEl.textContent="エラー: codeなし";return;}
  const st=sessionStorage.getItem("sp_state")||localStorage.getItem("sp_state");
  if(state!==st){msgEl.textContent="エラー: state不一致";return;}
  const verifier=sessionStorage.getItem("sp_pkce_verifier")||localStorage.getItem("sp_pkce_verifier");
  if(!verifier){msgEl.textContent="エラー: verifierなし";return;}

  exchange(code,verifier).then(tok=>{
    const expires_at=Date.now()+(tok.expires_in||3600)*1000-10000;
    // scope/refresh_token は無い場合がある → 空文字で扱う
    const saved={
      access_token: tok.access_token,
      refresh_token: tok.refresh_token||"",
      token_type: tok.token_type||"Bearer",
      scope: tok.scope||"",
      expires_at
    };
    localStorage.setItem("sp_token",JSON.stringify(saved));
    sessionStorage.clear(); localStorage.removeItem("sp_pkce_verifier"); localStorage.removeItem("sp_state");
    msgEl.innerHTML="<span class=ok>認証成功</span>";
    setTimeout(()=>location.href="./fulltracks_ultra_safe_v2.html?v=20250919",800);
  }).catch(e=>{
    msgEl.innerHTML="<span class=bad>交換失敗: "+(e.message||e)+"</span>";
  });
})();
</script>
</body>
</html>
