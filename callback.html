<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Spotify Auth — Callback</title>
  <style>
    :root{color-scheme:dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b1220;color:#cfe3ff;
         max-width:820px;margin:24px auto;padding:0 12px}
    pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;border-radius:10px;padding:12px}
    a.button,button{display:inline-block;padding:10px 14px;border:1px solid #3a4d75;border-radius:8px;background:#14213a;color:#e9f1ff;text-decoration:none;margin-right:8px}
    .err{color:#ffb4b4}
    .hint{color:#ffd166}
  </style>
</head>
<body>
<h1>Finishing sign-in…</h1>
<pre id="log">Waiting for code…</pre>
<p>
  <a class="button" id="back" href="https://npr2025.github.io/builder.html">Return to app (fallback)</a>
  <button id="retry">Retry</button>
</p>
<script>
const CLIENT_ID='5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI='https://npr2025.github.io/spotify-auth/callback.html';
const TOKEN_URL='https://accounts.spotify.com/api/token';
const LOG=(...a)=>{document.getElementById('log').textContent += '\n'+a.join(' ')}

async function exchange(code, verifier){
  const res=await fetch(TOKEN_URL,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:new URLSearchParams({
      grant_type:'authorization_code',
      code,
      redirect_uri:REDIRECT_URI,
      client_id:CLIENT_ID,
      code_verifier:verifier
    })
  });
  if(!res.ok){
    const txt=await res.text();
    throw new Error('HTTP '+res.status+' '+txt);
  }
  return res.json();
}

(async()=>{
  try{
    const params=new URLSearchParams(location.search);
    const err=params.get('error');
    if(err){
      LOG('ERROR: Spotify returned error:', err);
      LOG('ヒント:\n・Dashboardの Redirect URI が完全一致か: '+REDIRECT_URI+
          '\n・Development mode の Users に自分のアカウントを追加済みか'+
          '\n・auth.html / callback.html / builder.html が https://npr2025.github.io/ 配下か');
      return;
    }
    const code=params.get('code');
    if(!code){ LOG('ERROR: code missing'); return; }

    const state=params.get('state');
    const stateSaved=localStorage.getItem('oauth_state');
    if(state && stateSaved && state!==stateSaved){
      LOG('WARN: state mismatch（続行はするが再発ならクリアしてやり直し推奨）');
    }

    LOG('Exchanging code for token…');
    const verifier=localStorage.getItem('code_verifier');
    if(!verifier){ LOG('ERROR: code_verifier not found in localStorage'); return; }

    const token=await exchange(code, verifier);
    const now=Date.now();
    const expiresAt = now + (Number(token.expires_in||3600) * 1000);

    sessionStorage.setItem('access_token', token.access_token);
    if(token.refresh_token) sessionStorage.setItem('refresh_token', token.refresh_token);
    sessionStorage.setItem('token_type', token.token_type||'Bearer');
    sessionStorage.setItem('access_token_expires_at', String(expiresAt));

    // cleanup
    localStorage.removeItem('oauth_state');
    localStorage.removeItem('code_verifier');

    LOG('OK. Token stored in sessionStorage.');

    // return
    const ret = localStorage.getItem('return_to') || 'https://npr2025.github.io/builder.html';
    LOG('Returning to:', ret);
    location.replace(ret);
  }catch(e){
    LOG('ERROR:', e.message||String(e));
    if(/\binvalid_grant\b/.test(e.message)){
      LOG('ヒント（invalid_grant）:\n・Redirect URI が完全一致か（Dashboard）\n・同一オリジンで動作しているか（github.io）\n・code_verifier が auth→callback で上書き/消去されていないか（localStorage 使用）\n・一度戻ると code は再利用できないので auth からやり直す');
    }
  }
})();

document.getElementById('retry').onclick=()=>{ location.href='auth.html'; };
document.getElementById('back').onclick=(e)=>{ /* just link */ };
</script>
</body>
</html>
