<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:36px auto;padding:0 12px}
  #log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:420px;overflow:auto;margin-top:12px}
  a.btn,button{display:inline-block;margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
</style>
</head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">コード処理中…</p>
<p>
  <a class="btn" href="./index.html">トップへ戻る</a>
  <button id="btnRetry" hidden>もう一度トークン交換</button>
</p>
<pre id="log"></pre>

<script>
"use strict";
/*** 設定（auth.htmlと一致） ***/
const CLIENT_ID    = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI = "https://npr2025.github.io/spotify-auth/callback.html";

/*** ストレージキー ***/
const KEY_VERIFIER = "pkce_verifier";
const KEY_STATE    = "pkce_state";
const KEY_CODE_USED_PREFIX = "pkce_code_used_";

/*** UIユーティリティ ***/
const $ = s => document.querySelector(s);
const log = m => { const el=$("#log"); el.textContent += m + "\n"; console.log(m); };
function setStatus(t){ $("#status").textContent = t; }

/*** URLパラメータ取得 ***/
const params = new URLSearchParams(location.search);
const code  = params.get("code");
const state = params.get("state");
const error = params.get("error");

/*** 同じcodeの再使用をブロック ***/
function isCodeUsed(code){ return sessionStorage.getItem(KEY_CODE_USED_PREFIX + code) === "1"; }
function markCodeUsed(code){ sessionStorage.setItem(KEY_CODE_USED_PREFIX + code, "1"); }

/*** 429対応：Retry-Afterを見て待機して再試行 ***/
async function postTokenWithRetry(payload, maxRetry=3){
  let attempt = 0;
  while (true){
    attempt++;
    const res = await fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(payload)
    });
    if (res.status !== 429) return res;

    const ra = parseInt(res.headers.get("Retry-After")||"1", 10);
    const waitMs = Math.min(60, (isNaN(ra)?1:ra)) * 1000;
    log(`429 Too Many Requests（試行${attempt}/${maxRetry}）。${Math.ceil(waitMs/1000)}秒待機して再試行します。`);
    if (attempt >= maxRetry) return res;
    await new Promise(r => setTimeout(r, waitMs + 200));
  }
}

/*** メイン処理 ***/
async function run(){
  try{
    if (error){ setStatus("Authorization error: "+error); log("認可でエラー: "+error); $("#btnRetry").hidden = false; return; }
    if (!code || !state){ setStatus("code/state が見つかりません。"); $("#btnRetry").hidden = false; return; }

    // state 検証
    const st = sessionStorage.getItem(KEY_STATE);
    if (!st || st !== state){ setStatus("state 不一致（セッションとURLが合いません）。"); log(`session=${st} url=${state}`); $("#btnRetry").hidden = false; return; }

    // 同一codeの再使用を防止（リロード対策）
    if (isCodeUsed(code)){ setStatus("この認可コードは既に処理済みです。"); return; }
    markCodeUsed(code);

    // code_verifier を取得
    const verifier = sessionStorage.getItem(KEY_VERIFIER);
    if (!verifier){ setStatus("code_verifier が見つかりません（セッション切れ）。auth からやり直してください。"); $("#btnRetry").hidden = false; return; }

    setStatus("トークン交換中…");
    log("POST /api/token（PKCE）");

    const payload = {
      client_id: CLIENT_ID,
      grant_type: "authorization_code",
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    };

    const res = await postTokenWithRetry(payload, 3);
    const txt = await res.text();
    let data = null;
    try{ data = JSON.parse(txt); }catch(_){}
    if (!res.ok){
      setStatus(`トークン交換失敗: HTTP ${res.status}`);
      log("Body: " + txt);
      $("#btnRetry").hidden = false;
      return;
    }

    // 成功：トークン保存
    const { access_token, token_type, expires_in, refresh_token, scope } = data;
    const expAt = Date.now() + (expires_in*1000);

    sessionStorage.setItem("sp_access_token", access_token);
    sessionStorage.setItem("sp_token_type", token_type||"Bearer");
    sessionStorage.setItem("sp_expires_at", String(expAt));
    if (refresh_token) sessionStorage.setItem("sp_refresh_token", refresh_token);
    if (scope) sessionStorage.setItem("sp_scope", scope);

    // URLクリーンアップ（codeなどを消す）
    try{
      const cleanUrl = location.origin + location.pathname;
      history.replaceState({}, "", cleanUrl);
    }catch(_){}

    setStatus("サインイン完了。トークンを保存しました。");
    log("access_token 取得・保存 OK。index.html へ戻って処理を続けてください。");
  }catch(e){
    setStatus("エラー: " + (e.message||e));
    $("#btnRetry").hidden = false;
  }
}
$("#btnRetry").addEventListener("click", () => { location.href = "./auth.html"; });
run();
</script>
</body>
</html><!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:36px auto;padding:0 12px}
  #log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:420px;overflow:auto;margin-top:12px}
  a.btn,button{display:inline-block;margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .note{font-size:12px;color:#555}
</style>
</head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">Waiting for code…</p>
<p>
  <a class="btn" href="./index.html">トップへ戻る</a>
  <button id="btnRetry" hidden>もう一度トークン交換</button>
</p>
<div id="netNote" class="note"></div>
<pre id="log"></pre>

<script>
"use strict";
/*** 設定（auth.htmlと一致させる） ***/
const CLIENT_ID    = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI = "https://npr2025.github.io/spotify-auth/callback.html";

/*** ストレージキー ***/
const KEY_VERIFIER = "pkce_verifier";
const KEY_STATE    = "pkce_state";
const KEY_CODE_USED_PREFIX = "pkce_code_used_";

/*** UIユーティリティ ***/
const $ = s => document.querySelector(s);
const log = m => { const el=$("#log"); el.textContent += m + "\n"; console.log(m); };
function setStatus(t){ $("#status").textContent = t; }
function updateNetNote(){ $("#netNote").textContent = navigator.onLine ? "" : "（オフライン検出：オンライン復帰で自動再試行します）"; }
window.addEventListener("online",  updateNetNote);
window.addEventListener("offline", updateNetNote);

/*** URLパラメータ取得 ***/
const params = new URLSearchParams(location.search);
const code  = params.get("code");
const state = params.get("state");
const error = params.get("error");

/*** 同じ code の再使用をブロック（リロード誤爆防止） ***/
function isCodeUsed(code){ return sessionStorage.getItem(KEY_CODE_USED_PREFIX + code) === "1"; }
function markCodeUsed(code){ sessionStorage.setItem(KEY_CODE_USED_PREFIX + code, "1"); }

/*** 待機ユーティリティ ***/
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/*** 429/5xx/オフライン対応の交換処理 ***/
async function postTokenResilient(payload, maxRetry=5){
  let attempt = 0;
  while (true){
    attempt++;

    // オフラインなら復帰を待つ
    if (!navigator.onLine){
      setStatus("オフライン検出。オンライン復帰を待機…");
      await new Promise(res=>{
        const on = () => { window.removeEventListener("online", on); res(); };
        window.addEventListener("online", on);
      });
      await sleep(200); // ほんの余裕
    }

    const res = await fetch("https://accounts.spotify.com/api/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(payload)
    });

    if (res.status === 429 && attempt <= maxRetry){
      const ra = parseInt(res.headers.get("Retry-After")||"1", 10);
      const waitMs = Math.min(60, (isNaN(ra)?1:ra)) * 1000;
      log(`429 Too Many Requests（試行${attempt}/${maxRetry}）。${Math.ceil(waitMs/1000)}秒待機して再試行します。`);
      await sleep(waitMs + 200);
      continue;
    }
    if (res.status >= 500 && attempt <= maxRetry){
      const back = Math.min(8000, 700 * Math.pow(2, attempt-1));
      log(`5xx（試行${attempt}/${maxRetry}）→ バックオフ ${back}ms`);
      await sleep(back);
      continue;
    }
    return res;
  }
}

/*** メイン処理 ***/
async function run(){
  updateNetNote();
  try{
    if (error){ setStatus("Authorization error: "+error); log("認可でエラー: "+error); $("#btnRetry").hidden = false; return; }
    if (!code || !state){ setStatus("code/state が見つかりません。"); $("#btnRetry").hidden = false; return; }

    // state 検証（長さの簡易チェック付き）
    const st = sessionStorage.getItem(KEY_STATE);
    if (!st || st !== state || st.length < 6){ setStatus("state 不一致（セッションとURLが合いません）。"); log(`session=${st} url=${state}`); $("#btnRetry").hidden = false; return; }

    // 同一codeの再使用を防止
    if (isCodeUsed(code)){ setStatus("この認可コードは既に処理済みです。"); return; }
    markCodeUsed(code);

    // code_verifier を取得
    const verifier = sessionStorage.getItem(KEY_VERIFIER);
    if (!verifier){ setStatus("code_verifier が見つかりません（セッション切れ）。auth からやり直してください。"); $("#btnRetry").hidden = false; return; }

    setStatus("トークン交換中…");
    log("POST /api/token（PKCE）");

    const payload = {
      client_id: CLIENT_ID,
      grant_type: "authorization_code",
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    };

    const res = await postTokenResilient(payload, 5);
    const txt = await res.text();
    let data = null; try{ data = JSON.parse(txt); }catch(_){}

    if (!res.ok){
      setStatus(`トークン交換失敗: HTTP ${res.status}`);
      log("Body: " + txt);
      // invalid_grant などは再認可を促す
      $("#btnRetry").hidden = false;
      return;
    }

    // 成功：トークン保存
    const { access_token, token_type, expires_in, refresh_token, scope } = data;
    const expAt = Date.now() + (expires_in*1000);

    sessionStorage.setItem("sp_access_token", access_token);
    sessionStorage.setItem("sp_token_type", token_type||"Bearer");
    sessionStorage.setItem("sp_expires_at", String(expAt));
    if (refresh_token) sessionStorage.setItem("sp_refresh_token", refresh_token);
    if (scope) sessionStorage.setItem("sp_scope", scope);

    // URLクリーンアップ（code/state を消す）
    try{ const cleanUrl = location.origin + location.pathname; history.replaceState({}, "", cleanUrl); }catch(_){}

    setStatus("サインイン完了。トークンを保存しました。");
    log("access_token 取得・保存 OK。index.html へ戻って処理を続けてください。");
  }catch(e){
    setStatus("エラー: " + (e.message||e));
    $("#btnRetry").hidden = false;
  }
}

$("#btnRetry").addEventListener("click", () => {
  // codeは一度使うと無効なので、基本はauthからやり直し。
  location.href = "./auth.html";
});

run();
</script>
</body>
</html>
