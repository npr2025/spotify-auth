<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify 認可コールバック — v10.18 (Chrome)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:760px;margin:36px auto;padding:0 12px;background:#0b1220;color:#cfe3ff}
.btn{padding:10px 14px;border:1px solid #4a6aa3;border-radius:8px;background:#12213e;color:#cfe3ff;cursor:pointer}
pre#log{white-space:pre-wrap;background:#091125;color:#cfe3ff;padding:12px;border-radius:10px;min-height:160px}
code{background:#132347;border:1px solid #2b3c63;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<h1>Spotify 認可 — 戻り処理</h1>
<p>このページは自動でトークン交換し、完了後に元のページへ戻ります。</p>
<div class="row">
  <button id="retry" class="btn">再試行</button>
  <button id="back" class="btn">戻る</button>
</div>
<pre id="log">Booting…</pre>

<script>
const CLIENT_ID = "<YOUR_SPOTIFY_CLIENT_ID>";
const ACCOUNTS = "https://accounts.spotify.com";
const $ = s=>document.querySelector(s);
const log = (...a)=>{ const el=$("#log"); el.textContent += (el.textContent? "\n":"") + a.join(" "); el.scrollTop=el.scrollHeight; };
function setCookie(name, value, days=1){
  const d = new Date(); d.setTime(d.getTime()+days*864e5);
  document.cookie = `${name}=${encodeURIComponent(value)}; Expires=${d.toUTCString()}; Path=${location.pathname.replace(/\/[^/]*$/,'/')}; SameSite=Lax; Secure`;
}
function getCookie(name){
  return document.cookie.split('; ').reduce((a,c)=>{
    const [k,...v]=c.split('=');
    return k===name? decodeURIComponent(v.join('=')) : a;
  }, "");
}
function wipeVerifier(){
  sessionStorage.removeItem("code_verifier");
  localStorage.removeItem("code_verifier");
  document.cookie = `code_verifier=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=${location.pathname.replace(/\/[^/]*$/,'/')}; SameSite=Lax; Secure`;
}
function loadVerifier(){
  return sessionStorage.getItem("code_verifier") ||
         localStorage.getItem("code_verifier")   ||
         getCookie("code_verifier")              || "";
}
function saveToken(tok){
  sessionStorage.setItem("access_token", tok.access_token);
  if (tok.refresh_token) localStorage.setItem("refresh_token", tok.refresh_token);
  const expAt = Date.now() + (tok.expires_in||3600)*1000 - 15000;
  sessionStorage.setItem("token_expires_at", String(expAt));
}
function originIndex(){
  // 同一ディレクトリの index.html に戻す
  return location.origin + location.pathname.replace(/\/[^/]*$/,'/') + "index.html";
}
async function exchangeToken({code, redirect_uri, verifier}){
  const body = new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("code", code);
  body.set("redirect_uri", redirect_uri);
  body.set("client_id", CLIENT_ID);
  body.set("code_verifier", verifier);
  const res = await fetch(ACCOUNTS + "/api/token", {
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body
  });
  if (!res.ok){
    const t = await res.text();
    throw new Error(`token ${res.status}: ${t}`);
  }
  return res.json();
}

async function main(){
  const p = new URLSearchParams(location.search);
  const code = p.get("code");
  const stateB64 = p.get("state");
  const err  = p.get("error");

  $("#retry").onclick = ()=>{ location.reload(); };
  $("#back").onclick  = ()=>{ location.assign(originIndex()); };

  if (err){ log("error=", err); return; }
  if (!code){ log("no code"); return; }

  // state チェック（client_id 一致）
  try{
    const state = JSON.parse(decodeURIComponent(escape(atob(stateB64||""))));
    if (state?.client_id !== CLIENT_ID){
      log("STATE 不一致: client_id mismatch"); return;
    }
  }catch(e){
    log("STATE 解析失敗:", e.message); return;
  }

  // verifier 復元
  const verifier = loadVerifier();
  if (!verifier){ log("no code_verifier"); return; }

  log("token 交換中…");
  try{
    const tok = await exchangeToken({code, redirect_uri: location.origin + location.pathname, verifier});
    saveToken(tok);
    wipeVerifier();
    log("OK: アクセストークン保存");
    // 元の index へ戻す
    setTimeout(()=> location.assign(originIndex()), 600);
  }catch(e){
    log("token 交換失敗:", e.message);
    // 1回だけ PLAIN 再試行導線（auth に戻すのも可）
  }
}

document.addEventListener("DOMContentLoaded", main);
</script>
</body>
</html>
