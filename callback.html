<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify 認可コールバック — v10.20</title>
<style>
body{font-family:system-ui;margin:24px}
pre{white-space:pre-wrap}
button{padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
</style>
</head>
<body>
<h2>処理中…</h2>
<pre id="out"></pre>
<p>
  <button id="retry" style="display:none">再試行</button>
  <button id="home" style="display:none">トップへ戻る</button>
</p>
<script>
var BUILD_ID="v10.20";
var COOKIE_PATH=(function(){ try{ return location.pathname.replace(/\/[^\/]*$/,"/"); }catch(_){ return "/spotify-auth/"; }})();
var DYN_REDIRECT_URI=(function(){ try{ var base = location.origin + location.pathname.replace(/\/[^\/]*$/,""); if(base.charAt(base.length-1)==="/") base=base.slice(0,-1); return base+"/callback.html"; }catch(_){ return "https://npr2025.github.io/spotify-auth/callback.html"; }})();
var LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",cid:"sp_client_id",st:"sp_state"};
function out(s){var e=document.getElementById("out");e.textContent+=(e.textContent?"\n":"")+s}
function readVerifier(){
  try{var v1=localStorage.getItem(LS.ver);if(v1)return v1}catch(_){}
  try{var v2=sessionStorage.getItem(LS.ver);if(v2)return v2}catch(_){}
  try{var m=document.cookie.split(";").map(function(s){return s.trim().split("=")}).find(function(a){return a[0]===LS.ver});if(m&&m[1])return decodeURIComponent(m[1])}catch(_){}
  return ""
}
function clearVerifier(){
  try{localStorage.removeItem(LS.ver)}catch(_){}
  try{sessionStorage.removeItem(LS.ver)}catch(_){}
  try{document.cookie=LS.ver+"=; Max-Age=0; Path="+COOKIE_PATH}catch(_){}
}
function readClientId(){
  var d="1fd6350fcf4945a0b3ddffa2d5730d4e";
  try{var s = localStorage.getItem(LS.cid) || sessionStorage.getItem(LS.cid); if(s) return s}catch(_){}
  return d;
}
function parseStateCID(st){ var m=String(st||"").split("."); return (m.length>=3)?m[2]:null; }
function genRandom(n){var a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",s="";for(var i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)];return s;}
async function buildAuthURL_S256(cid){
  if(!(crypto&&crypto.subtle&&crypto.getRandomValues)) throw new Error("no subtle");
  var v=""; var r=new Uint8Array(64); crypto.getRandomValues(r); for(var i=0;i<r.length;i++) v+=String.fromCharCode(97+(r[i]%26));
  try{localStorage.setItem(LS.ver,v);sessionStorage.setItem(LS.ver,v);document.cookie=LS.ver+"="+encodeURIComponent(v)+"; Max-Age=900; SameSite=Lax; Path="+COOKIE_PATH;}catch(_){}
  try{localStorage.setItem(LS.cid,cid);sessionStorage.setItem(LS.cid,cid);}catch(_){}
  var buf=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v));
  var ch=btoa(String.fromCharCode.apply(null,new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  var st="s2."+Date.now()+"."+cid; try{localStorage.setItem(LS.st,st);sessionStorage.setItem(LS.st,st)}catch(_){}
  var u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",cid);
  u.searchParams.set("redirect_uri",DYN_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",ch);
  u.searchParams.set("scope","playlist-modify-public playlist-modify-private ugc-image-upload");
  u.searchParams.set("state",st);
  return u.toString();
}
function buildAuthURL_PLAIN(cid){
  var v=genRandom(64);
  try{localStorage.setItem(LS.ver,v);sessionStorage.setItem(LS.ver,v);document.cookie=LS.ver+"="+encodeURIComponent(v)+"; Max-Age=900; SameSite=Lax; Path="+COOKIE_PATH;}catch(_){}
  try{localStorage.setItem(LS.cid,cid);sessionStorage.setItem(LS.cid,cid);}catch(_){}
  var st="s2."+Date.now()+"."+cid; try{localStorage.setItem(LS.st,st);sessionStorage.setItem(LS.st,st)}catch(_){}
  var u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",cid);
  u.searchParams.set("redirect_uri",DYN_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","plain");
  u.searchParams.set("code_challenge",v);
  u.searchParams.set("scope","playlist-modify-public playlist-modify-private ugc-image-upload");
  u.searchParams.set("state",st);
  return u.toString();
}

async function tokenExchange(){
  var url=new URL(location.href);
  var code=url.searchParams.get("code");
  var err=url.searchParams.get("error");
  var st=url.searchParams.get("state");
  var cidFromState = parseStateCID(st);
  var cid = cidFromState || readClientId();

  out("STATE="+(st||"(なし)")+" / CID="+(cid||"(不明)")+" / REDIRECT="+DYN_REDIRECT_URI);

  if(err){ out("error="+err); document.getElementById("retry").style.display="inline-block"; return; }
  if(!code){
    out("no code");
    out("ヒント: Spotify Dashboard の Redirect URI が上の REDIRECT と完全一致しているか確認してください。");
    document.getElementById("retry").style.display="inline-block";
    return;
  }
  var cv=readVerifier();
  if(!cv){
    out("no code_verifier");
    document.getElementById("retry").style.display="inline-block";
    return;
  }

  var body=new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("code",code);
  body.set("redirect_uri",DYN_REDIRECT_URI);
  body.set("client_id",cid);
  body.set("code_verifier",cv);

  for(var a=0;a<4;a++){
    try{
      var r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body,cache:"no-store",redirect:"follow",mode:"cors"});
      if(!r.ok){
        var msg="token "+r.status;
        try{var j=await r.json();if(j.error||j.error_description)msg+=": "+(j.error_description||j.error)}catch(_){var t=await r.text();if(t)msg+=": "+t.slice(0,200)}
        throw new Error(msg);
      }
      var j=await r.json();
      try{localStorage.setItem(LS.acc,j.access_token)}catch(_){}
      try{localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000))}catch(_){}
      try{if(j.refresh_token)localStorage.setItem(LS.ref,j.refresh_token)}catch(_){}
      try{sessionStorage.setItem(LS.acc,j.access_token)}catch(_){}
      clearVerifier();
      document.getElementById("home").style.display="inline-block";
      location.assign(location.origin+location.pathname.replace(/\/[^\/]*$/,"/")+"index.html?v="+BUILD_ID+"&ok=1&bust="+Date.now());
      return;
    }catch(e){
      out("retry "+(a+1)+": "+(e.message||e));
      await new Promise(function(r){setTimeout(r,700*(a+1));});
    }
  }
  document.getElementById("retry").style.display="inline-block";
}
document.getElementById("retry").onclick=async function(){
  document.getElementById("retry").disabled=true;
  var st = new URL(location.href).searchParams.get("state") || "";
  var cid = parseStateCID(st) || readClientId();
  try{ location.assign(await buildAuthURL_S256(cid)); }catch(_){ location.assign(buildAuthURL_PLAIN(cid)); }
};
document.getElementById("home").onclick=function(){location.assign(location.origin+location.pathname.replace(/\/[^\/]*$/,"/")+"index.html?v="+BUILD_ID+"&bust="+Date.now())};
tokenExchange();
</script>
</body>
</html>
