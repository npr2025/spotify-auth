<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth – Callback</title>
<meta name="robots" content="noindex,nofollow">
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               connect-src 'self' https://accounts.spotify.com;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline';
               frame-ancestors 'none';
               base-uri 'self';">
<style>body{font-family:system-ui;padding:24px}</style>
</head>
<body>
<h1>認可処理中…</h1>
<pre id="out"></pre>
<script>
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const K={access:"sp_access_token",type:"sp_token_type",expAt:"sp_expires_at",refresh:"sp_refresh_token",scope:"sp_scope"};
const out=(m)=>document.getElementById('out').textContent+=m+"\n";
(async()=>{
  try{
    const params=new URLSearchParams(location.search);
    const code=params.get('code'); const err=params.get('error');
    if(err) throw new Error(err);
    if(!code) throw new Error("no code");
    const ver=sessionStorage.getItem('sp_code_verifier');
    if(!ver) throw new Error("no code_verifier");
    const body=new URLSearchParams({
      client_id:CLIENT_ID,
      grant_type:'authorization_code',
      code,
      redirect_uri:REDIRECT_URI,
      code_verifier:ver
    });
    const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    const txt=await res.text(); let data=null; try{data=JSON.parse(txt);}catch(_){}
    if(!res.ok) throw new Error(txt||("HTTP "+res.status));
    const expAt=Date.now()+data.expires_in*1000;
    sessionStorage.setItem(K.access,data.access_token);
    sessionStorage.setItem(K.type,data.token_type||"Bearer");
    sessionStorage.setItem(K.expAt,String(expAt));
    if(data.refresh_token) sessionStorage.setItem(K.refresh,data.refresh_token);
    if(data.scope) sessionStorage.setItem(K.scope,data.scope);
    out("OK. redirect to index.html");
    location.replace("./index.html");
  }catch(e){
    out("ERROR: "+(e.message||e));
  }
})();
</script>
</body>
</html>
