<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TDCS Auth Callback</title>
<style>body{font-family:system-ui;margin:24px}</style>
</head>
<body>
<h1>Finishing sign-in…</h1>
<pre id="log">Waiting for code…</pre>
<script>
const LOG=(...a)=>{document.getElementById('log').textContent += "\n" + a.join(' ');}

const CLIENT_ID='5b4dc486f92a46878665468fa5de9361';
const TOKEN_URL='https://accounts.spotify.com/api/token';
const REDIRECT_URI='https://npr2025.github.io/spotify-auth/callback.html';

(async()=>{
  try{
    const sp = new URL(location.href).searchParams;
    const code = sp.get('code');
    const state = sp.get('state');
    const err = sp.get('error');
    if(err){ LOG('ERROR: Spotify returned error:', err); return; }

    const expected = sessionStorage.getItem('oauth_state');
    if(!state || state !== expected){ LOG('ERROR: state mismatch'); return; }

    if(!code){ LOG('ERROR: no code'); return; }
    LOG('Exchanging code for token…');

    const code_verifier = sessionStorage.getItem('code_verifier');
    if(!code_verifier){ LOG('ERROR: code_verifier missing'); return; }

    const body = new URLSearchParams({
      grant_type:'authorization_code',
      code,
      redirect_uri: REDIRECT_URI,
      client_id: CLIENT_ID,
      code_verifier
    });

    const res = await fetch(TOKEN_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const txt = await res.text();
    if(!res.ok){ LOG('ERROR: HTTP', res.status, txt); return; }

    const t = JSON.parse(txt);
    const now = Date.now();
    sessionStorage.setItem('access_token', t.access_token);
    if(t.refresh_token) sessionStorage.setItem('refresh_token', t.refresh_token);
    if(t.expires_in) sessionStorage.setItem('access_token_expires_at', String(now + t.expires_in*1000));

    LOG('Token saved. Returning…');
    const returnTo = sessionStorage.getItem('return_to') || 'https://npr2025.github.io/';
    location.href = returnTo;
  }catch(e){
    LOG('ERROR:', e.message);
  }
})();
</script>
</body>
</html>
