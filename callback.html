<!doctype html>
<meta charset="utf-8">
<title>Spotify Callback</title>
<style>
  body{font:14px system-ui;color:#e6f1ff;background:#0b1220;padding:20px}
  pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;padding:12px;border-radius:8px}
  a,button{color:#cfe3ff}
</style>
<h1>Finishing sign-in…</h1>
<pre id="log">Waiting for code…</pre>
<script>
const LOG=(...a)=>{const el=document.getElementById('log');el.textContent+="\n"+a.join(' ')};

const CLIENT_ID   = '5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI= 'https://npr2025.github.io/spotify-auth/callback.html';
const TOKEN_URL   = 'https://accounts.spotify.com/api/token';
const DEFAULT_RETURN = 'https://npr2025.github.io/index.html';

function decodeState(s){
  try{
    const json = decodeURIComponent(escape(atob(s)));
    return JSON.parse(json);
  }catch(_){ return {}; }
}
function backToApp(){
  let ret = DEFAULT_RETURN;
  try{
    const ss = sessionStorage.getItem('return_to');
    if(ss && ss.startsWith('https://npr2025.github.io/')) ret = ss;
  }catch(_){}
  const qs = new URLSearchParams(location.search);
  const st = decodeState(qs.get('state')||'');
  if(st.rt && st.rt.startsWith('https://npr2025.github.io/')) ret = st.rt;
  location.replace(ret);
}
async function postForm(url, data){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: new URLSearchParams(data)
  });
  if(!res.ok){
    const t=await res.text();
    throw new Error(`HTTP ${res.status} ${t}`);
  }
  return res.json();
}

(async ()=>{
  try{
    const qs = new URLSearchParams(location.search);
    const err = qs.get('error');
    if(err){
      const desc = qs.get('error_description') || '';
      LOG('ERROR: Spotify returned error:', err, (desc?('— '+desc):''));
      LOG('\n原因候補: Development modeのUsers未追加 / 別アカで承認 / Redirect URI不一致');
      const a=document.createElement('a'); a.href=DEFAULT_RETURN; a.textContent='Return to app'; document.body.appendChild(a);
      return;
    }

    const code = qs.get('code');
    if(!code){ throw new Error('no code'); }

    const verifier = sessionStorage.getItem('code_verifier');
    if(!verifier){
      throw new Error('missing code_verifier（オリジン違い/別タブでauth→callbackになった可能性）');
    }
    LOG('code_verifier length =', verifier.length); // デバッグ表示

    LOG('Exchanging code for token…');
    const token = await postForm(TOKEN_URL, {
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    });

    sessionStorage.setItem('access_token', token.access_token);
    if(token.refresh_token){ sessionStorage.setItem('refresh_token', token.refresh_token); }
    const expiresAt = Date.now() + (token.expires_in||3600)*1000;
    sessionStorage.setItem('access_token_expires_at', String(expiresAt));

    LOG('Signed in. Returning…');
    backToApp();
  }catch(e){
    LOG('ERROR:', e.message);
    LOG('\nヒント:');
    LOG('・このエラーが "invalid_grant / code_verifier invalid" の場合は、auth.html の code_verifier 生成を修正版に更新してください。');
    LOG('・auth→callback を別オリジンや別タブで跨いでいないか（sessionStorageはタブ単位）');
    const a=document.createElement('a'); a.href=DEFAULT_RETURN; a.textContent='Return to app (fallback)'; document.body.appendChild(a);
  }
})();
</script>
