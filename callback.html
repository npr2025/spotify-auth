<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spotify 認可リダイレクト</title>
<style>
 body{font-family:system-ui;margin:2rem}
 .ok{color:#0a7f29}.bad{color:#b00020}
</style>
</head>
<body>
<h1>Spotify 認可リダイレクト</h1>
<div id="msg">処理中…</div>
<p><a href="./fulltracks_ultra_safe_v2.html">戻る</a></p>

<script>
const CLIENT_ID="378ef0f44b36499abd10d118ddbddc98";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";

async function exchange(code,verifier){
  const body=new URLSearchParams({
    client_id:CLIENT_ID,grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,code_verifier:verifier
  });
  const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!res.ok)throw new Error(await res.text());
  return res.json();
}

(async()=>{
  const sp=new URLSearchParams(location.search);
  const code=sp.get("code");const state=sp.get("state");
  if(!code){msg.textContent="エラー: codeなし";return;}
  const st=sessionStorage.getItem("sp_state")||localStorage.getItem("sp_state");
  if(state!==st){msg.textContent="エラー: state不一致";return;}
  const verifier=sessionStorage.getItem("sp_pkce_verifier")||localStorage.getItem("sp_pkce_verifier");
  if(!verifier){msg.textContent="エラー: verifierなし";return;}
  try{
    const tok=await exchange(code,verifier);
    const expires_at=Date.now()+tok.expires_in*1000-10000;
    localStorage.setItem("sp_token",JSON.stringify({access_token:tok.access_token,expires_at}));
    sessionStorage.clear();localStorage.removeItem("sp_pkce_verifier");localStorage.removeItem("sp_state");
    msg.innerHTML="<span class=ok>認証成功</span>";
    setTimeout(()=>location.href="./fulltracks_ultra_safe_v2.html",1000);
  }catch(e){msg.innerHTML="<span class=bad>交換失敗:"+e+"</span>";}
})();
</script>
</body>
</html>
