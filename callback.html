<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:36px auto;padding:0 12px}
  #log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:420px;overflow:auto;margin-top:12px}
  button{margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
</style>
</head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">Waiting for code…</p>
<p><button id="btnBack">アプリへ戻る</button></p>
<pre id="log"></pre>

<script>
const CLIENT_ID   = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const TOKEN_URL   = "https://accounts.spotify.com/api/token";
const REDIRECT_TO = () => sessionStorage.getItem("return_to") || "./";

const log = m => { const el=document.querySelector("#log"); el.textContent += m+"\n"; el.scrollTop=el.scrollHeight; console.log(m); };
const setStatus = t => { document.querySelector("#status").textContent = t; log(t); };

document.querySelector("#btnBack").onclick = ()=> location.replace(REDIRECT_TO());

async function exchange(){
  const qp = new URLSearchParams(location.search);
  const code  = qp.get("code");
  const state = qp.get("state");
  const err   = qp.get("error");
  if(err){ setStatus("auth error: "+err); return; }
  if(!code){ setStatus("code not found."); return; }

  const savedState   = sessionStorage.getItem("pkce_state");
  const codeVerifier = sessionStorage.getItem("pkce_verifier");
  if(!savedState || !codeVerifier){ setStatus("missing PKCE params in sessionStorage."); return; }
  if(state !== savedState){ setStatus("state mismatch."); return; }

  setStatus("Exchanging code → token…");
  const body = new URLSearchParams({
    client_id: CLIENT_ID,
    grant_type: "authorization_code",
    code,
    redirect_uri: "https://npr2025.github.io/spotify-auth/callback.html", // 登録と完全一致
    code_verifier: codeVerifier
  });
  const r = await fetch(TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
  if(!r.ok){ setStatus("token exchange failed: "+r.status+" "+(await r.text())); return; }
  const t = await r.json();

  const expAt = Date.now() + (t.expires_in||3600)*1000;
  sessionStorage.setItem("sp_access_token", t.access_token);
  sessionStorage.setItem("sp_exp_at", String(expAt));
  sessionStorage.setItem("sp_scope", t.scope||"");
  if(t.refresh_token){
    sessionStorage.setItem("sp_refresh_token", t.refresh_token);
    localStorage.setItem("sp_refresh_token", t.refresh_token);
  }
  sessionStorage.removeItem("pkce_state");
  sessionStorage.removeItem("pkce_verifier");

  setStatus("Authorized. returning to app…");
  history.replaceState({}, document.title, location.pathname);
  setTimeout(()=>location.replace(REDIRECT_TO()), 400);
}

exchange().catch(e=>setStatus("callback error: "+(e.message||e)));
</script>
</body>
</html>
