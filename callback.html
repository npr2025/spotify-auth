<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify 認可コールバック — v10.13</title>
<style>body{font-family:system-ui;margin:24px}pre{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px}</style>
</head>
<body>
<h2>処理中…</h2>
<pre id="out"></pre>
<p><button id="retry" style="display:none">再試行</button></p>
<script>
const BUILD_ID="v10.13";
const FIXED_REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const DEFAULT_CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",cid:"sp_client_id"};
function out(s){const e=document.getElementById("out");e.textContent+=(e.textContent?"\n":"")+s}
function readAny(k){try{let v=localStorage.getItem(k);if(v)return v}catch{} try{let v=sessionStorage.getItem(k);if(v)return v}catch{} try{const m=document.cookie.split(";").map(s=>s.trim().split("=")).find(a=>a[0]===k);if(m&&m[1])return decodeURIComponent(m[1])}catch{} return ""}
function parseState(str){try{const b=str.replace(/-/g,"+").replace(/_/g,"/");const pad="=".repeat((4-b.length%4)%4);return JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(b+pad),c=>c.charCodeAt(0))))}catch(_){return{}}}
window.addEventListener("unhandledrejection",e=>{e.preventDefault();out("unhandled: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)))});
async function tokenExchange(){
  const url=new URL(location.href);const code=url.searchParams.get("code");const err=url.searchParams.get("error");const stRaw=url.searchParams.get("state")||"";const st=parseState(stRaw);
  const client=readAny(LS.cid)||st.client_id||DEFAULT_CLIENT_ID;
  if(err){out("error="+err);document.getElementById("retry").style.display="inline-block";return}
  if(!code){out("no code");document.getElementById("retry").style.display="inline-block";return}
  const cv=readAny(LS.ver);if(!cv){out("no code_verifier");document.getElementById("retry").style.display="inline-block";return}
  const body=new URLSearchParams();body.set("grant_type","authorization_code");body.set("code",code);body.set("redirect_uri",FIXED_REDIRECT_URI);body.set("client_id",client);body.set("code_verifier",cv);
  for(let a=0;a<4;a++){
    try{
      const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body,cache:"no-store",redirect:"follow",mode:"cors"});
      if(!r.ok){
        let msg="token "+r.status;try{const j=await r.json();if(j.error||j.error_description)msg+=": "+(j.error_description||j.error)}catch(_){const t=await r.text();if(t)msg+=": "+t.slice(0,200)}
        throw new Error(msg)
      }
      const j=await r.json();
      try{localStorage.setItem(LS.acc,j.access_token)}catch(_){}
      try{localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000))}catch(_){}
      try{if(j.refresh_token)localStorage.setItem(LS.ref,j.refresh_token)}catch(_){}
      try{sessionStorage.setItem(LS.acc,j.access_token)}catch(_){}
      location.href="https://npr2025.github.io/spotify-auth/index.html?v="+BUILD_ID+"&ok=1&bust="+Date.now();
      return
    }catch(e){
      out("retry "+(a+1)+": "+(e.message||e));
      await new Promise(r=>setTimeout(r,700*(a+1)))
    }
  }
  document.getElementById("retry").style.display="inline-block"
}
document.getElementById("retry").onclick=()=>{document.getElementById("retry").style.display="none";location.href="https://npr2025.github.io/spotify-auth/index.html?v="+BUILD_ID+"&bust="+Date.now()};
tokenExchange();
</script>
</body></html>
