<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify 認可コールバック — v10.19</title>
<style>
body{font-family:system-ui;margin:24px}
pre{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px}
button{padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
</style>
</head>
<body>
<h2>処理中…</h2>
<pre id="out">Booting…</pre>
<p>
  <button id="retry" style="display:none">再試行</button>
  <button id="home" style="display:none">トップへ戻る</button>
</p>
<script>
const out=(...a)=>{const e=document.getElementById("out");e.textContent+=(e.textContent?'\n':'')+a.join(' ')};
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",cid:"sp_client_id",st:"sp_state"};
const FIXED_REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const SCOPES="playlist-modify-public playlist-modify-private ugc-image-upload";

function readVerifier(){
  try{const v1=localStorage.getItem(LS.ver);if(v1)return v1}catch(_){}
  try{const v2=sessionStorage.getItem(LS.ver);if(v2)return v2}catch(_){}
  try{const m=document.cookie.split(";").map(s=>s.trim().split("=")).find(a=>a[0]===LS.ver);if(m&&m[1])return decodeURIComponent(m[1])}catch(_){}
  return "";
}
function clearVerifier(){
  try{localStorage.removeItem(LS.ver)}catch(_){}
  try{sessionStorage.removeItem(LS.ver)}catch(_){}
  try{document.cookie=LS.ver+"=; Max-Age=0; Path=/spotify-auth/"}catch(_){}
}
function parseStateCV(st){
  // s3.<base64url(JSON: {t,cid,cv})>
  try{
    if(!st||!st.startsWith("s3.")) return {cid:null,cv:null};
    const b64=st.slice(3);
    const b=b64.replace(/-/g,"+").replace(/_/g,"/");
    const json=atob(b);
    const o=JSON.parse(json);
    return {cid:o.cid||null, cv:o.cv||null};
  }catch(_){return {cid:null,cv:null}}
}
function pickCID(st){
  const {cid}=parseStateCV(st);
  if(cid) return cid;
  try{const s=localStorage.getItem(LS.cid)||sessionStorage.getItem(LS.cid); if(s) return s}catch(_){}
  return "1fd6350fcf4945a0b3ddffa2d5730d4e";
}
function ensureCV(st){
  const stored=readVerifier();
  if(stored) return stored;
  const parsed=parseStateCV(st);
  return parsed.cv||"";
}

async function tokenExchange(){
  const url=new URL(location.href);
  const code=url.searchParams.get("code");
  const err=url.searchParams.get("error");
  const st=url.searchParams.get("state")||"";
  const cid=pickCID(st);

  out(`STATE=${st||"(なし)"} / CID=${cid||"(不明)"}`);

  if(err){ out("error="+err); document.getElementById("retry").style.display="inline-block"; return; }
  if(!code){ out("no code"); out("ヒント: Redirect URI が完全一致しているか / 同一タブ遷移か"); document.getElementById("retry").style.display="inline-block"; return; }

  const cv=ensureCV(st);
  if(!cv){ out("no code_verifier（ストレージ・cookie・state すべて空）"); document.getElementById("retry").style.display="inline-block"; return; }

  const body=new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("code",code);
  body.set("redirect_uri",FIXED_REDIRECT_URI);
  body.set("client_id",cid);
  body.set("code_verifier",cv);

  for(let a=0;a<4;a++){
    try{
      const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body,cache:"no-store",redirect:"follow",mode:"cors"});
      if(!r.ok){
        let msg="token "+r.status;
        try{const j=await r.json();if(j.error||j.error_description)msg+=": "+(j.error_description||j.error)}catch(_){const t=await r.text();if(t)msg+=": "+t.slice(0,200)}
        throw new Error(msg);
      }
      const j=await r.json();
      try{localStorage.setItem(LS.acc,j.access_token)}catch(_){}
      try{localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000))}catch(_){}
      try{if(j.refresh_token)localStorage.setItem(LS.ref,j.refresh_token)}catch(_){}
      try{sessionStorage.setItem(LS.acc,j.access_token)}catch(_){}
      clearVerifier();
      out("OK: token stored");
      document.getElementById("home").style.display="inline-block";
      location.assign("index.html?ok=1&bust="+Date.now());
      return;
    }catch(e){
      out("retry "+(a+1)+": "+(e.message||e));
      await new Promise(r=>setTimeout(r,700*(a+1)));
    }
  }
  document.getElementById("retry").style.display="inline-block";
}

document.getElementById("retry").onclick=async()=>{
  document.getElementById("retry").disabled=true;
  const st = new URL(location.href).searchParams.get("state") || "";
  const {cid}=parseStateCV(st);
  // 失敗時は PLAIN で再試行（cvを新規発行し state にも再封入）
  function randAlpha(n){const a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let s="";for(let i=0;i<n;i++) s+=a[Math.floor(Math.random()*a.length)];return s;}
  const v=randAlpha(64);
  try{localStorage.setItem(LS.ver,v);sessionStorage.setItem(LS.ver,v);document.cookie=`${LS.ver}=${encodeURIComponent(v)}; Max-Age=900; SameSite=Lax; Path=/spotify-auth/`;}catch(_){}
  const payload=`{"t":${Date.now()},"cid":"${cid||"1fd6...d4e"}","cv":"${v}"}`;
  const b64= btoa(payload).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  const state="s3."+b64;
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",cid||"1fd6350fcf4945a0b3ddffa2d5730d4e");
  u.searchParams.set("redirect_uri",FIXED_REDIRECT_URI);
  u.searchParams.set("code_challenge_method","plain");
  u.searchParams.set("code_challenge",v);
  u.searchParams.set("scope",SCOPES);
  u.searchParams.set("state",state);
  location.assign(u.toString());
};
document.getElementById("home").onclick=()=>{location.assign("index.html?bust="+Date.now())};
tokenExchange();
</script>
</body>
</html>
