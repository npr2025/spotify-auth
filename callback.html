<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify 認可コールバック — v10.10</title>
<style>
body{font-family:system-ui;margin:24px}
pre{white-space:pre-wrap;background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;min-height:120px}
button{padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;margin:6px 8px 0 0}
a.btn{display:inline-block;padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;color:#000;margin:6px 8px 0 0}
</style>
</head>
<body>
<h2>処理中…</h2>
<pre id="out"></pre>
<p>
  <button id="retry" style="display:none">再試行</button>
  <a id="openAuth" class="btn" href="#" target="_self" style="display:none">認可ページを同一タブで開く</a>
</p>
<script>
const BUILD_ID="v10.10";
const FIXED_REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const DEFAULT_CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",state:"sp_state",cid:"client_id_pref",last:"last_auth_url"};

function out(s){const e=document.getElementById("out");e.textContent+=(e.textContent?"\n":"")+s}

function getSaved(k){ try{return localStorage.getItem(k)||sessionStorage.getItem(k)||""}catch(_){return ""} }
function readCookie(name){ try{const m=document.cookie.split(";").map(s=>s.trim().split("=")).find(a=>a[0]===name); return m&&m[1]?decodeURIComponent(m[1]):""}catch(_){return ""} }
function readVerifier(){ return getSaved(LS.ver) || readCookie(LS.ver) || "" }
function readState(){ return getSaved(LS.state) || readCookie(LS.state) || "" }
function readClientIdFromState(st){ const m=String(st||"").match(/^ci_([^_]+)_/); return m?m[1]:"" }
function clientId(){ return getSaved(LS.cid) || readClientIdFromState(readState()) || DEFAULT_CLIENT_ID }

function clearVerifierAndState(){
  try{localStorage.removeItem(LS.ver);sessionStorage.removeItem(LS.ver);}catch(_){}
  try{document.cookie=LS.ver+"=; Max-Age=0; Path=/spotify-auth/"}catch(_){}
  try{localStorage.removeItem(LS.state);sessionStorage.removeItem(LS.state);}catch(_){}
  try{document.cookie=LS.state+"=; Max-Age=0; Path=/spotify-auth/"}catch(_){}
}

window.addEventListener("unhandledrejection",e=>{e.preventDefault();out("unhandled: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)))})

function showAuthOpen(){
  const u=getSaved(LS.last);
  const a=document.getElementById("openAuth");
  if(u){ a.href=u; a.style.display="inline-block"; }
}

async function tokenExchange(){
  const url=new URL(location.href);const code=url.searchParams.get("code");const err=url.searchParams.get("error");const st=url.searchParams.get("state")||readState();
  if(err){out("error="+err);document.getElementById("retry").style.display="inline-block";showAuthOpen();return}
  if(!code){
    out("no code");
    out("ヒント: Redirect URI 登録が正しいか？ → https://npr2025.github.io/spotify-auth/callback.html");
    out("ヒント: 認可URLを同一タブで開いているか？");
    out(`state=${st||"(なし)"} / 想定client_id=${clientId()}`);
    document.getElementById("retry").style.display="inline-block";
    showAuthOpen();
    return
  }
  const cv=readVerifier(); if(!cv){ out("no code_verifier（ブラウザのストレージ/タブ問題）"); showAuthOpen(); document.getElementById("retry").style.display="inline-block"; return }
  const cid=clientId();
  const body=new URLSearchParams(); body.set("grant_type","authorization_code"); body.set("code",code); body.set("redirect_uri",FIXED_REDIRECT_URI); body.set("client_id",cid); body.set("code_verifier",cv);

  for(let a=0;a<4;a++){
    try{
      const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body,cache:"no-store",redirect:"follow",mode:"cors"});
      if(!r.ok){
        let msg="token "+r.status;try{const j=await r.json();if(j.error||j.error_description)msg+=": "+(j.error_description||j.error)}catch(_){const t=await r.text();if(t)msg+=": "+t.slice(0,200)}
        throw new Error(msg)
      }
      const j=await r.json();
      try{localStorage.setItem(LS.acc,j.access_token)}catch(_){}
      try{localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000))}catch(_){}
      try{if(j.refresh_token)localStorage.setItem(LS.ref,j.refresh_token)}catch(_){}
      try{sessionStorage.setItem(LS.acc,j.access_token)}catch(_){}
      clearVerifierAndState();
      location.href="https://npr2025.github.io/spotify-auth/index.html?v="+BUILD_ID+"&ok=1&bust="+Date.now();
      return
    }catch(e){
      out("retry "+(a+1)+": "+(e.message||e));
      await new Promise(r=>setTimeout(r,700*(a+1)))
    }
  }
  document.getElementById("retry").style.display="inline-block"; showAuthOpen();
}
document.getElementById("retry").onclick=()=>{document.getElementById("retry").style.display="none";tokenExchange()};
tokenExchange();
</script>
</body></html>
