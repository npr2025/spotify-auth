<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>TDCS Auth Callback</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
           background:#0b1220;color:#cfe3ff;max-width:760px;margin:40px auto;padding:0 16px; }
    h1{font-size:20px;margin:0 0 12px}
    pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;padding:12px;border-radius:10px}
    a{color:#9ec1ff}
  </style>
</head>
<body>
<h1>Finishing sign-in…</h1>
<pre id="log">Waiting for code…</pre>
<script>
const CLIENT_ID = '5b4dc486f92a46878665468fa5de9361';
const TOKEN_URL = 'https://accounts.spotify.com/api/token';

const log=(...a)=>{ const el=document.getElementById('log'); el.textContent += '\n' + a.join(' '); };

(async () => {
  const url = new URL(location.href);
  const code = url.searchParams.get('code');
  const state = url.searchParams.get('state');
  const error = url.searchParams.get('error');

  if(error){
    log('ERROR: Spotify returned error:', error);
    log('ヒント:');
    log('・ダッシュボードの Redirect URI が完全一致しているか');
    log('・Development mode の Users に自分を追加済みか');
    log('・auth.html も callback.html も https://npr2025.github.io/spotify-auth/ 配下で動いているか');
    const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app'; document.body.appendChild(a);
    return;
  }
  if(!code){ log('ERROR: missing code'); const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app'; document.body.appendChild(a); return; }

  const st = sessionStorage.getItem('pkce_state');
  if(!st || st!==state){ log('ERROR: state mismatch'); const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app'; document.body.appendChild(a); return; }

  const verifier = sessionStorage.getItem('code_verifier');
  if(!verifier){ log('ERROR: code_verifier missing'); const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app'; document.body.appendChild(a); return; }

  try{
    log('Exchanging code for token…');
    const body = new URLSearchParams({
      grant_type:'authorization_code',
      code,
      redirect_uri:'https://npr2025.github.io/spotify-auth/callback.html',
      client_id: CLIENT_ID,
      code_verifier: verifier
    });
    const res = await fetch(TOKEN_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
    const txt = await res.text();
    if(!res.ok){
      log('ERROR: HTTP', res.status, txt);
      log('ヒント:');
      log('・Redirect URI 完全一致か？');
      log('・Development Users 追加済みか？');
      log('・auth/callback/builder が同一オリジン (https://npr2025.github.io/) か？');
      const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app (fallback)'; document.body.appendChild(a);
      return;
    }
    const tok = JSON.parse(txt);
    sessionStorage.setItem('access_token', tok.access_token);
    if(tok.refresh_token) sessionStorage.setItem('refresh_token', tok.refresh_token);
    if(tok.expires_in) sessionStorage.setItem('access_token_expires_at', String(Date.now()+tok.expires_in*1000));
    // 1回使った verifier/state は消しておく
    sessionStorage.removeItem('code_verifier');
    sessionStorage.removeItem('pkce_state');

    const ret = sessionStorage.getItem('return_to') || 'https://npr2025.github.io/spotify-auth/builder.html';
    location.replace(ret);
  }catch(e){
    log('ERROR:', e.message);
    const a=document.createElement('a'); a.href='builder.html'; a.textContent='Return to app'; document.body.appendChild(a);
  }
})();
</script>
</body>
</html>
