<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Authentication</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:1100px;margin:36px auto;padding:0 12px}
  button{padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#f6f6f6;cursor:pointer}
  button:disabled{opacity:.45;cursor:not-allowed}
  input,select{padding:6px 8px;border:1px solid #ccc;border-radius:6px}
  #row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  #pins{display:grid;grid-template-columns:180px 1fr 160px;gap:8px;align-items:center;margin:10px 0;padding:10px;border:1px dashed #ddd;border-radius:8px;background:#fafafa}
  #log{background:#0b1220;color:#cfe3ff;padding:10px;border-radius:8px;max-height:360px;overflow:auto;white-space:pre-wrap;margin-top:12px}
  #debug{font-size:13px;color:#333;background:#f6f6f9;border:1px solid #e5e6ef;border-radius:8px;padding:8px;margin:12px 0}
  ol{line-height:1.5}
  label.small{font-size:12px;color:#666}
</style>
</head>
<body>
<h1>Spotify Authentication</h1>
<p id="status">Booting…</p>

<div id="debug">
  <b>Token:</b> <span id="tokstate">–</span> |
  <button id="btnRefresh">Refresh token</button>
  <button id="btnReauth">Re-auth</button>
</div>

<!-- ここから先はあなたの機能 UI（省略可）。問題は Re-auth/Boot 周りなので最少構成でOK -->
<pre id="log"></pre>

<script>
/*** 固定（あなたの環境） ***/
const CLIENT_ID     = "1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI  = "https://npr2025.github.io/spotify-auth/callback.html";
const AUTH_ABS_URL  = "https://npr2025.github.io/spotify-auth/auth.html"; // ★絶対URL
const DESIRED_SCOPES = ["playlist-modify-private","playlist-modify-public"];

/*** 便利関数 ***/
const $=s=>document.querySelector(s);
const log=m=>{const el=$("#log"); el.textContent+=m+"\n"; el.scrollTop=el.scrollHeight; console.log(m);};
const setStatus=t=>{ $("#status").textContent=t; log(t); };
async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/*** Token 管理 ***/
function saveToken(t){
  const expAt = Date.now() + (t.expires_in||3600)*1000;
  sessionStorage.setItem("sp_access_token", t.access_token);
  if(t.refresh_token) sessionStorage.setItem("sp_refresh_token", t.refresh_token);
  sessionStorage.setItem("sp_exp_at", String(expAt));
  sessionStorage.setItem("sp_scope", t.scope||"");
  updateTokenDebug();
}
function clearToken(){
  ["sp_access_token","sp_refresh_token","sp_exp_at","sp_scope","pkce_state","pkce_verifier"].forEach(k=>sessionStorage.removeItem(k));
  updateTokenDebug();
}
function scopeOk(required){
  const s=(sessionStorage.getItem("sp_scope")||"").split(" ").filter(Boolean);
  return required.every(x=>s.includes(x));
}
function updateTokenDebug(){
  const exp=+sessionStorage.getItem("sp_exp_at")||0;
  const left = exp? Math.max(0, Math.floor((exp-Date.now())/1000)) : 0;
  const rt = !!sessionStorage.getItem("sp_refresh_token");
  const sc = sessionStorage.getItem("sp_scope")||"";
  $("#tokstate").textContent = (sessionStorage.getItem("sp_access_token")?"OK":"NONE")+
    ` / exp in ${left}s / refresh:${rt?"yes":"no"} / scope:[${sc}]`;
}

/*** Re-auth（絶対URL & フォールバック強化） ***/
function reauth(){
  setStatus("Re-auth → auth.html へ遷移します…");
  // 一度だけ強制的に cache-busting
  const url = AUTH_ABS_URL + (AUTH_ABS_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
  // 通常遷移
  location.href = url;
  // もし何らかの理由で遷移しない場合の保険
  setTimeout(()=>{ try{ location.replace(url); }catch(e){} }, 800);
}

/*** Token エンドポイント ***/
async function tokenByCode(code,verifier){
  const body=new URLSearchParams({
    client_id:CLIENT_ID, grant_type:"authorization_code", code, redirect_uri:REDIRECT_URI, code_verifier:verifier
  });
  const r=await fetch("https://accounts.spotify.com/api/token",{
    method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body
  });
  if(!r.ok){
    const txt = await r.text().catch(()=>String(r.status));
    throw new Error(`Token exchange ${r.status}: ${txt}`);
  }
  return r.json();
}
async function refreshTokenNow(){
  const rt=sessionStorage.getItem("sp_refresh_token");
  if(!rt) throw new Error("No refresh_token");
  const r=await fetch("https://accounts.spotify.com/api/token",{
    method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({client_id:CLIENT_ID,grant_type:"refresh_token",refresh_token:rt})
  });
  if(!r.ok){ clearToken(); throw new Error(`Refresh ${r.status}`); }
  const t=await r.json(); saveToken(t); log("Token refreshed.");
}

/*** 安全トークン取得：不足なら即 Re-auth（ハングさせない） ***/
async function ensureToken(requiredScopes=DESIRED_SCOPES){
  updateTokenDebug();
  const tok = sessionStorage.getItem("sp_access_token");
  const exp = +sessionStorage.getItem("sp_exp_at")||0;

  if(tok && Date.now() < exp-120000){ // 2分のマージン
    if(!scopeOk(requiredScopes)){
      setStatus("Scope 不足 → Re-auth へ");
      reauth(); return null;
    }
    return tok;
  }
  const rt=sessionStorage.getItem("sp_refresh_token");
  if(rt){
    try { await refreshTokenNow(); return sessionStorage.getItem("sp_access_token"); }
    catch(e){ setStatus("Refresh 失敗 → Re-auth"); reauth(); return null; }
  }
  // ここまで来たら素直に認可へ
  setStatus("トークン無し → Re-auth へ");
  reauth(); return null;
}

/*** 起動（PKCE コールバック） ***/
(async function boot(){
  try{
    log("JS boot");
    const qp = new URLSearchParams(location.search);
    const code  = qp.get("code");
    const state = qp.get("state");
    log("URL query = " + (location.search || "(none)"));

    if(code){
      const saved   = sessionStorage.getItem("pkce_state");
      const verifier= sessionStorage.getItem("pkce_verifier");
      if(saved && verifier && state===saved){
        log("code→token 交換開始");
        const tok=await tokenByCode(code,verifier);
        saveToken(tok);
        sessionStorage.removeItem("pkce_state");
        sessionStorage.removeItem("pkce_verifier");
        history.replaceState({},document.title,location.pathname); // URL をきれいに
      }else{
        setStatus("PKCE state 不一致 → Re-auth"); reauth(); return;
      }
    }

    const ok = await ensureToken();
    if(!ok) return; // Re-auth に飛ばした

    setStatus("Signed in. Ready.");
    // ここから先はあなたのビルド処理を続ける
  }catch(e){
    setStatus("Boot error: "+(e.message||e));
  }
})();

/*** 手動操作 ***/
document.getElementById("btnRefresh").onclick=()=>refreshTokenNow().catch(e=>setStatus("Refresh error: "+e.message));
document.getElementById("btnReauth").onclick =()=>{ clearToken(); reauth(); };
</script>
</body>
</html>
