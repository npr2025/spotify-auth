<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
body{font-family:system-ui;max-width:900px;margin:36px auto;padding:0 12px}
#log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:460px;overflow:auto;margin-top:12px}
a.btn,button{display:inline-block;margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none}
</style></head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">Waiting‚Ä¶</p>
<p><a href="auth.html?v=20250826-fullauto-artist" class="btn">„Ç¢„Éó„É™„Å∏Êàª„Çã</a></p>
<pre id="log"></pre>
<script>
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier"};
const log=s=>{const el=document.getElementById("log");el.textContent+=(el.textContent?"\n":"")+s;el.scrollTop=el.scrollHeight};
(async()=>{
  const p=new URLSearchParams(location.search); const code=p.get("code"); const err=p.get("error");
  if(err){document.getElementById("status").textContent="Error: "+err; log("error="+err); return;}
  if(!code){log("code not found"); return;}
  const cv=localStorage.getItem(LS.ver); if(!cv){document.getElementById("status").textContent="Missing code_verifier"; return;}
  const body=new URLSearchParams({grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,client_id:CLIENT_ID,code_verifier:cv});
  try{
    const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body});
    const t=await r.text(); let j; try{j=JSON.parse(t);}catch{j={raw:t};}
    if(!r.ok){document.getElementById("status").textContent="Failed"; log("Token error: "+t); return;}
    localStorage.setItem(LS.acc,j.access_token); localStorage.setItem(LS.ref,j.refresh_token||""); localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000));
    document.getElementById("status").textContent="Signed in."; log("‚úÖ authorized. „Åì„ÅÆ„Çø„Éñ„ÅØÈñâ„Åò„Å¶OK„ÄÇ");
  }catch(e){log("üí• "+e.message);}
})();
</script>
</body></html>
