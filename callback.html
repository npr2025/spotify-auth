<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:36px auto;padding:0 12px}
  #log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:420px;overflow:auto;margin-top:12px}
  a.btn,button{display:inline-block;margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;cursor:pointer}
</style>
</head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">Waiting for code‚Ä¶</p>
<p>
  <a href="auth.html" class="btn">„Ç¢„Éó„É™„Å∏Êàª„Çã</a>
</p>
<pre id="log"></pre>
<script>
const CLIENT_ID = "YOUR_SPOTIFY_CLIENT_ID";
const LS = {
  acc: "sp_access_token",
  ref: "sp_refresh_token",
  exp: "sp_token_exp",
  ver: "sp_code_verifier",
};

const log = (s)=>{ const el=document.getElementById("log"); el.textContent += (el.textContent? "\n": "") + s; el.scrollTop = el.scrollHeight; };

(async ()=>{
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  const err  = params.get("error");
  if(err){ document.getElementById("status").textContent = "Error: "+err; log("error="+err); return; }
  if(!code){ log("code not found"); return; }

  document.getElementById("status").textContent = "Exchanging code‚Ä¶";
  const code_verifier = localStorage.getItem(LS.ver);
  if(!code_verifier){ log("code_verifier missing"); return; }

  const body = new URLSearchParams({
    grant_type: "authorization_code",
    code,
    redirect_uri: location.origin + location.pathname,
    client_id: CLIENT_ID,
    code_verifier
  });

  try{
    const res = await fetch("https://accounts.spotify.com/api/token",{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body
    });
    const j = await res.json();
    if(!res.ok){ log("Token error: "+JSON.stringify(j)); document.getElementById("status").textContent="Failed"; return; }

    localStorage.setItem(LS.acc, j.access_token);
    localStorage.setItem(LS.ref, j.refresh_token||"");
    localStorage.setItem(LS.exp, String(Date.now()+ j.expires_in*1000));
    document.getElementById("status").textContent = "Signed in.";
    log("‚úÖ authorized. You can close this tab.");
  }catch(e){
    log("üí• "+e.message);
  }
})();
</script>
</body>
</html>
