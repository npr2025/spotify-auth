<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:36px auto;padding:0 12px}
  #log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:420px;overflow:auto;margin-top:12px}
  a.btn,button{display:inline-block;margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;cursor:pointer}
</style>
</head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">Waiting for code…</p>
<p>
  <button id="btnBack">アプリへ戻る</button>
  <button id="btnRetry">再試行</button>
</p>
<pre id="log"></pre>

<script>
const LOG=(...a)=>document.getElementById('log').textContent+='\n'+a.join(' ');
const S=document.getElementById('status');

function getCookie(n){ const m=document.cookie.match(new RegExp('(?:^|; )'+n+'=([^;]*)')); return m?decodeURIComponent(m[1]):null }
function restoreVerifier(){ return sessionStorage.getItem('code_verifier')||localStorage.getItem('code_verifier')||getCookie('code_verifier') }
function clientIdFromState(s){ try{ return JSON.parse(s).client_id||null }catch(_){ return null } }

async function tokenExchange(code,redirectUri,clientId,verifier){
  const body=new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:redirectUri,client_id:clientId,code_verifier:verifier});
  const res=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});
  if(res.status===429){
    const retry=Number(res.headers.get('Retry-After')||'2'); LOG('429 → wait',retry,'s'); await new Promise(r=>setTimeout(r,retry*1000));
    return tokenExchange(code,redirectUri,clientId,verifier);
  }
  if(!res.ok){ throw new Error('token '+res.status+': '+await res.text()) }
  return res.json();
}

async function main(){
  const u=new URL(location.href);
  const code=u.searchParams.get('code');
  const state=u.searchParams.get('state');
  const err=u.searchParams.get('error');
  const redirectUri='https://npr2025.github.io/spotify-auth/callback.html';

  if(err){ S.textContent='Error: '+err; LOG('error=',err); return }
  if(!code){ S.textContent='no code'; LOG('no code — 再試行'); return }

  const verifier=restoreVerifier();
  if(!verifier){ S.textContent='no code_verifier'; LOG('no code_verifier'); return }

  let clientId=sessionStorage.getItem('client_id');
  if(!clientId && state) clientId=clientIdFromState(state);
  if(!clientId){ S.textContent='no client_id'; LOG('client_id missing'); return }

  LOG('Exchanging token… client_id=',clientId);
  const tok=await tokenExchange(code,redirectUri,clientId,verifier);

  sessionStorage.setItem('access_token',tok.access_token);
  sessionStorage.setItem('expires_in',tok.expires_in);
  if(tok.refresh_token) sessionStorage.setItem('refresh_token',tok.refresh_token);

  S.textContent='OK — token acquired';
  LOG('access_token(len)=',String(tok.access_token||'').length,'expires_in=',tok.expires_in);

  document.getElementById('btnBack').onclick=()=>location.assign('builder.html');
  document.getElementById('btnRetry').onclick=()=>location.assign('auth.html');
}
main().catch(e=>{S.textContent='Token error'; LOG(e.message)});
</script>
</body>
</html>
