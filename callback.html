<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify 認可コールバック — v10.10</title>
<style>body{font-family:system-ui;margin:24px}pre{white-space:pre-wrap}button{padding:8px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}</style>
</head>
<body>
<h2>処理中…</h2>
<pre id="out"></pre>
<p><button id="retry" style="display:none">再試行</button></p>
<script>
const BUILD_ID="v10.10";
const FIXED_REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const LS={acc:"sp_access_token",ref:"sp_refresh_token",exp:"sp_token_exp",ver:"sp_code_verifier",state:"sp_auth_state",last:"sp_last_auth_url"};
function out(s){const e=document.getElementById("out");e.textContent+=(e.textContent?"\n":"")+s}
function readTriple(k){
  try{const v1=localStorage.getItem(k); if(v1) return v1}catch(_){}
  try{const v2=sessionStorage.getItem(k); if(v2) return v2}catch(_){}
  try{const m=document.cookie.split(";").map(s=>s.trim().split("=")).find(a=>a[0]===k); if(m&&m[1]) return decodeURIComponent(m[1])}catch(_){}
  return "";
}
function saveTriple(k,v){ try{localStorage.setItem(k,v)}catch(_){} try{sessionStorage.setItem(k,v)}catch(_){} try{document.cookie=`${k}=${encodeURIComponent(v)}; Max-Age=900; SameSite=Lax; Path=/spotify-auth/`}catch(_){} }
function clearVerifier(){try{localStorage.removeItem(LS.ver)}catch(_){}
try{sessionStorage.removeItem(LS.ver)}catch(_){}
try{document.cookie=LS.ver+"=; Max-Age=0; Path=/spotify-auth/"}catch(_){}
}
function readState(){
  const url=new URL(location.href); const s1=url.searchParams.get("state");
  if(s1) return s1;
  return readTriple(LS.state);
}
function b64url(buf){ let b=""; const u8=new Uint8Array(buf); for(let i=0;i<u8.length;i++) b+=String.fromCharCode(u8[i]); return btoa(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }
function getClientIdFallback(){
  const st=readState(); if(st){ const m=st.split("|").map(s=>s.trim()); const ci=m.find(x=>x.startsWith("ci=")); if(ci) return ci.slice(3); }
  try{ const pref=localStorage.getItem("client_id_pref"); if(pref) return pref }catch(_){}
  return "1fd6350fcf4945a0b3ddffa2d5730d4e";
}
window.addEventListener("unhandledrejection",e=>{e.preventDefault();out("unhandled: "+(e.reason&&e.reason.message?e.reason.message:String(e.reason)))})

/* no code 時に同一タブで自動再実行（S256） */
async function autoReauth(){
  try{
    const CLIENT_ID=getClientIdFallback();
    // new code_verifier
    let v=""; crypto.getRandomValues(new Uint8Array(64)).forEach(x=>v+=String.fromCharCode(97+(x%26)));
    const state=`${BUILD_ID}|ci=${CLIENT_ID}|ts=${Date.now()}|auto`;
    saveTriple(LS.ver,v); saveTriple(LS.state,state);
    const ch=b64url(await crypto.subtle.digest("SHA-256",new TextEncoder().encode(v)));
    const u=new URL("https://accounts.spotify.com/authorize");
    u.searchParams.set("response_type","code");
    u.searchParams.set("client_id",CLIENT_ID);
    u.searchParams.set("redirect_uri",FIXED_REDIRECT_URI);
    u.searchParams.set("code_challenge_method","S256");
    u.searchParams.set("code_challenge",ch);
    u.searchParams.set("scope","playlist-modify-public playlist-modify-private ugc-image-upload");
    u.searchParams.set("state",state);
    try{localStorage.setItem("client_id_pref",CLIENT_ID)}catch(_){}
    try{saveTriple(LS.last,u.toString())}catch(_){}
    location.replace(u.toString());
  }catch(e){
    out("autoReauth failed: "+(e.message||e));
    document.getElementById("retry").style.display="inline-block";
  }
}

async function tokenExchange(){
  const url=new URL(location.href);
  const code=url.searchParams.get("code");
  const err=url.searchParams.get("error");
  const CLIENT_ID=getClientIdFallback();

  if(err){ out("error="+err); document.getElementById("retry").style.display="inline-block"; return; }
  if(!code){
    out("no code → 自動再実行します");
    await autoReauth();
    return;
  }
  const cv=readTriple(LS.ver);
  if(!cv){ out("no code_verifier（ストレージ消失） → 『再試行』を押してください"); document.getElementById("retry").style.display="inline-block"; return; }

  const body=new URLSearchParams();
  body.set("grant_type","authorization_code");
  body.set("code",code);
  body.set("redirect_uri",FIXED_REDIRECT_URI);
  body.set("client_id",CLIENT_ID);
  body.set("code_verifier",cv);

  for(let a=0;a<4;a++){
    try{
      const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body,cache:"no-store",redirect:"follow",mode:"cors"});
      if(!r.ok){
        let msg="token "+r.status;
        try{const j=await r.json(); if(j.error||j.error_description) msg+=": "+(j.error_description||j.error)}catch(_){const t=await r.text(); if(t) msg+=": "+t.slice(0,200)}
        throw new Error(msg)
      }
      const j=await r.json();
      try{localStorage.setItem(LS.acc,j.access_token)}catch(_){}
      try{localStorage.setItem(LS.exp,String(Date.now()+j.expires_in*1000))}catch(_){}
      try{if(j.refresh_token)localStorage.setItem(LS.ref,j.refresh_token)}catch(_){}
      try{sessionStorage.setItem(LS.acc,j.access_token)}catch(_){}
      clearVerifier();
      location.href="https://npr2025.github.io/spotify-auth/index.html?v="+BUILD_ID+"&ok=1&bust="+Date.now();
      return;
    }catch(e){
      out("retry "+(a+1)+": "+(e.message||e));
      await new Promise(r=>setTimeout(r,700*(a+1)));
    }
  }
  document.getElementById("retry").style.display="inline-block";
}
document.getElementById("retry").onclick=()=>{document.getElementById("retry").style.display="none";tokenExchange()};
tokenExchange();
</script>
</body>
</html>
