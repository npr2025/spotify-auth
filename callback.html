<!doctype html>
<meta charset="utf-8">
<title>Spotify Callback</title>
<style>
  body{font:14px system-ui;color:#e6f1ff;background:#0b1220;padding:20px}
  pre{white-space:pre-wrap;background:#091426;border:1px solid #20304a;padding:12px;border-radius:8px}
  a,button{color:#cfe3ff}
</style>
<h1>Finishing sign-in…</h1>
<pre id="log">Waiting for code…</pre>
<script>
const LOG=(...a)=>{const el=document.getElementById('log');el.textContent+="\n"+a.join(' ')};

const CLIENT_ID = '5b4dc486f92a46878665468fa5de9361';
const REDIRECT_URI = 'https://npr2025.github.io/spotify-auth/callback.html';
const TOKEN_URL = 'https://accounts.spotify.com/api/token';

// x-www-form-urlencoded POST
async function postForm(url, data){
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body: new URLSearchParams(data)
  });
  if(!res.ok){
    const t=await res.text();
    throw new Error(`HTTP ${res.status} ${t}`);
  }
  return res.json();
}
function backToApp(){
  const ret = sessionStorage.getItem('return_to') || '/';
  location.href = ret;
}
(async ()=>{
  try{
    const qs = new URLSearchParams(location.search);
    const err = qs.get('error');
    if(err){ throw new Error('Spotify returned error: '+err); }

    const code = qs.get('code');
    const state = qs.get('state');
    if(!code){ throw new Error('no code'); }
    if(!state){ LOG('WARN: no state'); }

    const verifier = sessionStorage.getItem('code_verifier');
    if(!verifier){ throw new Error('missing code_verifier (originが違う/ストレージが消えた可能性)'); }

    LOG('Exchanging code for token…');
    const token = await postForm(TOKEN_URL, {
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    });

    // 保存（ビルダーは sessionStorage.getItem('access_token') を参照）
    sessionStorage.setItem('access_token', token.access_token);
    if(token.refresh_token){ sessionStorage.setItem('refresh_token', token.refresh_token); }
    const expiresAt = Date.now() + (token.expires_in||3600)*1000;
    sessionStorage.setItem('access_token_expires_at', String(expiresAt));

    LOG('Signed in. Returning to app…');
    backToApp();
  }catch(e){
    LOG('ERROR:', e.message);
    LOG('ヒント:');
    LOG('・ダッシュボードの Redirect URI が完全一致しているか');
    LOG('・Development mode の Users に自分のアカウントを追加済みか');
    LOG('・auth.html も callback.html も https://npr2025.github.io/ 配下で動かしているか');
  }
})();
</script>
