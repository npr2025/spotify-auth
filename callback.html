<!doctype html><meta charset="utf-8">
<title>Spotify Callback</title>
<pre id="log">Authenticating…</pre>
<script>
const CLIENT_ID="1fd6350fcf4945a0b3ddffa2d5730d4e";
const REDIRECT_URI="https://npr2025.github.io/spotify-auth/callback.html";
const log=(m)=>{document.getElementById("log").textContent+="\n"+m;};
function clean(){history.replaceState({},document.title,location.pathname);}
async function token(code,ver){const b=new URLSearchParams({client_id:CLIENT_ID,grant_type:"authorization_code",code,redirect_uri:REDIRECT_URI,code_verifier:ver});
  const r=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:b});
  return {ok:r.ok,status:r.status,json:await r.json()};}
(async()=>{
  log("JS boot");
  const q=new URLSearchParams(location.search);
  log("URL query = "+location.search);
  const code=q.get("code"), state=q.get("state"), err=q.get("error");
  const sv=sessionStorage.getItem("pkce_verifier"), ss=sessionStorage.getItem("pkce_state");
  if(err){log("Authorization error: "+err);return;}
  if(!code){log("No code in URL → Redirect URI不一致 or auth.html経由してない");return;}
  if(!sv){log("Missing PKCE verifier → auth.htmlから開始して");return;}
  if(!state || state!==ss){log("State mismatch");return;}
  const {ok,status,json}=await token(code,sv); clean();
  log("token status="+status); log(JSON.stringify(json));
})();
</script>
