<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Spotify Auth Callback</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:36px auto;padding:0 12px}
  #log{background:#0b1220;color:#cfe3ff;padding:12px;border-radius:8px;white-space:pre-wrap;max-height:420px;overflow:auto;margin-top:12px}
  a.btn,button{display:inline-block;margin:6px 8px 0 0;padding:9px 12px;border:1px solid #bbb;border-radius:8px;background:#fff;text-decoration:none;cursor:pointer}
</style>
</head>
<body>
<h1>Spotify Auth Callback</h1>
<p id="status">Waiting for codeâ€¦</p>
<p>
  <a href="auth.html" class="btn">ã‚¢ãƒ—ãƒªã¸æˆ»ã‚‹</a>
</p>
<pre id="log"></pre>
<script>
/*** å›ºå®šï¼šauth.html ã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ ***/
const CLIENT_ID    = "YOUR_SPOTIFY_CLIENT_ID";              // â† åŒã˜å€¤ã«
const REDIRECT_URI = "https://your-domain.example/callback.html"; // â† åŒã˜å€¤ã«

const LS = { acc:"sp_access_token", ref:"sp_refresh_token", exp:"sp_token_exp", ver:"sp_code_verifier" };
const log = (s)=>{ const el=document.getElementById("log"); el.textContent += (el.textContent? "\n": "") + s; el.scrollTop = el.scrollHeight; };

(async ()=>{
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  const err  = params.get("error");
  if(err){ document.getElementById("status").textContent = "Error: "+err; log("error="+err); return; }
  if(!code){ log("code not found"); return; }

  document.getElementById("status").textContent = "Exchanging codeâ€¦";
  const code_verifier = localStorage.getItem(LS.ver);
  if(!code_verifier){ log("code_verifier missing"); return; }

  const body = new URLSearchParams({
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,      // â† auth.html ã§æŠ•ã’ãŸã®ã¨å®Œå…¨ä¸€è‡´
    client_id: CLIENT_ID,
    code_verifier
  });

  try{
    const res = await fetch("https://accounts.spotify.com/api/token",{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body
    });
    const txt = await res.text();
    let j; try{ j = JSON.parse(txt); }catch{ j = {raw:txt}; }

    if(!res.ok){
      if((j.error||"").includes("invalid_client")){
        document.getElementById("status").textContent="Failed (INVALID_CLIENT)";
        log("âŒ INVALID_CLIENT: CLIENT_ID / REDIRECT_URI ã‚’ Dashboard ã¨å®Œå…¨ä¸€è‡´ã«ã€‚æœ«å°¾ /callback.htmlãƒ»http/httpsãƒ»ãƒãƒ¼ãƒˆç•ªå·ã¾ã§ç¢ºèªã€‚");
      }else{
        document.getElementById("status").textContent="Failed";
      }
      log("Token error: "+JSON.stringify(j));
      return;
    }

    localStorage.setItem(LS.acc, j.access_token);
    localStorage.setItem(LS.ref, j.refresh_token||"");
    localStorage.setItem(LS.exp, String(Date.now()+ j.expires_in*1000));
    document.getElementById("status").textContent = "Signed in.";
    log("âœ… authorized. You can close this tab.");
  }catch(e){
    log("ğŸ’¥ "+e.message);
  }
})();
</script>
</body>
</html>
